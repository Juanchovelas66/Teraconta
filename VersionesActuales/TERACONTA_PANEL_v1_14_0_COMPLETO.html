<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TERACONTA - Panel Admin + Cliente v1.14.0 (Reportes Ubicación Completo)</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; 
        }
    </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  </head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        const TERACONTA_LOGO = "data:image/png;base64,UklGRoIsAABXRUJQVlA4WAoAAAAgAAAAvwIAawIASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZWUDgglCoAABAAAZ0BKsACbAI+USiSRqOioaEg8hlgcAoJZ271P2TjM6eSCRxO22u7Vkv4B7F6eVjygVPj/8X1YcuB62fNn+4H6m+8R5s3ou9U36IH7HeVV8U2Q9edv8f2kf33+4/j12s/oj295b/YXmb/Gvtb+1/u3td/nu+X5if5PqC/kf8q/zf90/cDhX7d+gX70/Wv9v/fvyf+MD3j/nejf8T/ofYA/W7/lcbt6V7AP8+/u3/Y/z/u3/0v/x/0P+29O/6H/kv/Z/rvgQ/oH9o/63+G9sL//+5X9x///7sX7ziGA88Ysv5l/MplJk7JSo4qyDP1RChVjNKPfCwe9DCJHpWAZOHBe4L3Be4L3Be4L3Be4LBDbDxU/+ugzWLyCOtdxANd/be1GleOFycmyrpmv1RDxiAeeMWX8xM3hYpjvu7As97whYLYrRyfb1yBnVEly09Vsvkx8w2OTEKVEaNP09RPULNfqiHjEA88YsvuGkC6ktMv/rCTn/9sX//ycYLb6whtp23nFtsNNVvCBJ0e8/fyGxnwUoJo+1lLx3miJQ0UH4028dk4pfHVjSav5l/Mv5l/MtxesW2NDh/tHgYKB/Td+LMj8NKi8+xpb1IQp6v4p1w2iB8CEUHYU4yfnqL4JeG7z4xJq/mX8y/mX36+vL9Vg0dnx/H2RtZUnPQxAPPGLM/p4oxmZZH6/w0D+S+PeGjDJgWn+r9M1+qIeMP75A4ZyXpTKQN5aNHUc/njFl/Mv5lmpXRmrCcHz30SqWKwCULOboAtsxZUmr+ZfzL7+MSRGvQw6K4oYMrJq/mX8y/mX8yvcw4+hI2lURYhYyC4pNC1JI6v1RDxh/DJDcdCW2f+udrrcmxAPPGLL+ZfzL+EVMsMDl8QOml6DuxIJP3fWYgHnjFgE7MuZsaaLv5+jYXP/qiHjEA88Ysv5fs9V7JDw8179KI8Hyaar7RoAeMWX8fmf0jaih3EO+YxZfzL+ZfzL+ZfzK9ZoTAxYEJRaIxA4xoA6OWa/VEEBr9Kqer1TByoLI+KLzVZE4kmLrKVrk0D2CL0qZRSZ2Z4xD4FnYPsT4EtH44HRJ9M1+iPriw/hWkpDwg0B+f1RDzA4AQBMjEoXuSRES9uf5+jm3s4CMClabM1+pITf6ch3gKDpH7pwfLcfIafCpd/+JHvqSQJaa7ENOxOi61GlfFRNumGrei+KnIzPNhhVHc2LWcVM754HeLL+FjCcv8IpWa+Jh+iSYuwooqJOJB/XSolDQ4hgVgdmedN7xzXbCl6s4Ik0CK0Dxh1EVXpLmzduhe0ud8Ywz4sv5l/Dy70EWSlIb15xGXiPp05fcPTMGWGutfioWV4FtyGBqrhtcG8bwgIPNBObwjWS9hYTkJOr5jevXf92mlw6b7oXuC9p+EpE2nO6GNJGgr+bG0es2HUfONuh0xDshUJpkkQV+pCPLzL57jXT2IB54xEbFDVWHqlBLkygSq/mX9urlmZe9A8QkXhSrkWQis13B4lKfvGIB54tpQHvWH0KZhRKF7gvcF7fr3DTzo3d8QHUSs106fk9KGX8y/mCo73VybRS8YgHnjFl9HQSmTNUmxewFWa9+Rul4z8y/mX8PLuc0m0hEy4sv5l/MsQblx75sHh4ky4iNBYstX8y/mAS4JLpHEjjq2mLL+ZfzL653f0U+tYM2mcvzy9v1XfE/jprU/qiHjDYfvVKCbTSuhe4L3BeHySgRdD3M+6uGrmTsxiv+dqYZYgHnjEeXc5pNYKYcXPK6F7gvcF4hqc9RokQgXr3mR/9UHkJoipDxiAebjrdUoJGyBHreu/+pIAOqBgnOgxNBFRrtyDczFYUZgONDQTpKlZrv2eedwsNvZ4xZZeDrWyfVaphc6Tz327BpJ+JkVd3SbPDHK1s7EGbld3MNGJh6D18PWoHQ5gl6orgWu5R5k+OxAPO+MYWnyCZr9UQUfpZ8q89wSfKnebpXf9x9Tu2Z3i8dvCIDGld/d2OSR5AjKwAeMWXzMAm28h2fu9njFfufkWSmgVQU8DnMzpv/MjXvrTnVeROJJi7XM54vyZbY5FKDOxzk1AwTdWtNDEZANFNcvZ4xZf+1EO/Z21vwooh4xAPPGLL+ZfzAKR7VNcMjvQmLhYXxq7A9wXuC9oroNvoIjuC1fzL+ZfzL+ZfzL6MMMrhxjDQKkE7b0nBOJTY90D+zxiy/mV5/fIjSvpthnZrv/qiHjEA88YiDeM3CMLwnCanzROtmtGmEs8qH3TNfqiHEEfSSG4NKaSmprv/qiHjEA877AfJLMHvEajjmxZAn6yGYDxiy/mX8zPHBWn/heuDvBsPMv5l/Mv5l/CDRVNgpsUp3lNzTRfHI38tWnA71fzL+ZfzMSEF542FBtbcBbZFQRVTZ2PGIB54xZYIXgl4//fQ8nknrmQKtQcQt+xsExAPPGLL+ZfwoNKzB2m9nFXcFNw5KvXFy67EA88Yh6Xqhd//LUJ4WtF/+yC//yptpTvgKTRDYgHnjFl/Mv5l/PcsubyBs/g0vY/EyjGr1aHutiXh5qs5r2wFz4XyH7jT8L4HkJYP8zspbjO0KE4v/6IfVc/3/w6exk8Ysv5l/Mv5l/Mv6CuvcXAHOKga4ewGYugfBxWCuPGFkF+RsCq2mDrnvj+m8Z0vnXnK3Mec/KcS3/TCEITVP+Pv/U4YTv9UQ8YgHnjFl/Mv5l/NA3Go1TKPSdB8MogC8BzhFEPGIB54xZfzL+ZfzL+ZfzL+ZfzL+ZfzL+Zfy+AAP78DYAzrfHhgL9BqzZPJPKIoWDSsjPU2VyNe9E5eUAAwLoUmE5UAKoWcJbSEF8lwiLqWSKAAAnfM4zIRXnELnED9MnHIYP0OwbfpiLBo1TlkE2j1OT8G5vGzof9ARd8AAZJmOqPgTSQ1cVy6AbVDcms93hA1Hyq1b6AAAAN2D/3Zvl6kWwhNcSUESxJdHlLTgVuakiS37pmaZC8hxcrX+MxxLWsVF+FMdBpwU951f7bkoHZGP3ORhCC3ShApNQniE+7He/lg1SCMSC58vS5RAqmhr+hNsaGe0EKIk8wCK3EPbAtY8v105cWvqBk9pVIJzuRv+tzJ4PxPOV7qSpWKGo71p0A1hRe2HRAvcaebRW4BgkMwKnANDTiR/KcdlsDWg5CitiK9Dh7td3o2lBGmH7DZ10YSbC9D/UScxVOHfqddM+1twCkDpSV34JQWrvCiX+FpkdKKps6/oTLTfV3ajrIUrUw4IyFvVih2k8R84OB0Ew9x3IXticF7ohQM2jtmCsXw4thzcpSpRtHRhrSEddHoX+gN12oGTWZjB2koJGOSyv59IjF55V1DhGkqCVD7ZaXq9BEX0gA4EENPf2+87yCADlh76460+VUA87QdtkvwQWnDxz+m+x5fN+uUXBneG2VkmOpHbYWShzySCnigrLOixWJlJv8L626YqDDK7NnRj0EvHfpNogsKuHeFn+c95u9CISCOjw423/SrT6iYubbHPeUav0pxnf/lNj3Zc0N+kt/c+8Ge8aju9CykpR9F+EZfe1wjFQ4hbDcODq0wapMQyITvJ3wo6+XXFyfZSAIYrYff4rP5creW6Jo9XPqrZz4MJUgrSi6lm413aLtZD6gwBdsR2dLuB7jV7jGpOk9TlzXltzZz7uulHBoUmKEETD1hiZyJQz04ub47bCtQkQLkPyaUY1WJP5nUV6wOFqUqDTq6kQVcZmgZnlblERDXypeMh3a0ZKWpelhsAjsNOpBbMdWeFj6TjLqToIh5feFYYosi8uXvngpa6mTQU/A66FLNFqRL2zz4l/lWUGhexn/I4KxFBiJl4lEU6n5HWIwq9IYnevb49N5YH56doebNufmzOw5O8s3oX3PHLCrGNt0Z+PE6HSt8QJEqdgtZKQziAL1ddEGZhuNCjYXZ8N2h5Gy/RsjKR7LRh8ucLwZFDGa3F2Ka6GcZtJmEs9QWv2pWUgDlX4k7RWs0zZM3iuH5ijS4V0C+BhtGvkl+i2gs0cUrOHqrdRdVeVxTPG2r/u06ES4F/YI7AEh8Xsz3vnLy8ZQBDItKl0x7CnEFHk1em+G9MIj9Gyb2csRQG3bPZanunugWd5SbXwwtxFbsYH7xo15n8xkoNeQDevmR2L48WobX/39SXzCBEDRYnZ2KQgW7WxGZ9UJyugA8whLs0/aV3bvqvplMq1kj3H/wC6u/UlUlkGPuLuuYdM0Vc3mkFglC3KQt5JkZniacjY+jpsxkTutgrWWtD6ZdH21811TWELWxeEjoE2xW53wTrsfURCYtWCj85lJUekJBZ9oONNR14ehoAuhjdqFlsBlRvBEy5nU0d10K98y17XrZ90SFmwjat1rFlaNIgOuKG3+vkcWcblyt1XcK8ODPgetM+9e/zA1rP47pBWog/Hoijh7XqBp9AUGDmwkQDTtjyRbGIK2ir0cXfRDi7XadzqW/VED+krM64IPgK2B3C2SnZEnWwmj6dDFcJl76tXRIssE+VX/DUknBXv4AWmP0gtt6DMhmFtyTs9YQ+dfU7/DiCtD5Qz5RyxC4izA3zL+oon4w03GlvcpeB8cc8+iwbEt/W9Y4n8quzofuT0qrrzR8KhdNVbxVsltv9nQenaZwyXXLgggaR0Pel9cofF3KUnbfzWXkBtfN9RgTycbqy/jsXX5zxGc+QY7eKhEVY/OnAdoXoWS7xcSI0THeN53xMFrIkyZWY+Zm+taTsYwksVR6VdWpd53QAAQC1oynwRzQvup0x+SDO/uPGy1/LXV23Gkif6VCAor8oAp55E8L6+hPMzjM8lqscIY/nQSGkOrEFiu+biIJbijyc7hcYmI7WyPTiyBBHbBrH8MubmsDUUYfVpsLQgPPpf/3Hb0wQZ3zVW0BoyQALmuSs1Zb1yJZsgLTIlkk/0Mq/uKEUZUTUZg6oSjublL+BjMfbApo6LFrardEHfbGuT4ym8hTUZkykWcZS/hVDRbx02NcJvg07cCD2z7qbZzMLLiKXl1Y8P0Nk4jqiVjqVueFAhyfiG6+6DlBLCW9Pmk1LK6KKibUffMGKQvr7m3+LAATuxms82u05mBUxIuNuTHZGGZzQ/Jmne/Aq2o0OIkQ7MAFCVw8NRD5toWRQi2WNITT9t3jCVVr42w5n4Y2Jgyvg9VCIp6WURsUr7iD1HUv1qAtsTkzmf2x7y7bYxPyxP/m0jGNJpM0g+B4uJNeW1vtvYOu/UBervG/iCBVIaNvtV8vO9TUMUzp/7Aj6jERbTvSn79KUOmGbgfDtLe/Q0DboCHCu7TwwrnTxA0HlZbPqO+t19/E33V+QQpOHIzNfCtt17u9ItVh0QKcPeG73IebFlBAB3456/pKU/JVGKN2L893CDGD+rogu1cF4XrverDPZ+dnUdeoGeMo4dJJLZV/LoS+U93uVLkZwfJ887ifN8P8owhsz6hEQ0zLCQHbKMjZcVtGBvPXMaYMLz1RJUrfRd5SGO2AHQMERVDBPPJpxubfzpRo7cbtAI0Cc7R9NIpOzwAlje1SqC0m42uJbN9qKDilL7Zfoz20Lmzho/OOIemw7Xzt8+b+5LWmNH0po8BLd5Shl8JhSFHEJFByMxIAAMDPWmWsjWzpZO7VNltdNpSTqb98Xs1NOb+kIdpJ5UzKpnnQjTZk0ru2FNYi/yj7Cq6muFCThtSgXTwZbfv/fjJ33VavgHwriy1IraRaREzDBcItBdV1k6CBH6F171mVAonSskyBlPzDdn2ufuWD5NkEtVvGosSW/11670ShRA5SutWGrzkt28soH5pMDpts+iC5DkIaEgsGMhh/HiJ7vFqSYbPnalNnduepBrI++soIVwAQ0pQEwyKtP3yMLPnJOMa7x4t6/Hh1qIkbFisayKGNM9q0uWnRJaKPZKmdu3sRG5GdCguXBJJwAvNEVGdzayfcMzma7Snl3F3Jl3JcGhHJokQM4fYLB94VAM4zckzqYetbEe5jm/jI5B285Xc2frac6JD3rzNLMPxibNeh3rUXiwHAvwtLPGcrPsKOggqeC7qucsQL96gNcn2JnFCAAIApuAyTmZ+Bifwmt+dcuHtuNvVOvZJ2m+KmZNIMy+SguMdHlZbsNoydByHK3SEdBON53HvxjpC+qpqa/t1cT/QuzoSj0KgN8G8GI5Uk/IwaUxBclzyoBOgyxJrqhQQonX+MW0JxLghsNVVh7DB+A52Jmu7UugDmoXKrPRqZEw8SPSyX9H4u7fGWDyQpMMzkZQFQsqrrCX2AVgTimYRG+n+b2VSd30olH79SxviXBPyJD3hUlYBFbtM43kcVy93X5aaUDc86gKtK5ZB/SgX+1hQQBQijpfBJnErudE/dJ4E2tERC1TWmrzqk6LBF+jFC66DEYRFmap0siKraNISVTmusQV6SO35/FhoVkCr0tgiLc5UdbiJZEjN1L0b4Y96bIzrl9Hyt8qo9wW76Q9KQ+wIktzHA0yXGG0cgLuQX3DDYiE/G/aBaBicuMWZA/DTi+WoI2O9rPUScvwmzaa/OBQO6x9jOlKFMjcEAuWaTVNbJvKsS23jdIkBVSKCOlduLOIDTJPeBLfm4SdN6g8V1ARjclCPDNXrpS/gnefJSVGUzUuaFkj9Qa7+ItLRq+rQ4cGp2WXLlkrqjjEXlR5Y8ZaV+If5ilJ60zekEs4w/Y/vNCZiVw2N2oqqUapA4JBVfGfb4aqq0WXIcfiyjcASmLLKkHUk1FJtTGvRr//w1tGrFtJahZxdO0me0sPw9F0uDx6Ha8IUAk23qMfHlaKj8258A9RC6rJLH1Qjcgaj9Xx2J27atFn6eqJIFfjgIX2qU3vBFz5T2QNczCaREd1PRI6fmjVE/cv/Z+2/FzXMxbD23/c6fwb1U3iEqJv250rvnhig7qMauyP9Tt4GldicX4BgBROaxr7a8qzkRJszhYIVNI8e+TwwpqYOXUbvykepRG8sUpGk27IFZDpHjFvQcKrYvGemNVr8J6iiJculVHPAw98/UwXl36IvJRRkfu/lBRPstHJYY1tF2WcRa6aXGb8cZgKgzh6UBv9jYVZAUl2NQGf8HQhHLU5y0X3TL5eaR4hXzF/HFYjG6h4qPOU0xFNZ7QQruxArAZk1IG9zlv90yyAn6Nvvecq93+J0BM30S7R4oopYAok35vYpz1j4dUdDGnBIJWnPklyedIB1WNv2blnN71PPvowTPrP1MTx0txrrbz6vyDbhs+WfaltrYySRpLtJSdv/OyqMZcM6/xTRsM1usU53+9/EnaeTX5zVop1ABKEAGJlmZX2weJZnYDaRz8QDTE1wwKLqr6z3FaO58XWGIAQGLEIdaUmAmdElVvZ4LS9iqANbpUDfqLMMM0brUSw4ov1sp9vethdNtiXP4xSTM3o0VrGS/7JgpTz8B7LrqYjFum28Xz6CXw7GhF/CYBw66M1cyQ3Zxc8L0vHjEEGLGIMWT9a5+a3K0uyeeirkp5OmNZGwMmIJzbhUaXlaHyjjC985j1ipD3NeOto6lytBmnUaEjOFMEMQzRFz8L4HmZdtiaKOYo4K+klTg+sRUrhx6SF4BRw1DkYfOxyKmM62KiRV69zO83zXNVstsDrki4qHbfUo2w8xhJMobRnBMYteA8QSInoFi6jw0+1vpTMuYt7eEJ6TjeqVyfMcoxixIaAuuX98NWZMNBVjR5jjw/yTuKpxyeUAebtPg7g0L8x5sPM5fK8x23iyJoegFbXH9cTjqaZgX82M7WFWJSR+332lYw4dXZwhOaBjPb+bfwSKDtXrcJphRffs6CJKT43f2dsSINR3i/YqV8udRPvTmg1flUT1OwAPDcnR+cVaxC9owp24ukhXKIQ3LglC5PKBr2qa8zeAp6lz/wktO+2Tf5WInoQP5+LlkYbWDtVgpjoi9Unfny4QUiXxRLprHcm1g4NBxOUJFQhpwaFY85UDz20aTe+VR7fdSEzJ+PozkYUfY72UsP6VTDyvW9N85s4Tw0WANCfl593+n3OTNMuC1TW/BYvm6ZSW8mKQitf5Ps1chvP2mUeIZcPOtMl5HKytOHr/LBL8cPogsCm6rw0Xb0lDc4NuC+oLw0ylZrYpcL/XIg4VsnrqUt35GeF2AEtyo7ZqoM6f0x1hY03vIHXNg6inGSHGKQIOXVnm99ZM0mPxgtUg7eCmJg8X7vNusFRSKnZrsj2ifc3tv/yIjCsaAGa4DtAoerXm3ibZ34CXcAwTCyHdX1m9tgPnaSCLDhmSXf6tQdMPgToJDNjmDUNUF5Wgv0Gv1h142LnV9Tzni1J9QM6xg9DboYsjGoNab+MaGI0hahaRdmQ8wHEyQsuZug+pvMA62P4rzn9+KZPTI2OJG7PLKTwo33CbcS/zbMP7onMUyRSvqkI9ogjRYQzm6hPdSw3U4Zjyl9z/xPDRYe6Uv121il4OWFS2XdPlPwlVR3940ZALhHW8fAKo5pv9Qq+Z6Muxgz7EAV99Fo5bObHOVW407liWHHONDcRkG7TVU9mBCdDE8oc2Qt5a25M1fy2NJvh7jaez/6A6dMjV4BuNC083sF7Pn7rUnA9EfaXv/hR3HZgACmtwwTpe3g3IpaiRiHt6Gd9YKi2fh1S5tp1WpSrVGvYJuIk9xfNHwbOh6ghmyGybmWu3AxzsWVgQy8AQBJmOZ6VJtbMSiO+rH64gFKfm+N0VPnLSH9theRexAP2OjPVZ6NJJ1q3ucNZmMAmB/BF3DlCN0I138PuJz/XjB8Av8QFMZWTukLVCx1jViXkG6/l+tMPtS2cL85HdcnDiMPMGYg5fRFx2MaEVfQ1FOBYQQsE2Aj6yupDbKCmDSyPO8bVdp85ksluaIsuAhbD4vaOGC+JjZs1h/lTaK0I0NksdpGp6F2Kfo+/UyDsVpK9kaIBvrKPFejYFVcO8g3ekOTNzjWuL5EcStc9lXjE4UZU/kmvYvQVTFL0SiUfWmGsaL4zbq+ty2RCPDo1wzeHqNhCAxefN+KSI4+lW5Irp6BmvdxYANMrMwF0Idk3aZKwngEXqWjhm4BxXQ4YAhUaAu/hIh2/phaugU/gFnvPp4H1akyD3y4U3cxUndaeMESvppcN914dVLNCttEwD+8eimjJHfjpjSLjHnA6ydoTB9nbA4J/Zvv1ZIqXOBtjCAWG+h3VgxoIWowSOEqPgXyc8eFvIMcU1n8feuNaEh2xOPVsDu3/9wfh2NBe7dGMmgwCknHlJDJUGJWXOHYQYKHFKFS3CbRNQwfUDEpyZQmPmg03bpunWGzVem2lbPtGo9DLxP131CvK5ZyFttYti43sYvk60eChzwx+bKxHHaO91UhPg9+ArNCpAYhsyFjeTIMRrXx72S+6rhVUmAB3TtHwB/hnZPYyxpAsRCDbf8gHo4Oe3itjxWRlklywoHK3UaDrTau8NB/BRYccJD/0kBDqfk5IRUiPTq+qOprEzOdqv76WD46L+R4QTglLeu/SBuPzhXifwg1GlMsUpWtDGc8Uytp4nJDQp856mtmmuBGDFbxAdgJKEF2Oj7Go1m5Rw3anzVS21jiyLQonU1KHS3/CdlGm5jx2TXhbVSfFOg6NxY46XnMxDrY6Z4iPwIzYIXWNCQq3TyoNfj6tS/9A+4LFWbaeFbSrdJXvJYyaJc8YSfZvMc7+AI7+2g/3nEkvxIHP1Aedm02jgxJqst02e1ODsjszV84ADpfhkSBpgJlgrd97A0QaHHrdmFV4tHTGi4PClhmHdxs4voCEfjl1AK9K+8MzW8CjGIxOcPK8KyMt+GvKv19GkgK/CDZn/G8DapXT6HF6+MjVCTfom/BIHCACkt9m6V61rMGdEon3CPnUDV5fAouBJX5lYr8oUeiYWDA1iJ0xKefnWKKiYFTEgrO8logcN/zAIVpKNOHbGpErOcH/CSK6qGZBub/kqsG3pibQWpR58IeaI1rZiK+IMr5h38Q19K9mxURYzZIQ2TIeyayZvzq4Xz0h80CrQ9wKYBGI+XYQaOAh/2jW+t/GBxj5O4mLw5+6FwF8c97OVIpKQd8yHqOwGOV5NSj3mLithNMv1witUyUSkj5x/2NbROWHaAsnpaRI5G1hHxxOjBl1KNzstyE1amRFBuN1dsVa+uWUJXKXIckgUcDRCuYoNoO2jKfOgRKnkUMq82ehujzhiT2vvJ4dP2X3IbMS7/8QDu/N1iU4bjWftJLFzFnkx/X3KiFg6ItDW/clqrOcBgxPQgsox8h1tZE5o/zpunRsxUL2P16qP2bi1xSXL5QE2EzORgVTnONp6qeTT/+IleXggGPFcFaVrygef44nI7/VNUZTUix0b6gHW+xNrQjApmMNW2BdhXiAO1C+N4BDyFuSEvN0G0Pnca0T+AbkUuiIEvCDQVJrchMKEQLG1aQ3ku67wyYgSt5lhTwkfnVqoxX9dOrJSiPw3wdmy3TWmsfN2zX6isCJw8E/oLE+/gPHcZJsxP13hbeLjbvTh3MvldwP1y19xoFMBY2BzldS3rJ3zP1QrqZFL4c9KmqWh7HbC4OxHgft9BlR3CbynMqQBboEdSUWQB1n0ncqcYbi4JF8Mnpuf+l/++v7v2lH0PWFTzBZD+9TJFCopgKmdyMi5Bh2UY2lAmKVe2CM7BFgkqASVdvb9MvmoVe4OuJwyiymu8YB8Qhk9V0juK3RP/99qcvk6+Pbl9+lm3GfrmvR4gRQdVIc59Pd3qnkvUhrOfmo01ni2GQSTSBtrVZJ2+bckV+ZEWLZjqbpSgYkKNelAoElFq08/aHz0U2e+knbXNal/Pd5NJe1kF17uivOp2BmX8aO54HO0lyHKkYzZcNG21qI8WeV88pfPlzshVVN4JeQIFQmYw/mQRmw5BQbNkjZCci/YiucHq1P5ZlVx+zIFvb5FFzl3/FJ3CN2NJ3ohUm+dgX2dtg74lPzJfhTti6FzKfPMUzJonjyl6Hfx8aPAf1RP+iGbyPsJI2hO0VxyJvXfzgf2/YnGPSY5WdSDPrcncI9FfQBJx83Ag2eZwxnMQQ1SEgpiai46+zJgA3Xg/so9j9cUpEZzxuBhi+utovNfQ7IFqOB26fBTpTknz4TuksFHTipFyrr1YnUeuXPnhF8/AbYiWbO9NZNAVbYVk9d7KjeVSUM3dzg5+koZun4sFewE09tMLQnv16AP/iyPl0TY4aDbbXIsYrETy2dIt2h0swl7GbflJ773us2joQTvOqOwJMpik7xSxWBVhIFgmXYnAL1OCZAAEbYCsPhn7D5rLv/xJZ/VrSVLR8/AF71OVr0Yz5AKVb+Zix3pHdY6oxsHFGCq/2VonQEknTXJf8vAgb/6hB/fC+yPe7O/ZoBpmJmfMbiCSskntNVfABLeOWyYCurAlMKajdTCr4mpqKi0U4CDTeCA4tBtOEXM/IyXD/UyYJd5hcfHeSfnhL/mMv3txag0c2dr8K8jlcg7nnD2paz2ZmApkQtdkxfWB/dgl1RRm4ebwhH4/3v5s4AVid0bXor9OaEnf5+WKm2i0nm9GXMUa35Z0pAtoh5fpetjldwGEUH4IqQO8TLm9dBUEKQu5afby7f4+XEx6PR+Y1pC4CJGT2ea8RwzLZozsWErlbZjYTYdHCVhQ5rTHMWlog5OKMRvimbtNX520zGAAOPlSqqpvxU+Utz8CFf29B5GIS5dFxbYIWrExewukJjTxLMZ8/Jm7b6ot7nlj4LHZH37RYVSvX7A5PyOgLZgAab2D8DDCXxCa9ZhKr/wvzx5v0tNKWBf62q9oOf2q5h8hoOqLT203bErKYJXHZRtCMyZ7Q5/TTZoEh5GfoCYm5y07LmZq3HekJdQoQBMrfsYH8AlGW4e/+W5g6GsC3fN4sCzwR2+vC4kcQRdAqfiDAq06cAZ9jWe6St8gpHCDkyrhAMnWNVVNLAr4P6EcBh4aFLaWBVOtVipveeGI8ZxtZALsgyUqVbAa5/HoQFDNQl0ZzwlbMT2Eew8/5SoWvK72U6qADB+OPaCk9ahywAsLKhjxBRp+aezOYpUc5ihH6mwTmnUTvwCeqLRwBdTFhlV2/Gf/jgPVZevYqquTF+e6fuUe5AdfiWsZtK5cj5dGoNWIbk1BIkuJvHHQisiuHr5wWWZH7LZkH1Et8noMAYil570/jFZ5nomchlvaRsAZWEbdhLdtLSyQNzAwoPJbXFRQqrYRcPQJqJHJDWtZ7af+Dl1/vsjBvLV7gDH7vFCZ48bz8m4jAgMOfXhXwz219iJUtBqkJgP8GRIbWbNABajJKJitRn6rsHVzTIAO3j5tfwxv9UWVWJUW3B59sUDG6aYXZ0QURq8NHtEO9gQuYFA1XaKFeLYnmfrOk59Ck+naFGqDQ76KBonDZkrZe9zIoCdGfoaUDzt6jP9/mj6S2AgXG4GrjCEGI34zABaKC2Ly7GMfBL3GoDXUav261+GjyxN7ZK1vHmAj9lhlj9sYRSYNbOaegoAvMJdYSGwf6dMDP+fgTG7psAAyM+NN2woQAaUCfTEOk+pAytYopZd2YTdhYRwRmVf5CjKYRxoUiHotPpPcQ42meTXhdRWdauTVl8LOBU1r65EYrhLNuWgJdzc2f7PZUxnhZWmDZjrwIC18O2SxOnM0pz0BHL0dJzakb8X6eRqxiWLaAReKILYEkxswxOakg9/KQ2+Qx3WQHp3nOUzyUQOs5BKghijtM7+ibpw320qX9eFN/Ct1ysLOb2Hv2HJHbfqhO1HUdpwG04n2XxKL+Y14gO//LS6uUzOWi7pRwE7OEjdqitQ9lSssiyCIKWYJEVGJYpOHBdfHTeCA2wHOMqWa3Ul+KlPh3vEpS2NlOvdhHRyWWqvyZBKpuP7cwUm1bsSD1KkYSVByVOAM9QvJjldRJRDXifeSs7tmWNwGZqut3vvVTMsWqAAF8i5xgAvjDkcNI88a1om5Qn471dIl1QzgxreqCOwLY6jnxlO4wytUzLucP+NVFEVdpGP3tPQkRuuJNMJzf0Ejp+h4PaCSyTH8QP7VoN3sikKy+QbdJEQPnsvgRU9p3AQF2VMp3He0VYt1wYzOoEiYXbHT4XDTFcMquFDVC7KkQjX/i64b6Wpxgsxtf3naE3eA0TYSvLvCnb8Bs4nxQr6F+atDN9SjLg+zUYPfEBom5pjKhKLWKJHmc2MiR1Jlh5g6DpQPXLPiVCsFYhfcykuHubYEhOvE3LQbBkoGZZwHDwO1T7oSs7irLKD2qLo5oIQuyGQCqzFUplGCOp06spEdizGtwL/OH7StMapYD/kI7MXf1dPDyKb9i3zs54t3h57B8tsqx3hlq0PaycpN3QnZkYKVLOsiCCu9OFwn2RFwhU19qCxZOOJjrqy4ntHR/0xWDzUgpHAABKo1YnlOdONAdwueU06IbkHtwAkalwrbGuzERx3rubri2RcOA1WFeN+8PX/OLXFWXWke1yuy7Pp/lPQ4+m7/32AGCxkD5wDgVymRN3P5Hm6tJQHuHQHeUbsNN2dF0VoWBg3MsseZNayWZZP6SEzBnlsBd8vNGgXgE67GdSgLe4GFZ4G20mlRAluzrLG9Rtmb3WfrGS0Nck1oFQ1yq2YLVdXhlUsiPVJdO5MBLxK9BJ92sQlzioMmEGHbblcfwQhCg/K2ssyjONM3PHm3bE/229urhWlt9gZTJ/VI/T/lYWpsImDJGnP+Wn2lNWVOmFfySDU3g6xSLop2f3gA0m7jbCXVOKOMfgWpRQJGxa8n8k6QHEFpckslkIRbGkuz3b0izOuRKiNS9rci0I90Jo9zzcPNst/7q/3yTU3UhJJm02RFQ2nHSczwwTBLeYJjE666sY0uarRxtysS9JwMdggG/O9gvaTRy6EEiQuYd5txaZb66mQLAW3XdgFs04Mmsq76bKNOnEa03NZJutWr2iYn+f6bk0ucMRYAQ48KjKgdt+5/dWvgkmXhdh41jjpDAc97gEUoayRZynMpv0Yb1NEa1ttLpqN/dCuVLHeHj6GfWAvjEbA6Fg5qe6K2g0hBjltTEWDEVSDw/KISvEc3F+gLy9xG9OnGFjICK8ZgAABpUXbkwnhU1/AxmdEkc6Oq2jDyyat9J0Xi58Vnq2wiuMKx2iqYOD2NqAf2Tqr1MGHRkj1udM2eSKzdnvo0zS40NlfdsgFauCLKB9Wnq3MIGVThehHF3a8V9rhlrhldzFfy471FsWqi0xvw0wIHC8k05JIyI0FV9snqF6qv9d42l798ACNzSdQPaXXrrrIN+Uf8kEnhRHcys+RUGGClT0CKiFrRkCwcVYAXGpmqTcXPHP9s48n/mCrTdiF/6msmChSUM3oiiDWafkCmNqfcL2kcEqCGvYjpCynxERDA4TrOgzpNlBE3RL5h2F/IrXzexIYDZXazHfdsjUd4jaj7vIzFWGVu3cWLinpWmVKU8SXKRq7g9a1A57SxuBvk971aZr2HRnkridx/24gmtl9fyA4Un9CIr7cSXWgiixGzfcXJ7IXAb71HCBLFolD1yo8DAdhHeZ/5gAAANqqSkODPnlxCg26fe8E1jKZzdqxmR9sRtLlKwS5BJm8pWfjtJAl3CKwm+CMosSx8j8WKkv4U0Si+R9ARamDFOWa8N7FMfy3i2zX4Y4dFyuTWrK2Uynv6PZblSOIAAAAAAAAAAA=";
        
        const TeracontaLogo = ({ size = 'large', showText = true }) => {
          if (size === 'large') {
            return (
              <div className="flex flex-col items-center mb-4">
                <img 
                  src={TERACONTA_LOGO} 
                  alt="TERACONTA" 
                  className="w-24 h-24 object-contain"
                  style={{ backgroundColor: 'transparent' }}
                />
                {showText && (
                  <div className="mt-3 text-2xl font-bold tracking-wider text-gray-800">
                    TERACONTA
                  </div>
                )}
              </div>
            );
          }
          
          if (size === 'small') {
            return (
              <div className="flex items-center gap-3">
                <img 
                  src={TERACONTA_LOGO} 
                  alt="TERACONTA" 
                  className="w-10 h-10 object-contain"
                  style={{ backgroundColor: 'transparent' }}
                />
                {showText && (
                  <div className="text-xl font-bold text-white tracking-wide">
                    TERACONTA
                  </div>
                )}
              </div>
            );
          }
        };
        
        // ==================== ICONOS SVG ====================
        
        const Plus = ({ className = "w-5 h-5" }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
          </svg>
        );
        
        const Edit2 = ({ className = "w-5 h-5" }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
        );
        
        const Trash2 = ({ className = "w-5 h-5" }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        );
        
        const X = ({ className = "w-5 h-5" }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        );
        
        const Search = ({ className = "w-5 h-5" }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        );
        
        const Filter = ({ className = "w-5 h-5" }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
          </svg>
        );

        const Eye = ({ className = "w-5 h-5" }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        );
        
        const ArrowLeft = ({ className = "w-5 h-5" }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        );
        
        const ChevronDown = ({ className = "w-5 h-5" }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        );
        
        const ChevronRight = ({ className = "w-5 h-5" }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
          </svg>
        );
        
        const Users = ({ className = "w-5 h-5" }) => (
          <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
        );

        // ==================== DATOS MOCK ====================
        
        const INITIAL_CLIENTES = [
          {
            id: 1,
            nombre: 'Constructora ABC S.A.',
            nit: '900.123.456-7',
            representante: 'Carlos Méndez',
            email: 'carlos.mendez@abc.com',
            telefono: '+57 300 123 4567',
            direccion: 'Calle 100 #15-20, Bogotá',
            activo: true,
            fechaRegistro: '2024-01-15'
          },
          {
            id: 2,
            nombre: 'Inmobiliaria XYZ',
            nit: '900.234.567-8',
            representante: 'María Rodríguez',
            email: 'maria.rodriguez@xyz.com',
            telefono: '+57 310 234 5678',
            direccion: 'Carrera 7 #80-45, Bogotá',
            activo: true,
            fechaRegistro: '2024-02-20'
          },
          {
            id: 3,
            nombre: 'Grupo Empresarial 123',
            nit: '900.345.678-9',
            representante: 'Jorge Sánchez',
            email: 'jorge.sanchez@grupo123.com',
            telefono: '+57 320 345 6789',
            direccion: 'Avenida El Dorado #45-30, Bogotá',
            activo: true,
            fechaRegistro: '2024-03-10'
          }
        ];

        const INITIAL_PROYECTOS = [
          {
            id: 1,
            nombre: 'Edificio Torres del Parque',
            clienteId: 1,
            descripcion: 'Construcción de edificio residencial de 20 pisos',
            direccion: 'Carrera 15 #85-40, Bogotá',
            fechaInicio: '2024-01-20',
            fechaFin: '2025-06-30',
            presupuesto: 5000000000,
            estado: 'En Ejecución',
            activo: true,
            jornada: {
              horaInicio: '07:00',
              horaFin: '17:00',
              horasEstandar: 8,
              tiempoAlmuerzo: 60,
              diasLaborales: [1,2,3,4,5,6]
            }
          },
          {
            id: 2,
            nombre: 'Conjunto Residencial Los Sauces',
            clienteId: 1,
            descripcion: 'Desarrollo de 5 torres residenciales con zonas comunes',
            direccion: 'Calle 127 #52-30, Bogotá',
            fechaInicio: '2024-03-01',
            fechaFin: '2025-12-31',
            presupuesto: 12000000000,
            estado: 'En Planificación',
            activo: true,
            jornada: {
              horaInicio: '07:00',
              horaFin: '17:00',
              horasEstandar: 8,
              tiempoAlmuerzo: 60,
              diasLaborales: [1,2,3,4,5,6]
            }
          },
          {
            id: 3,
            nombre: 'Centro Comercial Plaza Norte',
            clienteId: 2,
            descripcion: 'Centro comercial de 3 pisos con estacionamiento subterráneo',
            direccion: 'Autopista Norte #145-20, Bogotá',
            fechaInicio: '2024-02-15',
            fechaFin: '2025-08-30',
            presupuesto: 8500000000,
            estado: 'En Ejecución',
            activo: true,
            jornada: {
              horaInicio: '07:00',
              horaFin: '17:00',
              horasEstandar: 8,
              tiempoAlmuerzo: 60,
              diasLaborales: [1,2,3,4,5,6]
            }
          },
          {
            id: 4,
            nombre: 'Urbanización Villa Hermosa',
            clienteId: 2,
            descripcion: 'Conjunto de 50 casas campestres',
            direccion: 'Vereda La Calera, Cundinamarca',
            fechaInicio: '2024-04-01',
            fechaFin: '2025-10-31',
            presupuesto: 6000000000,
            estado: 'En Planificación',
            activo: true,
            jornada: {
              horaInicio: '07:00',
              horaFin: '17:00',
              horasEstandar: 8,
              tiempoAlmuerzo: 60,
              diasLaborales: [1,2,3,4,5,6]
            }
          },
          {
            id: 5,
            nombre: 'Oficinas Corporate Center',
            clienteId: 3,
            descripcion: 'Edificio de oficinas clase A de 15 pisos',
            direccion: 'Carrera 7 #71-52, Bogotá',
            fechaInicio: '2023-11-01',
            fechaFin: '2024-12-31',
            presupuesto: 4000000000,
            estado: 'En Ejecución',
            activo: true,
            jornada: {
              horaInicio: '07:00',
              horaFin: '17:00',
              horasEstandar: 8,
              tiempoAlmuerzo: 60,
              diasLaborales: [1,2,3,4,5,6]
            }
          }
        ];

        // ==================== INSTANCIACIÓN DE PLANTILLAS (v1.6.0) ====================
        
        // Configuración de Localización por Proyecto
        const INITIAL_LOCALIZACION_CONFIG = [
          {
            id: 1,
            proyectoId: 1,  // Torres del Parque
            nivel1: {
              tipo: 'Torre',
              etiqueta: 'Torre/Edificio',
              opciones: ['Torre Norte', 'Torre Sur']
            },
            nivel2: {
              tipo: 'PisoApto',
              etiqueta: 'Piso + Apartamento',
              generarAutomatico: true,
              formato: 'Piso {piso} - Apto {apto}',
              config: {
                'Torre Norte': { pisos: 20, aptosPorPiso: 6 },
                'Torre Sur': { pisos: 20, aptosPorPiso: 6 }
              }
            },
            nivel3: {
              activo: false
            }
          },
          {
            id: 2,
            proyectoId: 4,  // Villa Hermosa (casas)
            nivel1: {
              tipo: 'Manzana',
              etiqueta: 'Manzana',
              opciones: ['Manzana A', 'Manzana B', 'Manzana C']
            },
            nivel2: {
              tipo: 'Casa',
              etiqueta: 'Casa',
              generarAutomatico: true,
              formato: 'Casa {numero}',
              config: {
                'Manzana A': { casas: 15 },
                'Manzana B': { casas: 18 },
                'Manzana C': { casas: 17 }
              }
            },
            nivel3: {
              activo: true,
              tipo: 'Area',
              etiqueta: 'Área',
              opciones: ['Sala', 'Cocina', 'Baño Principal', 'Baño Social', 'Habitación Principal', 'Habitación 2', 'Habitación 3', 'Garaje', 'Patio']
            }
          }
        ];

        // Ubicaciones generadas (ejemplos - en producción se generan automáticamente)
        const INITIAL_UBICACIONES = [
          // Torre Norte - Ejemplos
          { id: 1, proyectoId: 1, nivel1: 'Torre Norte', nivel2: 'Piso 1 - Apto 1', nivel3: null, activo: true },
          { id: 2, proyectoId: 1, nivel1: 'Torre Norte', nivel2: 'Piso 1 - Apto 2', nivel3: null, activo: true },
          { id: 3, proyectoId: 1, nivel1: 'Torre Norte', nivel2: 'Piso 1 - Apto 3', nivel3: null, activo: true },
          { id: 4, proyectoId: 1, nivel1: 'Torre Norte', nivel2: 'Piso 5 - Apto 3', nivel3: null, activo: true },
          { id: 5, proyectoId: 1, nivel1: 'Torre Norte', nivel2: 'Piso 10 - Apto 1', nivel3: null, activo: true },
          // Torre Sur - Ejemplos
          { id: 6, proyectoId: 1, nivel1: 'Torre Sur', nivel2: 'Piso 1 - Apto 1', nivel3: null, activo: true },
          { id: 7, proyectoId: 1, nivel1: 'Torre Sur', nivel2: 'Piso 12 - Apto 2', nivel3: null, activo: true },
          // En producción habría 240 ubicaciones (2 torres × 20 pisos × 6 aptos)
        ];

        // Disciplinas instanciadas en proyectos (ejemplos)
        const INITIAL_PROYECTO_DISCIPLINAS = [
          // Proyecto 1 - Todas las disciplinas activas
          { id: 1, proyectoId: 1, disciplinaMaestraId: 1, activo: true },  // Estructuras
          { id: 2, proyectoId: 1, disciplinaMaestraId: 2, activo: true },  // Mampostería
          { id: 3, proyectoId: 1, disciplinaMaestraId: 3, activo: true },  // Acabados
          { id: 4, proyectoId: 1, disciplinaMaestraId: 4, activo: true },  // Instalaciones Eléctricas
          { id: 5, proyectoId: 1, disciplinaMaestraId: 5, activo: true },  // Instalaciones Hidrosanitarias
          { id: 6, proyectoId: 1, disciplinaMaestraId: 6, activo: false }, // Instalaciones de Gas (desactivada)
        ];

        // Tareas instanciadas en proyectos (ejemplos - representativas)
        const INITIAL_PROYECTO_TAREAS = [
          // Proyecto 1 - Estructuras
          { id: 1, proyectoId: 1, proyectoDisciplinaId: 1, tareaMaestraId: 1, activo: true },  // Excavación
          { id: 2, proyectoId: 1, proyectoDisciplinaId: 1, tareaMaestraId: 2, activo: true },  // Cimentación
          { id: 3, proyectoId: 1, proyectoDisciplinaId: 1, tareaMaestraId: 3, activo: true },  // Columnas
          // Proyecto 1 - Mampostería
          { id: 4, proyectoId: 1, proyectoDisciplinaId: 2, tareaMaestraId: 6, activo: true },  // Muros en Ladrillo
          // Proyecto 1 - Acabados
          { id: 5, proyectoId: 1, proyectoDisciplinaId: 3, tareaMaestraId: 8, activo: true },  // Pañete
          { id: 6, proyectoId: 1, proyectoDisciplinaId: 3, tareaMaestraId: 10, activo: true }, // Pintura Interior
          // En producción habrá ~23 tareas por proyecto
        ];

        // Subtareas instanciadas en proyectos (ejemplos - con control de subutilización heredado)
        const INITIAL_PROYECTO_SUBTAREAS = [
          // Proyecto 1 - Excavación
          {
            id: 1,
            proyectoId: 1,
            proyectoTareaId: 1,
            subtareaMaestraId: 1,  // Replanteo
            activo: true,
            // Hereda de maestra:
            tiposTrabajadorPermitidos: [2, 3, 4, 5],
            tipoTrabajadorOptimo: 2,
            // Sin override (usa valores heredados)
            tiposTrabajadorPermitidosCustom: null,
            tipoTrabajadorOptimoCustom: null
          },
          {
            id: 2,
            proyectoId: 1,
            proyectoTareaId: 1,
            subtareaMaestraId: 2,  // Excavación Mecánica
            activo: true,
            tiposTrabajadorPermitidos: [2, 3, 4, 5],
            tipoTrabajadorOptimo: 2,
            tiposTrabajadorPermitidosCustom: null,
            tipoTrabajadorOptimoCustom: null
          },
          {
            id: 3,
            proyectoId: 1,
            proyectoTareaId: 1,
            subtareaMaestraId: 3,  // Retiro de Material
            activo: true,
            tiposTrabajadorPermitidos: [1, 2, 3, 4, 5],
            tipoTrabajadorOptimo: 1,
            // EJEMPLO DE OVERRIDE - Cliente personalizó esta subtarea
            tiposTrabajadorPermitidosCustom: [2, 3],  // Solo Ayudante u Oficial (obra de lujo)
            tipoTrabajadorOptimoCustom: 2  // Ayudante es óptimo
          },
          // Proyecto 1 - Cimentación
          {
            id: 4,
            proyectoId: 1,
            proyectoTareaId: 2,
            subtareaMaestraId: 4,  // Armado de Acero
            activo: true,
            tiposTrabajadorPermitidos: [3, 4, 5],
            tipoTrabajadorOptimo: 3,
            tiposTrabajadorPermitidosCustom: null,
            tipoTrabajadorOptimoCustom: null
          },
          // En producción habrá ~30 subtareas por proyecto
        ];

        // ⭐ NUEVO v1.6.1 - Asignación de Trabajadores a Proyectos
        const INITIAL_PROYECTO_TRABAJADORES = [
          // Proyecto 1 tiene 3 trabajadores asignados
          { id: 1, proyectoId: 1, trabajadorId: 1, activo: true },
          { id: 2, proyectoId: 1, trabajadorId: 2, activo: true },
          { id: 3, proyectoId: 1, trabajadorId: 3, activo: true }
        ];


        const ESTADOS_PROYECTO = [
          'En Planificación',
          'En Ejecución',
          'Pausado',
          'Completado',
          'Cancelado'
        ];

        const INITIAL_TIPOS_TRABAJADOR = [
          {
            id: 1,
            nombre: 'Peón',
            nivel: 1,  // ⭐ NUEVO
            fijo: false,
            descripcion: 'Trabajador no calificado, labores generales',
            tarifaHoraPorDefecto: 7000
          },
          {
            id: 2,
            nombre: 'Ayudante',
            nivel: 2,  // ⭐ NUEVO
            fijo: false,
            descripcion: 'Asistente de obra',
            tarifaHoraPorDefecto: 8500
          },
          {
            id: 3,
            nombre: 'Oficial',
            nivel: 3,  // ⭐ NUEVO
            fijo: false,
            descripcion: 'Trabajador calificado',
            tarifaHoraPorDefecto: 15000
          },
          {
            id: 4,
            nombre: 'Maestro',
            nivel: 4,  // ⭐ NUEVO
            fijo: false,
            descripcion: 'Trabajador experto',
            tarifaHoraPorDefecto: 18000
          },
          {
            id: 5,
            nombre: 'Supervisor',
            nivel: 5,  // ⭐ NUEVO
            fijo: true,
            descripcion: 'Supervisa y registra tiempo de trabajadores (requerido para App Móvil)',
            tarifaHoraPorDefecto: 20000
          }
        ];

        const INITIAL_TRABAJADORES = [
          {
            id: 1,
            nombre: 'Carlos Ramírez',
            documento: '1.234.567-8',
            tipoTrabajadorId: 2, // Oficial
            clienteId: 1,
            proyectoId: 1,
            proyectosAsignados: [1], // ⭐ Asignado a proyecto 1
            tarifaHora: 10000,
            telefono: '+57 300 111 2222',
            email: 'carlos.ramirez@email.com',
            activo: true,
            fechaIngreso: '2024-01-20'
          },
          {
            id: 2,
            nombre: 'Pedro González',
            documento: '2.345.678-9',
            tipoTrabajadorId: 1, // Supervisor
            clienteId: 1,
            proyectoId: 1,
            proyectosAsignados: [1], // ⭐ Asignado a proyecto 1
            tarifaHora: 15000,
            telefono: '+57 310 222 3333',
            email: 'pedro.gonzalez@email.com',
            activo: true,
            fechaIngreso: '2024-01-22'
          },
          {
            id: 3,
            nombre: 'María Torres',
            documento: '3.456.789-0',
            tipoTrabajadorId: 2, // Oficial
            clienteId: 1,
            proyectoId: 1,
            proyectosAsignados: [1], // ⭐ Asignado a proyecto 2
            tarifaHora: 10600,
            telefono: '+57 320 333 4444',
            email: 'maria.torres@email.com',
            activo: true,
            fechaIngreso: '2024-03-01'
          },
          {
            id: 4,
            nombre: 'José Martínez',
            documento: '4.567.890-1',
            tipoTrabajadorId: 4, // Maestro
            clienteId: 2,
            proyectoId: 3,
            proyectosAsignados: [3], // ⭐ Asignado a proyecto 3
            tarifaHora: 12500,
            telefono: '+57 315 444 5555',
            email: 'jose.martinez@email.com',
            activo: true,
            fechaIngreso: '2024-02-15'
          },
          {
            id: 5,
            nombre: 'Ana Rodríguez',
            documento: '5.678.901-2',
            tipoTrabajadorId: 3, // Ayudante
            clienteId: 2,
            proyectoId: 3,
            proyectosAsignados: [3], // ⭐ Asignado a proyecto 3
            tarifaHora: 7500,
            telefono: '+57 318 555 6666',
            email: 'ana.rodriguez@email.com',
            activo: true,
            fechaIngreso: '2024-02-18'
          },
          {
            id: 6,
            nombre: 'Luis Sánchez',
            documento: '6.789.012-3',
            tipoTrabajadorId: 2, // Oficial
            clienteId: 3,
            proyectoId: 5,
            proyectosAsignados: [5], // ⭐ Asignado a proyecto 5
            tarifaHora: 10600,
            telefono: '+57 312 666 7777',
            email: 'luis.sanchez@email.com',
            activo: true,
            fechaIngreso: '2023-11-01'
          },
          {
            id: 7,
            nombre: 'Jorge Fernández',
            documento: '7.890.123-4',
            tipoTrabajadorId: 3, // Ayudante
            clienteId: 1,
            proyectoId: 1,
            proyectosAsignados: [1], // ⭐ Asignado a proyecto 1
            tarifaHora: 7500,
            telefono: '+57 317 777 8888',
            email: 'jorge.fernandez@email.com',
            activo: true,
            fechaIngreso: '2024-01-25'
          },
          {
            id: 8,
            nombre: 'Patricia López',
            documento: '8.901.234-5',
            tipoTrabajadorId: 1, // Supervisor
            clienteId: 2,
            proyectoId: 4,
            proyectosAsignados: [4], // ⭐ Asignado a proyecto 4
            tarifaHora: 15000,
            telefono: '+57 314 888 9999',
            email: 'patricia.lopez@email.com',
            activo: true,
            fechaIngreso: '2024-04-01'
          }
        ];

        // ==================== DATOS INICIALES: CARGOS ====================
        
        const INITIAL_CARGOS = [
          { id: 1, nombre: 'Gerente de Proyecto', descripcion: 'Responsable de la gestión integral del proyecto' },
          { id: 2, nombre: 'Coordinador de Obra', descripcion: 'Coordina actividades en sitio' },
          { id: 3, nombre: 'Contador', descripcion: 'Gestión contable y financiera' },
          { id: 4, nombre: 'Recursos Humanos', descripcion: 'Gestión de personal y nómina' },
          { id: 5, nombre: 'Compras y Logística', descripcion: 'Adquisición de materiales y logística' }
        ];

        // ==================== DATOS INICIALES: DEPARTAMENTOS ====================
        
        const INITIAL_DEPARTAMENTOS = [
          { id: 1, nombre: 'Operaciones', descripcion: 'Ejecución y control de proyectos' },
          { id: 2, nombre: 'Administración', descripcion: 'Gestión administrativa y soporte' },
          { id: 3, nombre: 'Finanzas', descripcion: 'Control financiero y contabilidad' },
          { id: 4, nombre: 'Recursos Humanos', descripcion: 'Gestión de talento humano' }
        ];

        // ==================== DATOS INICIALES: PERSONAL/STAFF ====================
        
        const INITIAL_PERSONAL = [
          {
            id: 1,
            nombre: 'María González',
            documento: '10.123.456-7',
            cargoId: 1, // Gerente de Proyecto
            departamentoId: 1, // Operaciones
            clienteId: 1,
            proyectosAsignados: [1, 2],
            tipoContrato: 'Indefinido',
            salarioMensual: 5000000,
            fechaIngreso: '2024-01-15',
            telefono: '+57 300 111 2222',
            email: 'maria.gonzalez@empresa.com',
            activo: true
          },
          {
            id: 2,
            nombre: 'Juan Pérez Silva',
            documento: '10.234.567-8',
            cargoId: 2, // Coordinador de Obra
            departamentoId: 1, // Operaciones
            clienteId: 1,
            proyectosAsignados: [1],
            tipoContrato: 'Fijo',
            salarioMensual: 3500000,
            fechaIngreso: '2024-02-01',
            telefono: '+57 310 222 3333',
            email: 'juan.perez@empresa.com',
            activo: true
          },
          {
            id: 3,
            nombre: 'Ana María Rodríguez',
            documento: '10.345.678-9',
            cargoId: 3, // Contador
            departamentoId: 3, // Finanzas
            clienteId: 2,
            proyectosAsignados: [3, 4],
            tipoContrato: 'Indefinido',
            salarioMensual: 4000000,
            fechaIngreso: '2024-01-20',
            telefono: '+57 320 333 4444',
            email: 'ana.rodriguez@empresa.com',
            activo: true
          },
          {
            id: 4,
            nombre: 'Carlos Martínez López',
            documento: '10.456.789-0',
            cargoId: 4, // Recursos Humanos
            departamentoId: 4, // Recursos Humanos
            clienteId: 3,
            proyectosAsignados: [5, 6],
            tipoContrato: 'Indefinido',
            salarioMensual: 3800000,
            fechaIngreso: '2023-11-15',
            telefono: '+57 315 444 5555',
            email: 'carlos.martinez@empresa.com',
            activo: true
          },
          {
            id: 5,
            nombre: 'Laura Sánchez Torres',
            documento: '10.567.890-1',
            cargoId: 5, // Compras y Logística
            departamentoId: 2, // Administración
            clienteId: 1,
            proyectosAsignados: [1, 2],
            tipoContrato: 'Fijo',
            salarioMensual: 3200000,
            fechaIngreso: '2024-03-01',
            telefono: '+57 318 555 6666',
            email: 'laura.sanchez@empresa.com',
            activo: true
          }
        ];

        // ==================== PLANTILLAS MAESTRAS (Solo Admin) ====================
        
        // Disciplinas Maestras - Base común para todos los proyectos
        const INITIAL_DISCIPLINAS_MAESTRAS = [
          {
            id: 1,
            nombre: 'Estructuras',
            codigo: 'EST',
            descripcion: 'Obras de estructura, cimentación y concreto',
            color: '#3B82F6',
            orden: 1,
            activo: true,
            sistema: true
          },
          {
            id: 2,
            nombre: 'Mampostería',
            codigo: 'MAM',
            descripcion: 'Muros en ladrillo, bloque y mampostería',
            color: '#EF4444',
            orden: 2,
            activo: true,
            sistema: true
          },
          {
            id: 3,
            nombre: 'Acabados',
            codigo: 'ACA',
            descripcion: 'Pañetes, estucos, pintura y acabados finales',
            color: '#10B981',
            orden: 3,
            activo: true,
            sistema: true
          },
          {
            id: 4,
            nombre: 'Instalaciones Eléctricas',
            codigo: 'IEL',
            descripcion: 'Instalaciones eléctricas, iluminación y fuerza',
            color: '#F59E0B',
            orden: 4,
            activo: true,
            sistema: true
          },
          {
            id: 5,
            nombre: 'Instalaciones Hidráulicas',
            codigo: 'IHI',
            descripcion: 'Instalaciones hidráulicas y sanitarias',
            color: '#06B6D4',
            orden: 5,
            activo: true,
            sistema: true
          },
          {
            id: 6,
            nombre: 'Carpintería',
            codigo: 'CAR',
            descripcion: 'Carpintería de madera y metálica',
            color: '#8B4513',
            orden: 6,
            activo: true,
            sistema: true
          }
        ];

        // Tareas Maestras - Base común por disciplina
        const INITIAL_TAREAS_MAESTRAS = [
          // Estructuras
          {
            id: 1,
            disciplinaMaestraId: 1,
            nombre: 'Excavación y Movimiento de Tierras',
            codigo: 'EST-001',
            descripcion: 'Excavación mecánica y manual para cimentación',
            unidadMedida: 'm³',
            rendimientoBase: 8.5,
            orden: 1,
            activo: true,
            sistema: true
          },
          {
            id: 2,
            disciplinaMaestraId: 1,
            nombre: 'Cimentación y Zapatas',
            codigo: 'EST-002',
            descripcion: 'Armado y fundición de zapatas y vigas de cimentación',
            unidadMedida: 'm³',
            rendimientoBase: 3.2,
            orden: 2,
            activo: true,
            sistema: true
          },
          {
            id: 3,
            disciplinaMaestraId: 1,
            nombre: 'Columnas',
            codigo: 'EST-003',
            descripcion: 'Armado, encofrado y fundición de columnas',
            unidadMedida: 'm³',
            rendimientoBase: 2.8,
            orden: 3,
            activo: true,
            sistema: true
          },
          {
            id: 4,
            disciplinaMaestraId: 1,
            nombre: 'Vigas',
            codigo: 'EST-004',
            descripcion: 'Armado, encofrado y fundición de vigas',
            unidadMedida: 'm³',
            rendimientoBase: 3.0,
            orden: 4,
            activo: true,
            sistema: true
          },
          {
            id: 5,
            disciplinaMaestraId: 1,
            nombre: 'Placas de Entrepiso',
            codigo: 'EST-005',
            descripcion: 'Armado, encofrado y fundición de placas',
            unidadMedida: 'm²',
            rendimientoBase: 12.0,
            orden: 5,
            activo: true,
            sistema: true
          },
          // Mampostería
          {
            id: 6,
            disciplinaMaestraId: 2,
            nombre: 'Muros en Ladrillo',
            codigo: 'MAM-001',
            descripcion: 'Levante de muros en ladrillo prensado',
            unidadMedida: 'm²',
            rendimientoBase: 8.0,
            orden: 1,
            activo: true,
            sistema: true
          },
          {
            id: 7,
            disciplinaMaestraId: 2,
            nombre: 'Muros en Bloque',
            codigo: 'MAM-002',
            descripcion: 'Levante de muros en bloque de concreto',
            unidadMedida: 'm²',
            rendimientoBase: 10.0,
            orden: 2,
            activo: true,
            sistema: true
          },
          // Acabados
          {
            id: 8,
            disciplinaMaestraId: 3,
            nombre: 'Pañete Liso',
            codigo: 'ACA-001',
            descripcion: 'Pañete liso en muros interiores y exteriores',
            unidadMedida: 'm²',
            rendimientoBase: 15.0,
            orden: 1,
            activo: true,
            sistema: true
          },
          {
            id: 9,
            disciplinaMaestraId: 3,
            nombre: 'Estuco',
            codigo: 'ACA-002',
            descripcion: 'Aplicación de estuco sobre pañete',
            unidadMedida: 'm²',
            rendimientoBase: 20.0,
            orden: 2,
            activo: true,
            sistema: true
          },
          {
            id: 10,
            disciplinaMaestraId: 3,
            nombre: 'Pintura Interior',
            codigo: 'ACA-003',
            descripcion: 'Pintura vinílica en muros interiores',
            unidadMedida: 'm²',
            rendimientoBase: 25.0,
            orden: 3,
            activo: true,
            sistema: true
          },
          {
            id: 11,
            disciplinaMaestraId: 3,
            nombre: 'Pintura Exterior',
            codigo: 'ACA-004',
            descripcion: 'Pintura elastomérica en fachadas',
            unidadMedida: 'm²',
            rendimientoBase: 18.0,
            orden: 4,
            activo: true,
            sistema: true
          },
          {
            id: 12,
            disciplinaMaestraId: 3,
            nombre: 'Enchape Cerámico',
            codigo: 'ACA-005',
            descripcion: 'Instalación de enchape cerámico en pisos y muros',
            unidadMedida: 'm²',
            rendimientoBase: 6.5,
            orden: 5,
            activo: true,
            sistema: true
          },
          // Instalaciones Eléctricas
          {
            id: 13,
            disciplinaMaestraId: 4,
            nombre: 'Tubería Eléctrica',
            codigo: 'IEL-001',
            descripcion: 'Instalación de tubería conduit empotrada',
            unidadMedida: 'm',
            rendimientoBase: 25.0,
            orden: 1,
            activo: true,
            sistema: true
          },
          {
            id: 14,
            disciplinaMaestraId: 4,
            nombre: 'Cableado',
            codigo: 'IEL-002',
            descripcion: 'Instalación de cable eléctrico',
            unidadMedida: 'm',
            rendimientoBase: 40.0,
            orden: 2,
            activo: true,
            sistema: true
          },
          {
            id: 15,
            disciplinaMaestraId: 4,
            nombre: 'Salidas e Interruptores',
            codigo: 'IEL-003',
            descripcion: 'Instalación de tomas e interruptores',
            unidadMedida: 'und',
            rendimientoBase: 12.0,
            orden: 3,
            activo: true,
            sistema: true
          },
          {
            id: 16,
            disciplinaMaestraId: 4,
            nombre: 'Tablero Eléctrico',
            codigo: 'IEL-004',
            descripcion: 'Instalación y conexión de tablero eléctrico',
            unidadMedida: 'und',
            rendimientoBase: 1.0,
            orden: 4,
            activo: true,
            sistema: true
          },
          // Instalaciones Hidráulicas
          {
            id: 17,
            disciplinaMaestraId: 5,
            nombre: 'Tubería Agua Fría',
            codigo: 'IHI-001',
            descripcion: 'Instalación de tubería PVC agua fría',
            unidadMedida: 'm',
            rendimientoBase: 15.0,
            orden: 1,
            activo: true,
            sistema: true
          },
          {
            id: 18,
            disciplinaMaestraId: 5,
            nombre: 'Tubería Agua Caliente',
            codigo: 'IHI-002',
            descripcion: 'Instalación de tubería CPVC agua caliente',
            unidadMedida: 'm',
            rendimientoBase: 12.0,
            orden: 2,
            activo: true,
            sistema: true
          },
          {
            id: 19,
            disciplinaMaestraId: 5,
            nombre: 'Desagües',
            codigo: 'IHI-003',
            descripcion: 'Instalación de tubería PVC sanitaria',
            unidadMedida: 'm',
            rendimientoBase: 10.0,
            orden: 3,
            activo: true,
            sistema: true
          },
          {
            id: 20,
            disciplinaMaestraId: 5,
            nombre: 'Aparatos Sanitarios',
            codigo: 'IHI-004',
            descripcion: 'Instalación de aparatos sanitarios',
            unidadMedida: 'und',
            rendimientoBase: 2.0,
            orden: 4,
            activo: true,
            sistema: true
          },
          // Carpintería
          {
            id: 21,
            disciplinaMaestraId: 6,
            nombre: 'Puertas en Madera',
            codigo: 'CAR-001',
            descripcion: 'Suministro e instalación de puertas en madera',
            unidadMedida: 'und',
            rendimientoBase: 2.0,
            orden: 1,
            activo: true,
            sistema: true
          },
          {
            id: 22,
            disciplinaMaestraId: 6,
            nombre: 'Ventanas en Aluminio',
            codigo: 'CAR-002',
            descripcion: 'Suministro e instalación de ventanería aluminio',
            unidadMedida: 'm²',
            rendimientoBase: 3.5,
            orden: 2,
            activo: true,
            sistema: true
          },
          {
            id: 23,
            disciplinaMaestraId: 6,
            nombre: 'Closets',
            codigo: 'CAR-003',
            descripcion: 'Fabricación e instalación de closets',
            unidadMedida: 'm',
            rendimientoBase: 1.5,
            orden: 3,
            activo: true,
            sistema: true
          }
        ];

        // Subtareas Maestras - Desglose detallado de tareas
        const INITIAL_SUBTAREAS_MAESTRAS = [
          // Excavación (Tarea 1)
          {
            id: 1,
            tareaMaestraId: 1,
            nombre: 'Replanteo y Trazado',
            codigo: 'EST-001-01',
            descripcion: 'Replanteo de ejes y niveles',
            tiposTrabajadorPermitidos: [2, 3, 4, 5],  // Ayudante, Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 2,  // Ayudante
            orden: 1,
            activo: true
          },
          {
            id: 2,
            tareaMaestraId: 1,
            nombre: 'Excavación Mecánica',
            codigo: 'EST-001-02',
            descripcion: 'Excavación con retroexcavadora',
            tiposTrabajadorPermitidos: [2, 3, 4, 5],  // Ayudante, Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 2,  // Ayudante
            orden: 2,
            activo: true
          },
          {
            id: 3,
            tareaMaestraId: 1,
            nombre: 'Retiro de Material',
            codigo: 'EST-001-03',
            descripcion: 'Cargue y transporte de material excavado',
            tiposTrabajadorPermitidos: [1, 2, 3, 4, 5],  // Todos
            tipoTrabajadorOptimo: 1,  // Peón
            orden: 3,
            activo: true
          },
          // Cimentación (Tarea 2)
          {
            id: 4,
            tareaMaestraId: 2,
            nombre: 'Armado de Acero',
            codigo: 'EST-002-01',
            descripcion: 'Armado y amarre de acero de refuerzo',
            tiposTrabajadorPermitidos: [3, 4, 5],  // Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 3,  // Oficial
            orden: 1,
            activo: true
          },
          {
            id: 5,
            tareaMaestraId: 2,
            nombre: 'Encofrado',
            codigo: 'EST-002-02',
            descripcion: 'Instalación de formaleta',
            tiposTrabajadorPermitidos: [3, 4, 5],  // Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 3,  // Oficial
            orden: 2,
            activo: true
          },
          {
            id: 6,
            tareaMaestraId: 2,
            nombre: 'Fundición',
            codigo: 'EST-002-03',
            descripcion: 'Vaciado de concreto',
            tiposTrabajadorPermitidos: [3, 4, 5],  // Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 3,  // Oficial
            orden: 3,
            activo: true
          },
          {
            id: 7,
            tareaMaestraId: 2,
            nombre: 'Desencofrado',
            codigo: 'EST-002-04',
            descripcion: 'Retiro de formaleta',
            tiposTrabajadorPermitidos: [2, 3, 4, 5],  // Ayudante, Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 2,  // Ayudante
            orden: 4,
            activo: true
          },
          // Columnas (Tarea 3)
          {
            id: 8,
            tareaMaestraId: 3,
            nombre: 'Armado de Acero',
            codigo: 'EST-003-01',
            descripcion: 'Armado de hierro para columnas',
            tiposTrabajadorPermitidos: [3, 4, 5],  // Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 3,  // Oficial
            orden: 1,
            activo: true
          },
          {
            id: 9,
            tareaMaestraId: 3,
            nombre: 'Encofrado',
            codigo: 'EST-003-02',
            descripcion: 'Instalación de formaleta en columnas',
            tiposTrabajadorPermitidos: [3, 4, 5],  // Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 3,  // Oficial
            orden: 2,
            activo: true
          },
          {
            id: 10,
            tareaMaestraId: 3,
            nombre: 'Fundición',
            codigo: 'EST-003-03',
            descripcion: 'Vaciado de concreto en columnas',
            tiposTrabajadorPermitidos: [3, 4, 5],  // Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 3,  // Oficial
            orden: 3,
            activo: true
          },
          {
            id: 11,
            tareaMaestraId: 3,
            nombre: 'Desencofrado',
            codigo: 'EST-003-04',
            descripcion: 'Retiro de formaleta',
            tiposTrabajadorPermitidos: [2, 3, 4, 5],  // Ayudante, Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 2,  // Ayudante
            orden: 4,
            activo: true
          },
          // Muros en Ladrillo (Tarea 6)
          {
            id: 12,
            tareaMaestraId: 6,
            nombre: 'Replanteo',
            codigo: 'MAM-001-01',
            descripcion: 'Replanteo de muros en placa',
            tiposTrabajadorPermitidos: [2, 3, 4, 5],  // Ayudante, Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 2,  // Ayudante
            orden: 1,
            activo: true
          },
          {
            id: 13,
            tareaMaestraId: 6,
            nombre: 'Pega de Ladrillo',
            codigo: 'MAM-001-02',
            descripcion: 'Levante de muro con mortero',
            tiposTrabajadorPermitidos: [3, 4, 5],  // Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 3,  // Oficial
            orden: 2,
            activo: true
          },
          {
            id: 14,
            tareaMaestraId: 6,
            nombre: 'Dinteles',
            codigo: 'MAM-001-03',
            descripcion: 'Fundición de dinteles en vanos',
            tiposTrabajadorPermitidos: [3, 4, 5],  // Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 3,  // Oficial
            orden: 3,
            activo: true
          },
          // Pañete (Tarea 8)
          {
            id: 15,
            tareaMaestraId: 8,
            nombre: 'Maestras',
            codigo: 'ACA-001-01',
            descripcion: 'Colocación de maestras verticales',
            tiposTrabajadorPermitidos: [2, 3, 4, 5],  // Ayudante, Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 2,  // Ayudante
            orden: 1,
            activo: true
          },
          {
            id: 16,
            tareaMaestraId: 8,
            nombre: 'Salpicado',
            codigo: 'ACA-001-02',
            descripcion: 'Primera capa de mortero',
            tiposTrabajadorPermitidos: [2, 3, 4, 5],  // Ayudante, Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 2,  // Ayudante
            orden: 2,
            activo: true
          },
          {
            id: 17,
            tareaMaestraId: 8,
            nombre: 'Afinado',
            codigo: 'ACA-001-03',
            descripcion: 'Segunda capa y alisado',
            tiposTrabajadorPermitidos: [3, 4, 5],  // Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 3,  // Oficial
            orden: 3,
            activo: true
          },
          // Pintura Interior (Tarea 10)
          {
            id: 18,
            tareaMaestraId: 10,
            nombre: 'Resane',
            codigo: 'ACA-003-01',
            descripcion: 'Resane de imperfecciones',
            tiposTrabajadorPermitidos: [2, 3, 4, 5],  // Ayudante, Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 2,  // Ayudante
            orden: 1,
            activo: true
          },
          {
            id: 19,
            tareaMaestraId: 10,
            nombre: 'Imprimante',
            codigo: 'ACA-003-02',
            descripcion: 'Aplicación de sellador',
            tiposTrabajadorPermitidos: [2, 3, 4, 5],  // Ayudante, Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 2,  // Ayudante
            orden: 2,
            activo: true
          },
          {
            id: 20,
            tareaMaestraId: 10,
            nombre: 'Primera Mano',
            codigo: 'ACA-003-03',
            descripcion: 'Primera capa de pintura',
            tiposTrabajadorPermitidos: [3, 4, 5],  // Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 3,  // Oficial
            orden: 3,
            activo: true
          },
          {
            id: 21,
            tareaMaestraId: 10,
            nombre: 'Segunda Mano',
            codigo: 'ACA-003-04',
            descripcion: 'Segunda capa de pintura',
            tiposTrabajadorPermitidos: [3, 4, 5],  // Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 3,  // Oficial
            orden: 4,
            activo: true
          },
          // Enchape (Tarea 12)
          {
            id: 22,
            tareaMaestraId: 12,
            nombre: 'Preparación de Superficie',
            codigo: 'ACA-005-01',
            descripcion: 'Limpieza y nivelación',
            tiposTrabajadorPermitidos: [1, 2, 3, 4, 5],  // Todos
            tipoTrabajadorOptimo: 1,  // Peón
            orden: 1,
            activo: true
          },
          {
            id: 23,
            tareaMaestraId: 12,
            nombre: 'Pega de Cerámica',
            codigo: 'ACA-005-02',
            descripcion: 'Instalación de baldosas',
            tiposTrabajadorPermitidos: [3, 4, 5],  // Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 3,  // Oficial
            orden: 2,
            activo: true
          },
          {
            id: 24,
            tareaMaestraId: 12,
            nombre: 'Emboquillado',
            codigo: 'ACA-005-03',
            descripcion: 'Aplicación de boquilla',
            tiposTrabajadorPermitidos: [2, 3, 4, 5],  // Ayudante, Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 2,  // Ayudante
            orden: 3,
            activo: true
          },
          // Tubería Eléctrica (Tarea 13)
          {
            id: 25,
            tareaMaestraId: 13,
            nombre: 'Trazado',
            codigo: 'IEL-001-01',
            descripcion: 'Marcado de recorridos',
            tiposTrabajadorPermitidos: [2, 3, 4, 5],  // Ayudante, Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 2,  // Ayudante
            orden: 1,
            activo: true
          },
          {
            id: 26,
            tareaMaestraId: 13,
            nombre: 'Ranurado',
            codigo: 'IEL-001-02',
            descripcion: 'Regatas en muros',
            tiposTrabajadorPermitidos: [2, 3, 4, 5],  // Ayudante, Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 2,  // Ayudante
            orden: 2,
            activo: true
          },
          {
            id: 27,
            tareaMaestraId: 13,
            nombre: 'Instalación de Tubería',
            codigo: 'IEL-001-03',
            descripcion: 'Colocación de conduit',
            tiposTrabajadorPermitidos: [3, 4, 5],  // Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 3,  // Oficial
            orden: 3,
            activo: true
          },
          // Desagües (Tarea 19)
          {
            id: 28,
            tareaMaestraId: 19,
            nombre: 'Trazado',
            codigo: 'IHI-003-01',
            descripcion: 'Replanteo de bajantes',
            tiposTrabajadorPermitidos: [2, 3, 4, 5],  // Ayudante, Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 2,  // Ayudante
            orden: 1,
            activo: true
          },
          {
            id: 29,
            tareaMaestraId: 19,
            nombre: 'Instalación de Tubería',
            codigo: 'IHI-003-02',
            descripcion: 'Colocación de PVC sanitario',
            tiposTrabajadorPermitidos: [3, 4, 5],  // Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 3,  // Oficial
            orden: 2,
            activo: true
          },
          {
            id: 30,
            tareaMaestraId: 19,
            nombre: 'Pruebas',
            codigo: 'IHI-003-03',
            descripcion: 'Prueba hidrostática',
            tiposTrabajadorPermitidos: [3, 4, 5],  // Oficial, Maestro, Supervisor
            tipoTrabajadorOptimo: 3,  // Oficial
            orden: 3,
            activo: true
          }
        ];

        // ==================== UTILIDADES DE LOCALSTORAGE ====================
        
        const STORAGE_KEYS = {
          CLIENTES: 'teraconta_clientes',
          PROYECTOS: 'teraconta_proyectos',
          TRABAJADORES: 'teraconta_trabajadores',
          TIPOS_TRABAJADOR: 'teraconta_tipos_trabajador',
          PERSONAL: 'teraconta_personal',
          CARGOS: 'teraconta_cargos',
          DEPARTAMENTOS: 'teraconta_departamentos',
          DISCIPLINAS_MAESTRAS: 'teraconta_disciplinas_maestras',
          TAREAS_MAESTRAS: 'teraconta_tareas_maestras',
          SUBTAREAS_MAESTRAS: 'teraconta_subtareas_maestras',
          // ⭐ NUEVO v1.6.0
          LOCALIZACION_CONFIG: 'teraconta_localizacion_config',
          UBICACIONES: 'teraconta_ubicaciones',
          PROYECTO_DISCIPLINAS: 'teraconta_proyecto_disciplinas',
          PROYECTO_TAREAS: 'teraconta_proyecto_tareas',
          PROYECTO_SUBTAREAS: 'teraconta_proyecto_subtareas',
          // ⭐ NUEVO v1.6.1
          PROYECTO_TRABAJADORES: 'teraconta_proyecto_trabajadores'
        };

        const StorageUtils = {
          getClientes: () => {
            try {
              const stored = localStorage.getItem(STORAGE_KEYS.CLIENTES);
              return stored ? JSON.parse(stored) : INITIAL_CLIENTES;
            } catch (error) {
              console.error('Error loading clientes:', error);
              return INITIAL_CLIENTES;
            }
          },

          getProyectos: () => {
            try {
              const stored = localStorage.getItem(STORAGE_KEYS.PROYECTOS);
              return stored ? JSON.parse(stored) : INITIAL_PROYECTOS;
            } catch (error) {
              console.error('Error loading proyectos:', error);
              return INITIAL_PROYECTOS;
            }
          },

          getTrabajadores: () => {
            try {
              const stored = localStorage.getItem(STORAGE_KEYS.TRABAJADORES);
              return stored ? JSON.parse(stored) : INITIAL_TRABAJADORES;
            } catch (error) {
              console.error('Error loading trabajadores:', error);
              return INITIAL_TRABAJADORES;
            }
          },

          getTiposTrabajador: () => {
            try {
              const stored = localStorage.getItem(STORAGE_KEYS.TIPOS_TRABAJADOR);
              return stored ? JSON.parse(stored) : INITIAL_TIPOS_TRABAJADOR;
            } catch (error) {
              console.error('Error loading tipos trabajador:', error);
              return INITIAL_TIPOS_TRABAJADOR;
            }
          },

          getPersonal: () => {
            try {
              const stored = localStorage.getItem(STORAGE_KEYS.PERSONAL);
              return stored ? JSON.parse(stored) : INITIAL_PERSONAL;
            } catch (error) {
              console.error('Error loading personal:', error);
              return INITIAL_PERSONAL;
            }
          },

          getCargos: () => {
            try {
              const stored = localStorage.getItem(STORAGE_KEYS.CARGOS);
              return stored ? JSON.parse(stored) : INITIAL_CARGOS;
            } catch (error) {
              console.error('Error loading cargos:', error);
              return INITIAL_CARGOS;
            }
          },

          getDepartamentos: () => {
            try {
              const stored = localStorage.getItem(STORAGE_KEYS.DEPARTAMENTOS);
              return stored ? JSON.parse(stored) : INITIAL_DEPARTAMENTOS;
            } catch (error) {
              console.error('Error loading departamentos:', error);
              return INITIAL_DEPARTAMENTOS;
            }
          },

          getDisciplinasMaestras: () => {
            try {
              const stored = localStorage.getItem(STORAGE_KEYS.DISCIPLINAS_MAESTRAS);
              return stored ? JSON.parse(stored) : INITIAL_DISCIPLINAS_MAESTRAS;
            } catch (error) {
              console.error('Error loading disciplinas maestras:', error);
              return INITIAL_DISCIPLINAS_MAESTRAS;
            }
          },

          getTareasMaestras: () => {
            try {
              const stored = localStorage.getItem(STORAGE_KEYS.TAREAS_MAESTRAS);
              return stored ? JSON.parse(stored) : INITIAL_TAREAS_MAESTRAS;
            } catch (error) {
              console.error('Error loading tareas maestras:', error);
              return INITIAL_TAREAS_MAESTRAS;
            }
          },

          getSubtareasMaestras: () => {
            try {
              const stored = localStorage.getItem(STORAGE_KEYS.SUBTAREAS_MAESTRAS);
              return stored ? JSON.parse(stored) : INITIAL_SUBTAREAS_MAESTRAS;
            } catch (error) {
              console.error('Error loading subtareas maestras:', error);
              return INITIAL_SUBTAREAS_MAESTRAS;
            }
          },

          // ⭐ NUEVO v1.6.0 - Getters para instanciación y localización
          getLocalizacionConfig: () => {
            try {
              const stored = localStorage.getItem(STORAGE_KEYS.LOCALIZACION_CONFIG);
              return stored ? JSON.parse(stored) : INITIAL_LOCALIZACION_CONFIG;
            } catch (error) {
              console.error('Error loading localizacion config:', error);
              return INITIAL_LOCALIZACION_CONFIG;
            }
          },

          getUbicaciones: () => {
            try {
              const stored = localStorage.getItem(STORAGE_KEYS.UBICACIONES);
              return stored ? JSON.parse(stored) : INITIAL_UBICACIONES;
            } catch (error) {
              console.error('Error loading ubicaciones:', error);
              return INITIAL_UBICACIONES;
            }
          },

          getProyectoDisciplinas: () => {
            try {
              const stored = localStorage.getItem(STORAGE_KEYS.PROYECTO_DISCIPLINAS);
              return stored ? JSON.parse(stored) : INITIAL_PROYECTO_DISCIPLINAS;
            } catch (error) {
              console.error('Error loading proyecto disciplinas:', error);
              return INITIAL_PROYECTO_DISCIPLINAS;
            }
          },

          getProyectoTareas: () => {
            try {
              const stored = localStorage.getItem(STORAGE_KEYS.PROYECTO_TAREAS);
              return stored ? JSON.parse(stored) : INITIAL_PROYECTO_TAREAS;
            } catch (error) {
              console.error('Error loading proyecto tareas:', error);
              return INITIAL_PROYECTO_TAREAS;
            }
          },

          getProyectoSubtareas: () => {
            try {
              const stored = localStorage.getItem(STORAGE_KEYS.PROYECTO_SUBTAREAS);
              return stored ? JSON.parse(stored) : INITIAL_PROYECTO_SUBTAREAS;
            } catch (error) {
              console.error('Error loading proyecto subtareas:', error);
              return INITIAL_PROYECTO_SUBTAREAS;
            }
          },

          saveClientes: (clientes) => {
            try {
              localStorage.setItem(STORAGE_KEYS.CLIENTES, JSON.stringify(clientes));
              return true;
            } catch (error) {
              console.error('Error saving clientes:', error);
              return false;
            }
          },

          saveProyectos: (proyectos) => {
            try {
              localStorage.setItem(STORAGE_KEYS.PROYECTOS, JSON.stringify(proyectos));
              return true;
            } catch (error) {
              console.error('Error saving proyectos:', error);
              return false;
            }
          },

          saveTrabajadores: (trabajadores) => {
            try {
              localStorage.setItem(STORAGE_KEYS.TRABAJADORES, JSON.stringify(trabajadores));
              return true;
            } catch (error) {
              console.error('Error saving trabajadores:', error);
              return false;
            }
          },

          saveTiposTrabajador: (tipos) => {
            try {
              localStorage.setItem(STORAGE_KEYS.TIPOS_TRABAJADOR, JSON.stringify(tipos));
              return true;
            } catch (error) {
              console.error('Error saving tipos trabajador:', error);
              return false;
            }
          },

          savePersonal: (personal) => {
            try {
              localStorage.setItem(STORAGE_KEYS.PERSONAL, JSON.stringify(personal));
              return true;
            } catch (error) {
              console.error('Error saving personal:', error);
              return false;
            }
          },

          saveCargos: (cargos) => {
            try {
              localStorage.setItem(STORAGE_KEYS.CARGOS, JSON.stringify(cargos));
              return true;
            } catch (error) {
              console.error('Error saving cargos:', error);
              return false;
            }
          },

          saveDepartamentos: (departamentos) => {
            try {
              localStorage.setItem(STORAGE_KEYS.DEPARTAMENTOS, JSON.stringify(departamentos));
              return true;
            } catch (error) {
              console.error('Error saving departamentos:', error);
              return false;
            }
          },

          saveDisciplinasMaestras: (disciplinas) => {
            try {
              localStorage.setItem(STORAGE_KEYS.DISCIPLINAS_MAESTRAS, JSON.stringify(disciplinas));
              return true;
            } catch (error) {
              console.error('Error saving disciplinas maestras:', error);
              return false;
            }
          },

          saveTareasMaestras: (tareas) => {
            try {
              localStorage.setItem(STORAGE_KEYS.TAREAS_MAESTRAS, JSON.stringify(tareas));
              return true;
            } catch (error) {
              console.error('Error saving tareas maestras:', error);
              return false;
            }
          },

          saveSubtareasMaestras: (subtareas) => {
            try {
              localStorage.setItem(STORAGE_KEYS.SUBTAREAS_MAESTRAS, JSON.stringify(subtareas));
              return true;
            } catch (error) {
              console.error('Error saving subtareas maestras:', error);
              return false;
            }
          },

          // ⭐ NUEVO v1.6.0 - Savers para instanciación y localización
          saveLocalizacionConfig: (config) => {
            try {
              localStorage.setItem(STORAGE_KEYS.LOCALIZACION_CONFIG, JSON.stringify(config));
              return true;
            } catch (error) {
              console.error('Error saving localizacion config:', error);
              return false;
            }
          },

          saveUbicaciones: (ubicaciones) => {
            try {
              localStorage.setItem(STORAGE_KEYS.UBICACIONES, JSON.stringify(ubicaciones));
              return true;
            } catch (error) {
              console.error('Error saving ubicaciones:', error);
              return false;
            }
          },

          saveProyectoDisciplinas: (disciplinas) => {
            try {
              localStorage.setItem(STORAGE_KEYS.PROYECTO_DISCIPLINAS, JSON.stringify(disciplinas));
              return true;
            } catch (error) {
              console.error('Error saving proyecto disciplinas:', error);
              return false;
            }
          },

          saveProyectoTareas: (tareas) => {
            try {
              localStorage.setItem(STORAGE_KEYS.PROYECTO_TAREAS, JSON.stringify(tareas));
              return true;
            } catch (error) {
              console.error('Error saving proyecto tareas:', error);
              return false;
            }
          },

          saveProyectoSubtareas: (subtareas) => {
            try {
              localStorage.setItem(STORAGE_KEYS.PROYECTO_SUBTAREAS, JSON.stringify(subtareas));
              return true;
            } catch (error) {
              console.error('Error saving proyecto subtareas:', error);
              return false;
            }
          },
          
          // ⭐ NUEVO v1.6.1 - Asignación de Trabajadores
          getProyectoTrabajadores: () => {
            try {
              const stored = localStorage.getItem(STORAGE_KEYS.PROYECTO_TRABAJADORES);
              return stored ? JSON.parse(stored) : INITIAL_PROYECTO_TRABAJADORES;
            } catch (error) {
              console.error('Error loading proyecto trabajadores:', error);
              return INITIAL_PROYECTO_TRABAJADORES;
            }
          },
          
          saveProyectoTrabajadores: (trabajadores) => {
            try {
              localStorage.setItem(STORAGE_KEYS.PROYECTO_TRABAJADORES, JSON.stringify(trabajadores));
              return true;
            } catch (error) {
              console.error('Error saving proyecto trabajadores:', error);
              return false;
            }
          },

          resetData: () => {
            localStorage.setItem(STORAGE_KEYS.CLIENTES, JSON.stringify(INITIAL_CLIENTES));
            localStorage.setItem(STORAGE_KEYS.PROYECTOS, JSON.stringify(INITIAL_PROYECTOS));
            localStorage.setItem(STORAGE_KEYS.TRABAJADORES, JSON.stringify(INITIAL_TRABAJADORES));
            localStorage.setItem(STORAGE_KEYS.TIPOS_TRABAJADOR, JSON.stringify(INITIAL_TIPOS_TRABAJADOR));
            localStorage.setItem(STORAGE_KEYS.PERSONAL, JSON.stringify(INITIAL_PERSONAL));
            localStorage.setItem(STORAGE_KEYS.CARGOS, JSON.stringify(INITIAL_CARGOS));
            localStorage.setItem(STORAGE_KEYS.DEPARTAMENTOS, JSON.stringify(INITIAL_DEPARTAMENTOS));
            localStorage.setItem(STORAGE_KEYS.DISCIPLINAS_MAESTRAS, JSON.stringify(INITIAL_DISCIPLINAS_MAESTRAS));
            localStorage.setItem(STORAGE_KEYS.TAREAS_MAESTRAS, JSON.stringify(INITIAL_TAREAS_MAESTRAS));
            localStorage.setItem(STORAGE_KEYS.SUBTAREAS_MAESTRAS, JSON.stringify(INITIAL_SUBTAREAS_MAESTRAS));
            // ⭐ NUEVO v1.6.0
            localStorage.setItem(STORAGE_KEYS.LOCALIZACION_CONFIG, JSON.stringify(INITIAL_LOCALIZACION_CONFIG));
            localStorage.setItem(STORAGE_KEYS.UBICACIONES, JSON.stringify(INITIAL_UBICACIONES));
            localStorage.setItem(STORAGE_KEYS.PROYECTO_DISCIPLINAS, JSON.stringify(INITIAL_PROYECTO_DISCIPLINAS));
            localStorage.setItem(STORAGE_KEYS.PROYECTO_TAREAS, JSON.stringify(INITIAL_PROYECTO_TAREAS));
            localStorage.setItem(STORAGE_KEYS.PROYECTO_SUBTAREAS, JSON.stringify(INITIAL_PROYECTO_SUBTAREAS));
          }
        };

        // ==================== UTILIDADES ====================
        
        const formatCurrency = (value) => {
          return new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0
          }).format(value);
        };

        const formatDate = (dateString) => {
          const date = new Date(dateString);
          return date.toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' });
        };

        const getEstadoColor = (estado) => {
          const colors = {
            'En Planificación': 'bg-blue-100 text-blue-800',
            'En Ejecución': 'bg-green-100 text-green-800',
            'Pausado': 'bg-yellow-100 text-yellow-800',
            'Completado': 'bg-purple-100 text-purple-800',
            'Cancelado': 'bg-red-100 text-red-800'
          };
          return colors[estado] || 'bg-gray-100 text-gray-800';
        };

        // ==================== COMPONENTE PRINCIPAL ====================
        
        function TeracontaDualPanel() {
          const [userRole, setUserRole] = useState('admin');
          const [currentClienteId, setCurrentClienteId] = useState(1);
          const [showLogin, setShowLogin] = useState(true);
          
          // Cargar datos desde localStorage
          const [clientes, setClientes] = useState(() => StorageUtils.getClientes());
          const [proyectos, setProyectos] = useState(() => StorageUtils.getProyectos());
          const [trabajadores, setTrabajadores] = useState(() => StorageUtils.getTrabajadores());
          const [tiposTrabajador, setTiposTrabajador] = useState(() => StorageUtils.getTiposTrabajador());
          const [personal, setPersonal] = useState(() => StorageUtils.getPersonal());
          const [cargos, setCargos] = useState(() => StorageUtils.getCargos());
          const [departamentos, setDepartamentos] = useState(() => StorageUtils.getDepartamentos());
          const [disciplinasMaestras, setDisciplinasMaestras] = useState(() => StorageUtils.getDisciplinasMaestras());
          const [tareasMaestras, setTareasMaestras] = useState(() => StorageUtils.getTareasMaestras());
          const [subtareasMaestras, setSubtareasMaestras] = useState(() => StorageUtils.getSubtareasMaestras());
          
          // ⭐ NUEVO v1.6.0 - Instanciación y Localización
          const [localizacionConfig, setLocalizacionConfig] = useState(() => StorageUtils.getLocalizacionConfig());
          const [ubicaciones, setUbicaciones] = useState(() => StorageUtils.getUbicaciones());
          const [proyectoDisciplinas, setProyectoDisciplinas] = useState(() => StorageUtils.getProyectoDisciplinas());
          const [proyectoTareas, setProyectoTareas] = useState(() => StorageUtils.getProyectoTareas());
          const [proyectoSubtareas, setProyectoSubtareas] = useState(() => StorageUtils.getProyectoSubtareas());
          
          // ⭐ NUEVO v1.6.1 - Asignación de Trabajadores a Proyecto
          const [proyectoTrabajadores, setProyectoTrabajadores] = useState(() => StorageUtils.getProyectoTrabajadores());

          // Guardar clientes cuando cambien
          useEffect(() => {
            StorageUtils.saveClientes(clientes);
          }, [clientes]);

          // Guardar proyectos cuando cambien
          useEffect(() => {
            StorageUtils.saveProyectos(proyectos);
          }, [proyectos]);

          // Guardar trabajadores cuando cambien
          useEffect(() => {
            StorageUtils.saveTrabajadores(trabajadores);
          }, [trabajadores]);

          // Guardar tipos trabajador cuando cambien
          useEffect(() => {
            StorageUtils.saveTiposTrabajador(tiposTrabajador);
          }, [tiposTrabajador]);

          // Guardar personal cuando cambien
          useEffect(() => {
            StorageUtils.savePersonal(personal);
          }, [personal]);

          // Guardar cargos cuando cambien
          useEffect(() => {
            StorageUtils.saveCargos(cargos);
          }, [cargos]);

          // Guardar departamentos cuando cambien
          useEffect(() => {
            StorageUtils.saveDepartamentos(departamentos);
          }, [departamentos]);

          // Guardar disciplinas maestras cuando cambien
          useEffect(() => {
            StorageUtils.saveDisciplinasMaestras(disciplinasMaestras);
          }, [disciplinasMaestras]);

          // Guardar tareas maestras cuando cambien
          useEffect(() => {
            StorageUtils.saveTareasMaestras(tareasMaestras);
          }, [tareasMaestras]);

          // Guardar subtareas maestras cuando cambien
          useEffect(() => {
            StorageUtils.saveSubtareasMaestras(subtareasMaestras);
          }, [subtareasMaestras]);

          // ⭐ NUEVO v1.6.0 - Guardar instanciación y localización
          useEffect(() => {
            StorageUtils.saveLocalizacionConfig(localizacionConfig);
          }, [localizacionConfig]);

          useEffect(() => {
            StorageUtils.saveUbicaciones(ubicaciones);
          }, [ubicaciones]);

          useEffect(() => {
            StorageUtils.saveProyectoDisciplinas(proyectoDisciplinas);
          }, [proyectoDisciplinas]);

          useEffect(() => {
            StorageUtils.saveProyectoTareas(proyectoTareas);
          }, [proyectoTareas]);

          useEffect(() => {
            StorageUtils.saveProyectoSubtareas(proyectoSubtareas);
          }, [proyectoSubtareas]);
          
          // ⭐ NUEVO v1.6.1 - Guardar asignaciones de trabajadores
          useEffect(() => {
            StorageUtils.saveProyectoTrabajadores(proyectoTrabajadores);
          }, [proyectoTrabajadores]);

          const handleLogin = (role, clienteId = null) => {
            setUserRole(role);
            if (role === 'cliente' && clienteId) {
              setCurrentClienteId(clienteId);
            }
            setShowLogin(false);
          };

          if (showLogin) {
            return <LoginScreen onLogin={handleLogin} clientes={clientes} />;
          }

          return (
            <MainPanel 
              userRole={userRole}
              currentClienteId={currentClienteId}
              clientes={clientes}
              setClientes={setClientes}
              proyectos={proyectos}
              setProyectos={setProyectos}
              trabajadores={trabajadores}
              setTrabajadores={setTrabajadores}
              tiposTrabajador={tiposTrabajador}
              setTiposTrabajador={setTiposTrabajador}
              personal={personal}
              setPersonal={setPersonal}
              cargos={cargos}
              setCargos={setCargos}
              departamentos={departamentos}
              setDepartamentos={setDepartamentos}
              disciplinasMaestras={disciplinasMaestras}
              setDisciplinasMaestras={setDisciplinasMaestras}
              tareasMaestras={tareasMaestras}
              setTareasMaestras={setTareasMaestras}
              subtareasMaestras={subtareasMaestras}
              setSubtareasMaestras={setSubtareasMaestras}
              localizacionConfig={localizacionConfig}
              setLocalizacionConfig={setLocalizacionConfig}
              ubicaciones={ubicaciones}
              setUbicaciones={setUbicaciones}
              proyectoDisciplinas={proyectoDisciplinas}
              setProyectoDisciplinas={setProyectoDisciplinas}
              proyectoTareas={proyectoTareas}
              setProyectoTareas={setProyectoTareas}
              proyectoSubtareas={proyectoSubtareas}
              setProyectoSubtareas={setProyectoSubtareas}
              proyectoTrabajadores={proyectoTrabajadores}
              setProyectoTrabajadores={setProyectoTrabajadores}
              onLogout={() => setShowLogin(true)}
            />
          );
        }

        // ==================== PANTALLA DE LOGIN ====================
        

        // ==================== UTILIDADES DE INSTANCIACIÓN (v1.6.0) ====================
        
        const InstanciacionUtils = {
          // Clonar plantillas maestras al crear proyecto
          clonarPlantillasMaestras: (proyectoId, disciplinasMaestras, tareasMaestras, subtareasMaestras) => {
            const resultados = {
              disciplinas: [],
              tareas: [],
              subtareas: []
            };

            // 1. Clonar Disciplinas activas
            const disciplinasActivas = disciplinasMaestras.filter(d => d.activo);
            disciplinasActivas.forEach(disciplina => {
              resultados.disciplinas.push({
                id: null,  // Se asignará después
                proyectoId: proyectoId,
                disciplinaMaestraId: disciplina.id,
                nombre: disciplina.nombre,
                codigo: disciplina.codigo,
                descripcion: disciplina.descripcion,
                color: disciplina.color,
                activo: true
              });
            });

            // 2. Clonar Tareas activas
            const tareasActivas = tareasMaestras.filter(t => t.activo);
            tareasActivas.forEach(tarea => {
              resultados.tareas.push({
                id: null,  // Se asignará después
                proyectoId: proyectoId,
                disciplinaId: null,  // Se vinculará después
                tareaMaestraId: tarea.id,
                disciplinaMaestraId: tarea.disciplinaMaestraId,
                nombre: tarea.nombre,
                codigo: tarea.codigo,
                descripcion: tarea.descripcion,
                unidadMedida: tarea.unidadMedida,
                rendimientoOptimo: tarea.rendimientoOptimo,
                activo: true
              });
            });

            // 3. Clonar Subtareas activas (con tipos de trabajador)
            const subtareasActivas = subtareasMaestras.filter(s => s.activo);
            subtareasActivas.forEach(subtarea => {
              resultados.subtareas.push({
                id: null,  // Se asignará después
                proyectoId: proyectoId,
                tareaId: null,  // Se vinculará después
                subtareaMaestraId: subtarea.id,
                tareaMaestraId: subtarea.tareaMaestraId,
                nombre: subtarea.nombre,
                descripcion: subtarea.descripcion,
                // ⭐ CRÍTICO: Copiar tipos de trabajador
                tipoTrabajadorOptimo: subtarea.tipoTrabajadorOptimo || null,
                tiposPermitidos: subtarea.tiposPermitidos || [],
                alertaSubutilizacion: subtarea.alertaSubutilizacion || false,
                activo: true
              });
            });

            return resultados;
          },

          // Asignar IDs secuenciales
          asignarIds: (items, existentes) => {
            const maxId = existentes.length > 0 
              ? Math.max(...existentes.map(item => item.id))
              : 0;
            
            return items.map((item, index) => ({
              ...item,
              id: maxId + index + 1
            }));
          },

          // Vincular tareas con disciplinas del proyecto
          vincularTareas: (proyectoTareas, proyectoDisciplinas, tareasMaestras) => {
            return proyectoTareas.map(pTarea => {
              const tareaMaestra = tareasMaestras.find(t => t.id === pTarea.tareaMaestraId);
              const proyectoDisciplina = proyectoDisciplinas.find(
                pd => pd.disciplinaMaestraId === tareaMaestra?.disciplinaMaestraId
              );
              
              return {
                ...pTarea,
                disciplinaId: proyectoDisciplina?.id || null
              };
            });
          },

          // Vincular subtareas con tareas del proyecto
          vincularSubtareas: (proyectoSubtareas, proyectoTareas, subtareasMaestras) => {
            return proyectoSubtareas.map(pSubtarea => {
              const subtareaMaestra = subtareasMaestras.find(s => s.id === pSubtarea.subtareaMaestraId);
              const proyectoTarea = proyectoTareas.find(
                pt => pt.tareaMaestraId === subtareaMaestra?.tareaMaestraId
              );
              
              return {
                ...pSubtarea,
                tareaId: proyectoTarea?.id || null
              };
            });
          },

          // Función completa de instanciación
          instanciarProyecto: (
            proyectoId,
            disciplinasMaestras,
            tareasMaestras,
            subtareasMaestras,
            proyectoDisciplinasExistentes,
            proyectoTareasExistentes,
            proyectoSubtareasExistentes
          ) => {
            // 1. Clonar plantillas
            const clonados = InstanciacionUtils.clonarPlantillasMaestras(
              proyectoId,
              disciplinasMaestras,
              tareasMaestras,
              subtareasMaestras
            );

            // 2. Asignar IDs
            let proyectoDisciplinas = InstanciacionUtils.asignarIds(
              clonados.disciplinas,
              proyectoDisciplinasExistentes
            );

            let proyectoTareas = InstanciacionUtils.asignarIds(
              clonados.tareas,
              proyectoTareasExistentes
            );

            let proyectoSubtareas = InstanciacionUtils.asignarIds(
              clonados.subtareas,
              proyectoSubtareasExistentes
            );

            // 3. Vincular relaciones
            proyectoTareas = InstanciacionUtils.vincularTareas(
              proyectoTareas,
              proyectoDisciplinas,
              tareasMaestras
            );

            proyectoSubtareas = InstanciacionUtils.vincularSubtareas(
              proyectoSubtareas,
              proyectoTareas,
              subtareasMaestras
            );

            return {
              proyectoDisciplinas,
              proyectoTareas,
              proyectoSubtareas
            };
          }
        };

        // Utilidades para Localización
        const LocalizacionUtils = {
          // Generar ubicaciones automáticamente según configuración
          generarUbicaciones: (config, proyectoId, ubicacionesExistentes) => {
            const ubicaciones = [];
            let id = ubicacionesExistentes.length > 0
              ? Math.max(...ubicacionesExistentes.map(u => u.id))
              : 0;

            if (!config || !config.nivel1 || !config.nivel2) {
              return [];
            }

            // Generar para cada opción de Nivel 1
            config.nivel1.opciones.forEach(opcionNivel1 => {
              
              if (config.nivel2.generarAutomatico) {
                // Generación automática
                const configNivel1 = config.nivel2.config[opcionNivel1];
                
                if (configNivel1) {
                  if (configNivel1.pisos && configNivel1.aptosPorPiso) {
                    // Caso: Pisos + Apartamentos
                    for (let piso = 1; piso <= configNivel1.pisos; piso++) {
                      for (let apto = 1; apto <= configNivel1.aptosPorPiso; apto++) {
                        id++;
                        const nivel2Text = config.nivel2.formato
                          .replace('{piso}', piso)
                          .replace('{apto}', apto);
                        
                        ubicaciones.push({
                          id: id,
                          proyectoId: proyectoId,
                          nivel1: opcionNivel1,
                          nivel2: nivel2Text,
                          nivel3: null,
                          activo: true
                        });
                      }
                    }
                  } else if (configNivel1.casas) {
                    // Caso: Casas numeradas
                    for (let casa = 1; casa <= configNivel1.casas; casa++) {
                      id++;
                      const nivel2Text = config.nivel2.formato
                        .replace('{numero}', casa);
                      
                      ubicaciones.push({
                        id: id,
                        proyectoId: proyectoId,
                        nivel1: opcionNivel1,
                        nivel2: nivel2Text,
                        nivel3: null,
                        activo: true
                      });
                    }
                  }
                }
              } else {
                // Generación manual
                const opcionesNivel2 = config.nivel2.config[opcionNivel1] || [];
                opcionesNivel2.forEach(opcionNivel2 => {
                  id++;
                  ubicaciones.push({
                    id: id,
                    proyectoId: proyectoId,
                    nivel1: opcionNivel1,
                    nivel2: opcionNivel2,
                    nivel3: null,
                    activo: true
                  });
                });
              }
            });

            return ubicaciones;
          },

          // Contar ubicaciones que se generarán
          contarUbicaciones: (config) => {
            if (!config || !config.nivel1 || !config.nivel2) {
              return 0;
            }

            let total = 0;

            config.nivel1.opciones.forEach(opcionNivel1 => {
              if (config.nivel2.generarAutomatico) {
                const configNivel1 = config.nivel2.config[opcionNivel1];
                
                if (configNivel1) {
                  if (configNivel1.pisos && configNivel1.aptosPorPiso) {
                    total += configNivel1.pisos * configNivel1.aptosPorPiso;
                  } else if (configNivel1.casas) {
                    total += configNivel1.casas;
                  }
                }
              } else {
                const opcionesNivel2 = config.nivel2.config[opcionNivel1] || [];
                total += opcionesNivel2.length;
              }
            });

            return total;
          }
        };

        
        // ==================== SISTEMA DE LOGIN CON AUTENTICACIÓN ====================
        
        // Usuarios de demostración
        const DEMO_USERS = [
          {
            id: 1,
            username: 'admin',
            password: 'admin123',
            role: 'admin',
            nombre: 'Administrador General'
          },
          {
            id: 2,
            username: 'cliente1',
            password: 'cliente123',
            role: 'cliente',
            clienteId: 1,
            nombre: 'Cliente Demo 1'
          },
          {
            id: 3,
            username: 'cliente2',
            password: 'cliente456',
            role: 'cliente',
            clienteId: 2,
            nombre: 'Cliente Demo 2'
          }
        ];
        
        function LoginScreen({ onLogin, clientes }) {
          const [username, setUsername] = useState('');
          const [password, setPassword] = useState('');
          const [error, setError] = useState('');
          const [showPassword, setShowPassword] = useState(false);

          const handleSubmit = (e) => {
            e.preventDefault();
            setError('');
            
            // Buscar usuario
            const user = DEMO_USERS.find(u => 
              u.username.toLowerCase() === username.toLowerCase() && 
              u.password === password
            );
            
            if (user) {
              // Login exitoso
              onLogin(user.role, user.clienteId || null);
            } else {
              setError('Usuario o contraseña incorrectos');
            }
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                <div className="text-center mb-8">
                  <TeracontaLogo size="large" showText={true} />
                  <p className="text-gray-600 mt-4">Sistema de Gestión de Proyectos</p>
                </div>

                <form onSubmit={handleSubmit} className="space-y-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Usuario
                    </label>
                    <input
                      type="text"
                      value={username}
                      onChange={(e) => setUsername(e.target.value)}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Ingresa tu usuario"
                      required
                      autoFocus
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Contraseña
                    </label>
                    <div className="relative">
                      <input
                        type={showPassword ? "text" : "password"}
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Ingresa tu contraseña"
                        required
                      />
                      <button
                        type="button"
                        onClick={() => setShowPassword(!showPassword)}
                        className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                      >
                        {showPassword ? '👁️' : '👁️‍🗨️'}
                      </button>
                    </div>
                  </div>

                  {error && (
                    <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg text-sm">
                      {error}
                    </div>
                  )}

                  <button
                    type="submit"
                    className="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg hover:shadow-xl"
                  >
                    Iniciar Sesión
                  </button>
                </form>

                <div className="mt-8 pt-6 border-t border-gray-200">
                  <p className="text-xs text-gray-500 text-center mb-3">Usuarios de demostración:</p>
                  <div className="space-y-2 text-xs">
                    <div className="bg-blue-50 p-3 rounded-lg">
                      <p className="font-semibold text-blue-900">👨‍💼 Administrador</p>
                      <p className="text-blue-700">Usuario: <span className="font-mono">admin</span></p>
                      <p className="text-blue-700">Contraseña: <span className="font-mono">admin123</span></p>
                    </div>
                    <div className="bg-purple-50 p-3 rounded-lg">
                      <p className="font-semibold text-purple-900">👤 Cliente</p>
                      <p className="text-purple-700">Usuario: <span className="font-mono">cliente1</span></p>
                      <p className="text-purple-700">Contraseña: <span className="font-mono">cliente123</span></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          );
        }


        function MainPanel({ 
          userRole, 
          currentClienteId, 
          clientes, 
          setClientes, 
          proyectos, 
          setProyectos, 
          trabajadores, 
          setTrabajadores, 
          tiposTrabajador, 
          setTiposTrabajador, 
          personal, 
          setPersonal, 
          cargos, 
          setCargos, 
          departamentos, 
          setDepartamentos, 
          disciplinasMaestras, 
          setDisciplinasMaestras, 
          tareasMaestras, 
          setTareasMaestras, 
          subtareasMaestras, 
          setSubtareasMaestras,
          localizacionConfig,
          setLocalizacionConfig,
          ubicaciones,
          setUbicaciones,
          proyectoDisciplinas,
          setProyectoDisciplinas,
          proyectoTareas,
          setProyectoTareas,
          proyectoSubtareas,
          setProyectoSubtareas,
          proyectoTrabajadores,
          setProyectoTrabajadores,
          onLogout 
        }) {
          const [activeView, setActiveView] = useState('dashboard');

          const currentCliente = clientes.find(c => c.id === currentClienteId);
          const isAdmin = userRole === 'admin';

          return (
            <div className="flex h-screen bg-gray-100">
              <div className={`w-64 ${isAdmin ? 'bg-gradient-to-b from-blue-600 to-blue-800' : 'bg-gradient-to-b from-purple-600 to-purple-800'} text-white`}>
                <div className="p-6">
                  <TeracontaLogo size="small" showText={true} />
                  <p className="text-sm text-white/70 mt-3">
                    {isAdmin ? '👨‍💼 Panel Admin' : '👤 Panel Cliente'}
                  </p>
                  {!isAdmin && currentCliente && (
                    <p className="text-xs text-white/60 mt-2">{currentCliente.nombre}</p>
                  )}
                </div>
                
                <nav className="mt-6">
                  <button
                    onClick={() => setActiveView('dashboard')}
                    className={`w-full px-6 py-3 text-left hover:bg-white/10 transition ${
                      activeView === 'dashboard' ? 'bg-white/20 border-l-4 border-white' : ''
                    }`}
                  >
                    📊 Dashboard
                  </button>
                  <button
                    onClick={() => setActiveView('reporte-subutilizacion')}
                    className={`w-full px-6 py-3 text-left hover:bg-white/10 transition ${
                      activeView === 'reporte-subutilizacion' ? 'bg-white/20 border-l-4 border-white' : ''
                    }`}
                  >
                    ⚠️ Subutilización
                  </button>
                  <button
                    onClick={() => setActiveView('reporte-improductividad')}
                    className={`w-full px-6 py-3 text-left hover:bg-white/10 transition ${
                      activeView === 'reporte-improductividad' ? 'bg-white/20 border-l-4 border-white' : ''
                    }`}
                  >
                    ⏳ Tiempos Improductivos
                  </button>
                  <button
                    onClick={() => setActiveView('reporte-ubicacion')}
                    className={`w-full px-6 py-3 text-left hover:bg-white/10 transition ${
                      activeView === 'reporte-ubicacion' ? 'bg-white/20 border-l-4 border-white' : ''
                    }`}
                  >
                    📍 Reportes de Ubicación
                  </button>
                  <button
                    onClick={() => setActiveView('clientes')}
                    className={`w-full px-6 py-3 text-left hover:bg-white/10 transition ${
                      activeView === 'clientes' ? 'bg-white/20 border-l-4 border-white' : ''
                    }`}
                  >
                    👥 {isAdmin ? 'Clientes' : 'Mi Información'}
                  </button>
                  <button
                    onClick={() => setActiveView('proyectos')}
                    className={`w-full px-6 py-3 text-left hover:bg-white/10 transition ${
                      activeView === 'proyectos' ? 'bg-white/20 border-l-4 border-white' : ''
                    }`}
                  >
                    🏗️ Proyectos
                  </button>
                  <button
                    onClick={() => setActiveView('trabajadores')}
                    className={`w-full px-6 py-3 text-left hover:bg-white/10 transition ${
                      activeView === 'trabajadores' ? 'bg-white/20 border-l-4 border-white' : ''
                    }`}
                  >
                    👷 Trabajadores
                  </button>
                  <button
                    onClick={() => setActiveView('personal')}
                    className={`w-full px-6 py-3 text-left hover:bg-white/10 transition ${
                      activeView === 'personal' ? 'bg-white/20 border-l-4 border-white' : ''
                    }`}
                  >
                    👔 Personal/Staff
                  </button>
                  
                  {isAdmin && (
                    <>
                      <div className="border-t border-white/20 my-4"></div>
                      <div className="px-6 py-2 text-xs text-white/50 font-semibold uppercase">
                        Plantillas (Admin)
                      </div>
                      <button
                        onClick={() => setActiveView('disciplinas')}
                        className={`w-full px-6 py-3 text-left hover:bg-white/10 transition ${
                          activeView === 'disciplinas' ? 'bg-white/20 border-l-4 border-white' : ''
                        }`}
                      >
                        📂 Disciplinas
                      </button>
                      <button
                        onClick={() => setActiveView('tareas')}
                        className={`w-full px-6 py-3 text-left hover:bg-white/10 transition ${
                          activeView === 'tareas' ? 'bg-white/20 border-l-4 border-white' : ''
                        }`}
                      >
                        📋 Tareas
                      </button>
                      <button
                        onClick={() => setActiveView('subtareas')}
                        className={`w-full px-6 py-3 text-left hover:bg-white/10 transition ${
                          activeView === 'subtareas' ? 'bg-white/20 border-l-4 border-white' : ''
                        }`}
                      >
                        📝 Subtareas
                      </button>
                    </>
                  )}
                  
                  <div className="border-t border-white/20 my-4"></div>
                  
                  <button
                    onClick={onLogout}
                    className="w-full px-6 py-3 text-left hover:bg-red-500/20 transition text-red-200"
                  >
                    🚪 Cerrar Sesión
                  </button>
                </nav>
              </div>

              <div className="flex-1 overflow-auto">
                <div className="p-8">
                  {activeView === 'dashboard' && (
                    <Dashboard 
                      userRole={userRole} 
                      clientes={clientes} 
                      proyectos={proyectos}
                      trabajadores={trabajadores}
                      currentClienteId={currentClienteId} 
                    />
                  )}
                  {activeView === 'reporte-subutilizacion' && (
                    <ReporteSubutilizacion
                      proyectos={proyectos}
                      trabajadores={trabajadores}
                      clientes={clientes}
                      tiposTrabajador={tiposTrabajador}
                      currentClienteId={currentClienteId}
                      userRole={userRole}
                    />
                  )}
                  {activeView === 'reporte-improductividad' && (
                    <ReporteImproductividad
                      proyectos={proyectos}
                      trabajadores={trabajadores}
                      clientes={clientes}
                      tiposTrabajador={tiposTrabajador}
                      currentClienteId={currentClienteId}
                      userRole={userRole}
                    />
                  )}
                  {activeView === 'reporte-ubicacion' && (
                    <ReporteUbicacion
                      proyectos={proyectos}
                      trabajadores={trabajadores}
                      clientes={clientes}
                      currentClienteId={currentClienteId}
                      userRole={userRole}
                      ubicaciones={ubicaciones}
                    />
                  )}
                  {activeView === 'clientes' && (
                    <ClientesCRUD 
                      clientes={clientes}
                      setClientes={setClientes}
                      userRole={userRole}
                      currentClienteId={currentClienteId}
                    />
                  )}
                  {activeView === 'proyectos' && (
                    <ProyectosCRUD 
                      proyectos={proyectos}
                      setProyectos={setProyectos}
                      clientes={clientes}
                      userRole={userRole}
                      currentClienteId={currentClienteId}
                      disciplinasMaestras={disciplinasMaestras}
                      tareasMaestras={tareasMaestras}
                      subtareasMaestras={subtareasMaestras}
                      proyectoDisciplinas={proyectoDisciplinas}
                      setProyectoDisciplinas={setProyectoDisciplinas}
                      proyectoTareas={proyectoTareas}
                      setProyectoTareas={setProyectoTareas}
                      proyectoSubtareas={proyectoSubtareas}
                      setProyectoSubtareas={setProyectoSubtareas}
                      localizacionConfig={localizacionConfig}
                      setLocalizacionConfig={setLocalizacionConfig}
                      ubicaciones={ubicaciones}
                      setUbicaciones={setUbicaciones}
                      proyectoTrabajadores={proyectoTrabajadores}
                      setProyectoTrabajadores={setProyectoTrabajadores}
                      trabajadores={trabajadores}
                      tiposTrabajador={tiposTrabajador}
                    />
                  )}
                  {activeView === 'trabajadores' && (
                    <TrabajadoresCRUD 
                      trabajadores={trabajadores}
                      setTrabajadores={setTrabajadores}
                      clientes={clientes}
                      proyectos={proyectos}
                      tiposTrabajador={tiposTrabajador}
                      setTiposTrabajador={setTiposTrabajador}
                      userRole={userRole}
                      currentClienteId={currentClienteId}
                    />
                  )}
                  {activeView === 'personal' && (
                    <PersonalCRUD
                      personal={personal}
                      setPersonal={setPersonal}
                      clientes={clientes}
                      proyectos={proyectos}
                      cargos={cargos}
                      setCargos={setCargos}
                      departamentos={departamentos}
                      setDepartamentos={setDepartamentos}
                      userRole={userRole}
                      currentClienteId={currentClienteId}
                    />
                  )}
                  {activeView === 'disciplinas' && (
                    <DisciplinasMaestrasCRUD
                      disciplinas={disciplinasMaestras}
                      setDisciplinas={setDisciplinasMaestras}
                    />
                  )}
                  {activeView === 'tareas' && (
                    <TareasMaestrasCRUD
                      tareas={tareasMaestras}
                      setTareas={setTareasMaestras}
                      disciplinas={disciplinasMaestras}
                    />
                  )}
                  {activeView === 'subtareas' && (
                    <SubtareasMaestrasCRUD
                      subtareas={subtareasMaestras}
                      setSubtareas={setSubtareasMaestras}
                      tareas={tareasMaestras}
                      disciplinas={disciplinasMaestras}
                      tiposTrabajador={tiposTrabajador}
                    />
                  )}
                </div>
              </div>
            </div>
          );
        }

        // ==================== DASHBOARD ====================
        
        // Modal Subtarea Maestra - Con selección de tipos de trabajador
        // ==================== MODAL DISCIPLINA MAESTRA ====================
        
        function DisciplinaMaestraModal({ disciplina, onSave, onClose }) {
          const [formData, setFormData] = useState(disciplina || {
            nombre: '',
            codigo: '',
            descripcion: '',
            color: '#3B82F6',
            orden: 1,
            activo: true
          });

          const handleSubmit = (e) => {
            e.preventDefault();
            onSave(formData);
          };

          return (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl">
                <div className="flex items-center justify-between p-6 border-b border-gray-200">
                  <h3 className="text-xl font-bold text-gray-900">
                    {disciplina ? 'Editar Disciplina' : 'Nueva Disciplina'}
                  </h3>
                  <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                    <X className="w-6 h-6" />
                  </button>
                </div>

                <form onSubmit={handleSubmit}>
                  <div className="p-6 space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Nombre *
                        </label>
                        <input
                          type="text"
                          required
                          value={formData.nombre}
                          onChange={(e) => setFormData({...formData, nombre: e.target.value})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="Estructuras"
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Código * (máx 5 caracteres)
                        </label>
                        <input
                          type="text"
                          required
                          maxLength="5"
                          value={formData.codigo}
                          onChange={(e) => setFormData({...formData, codigo: e.target.value.toUpperCase()})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="EST"
                        />
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Descripción
                      </label>
                      <textarea
                        value={formData.descripcion}
                        onChange={(e) => setFormData({...formData, descripcion: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        rows="2"
                        placeholder="Descripción de la disciplina..."
                      />
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Color
                        </label>
                        <input
                          type="color"
                          value={formData.color}
                          onChange={(e) => setFormData({...formData, color: e.target.value})}
                          className="w-full h-10 border border-gray-300 rounded-lg cursor-pointer"
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Orden
                        </label>
                        <input
                          type="number"
                          min="1"
                          value={formData.orden}
                          onChange={(e) => setFormData({...formData, orden: parseInt(e.target.value)})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                    </div>

                    <div className="flex items-center">
                      <input
                        type="checkbox"
                        id="activo"
                        checked={formData.activo}
                        onChange={(e) => setFormData({...formData, activo: e.target.checked})}
                        className="w-4 h-4 text-blue-600 border-gray-300 rounded"
                      />
                      <label htmlFor="activo" className="ml-2 text-sm font-medium text-gray-700">
                        Disciplina activa
                      </label>
                    </div>
                  </div>

                  <div className="flex items-center justify-end gap-3 p-6 border-t border-gray-200 bg-gray-50">
                    <button
                      type="button"
                      onClick={onClose}
                      className="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                      Cancelar
                    </button>
                    <button
                      type="submit"
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                    >
                      {disciplina ? 'Actualizar' : 'Crear'}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          );
        }


        // ==================== REPORTE DE TIEMPOS IMPRODUCTIVOS v1.9.0 ====================
        
        function ReporteImproductividad({ proyectos, trabajadores, clientes, tiposTrabajador, currentClienteId, userRole }) {
          const isAdmin = userRole === 'admin';
          
          // ⭐ Filtrar proyectos visibles por cliente
          const visibleProyectos = isAdmin
            ? proyectos
            : proyectos.filter(p => p.clienteId === currentClienteId);
          
          // ⭐ v1.10.0 FIX - DATOS MOCK - Tiempos Improductivos
          const [registrosImproductivos] = React.useState([
            // ESPERAS - Material
            {
              id: 101,
              fecha: '2025-01-15',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              categoria: 'esperas',
              subcategoria: 'material',
              descripcion: 'Esperando cemento - proveedor retrasado',
              duracionHoras: 2.5,
              salarioPorHora: 40000,
              costoTotal: 100000,
              ubicacion: 'Torre Norte - Piso 5'
            },
            {
              id: 102,
              fecha: '2025-01-16',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              categoria: 'esperas',
              subcategoria: 'material',
              descripcion: 'Falta de arena',
              duracionHoras: 1.5,
              salarioPorHora: 30000,
              costoTotal: 45000,
              ubicacion: 'Torre Sur - Piso 3'
            },
            {
              id: 103,
              fecha: '2025-01-18',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 3,
              trabajador: 'María Torres',
              tipoTrabajador: 'Maestro',
              categoria: 'esperas',
              subcategoria: 'material',
              descripcion: 'Esperando bloques',
              duracionHoras: 2,
              salarioPorHora: 50000,
              costoTotal: 100000,
              ubicacion: 'Sótano - Zona A'
            },
            
            // ESPERAS - Herramientas/Equipos
            {
              id: 104,
              fecha: '2025-01-15',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              categoria: 'esperas',
              subcategoria: 'herramientas_equipos',
              descripcion: 'Esperando taladro',
              duracionHoras: 1,
              salarioPorHora: 30000,
              costoTotal: 30000,
              ubicacion: 'Torre Norte - Piso 6'
            },
            {
              id: 105,
              fecha: '2025-01-17',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              categoria: 'esperas',
              subcategoria: 'herramientas_equipos',
              descripcion: 'Mezcladora averiada',
              duracionHoras: 1.5,
              salarioPorHora: 40000,
              costoTotal: 60000,
              ubicacion: 'Torre Norte - Piso 7'
            },
            
            // ESPERAS - Instrucciones
            {
              id: 106,
              fecha: '2025-01-16',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              categoria: 'esperas',
              subcategoria: 'instrucciones',
              descripcion: 'Esperando aprobación de planos',
              duracionHoras: 2,
              salarioPorHora: 40000,
              costoTotal: 80000,
              ubicacion: 'Torre Sur - Piso 4'
            },
            {
              id: 107,
              fecha: '2025-01-18',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 3,
              trabajador: 'María Torres',
              tipoTrabajador: 'Maestro',
              categoria: 'esperas',
              subcategoria: 'instrucciones',
              descripcion: 'Consulta técnica ingeniero',
              duracionHoras: 1,
              salarioPorHora: 50000,
              costoTotal: 50000,
              ubicacion: 'Torre Norte - Piso 8'
            },
            
            // ESPERAS - Clima
            {
              id: 108,
              fecha: '2025-01-16',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 3,
              trabajador: 'María Torres',
              tipoTrabajador: 'Maestro',
              categoria: 'esperas',
              subcategoria: 'clima',
              descripcion: 'Lluvia intensa',
              duracionHoras: 3,
              salarioPorHora: 50000,
              costoTotal: 150000,
              ubicacion: 'Obra exterior'
            },
            {
              id: 109,
              fecha: '2025-01-19',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              categoria: 'esperas',
              subcategoria: 'clima',
              descripcion: 'Lluvia moderada',
              duracionHoras: 2,
              salarioPorHora: 30000,
              costoTotal: 60000,
              ubicacion: 'Fachada principal'
            },
            
            // ESPERAS - Otros oficios
            {
              id: 110,
              fecha: '2025-01-17',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              categoria: 'esperas',
              subcategoria: 'otros_oficios',
              descripcion: 'Esperando electricista termine',
              duracionHoras: 1.5,
              salarioPorHora: 30000,
              costoTotal: 45000,
              ubicacion: 'Torre Norte - Piso 5'
            },
            
            // PERMISOS - Médico
            {
              id: 111,
              fecha: '2025-01-16',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              categoria: 'permisos',
              subcategoria: 'medico',
              descripcion: 'Cita odontológica',
              duracionHoras: 2,
              salarioPorHora: 40000,
              costoTotal: 80000
            },
            {
              id: 112,
              fecha: '2025-01-18',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 3,
              trabajador: 'María Torres',
              tipoTrabajador: 'Maestro',
              categoria: 'permisos',
              subcategoria: 'medico',
              descripcion: 'Examen médico periódico',
              duracionHoras: 3,
              salarioPorHora: 50000,
              costoTotal: 150000
            },
            {
              id: 113,
              fecha: '2025-01-19',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              categoria: 'permisos',
              subcategoria: 'medico',
              descripcion: 'Incapacidad médica',
              duracionHoras: 4,
              salarioPorHora: 30000,
              costoTotal: 120000
            },
            
            // PERMISOS - Personal
            {
              id: 114,
              fecha: '2025-01-17',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              categoria: 'permisos',
              subcategoria: 'personal',
              descripcion: 'Trámite bancario',
              duracionHoras: 1.5,
              salarioPorHora: 30000,
              costoTotal: 45000
            },
            {
              id: 115,
              fecha: '2025-01-19',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              categoria: 'permisos',
              subcategoria: 'personal',
              descripcion: 'Diligencia personal',
              duracionHoras: 2,
              salarioPorHora: 40000,
              costoTotal: 80000
            },
            
            // PERMISOS - Calamidad
            {
              id: 116,
              fecha: '2025-01-18',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              categoria: 'permisos',
              subcategoria: 'calamidad',
              descripcion: 'Calamidad familiar',
              duracionHoras: 4,
              salarioPorHora: 40000,
              costoTotal: 160000
            },
            
            // PERMISOS - Capacitación
            {
              id: 117,
              fecha: '2025-01-19',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 3,
              trabajador: 'María Torres',
              tipoTrabajador: 'Maestro',
              categoria: 'permisos',
              subcategoria: 'capacitacion',
              descripcion: 'Capacitación en seguridad',
              duracionHoras: 3,
              salarioPorHora: 50000,
              costoTotal: 150000
            },
            
            // SIN TAREAS - Automático
            {
              id: 118,
              fecha: '2025-01-17',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 3,
              trabajador: 'María Torres',
              tipoTrabajador: 'Maestro',
              categoria: 'sin_tareas',
              subcategoria: 'sin_asignacion',
              descripcion: 'Sin asignación (detectado automático)',
              duracionHoras: 0.5,
              salarioPorHora: 50000,
              costoTotal: 25000,
              esAutomatico: true
            },
            {
              id: 119,
              fecha: '2025-01-18',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              categoria: 'sin_tareas',
              subcategoria: 'sin_asignacion',
              descripcion: 'Gap entre tareas (automático)',
              duracionHoras: 0.75,
              salarioPorHora: 30000,
              costoTotal: 22500,
              esAutomatico: true
            },
            {
              id: 120,
              fecha: '2025-01-19',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              categoria: 'sin_tareas',
              subcategoria: 'sin_asignacion',
              descripcion: 'Sin asignación',
              duracionHoras: 1,
              salarioPorHora: 40000,
              costoTotal: 40000,
              esAutomatico: true
            }
          ]);
          
          // ⭐ v1.10.0 - DATOS MOCK - Tiempos Productivos
          const [registrosProductivos] = React.useState([
            // ALBAÑILERÍA - Carlos Ramírez
            {
              id: 201,
              fecha: '2025-01-15',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              esProductivo: true,
              disciplina: 'Albañilería',
              tarea: 'Levante de muros',
              subtarea: 'Colocación de bloques',
              duracionHoras: 6,
              salarioPorHora: 40000,
              costoTotal: 240000,
              ubicacion: 'Torre Norte - Piso 5'
            },
            {
              id: 202,
              fecha: '2025-01-16',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              esProductivo: true,
              disciplina: 'Albañilería',
              tarea: 'Pañete',
              subtarea: 'Aplicación de mezcla',
              duracionHoras: 5,
              salarioPorHora: 40000,
              costoTotal: 200000,
              ubicacion: 'Torre Sur - Piso 4'
            },
            {
              id: 203,
              fecha: '2025-01-17',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              esProductivo: true,
              disciplina: 'Albañilería',
              tarea: 'Levante de muros',
              subtarea: 'Trazado',
              duracionHoras: 4.5,
              salarioPorHora: 40000,
              costoTotal: 180000,
              ubicacion: 'Torre Norte - Piso 6'
            },
            {
              id: 204,
              fecha: '2025-01-18',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              esProductivo: true,
              disciplina: 'Albañilería',
              tarea: 'Enchape',
              subtarea: 'Instalación cerámica',
              duracionHoras: 7,
              salarioPorHora: 40000,
              costoTotal: 280000,
              ubicacion: 'Torre Norte - Piso 7'
            },
            {
              id: 205,
              fecha: '2025-01-19',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              esProductivo: true,
              disciplina: 'Albañilería',
              tarea: 'Pañete',
              subtarea: 'Preparación de mezcla',
              duracionHoras: 6,
              salarioPorHora: 40000,
              costoTotal: 240000,
              ubicacion: 'Torre Sur - Piso 5'
            },
            
            // PINTURA - Pedro González
            {
              id: 206,
              fecha: '2025-01-15',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              esProductivo: true,
              disciplina: 'Pintura',
              tarea: 'Preparación de superficie',
              subtarea: 'Lijado',
              duracionHoras: 5,
              salarioPorHora: 30000,
              costoTotal: 150000,
              ubicacion: 'Torre Norte - Piso 3'
            },
            {
              id: 207,
              fecha: '2025-01-15',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              esProductivo: true,
              disciplina: 'Pintura',
              tarea: 'Pintura base',
              subtarea: 'Primera mano',
              duracionHoras: 2,
              salarioPorHora: 30000,
              costoTotal: 60000,
              ubicacion: 'Torre Norte - Piso 3'
            },
            {
              id: 208,
              fecha: '2025-01-16',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              esProductivo: true,
              disciplina: 'Pintura',
              tarea: 'Pintura acabado',
              subtarea: 'Segunda mano',
              duracionHoras: 6,
              salarioPorHora: 30000,
              costoTotal: 180000,
              ubicacion: 'Torre Sur - Piso 3'
            },
            {
              id: 209,
              fecha: '2025-01-17',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              esProductivo: true,
              disciplina: 'Albañilería',
              tarea: 'Levante de muros',
              subtarea: 'Colocación de bloques',
              duracionHoras: 5,
              salarioPorHora: 30000,
              costoTotal: 150000,
              ubicacion: 'Torre Norte - Piso 5'
            },
            {
              id: 210,
              fecha: '2025-01-18',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              esProductivo: true,
              disciplina: 'Pintura',
              tarea: 'Retoques',
              subtarea: 'Corrección de detalles',
              duracionHoras: 4,
              salarioPorHora: 30000,
              costoTotal: 120000,
              ubicacion: 'Torre Sur - Piso 4'
            },
            {
              id: 211,
              fecha: '2025-01-19',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              esProductivo: true,
              disciplina: 'Pintura',
              tarea: 'Preparación de superficie',
              subtarea: 'Limpieza',
              duracionHoras: 5,
              salarioPorHora: 30000,
              costoTotal: 150000,
              ubicacion: 'Torre Norte - Piso 8'
            },
            
            // ESTRUCTURA - María Torres
            {
              id: 212,
              fecha: '2025-01-15',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 3,
              trabajador: 'María Torres',
              tipoTrabajador: 'Maestro',
              esProductivo: true,
              disciplina: 'Estructura',
              tarea: 'Columnas',
              subtarea: 'Armado de acero',
              duracionHoras: 8,
              salarioPorHora: 50000,
              costoTotal: 400000,
              ubicacion: 'Torre Norte - Piso 9'
            },
            {
              id: 213,
              fecha: '2025-01-16',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 3,
              trabajador: 'María Torres',
              tipoTrabajador: 'Maestro',
              esProductivo: true,
              disciplina: 'Estructura',
              tarea: 'Vigas',
              subtarea: 'Encofrado',
              duracionHoras: 5,
              salarioPorHora: 50000,
              costoTotal: 250000,
              ubicacion: 'Torre Norte - Piso 9'
            },
            {
              id: 214,
              fecha: '2025-01-17',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 3,
              trabajador: 'María Torres',
              tipoTrabajador: 'Maestro',
              esProductivo: true,
              disciplina: 'Estructura',
              tarea: 'Columnas',
              subtarea: 'Vaciado de concreto',
              duracionHoras: 7,
              salarioPorHora: 50000,
              costoTotal: 350000,
              ubicacion: 'Torre Sur - Piso 8'
            },
            {
              id: 215,
              fecha: '2025-01-18',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 3,
              trabajador: 'María Torres',
              tipoTrabajador: 'Maestro',
              esProductivo: true,
              disciplina: 'Estructura',
              tarea: 'Cimentación',
              subtarea: 'Armado de hierro',
              duracionHoras: 4,
              salarioPorHora: 50000,
              costoTotal: 200000,
              ubicacion: 'Sótano - Zona B'
            },
            {
              id: 216,
              fecha: '2025-01-19',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 3,
              trabajador: 'María Torres',
              tipoTrabajador: 'Maestro',
              esProductivo: true,
              disciplina: 'Estructura',
              tarea: 'Vigas',
              subtarea: 'Desencofrado',
              duracionHoras: 6,
              salarioPorHora: 50000,
              costoTotal: 300000,
              ubicacion: 'Torre Norte - Piso 10'
            },
            
            // Más registros distribuidos
            {
              id: 217,
              fecha: '2025-01-15',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              esProductivo: true,
              disciplina: 'Electricidad',
              tarea: 'Canalización',
              subtarea: 'Instalación de tubería',
              duracionHoras: 2,
              salarioPorHora: 40000,
              costoTotal: 80000,
              ubicacion: 'Torre Norte - Piso 5'
            },
            {
              id: 218,
              fecha: '2025-01-16',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              esProductivo: true,
              disciplina: 'Plomería',
              tarea: 'Redes hidráulicas',
              subtarea: 'Instalación tuberías',
              duracionHoras: 2,
              salarioPorHora: 30000,
              costoTotal: 60000,
              ubicacion: 'Torre Sur - Piso 3'
            },
            {
              id: 219,
              fecha: '2025-01-17',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 3,
              trabajador: 'María Torres',
              tipoTrabajador: 'Maestro',
              esProductivo: true,
              disciplina: 'Estructura',
              tarea: 'Excavación',
              subtarea: 'Excavación mecánica',
              duracionHoras: 3,
              salarioPorHora: 50000,
              costoTotal: 150000,
              ubicacion: 'Sótano - Zona C'
            },
            {
              id: 220,
              fecha: '2025-01-18',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              esProductivo: true,
              disciplina: 'Albañilería',
              tarea: 'Pisos',
              subtarea: 'Instalación',
              duracionHoras: 5,
              salarioPorHora: 40000,
              costoTotal: 200000,
              ubicacion: 'Torre Norte - Piso 6'
            },
            {
              id: 221,
              fecha: '2025-01-19',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              esProductivo: true,
              disciplina: 'Pintura',
              tarea: 'Pintura acabado',
              subtarea: 'Tercera mano',
              duracionHoras: 6,
              salarioPorHora: 30000,
              costoTotal: 180000,
              ubicacion: 'Torre Sur - Piso 5'
            },
            {
              id: 222,
              fecha: '2025-01-15',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 3,
              trabajador: 'María Torres',
              tipoTrabajador: 'Maestro',
              esProductivo: true,
              disciplina: 'Estructura',
              tarea: 'Columnas',
              subtarea: 'Desencofrado',
              duracionHoras: 3,
              salarioPorHora: 50000,
              costoTotal: 150000,
              ubicacion: 'Torre Norte - Piso 8'
            },
            {
              id: 223,
              fecha: '2025-01-16',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              esProductivo: true,
              disciplina: 'Albañilería',
              tarea: 'Levante de muros',
              subtarea: 'Colocación de bloques',
              duracionHoras: 5,
              salarioPorHora: 40000,
              costoTotal: 200000,
              ubicacion: 'Torre Sur - Piso 6'
            },
            {
              id: 224,
              fecha: '2025-01-17',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              esProductivo: true,
              disciplina: 'Pintura',
              tarea: 'Preparación de superficie',
              subtarea: 'Masillado',
              duracionHoras: 4,
              salarioPorHora: 30000,
              costoTotal: 120000,
              ubicacion: 'Torre Norte - Piso 7'
            },
            {
              id: 225,
              fecha: '2025-01-18',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 3,
              trabajador: 'María Torres',
              tipoTrabajador: 'Maestro',
              esProductivo: true,
              disciplina: 'Estructura',
              tarea: 'Vigas',
              subtarea: 'Armado de acero',
              duracionHoras: 7,
              salarioPorHora: 50000,
              costoTotal: 350000,
              ubicacion: 'Torre Sur - Piso 9'
            },
            {
              id: 226,
              fecha: '2025-01-19',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              esProductivo: true,
              disciplina: 'Albañilería',
              tarea: 'Pañete',
              subtarea: 'Aplicación de mezcla',
              duracionHoras: 4,
              salarioPorHora: 40000,
              costoTotal: 160000,
              ubicacion: 'Torre Norte - Piso 8'
            },
            {
              id: 227,
              fecha: '2025-01-15',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              esProductivo: true,
              disciplina: 'Electricidad',
              tarea: 'Cableado',
              subtarea: 'Instalación cables',
              duracionHoras: 3,
              salarioPorHora: 30000,
              costoTotal: 90000,
              ubicacion: 'Torre Norte - Piso 4'
            },
            {
              id: 228,
              fecha: '2025-01-16',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 3,
              trabajador: 'María Torres',
              tipoTrabajador: 'Maestro',
              esProductivo: true,
              disciplina: 'Estructura',
              tarea: 'Cimentación',
              subtarea: 'Fundida',
              duracionHoras: 6,
              salarioPorHora: 50000,
              costoTotal: 300000,
              ubicacion: 'Sótano - Zona A'
            },
            {
              id: 229,
              fecha: '2025-01-17',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              esProductivo: true,
              disciplina: 'Albañilería',
              tarea: 'Enchape',
              subtarea: 'Instalación cerámica',
              duracionHoras: 6,
              salarioPorHora: 40000,
              costoTotal: 240000,
              ubicacion: 'Torre Sur - Piso 7'
            },
            {
              id: 230,
              fecha: '2025-01-18',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              esProductivo: true,
              disciplina: 'Pintura',
              tarea: 'Pintura base',
              subtarea: 'Primera mano',
              duracionHoras: 5,
              salarioPorHora: 30000,
              costoTotal: 150000,
              ubicacion: 'Torre Norte - Piso 9'
            },
            {
              id: 231,
              fecha: '2025-01-19',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 3,
              trabajador: 'María Torres',
              tipoTrabajador: 'Maestro',
              esProductivo: true,
              disciplina: 'Estructura',
              tarea: 'Columnas',
              subtarea: 'Vaciado de concreto',
              duracionHoras: 8,
              salarioPorHora: 50000,
              costoTotal: 400000,
              ubicacion: 'Torre Norte - Piso 11'
            }
          ]);
          
          // ⭐ v1.10.0 - Combinar registros productivos e improductivos
          const todosLosRegistros = React.useMemo(() => {
            return [...registrosProductivos, ...registrosImproductivos].sort((a, b) => {
              const fechaA = new Date(a.fecha);
              const fechaB = new Date(b.fecha);
              return fechaA - fechaB;
            });
          }, [registrosProductivos, registrosImproductivos]);
          
          // ⭐ Filtros
          const [filtroCliente, setFiltroCliente] = React.useState('all'); // ⭐ v1.10.0 - NUEVO
          const [filtroProyecto, setFiltroProyecto] = React.useState('all');
          const [filtroTrabajador, setFiltroTrabajador] = React.useState('all');
          const [filtroCategoria, setFiltroCategoria] = React.useState('all');
          const [filtroFecha, setFiltroFecha] = React.useState('all'); // 'all', 'hoy', 'semana', 'mes'
          
          // ⭐ v1.10.0 FIX - Filtrar proyectos por cliente seleccionado
          const proyectosFiltradosPorCliente = React.useMemo(() => {
            if (!isAdmin) {
              // Cliente: solo sus proyectos
              return visibleProyectos;
            }
            
            // Admin: filtrar por cliente seleccionado
            if (filtroCliente === 'all') {
              return visibleProyectos;
            }
            
            return visibleProyectos.filter(p => p.clienteId === parseInt(filtroCliente));
          }, [isAdmin, filtroCliente, visibleProyectos]);
          
          // Aplicar filtros
          const registrosFiltrados = React.useMemo(() => {
            return todosLosRegistros.filter(reg => {
              // Filtro por cliente (Admin selecciona, Cliente auto-filtrado)
              if (isAdmin && filtroCliente !== 'all' && reg.clienteId !== parseInt(filtroCliente)) return false;
              if (!isAdmin && reg.clienteId !== currentClienteId) return false;
              
              // Filtro por proyecto
              if (filtroProyecto !== 'all' && reg.proyectoId !== parseInt(filtroProyecto)) return false;
              
              // Filtro por trabajador
              if (filtroTrabajador !== 'all' && reg.trabajadorId !== parseInt(filtroTrabajador)) return false;
              
              // Filtro por categoría (solo aplica a improductivos)
              if (filtroCategoria !== 'all') {
                if (filtroCategoria === 'productivos' && !reg.esProductivo) return false;
                if (filtroCategoria !== 'productivos' && (reg.esProductivo || reg.categoria !== filtroCategoria)) return false;
              }
              
              // Filtro por fecha
              if (filtroFecha !== 'all') {
                const hoy = new Date();
                const fechaReg = new Date(reg.fecha);
                
                if (filtroFecha === 'hoy') {
                  if (fechaReg.toDateString() !== hoy.toDateString()) return false;
                } else if (filtroFecha === 'semana') {
                  const inicioSemana = new Date(hoy);
                  inicioSemana.setDate(hoy.getDate() - 7);
                  if (fechaReg < inicioSemana) return false;
                } else if (filtroFecha === 'mes') {
                  const inicioMes = new Date(hoy);
                  inicioMes.setDate(hoy.getDate() - 30);
                  if (fechaReg < inicioMes) return false;
                }
              }
              
              return true;
            });
          }, [todosLosRegistros, filtroCliente, filtroProyecto, filtroTrabajador, filtroCategoria, filtroFecha, isAdmin, currentClienteId]);
          
          // ⭐ v1.10.0 - Separar productivos e improductivos
          const registrosProductivosFiltrados = React.useMemo(() => {
            return registrosFiltrados.filter(r => r.esProductivo);
          }, [registrosFiltrados]);
          
          const registrosImproductivosFiltrados = React.useMemo(() => {
            return registrosFiltrados.filter(r => !r.esProductivo);
          }, [registrosFiltrados]);
          
          // Continúa en siguiente parte...
          
          // ⭐ CÁLCULOS DE KPIs - v1.10.0 Actualizado
          const kpis = React.useMemo(() => {
            // Totales generales
            const totalHoras = registrosFiltrados.reduce((sum, r) => sum + (r.duracionHoras || 0), 0);
            const totalCosto = registrosFiltrados.reduce((sum, r) => sum + (r.costoTotal || 0), 0);
            
            // Productivos
            const horasProductivas = registrosProductivosFiltrados.reduce((sum, r) => sum + (r.duracionHoras || 0), 0);
            const costoProductivo = registrosProductivosFiltrados.reduce((sum, r) => sum + (r.costoTotal || 0), 0);
            
            // Improductivos
            const horasImproductivas = registrosImproductivosFiltrados.reduce((sum, r) => sum + (r.duracionHoras || 0), 0);
            const costoImproductivo = registrosImproductivosFiltrados.reduce((sum, r) => sum + (r.costoTotal || 0), 0);
            
            // Porcentajes
            const porcentajeProductivo = totalHoras > 0 ? (horasProductivas / totalHoras) * 100 : 0;
            const porcentajeImproductivo = totalHoras > 0 ? (horasImproductivas / totalHoras) * 100 : 0;
            
            // Por categoría (solo improductivos)
            const porCategoria = registrosImproductivosFiltrados.reduce((acc, r) => {
              if (!acc[r.categoria]) {
                acc[r.categoria] = { horas: 0, costo: 0, cantidad: 0 };
              }
              acc[r.categoria].horas += r.duracionHoras || 0;
              acc[r.categoria].costo += r.costoTotal || 0;
              acc[r.categoria].cantidad += 1;
              return acc;
            }, {});
            
            // Por subcategoría (top causes) - solo improductivos
            const porSubcategoria = registrosImproductivosFiltrados.reduce((acc, r) => {
              const key = r.subcategoria;
              if (!acc[key]) {
                acc[key] = { horas: 0, costo: 0, cantidad: 0, nombre: r.subcategoria };
              }
              acc[key].horas += r.duracionHoras || 0;
              acc[key].costo += r.costoTotal || 0;
              acc[key].cantidad += 1;
              return acc;
            }, {});
            
            const top10Subcategorias = Object.values(porSubcategoria)
              .sort((a, b) => b.horas - a.horas)
              .slice(0, 10);
            
            return {
              // Totales generales
              totalHoras,
              totalCosto,
              
              // Productivos
              horasProductivas,
              costoProductivo,
              porcentajeProductivo,
              
              // Improductivos
              horasImproductivas,
              costoImproductivo,
              porcentajeImproductivo,
              
              // Otros
              promedioPorRegistro: registrosFiltrados.length > 0 ? totalHoras / registrosFiltrados.length : 0,
              porCategoria,
              top10Subcategorias
            };
          }, [registrosFiltrados, registrosProductivosFiltrados, registrosImproductivosFiltrados]);
          
          // ⭐ GRÁFICO DE TORTA - Distribución por Categoría
          React.useEffect(() => {
            const ctx = document.getElementById('distribucionCategoriaChart');
            if (ctx && Object.keys(kpis.porCategoria).length > 0) {
              const existingChart = Chart.getChart(ctx);
              if (existingChart) existingChart.destroy();
              
              const categorias = Object.keys(kpis.porCategoria);
              const horas = categorias.map(c => kpis.porCategoria[c].horas);
              
              const colores = {
                esperas: 'rgba(239, 68, 68, 0.8)',
                permisos: 'rgba(168, 85, 247, 0.8)',
                sin_tareas: 'rgba(156, 163, 175, 0.8)'
              };
              
              const nombres = {
                esperas: 'Esperas',
                permisos: 'Permisos',
                sin_tareas: 'Sin Tareas'
              };
              
              new Chart(ctx, {
                type: 'doughnut',
                data: {
                  labels: categorias.map(c => nombres[c] || c),
                  datasets: [{
                    data: horas,
                    backgroundColor: categorias.map(c => colores[c] || 'rgba(156, 163, 175, 0.8)'),
                    borderWidth: 2,
                    borderColor: '#fff'
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      position: 'bottom',
                      labels: {
                        padding: 15,
                        font: {
                          size: 13,
                          weight: 'bold'
                        }
                      }
                    },
                    tooltip: {
                      callbacks: {
                        label: function(context) {
                          const label = context.label || '';
                          const horas = context.parsed;
                          const porcentaje = ((horas / kpis.totalHoras) * 100).toFixed(1);
                          const categoria = categorias[context.dataIndex];
                          const costo = kpis.porCategoria[categoria].costo;
                          
                          return [
                            label + ': ' + horas.toFixed(1) + 'h (' + porcentaje + '%)',
                            'Costo: ' + new Intl.NumberFormat('es-CO', {
                              style: 'currency',
                              currency: 'COP',
                              minimumFractionDigits: 0
                            }).format(costo)
                          ];
                        }
                      },
                      backgroundColor: 'rgba(0, 0, 0, 0.85)',
                      padding: 12
                    }
                  }
                }
              });
            }
          }, [kpis]);
          
          // ⭐ GRÁFICO DE BARRAS - Top 10 Causas
          React.useEffect(() => {
            const ctx = document.getElementById('topCausasChart');
            if (ctx && kpis.top10Subcategorias.length > 0) {
              const existingChart = Chart.getChart(ctx);
              if (existingChart) existingChart.destroy();
              
              const nombres = {
                material: 'Espera de Material',
                herramientas_equipos: 'Herramientas/Equipos',
                instrucciones: 'Instrucciones',
                clima: 'Clima Adverso',
                otros_oficios: 'Otros Oficios',
                medico: 'Permiso Médico',
                personal: 'Permiso Personal',
                calamidad: 'Calamidad',
                capacitacion: 'Capacitación',
                sin_asignacion: 'Sin Asignación'
              };
              
              new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: kpis.top10Subcategorias.map(s => nombres[s.nombre] || s.nombre),
                  datasets: [{
                    label: 'Horas',
                    data: kpis.top10Subcategorias.map(s => s.horas),
                    backgroundColor: 'rgba(249, 115, 22, 0.8)',
                    borderColor: 'rgb(249, 115, 22)',
                    borderWidth: 2,
                    borderRadius: 6
                  }]
                },
                options: {
                  indexAxis: 'y',
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      display: false
                    },
                    tooltip: {
                      callbacks: {
                        label: function(context) {
                          const subcategoria = kpis.top10Subcategorias[context.dataIndex];
                          return [
                            'Horas: ' + subcategoria.horas.toFixed(1) + 'h',
                            'Costo: ' + new Intl.NumberFormat('es-CO', {
                              style: 'currency',
                              currency: 'COP',
                              minimumFractionDigits: 0
                            }).format(subcategoria.costo),
                            'Registros: ' + subcategoria.cantidad
                          ];
                        }
                      },
                      backgroundColor: 'rgba(0, 0, 0, 0.85)',
                      padding: 12
                    }
                  },
                  scales: {
                    x: {
                      beginAtZero: true,
                      ticks: {
                        callback: function(value) {
                          return value + 'h';
                        }
                      }
                    }
                  }
                }
              });
            }
          }, [kpis]);
          
          // ⭐ GRÁFICO DE LÍNEAS - Tendencia Temporal
          React.useEffect(() => {
            const ctx = document.getElementById('tendenciaChart');
            if (ctx && registrosFiltrados.length > 0) {
              const existingChart = Chart.getChart(ctx);
              if (existingChart) existingChart.destroy();
              
              // Agrupar por fecha
              const porFecha = registrosFiltrados.reduce((acc, r) => {
                if (!acc[r.fecha]) {
                  acc[r.fecha] = {
                    esperas: 0,
                    permisos: 0,
                    sin_tareas: 0
                  };
                }
                acc[r.fecha][r.categoria] += r.duracionHoras;
                return acc;
              }, {});
              
              const fechas = Object.keys(porFecha).sort();
              const fechasFormateadas = fechas.map(f => {
                const [year, month, day] = f.split('-');
                return `${day}/${month}`;
              });
              
              new Chart(ctx, {
                type: 'line',
                data: {
                  labels: fechasFormateadas,
                  datasets: [
                    {
                      label: 'Esperas',
                      data: fechas.map(f => porFecha[f].esperas),
                      borderColor: 'rgb(239, 68, 68)',
                      backgroundColor: 'rgba(239, 68, 68, 0.1)',
                      borderWidth: 3,
                      tension: 0.4,
                      fill: true
                    },
                    {
                      label: 'Permisos',
                      data: fechas.map(f => porFecha[f].permisos),
                      borderColor: 'rgb(168, 85, 247)',
                      backgroundColor: 'rgba(168, 85, 247, 0.1)',
                      borderWidth: 3,
                      tension: 0.4,
                      fill: true
                    },
                    {
                      label: 'Sin Tareas',
                      data: fechas.map(f => porFecha[f].sin_tareas),
                      borderColor: 'rgb(156, 163, 175)',
                      backgroundColor: 'rgba(156, 163, 175, 0.1)',
                      borderWidth: 3,
                      tension: 0.4,
                      fill: true
                    }
                  ]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  interaction: {
                    mode: 'index',
                    intersect: false
                  },
                  plugins: {
                    legend: {
                      position: 'top',
                      labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                          size: 13,
                          weight: 'bold'
                        }
                      }
                    },
                    tooltip: {
                      callbacks: {
                        label: function(context) {
                          return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + 'h';
                        }
                      },
                      backgroundColor: 'rgba(0, 0, 0, 0.85)',
                      padding: 12
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: function(value) {
                          return value + 'h';
                        }
                      }
                    }
                  }
                }
              });
            }
          }, [registrosFiltrados]);
          
          // ⭐ v1.10.0 - NUEVO: Gráfico Barras Apiladas 100% (Composición)
          React.useEffect(() => {
            const ctx = document.getElementById('composicionChart');
            if (ctx && registrosFiltrados.length > 0) {
              const existingChart = Chart.getChart(ctx);
              if (existingChart) existingChart.destroy();
              
              // Agrupar por fecha
              const porFecha = registrosFiltrados.reduce((acc, r) => {
                if (!acc[r.fecha]) {
                  acc[r.fecha] = {
                    productivo: 0,
                    esperas: 0,
                    permisos: 0,
                    sin_tareas: 0,
                    total: 0
                  };
                }
                
                if (r.esProductivo) {
                  acc[r.fecha].productivo += r.duracionHoras || 0;
                } else if (r.categoria === 'esperas') {
                  acc[r.fecha].esperas += r.duracionHoras || 0;
                } else if (r.categoria === 'permisos') {
                  acc[r.fecha].permisos += r.duracionHoras || 0;
                } else if (r.categoria === 'sin_tareas') {
                  acc[r.fecha].sin_tareas += r.duracionHoras || 0;
                }
                
                acc[r.fecha].total += r.duracionHoras || 0;
                return acc;
              }, {});
              
              const fechas = Object.keys(porFecha).sort();
              const fechasFormateadas = fechas.map(f => {
                const [year, month, day] = f.split('-');
                return `${day}/${month}`;
              });
              
              // Calcular porcentajes
              const dataProductivo = fechas.map(f => {
                const total = porFecha[f].total;
                return total > 0 ? (porFecha[f].productivo / total) * 100 : 0;
              });
              
              const dataEsperas = fechas.map(f => {
                const total = porFecha[f].total;
                return total > 0 ? (porFecha[f].esperas / total) * 100 : 0;
              });
              
              const dataPermisos = fechas.map(f => {
                const total = porFecha[f].total;
                return total > 0 ? (porFecha[f].permisos / total) * 100 : 0;
              });
              
              const dataSinTareas = fechas.map(f => {
                const total = porFecha[f].total;
                return total > 0 ? (porFecha[f].sin_tareas / total) * 100 : 0;
              });
              
              new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: fechasFormateadas,
                  datasets: [
                    {
                      label: 'Productivo',
                      data: dataProductivo,
                      backgroundColor: 'rgba(16, 185, 129, 0.8)',
                      borderColor: 'rgb(16, 185, 129)',
                      borderWidth: 2
                    },
                    {
                      label: 'Esperas',
                      data: dataEsperas,
                      backgroundColor: 'rgba(239, 68, 68, 0.8)',
                      borderColor: 'rgb(239, 68, 68)',
                      borderWidth: 2
                    },
                    {
                      label: 'Permisos',
                      data: dataPermisos,
                      backgroundColor: 'rgba(168, 85, 247, 0.8)',
                      borderColor: 'rgb(168, 85, 247)',
                      borderWidth: 2
                    },
                    {
                      label: 'Sin Tareas',
                      data: dataSinTareas,
                      backgroundColor: 'rgba(156, 163, 175, 0.8)',
                      borderColor: 'rgb(156, 163, 175)',
                      borderWidth: 2
                    }
                  ]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                    x: {
                      stacked: true
                    },
                    y: {
                      stacked: true,
                      min: 0,
                      max: 100,
                      ticks: {
                        callback: function(value) {
                          return value + '%';
                        }
                      }
                    }
                  },
                  plugins: {
                    legend: {
                      position: 'top',
                      labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                          size: 13,
                          weight: 'bold'
                        }
                      }
                    },
                    tooltip: {
                      callbacks: {
                        label: function(context) {
                          const label = context.dataset.label || '';
                          const value = context.parsed.y.toFixed(1);
                          const fecha = fechas[context.dataIndex];
                          const categoria = label.toLowerCase();
                          
                          let horas = 0;
                          if (categoria === 'productivo') {
                            horas = porFecha[fecha].productivo;
                          } else if (categoria === 'esperas') {
                            horas = porFecha[fecha].esperas;
                          } else if (categoria === 'permisos') {
                            horas = porFecha[fecha].permisos;
                          } else if (categoria === 'sin tareas') {
                            horas = porFecha[fecha].sin_tareas;
                          }
                          
                          return label + ': ' + value + '% (' + horas.toFixed(1) + 'h)';
                        }
                      },
                      backgroundColor: 'rgba(0, 0, 0, 0.85)',
                      padding: 12
                    }
                  }
                }
              });
            }
          }, [registrosFiltrados]);
          
          // ⭐ v1.10.0 - NUEVO: Gráfico Líneas Comparativas (Productivo vs Improductivo)
          React.useEffect(() => {
            const ctx = document.getElementById('comparativaChart');
            if (ctx && registrosFiltrados.length > 0) {
              const existingChart = Chart.getChart(ctx);
              if (existingChart) existingChart.destroy();
              
              // Agrupar por fecha
              const porFecha = registrosFiltrados.reduce((acc, r) => {
                if (!acc[r.fecha]) {
                  acc[r.fecha] = {
                    productivo: 0,
                    improductivo: 0
                  };
                }
                
                if (r.esProductivo) {
                  acc[r.fecha].productivo += r.duracionHoras || 0;
                } else {
                  acc[r.fecha].improductivo += r.duracionHoras || 0;
                }
                
                return acc;
              }, {});
              
              const fechas = Object.keys(porFecha).sort();
              const fechasFormateadas = fechas.map(f => {
                const [year, month, day] = f.split('-');
                return `${day}/${month}`;
              });
              
              new Chart(ctx, {
                type: 'line',
                data: {
                  labels: fechasFormateadas,
                  datasets: [
                    {
                      label: 'Productivo',
                      data: fechas.map(f => porFecha[f].productivo),
                      borderColor: 'rgb(16, 185, 129)',
                      backgroundColor: 'rgba(16, 185, 129, 0.1)',
                      borderWidth: 4,
                      tension: 0.4,
                      fill: true,
                      pointRadius: 6,
                      pointHoverRadius: 8
                    },
                    {
                      label: 'Improductivo',
                      data: fechas.map(f => porFecha[f].improductivo),
                      borderColor: 'rgb(239, 68, 68)',
                      backgroundColor: 'rgba(239, 68, 68, 0.1)',
                      borderWidth: 3,
                      tension: 0.4,
                      fill: true,
                      pointRadius: 5,
                      pointHoverRadius: 7
                    }
                  ]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  interaction: {
                    mode: 'index',
                    intersect: false
                  },
                  plugins: {
                    legend: {
                      position: 'top',
                      labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                          size: 14,
                          weight: 'bold'
                        }
                      }
                    },
                    tooltip: {
                      callbacks: {
                        label: function(context) {
                          const label = context.dataset.label || '';
                          const value = context.parsed.y.toFixed(1);
                          return label + ': ' + value + 'h';
                        },
                        afterLabel: function(context) {
                          const fecha = fechas[context.dataIndex];
                          const total = porFecha[fecha].productivo + porFecha[fecha].improductivo;
                          const porcentaje = total > 0 ? (context.parsed.y / total * 100).toFixed(1) : 0;
                          return '(' + porcentaje + '% del total)';
                        }
                      },
                      backgroundColor: 'rgba(0, 0, 0, 0.85)',
                      padding: 12
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: function(value) {
                          return value + 'h';
                        }
                      }
                    }
                  }
                }
              });
            }
          }, [registrosFiltrados]);
          
          return (
            <div className="space-y-6">
              <div>
                <h2 className="text-3xl font-bold text-gray-800 mb-2">
                  {isAdmin ? '📊 Análisis de Tiempos - Global' : '📊 Mi Análisis de Tiempos'}
                </h2>
                <p className="text-gray-600">
                  Análisis completo de tiempos productivos e improductivos: rendimiento, esperas, permisos y períodos sin tareas
                </p>
              </div>

              {/* Filtros */}
              <div className="bg-white rounded-xl shadow-md p-6">
                <h3 className="text-lg font-bold text-gray-800 mb-4">Filtros</h3>
                <div className={`grid grid-cols-1 ${isAdmin ? 'md:grid-cols-5' : 'md:grid-cols-4'} gap-4`}>
                  {/* Filtro Cliente - Solo Admin */}
                  {isAdmin && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                      <select
                        value={filtroCliente}
                        onChange={(e) => {
                          setFiltroCliente(e.target.value);
                          setFiltroProyecto('all'); // Reset proyecto al cambiar cliente
                        }}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="all">Todos</option>
                        {clientes.map(c => (
                          <option key={c.id} value={c.id}>{c.nombre}</option>
                        ))}
                      </select>
                    </div>
                  )}
                  
                  {/* Filtro Proyecto */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Proyecto</label>
                    <select
                      value={filtroProyecto}
                      onChange={(e) => setFiltroProyecto(e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="all">Todos</option>
                      {proyectosFiltradosPorCliente.map(p => (
                        <option key={p.id} value={p.id}>{p.nombre}</option>
                      ))}
                    </select>
                  </div>
                  
                  {/* Filtro Trabajador */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Trabajador</label>
                    <select
                      value={filtroTrabajador}
                      onChange={(e) => setFiltroTrabajador(e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="all">Todos</option>
                      {trabajadores.map(t => (
                        <option key={t.id} value={t.id}>{t.nombre}</option>
                      ))}
                    </select>
                  </div>
                  
                  {/* Filtro Categoría */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                    <select
                      value={filtroCategoria}
                      onChange={(e) => setFiltroCategoria(e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="all">Todos</option>
                      <option value="productivos">✅ Productivos</option>
                      <option value="esperas">⏳ Esperas</option>
                      <option value="permisos">🚪 Permisos</option>
                      <option value="sin_tareas">⏸️ Sin Tareas</option>
                    </select>
                  </div>
                  
                  {/* Filtro Fecha */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Período</label>
                    <select
                      value={filtroFecha}
                      onChange={(e) => setFiltroFecha(e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="all">Todo</option>
                      <option value="hoy">Hoy</option>
                      <option value="semana">Esta semana</option>
                      <option value="mes">Este mes</option>
                    </select>
                  </div>
                </div>
                
                {/* Botón limpiar filtros */}
                {(filtroCliente !== 'all' || filtroProyecto !== 'all' || filtroTrabajador !== 'all' || filtroCategoria !== 'all' || filtroFecha !== 'all') && (
                  <div className="mt-4">
                    <button
                      onClick={() => {
                        setFiltroCliente('all');
                        setFiltroProyecto('all');
                        setFiltroTrabajador('all');
                        setFiltroCategoria('all');
                        setFiltroFecha('all');
                      }}
                      className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm font-semibold"
                    >
                      Limpiar filtros
                    </button>
                  </div>
                )}
              </div>

              {/* KPIs Principales - v1.10.0 Actualizado */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {/* Total Horas */}
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl shadow-md p-6 border border-blue-200">
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="text-sm font-semibold text-blue-800">Total Horas</h3>
                    <span className="text-2xl">⏱️</span>
                  </div>
                  <p className="text-3xl font-bold text-blue-900">{kpis.totalHoras.toFixed(1)}h</p>
                  <p className="text-xs text-blue-600 mt-1">{registrosFiltrados.length} registros</p>
                </div>
                
                {/* Horas Productivas */}
                <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-xl shadow-md p-6 border border-green-200">
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="text-sm font-semibold text-green-800">Horas Productivas</h3>
                    <span className="text-2xl">✅</span>
                  </div>
                  <p className="text-3xl font-bold text-green-900">{kpis.horasProductivas.toFixed(1)}h</p>
                  <p className="text-xs text-green-600 mt-1">{registrosProductivosFiltrados.length} registros</p>
                </div>
                
                {/* Horas Improductivas */}
                <div className="bg-gradient-to-br from-red-50 to-red-100 rounded-xl shadow-md p-6 border border-red-200">
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="text-sm font-semibold text-red-800">Horas Improductivas</h3>
                    <span className="text-2xl">⏳</span>
                  </div>
                  <p className="text-3xl font-bold text-red-900">{kpis.horasImproductivas.toFixed(1)}h</p>
                  <p className="text-xs text-red-600 mt-1">{registrosImproductivosFiltrados.length} registros</p>
                </div>
                
                {/* % Productividad */}
                <div className="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-xl shadow-md p-6 border border-emerald-200">
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="text-sm font-semibold text-emerald-800">% Productividad</h3>
                    <span className="text-2xl">📊</span>
                  </div>
                  <p className="text-3xl font-bold text-emerald-900">{kpis.porcentajeProductivo.toFixed(1)}%</p>
                  <p className="text-xs text-emerald-600 mt-1">
                    {kpis.porcentajeProductivo >= 85 ? '✅ Excelente' :
                     kpis.porcentajeProductivo >= 70 ? '🟡 Bueno' : '🔴 Crítico'}
                  </p>
                </div>
                
                {/* % Improductivo */}
                <div className="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl shadow-md p-6 border border-orange-200">
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="text-sm font-semibold text-orange-800">% Improductivo</h3>
                    <span className="text-2xl">⚠️</span>
                  </div>
                  <p className="text-3xl font-bold text-orange-900">{kpis.porcentajeImproductivo.toFixed(1)}%</p>
                  <p className="text-xs text-orange-600 mt-1">Por mejorar</p>
                </div>
                
                {/* Tendencia */}
                <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl shadow-md p-6 border border-purple-200">
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="text-sm font-semibold text-purple-800">Costo Total</h3>
                    <span className="text-2xl">💰</span>
                  </div>
                  <p className="text-3xl font-bold text-purple-900">
                    {new Intl.NumberFormat('es-CO', {
                      style: 'currency',
                      currency: 'COP',
                      minimumFractionDigits: 0,
                      maximumFractionDigits: 0
                    }).format(kpis.totalCosto)}
                  </p>
                  <p className="text-xs text-purple-600 mt-1">
                    Prod: {new Intl.NumberFormat('es-CO', {
                      style: 'currency',
                      currency: 'COP',
                      minimumFractionDigits: 0,
                      maximumFractionDigits: 0,
                      notation: 'compact'
                    }).format(kpis.costoProductivo)}
                  </p>
                </div>
              </div>

              {/* ⭐ v1.10.0 - Indicador de Productividad con Barra de Progreso */}
              <div className="bg-white rounded-xl shadow-md p-6">
                <h3 className="text-lg font-bold text-gray-800 mb-4 text-center">
                  Indicador de Productividad
                </h3>
                
                {/* Porcentaje Grande */}
                <div className="text-center mb-4">
                  <div className="text-5xl font-bold text-gray-800">
                    {kpis.porcentajeProductivo.toFixed(1)}%
                  </div>
                  <div className="text-sm font-semibold mt-2" style={{
                    color: kpis.porcentajeProductivo >= 85 ? '#10b981' :
                           kpis.porcentajeProductivo >= 70 ? '#f59e0b' : '#ef4444'
                  }}>
                    {kpis.porcentajeProductivo >= 85 ? '✅ EXCELENTE' :
                     kpis.porcentajeProductivo >= 70 ? '🟡 BUENO' : '🔴 CRÍTICO'}
                  </div>
                </div>
                
                {/* Barra de Progreso */}
                <div className="relative mb-6">
                  {/* Barra de fondo con gradiente */}
                  <div style={{
                    width: '100%',
                    height: '32px',
                    borderRadius: '16px',
                    background: 'linear-gradient(90deg, #ef4444 0%, #ef4444 70%, #f59e0b 70%, #f59e0b 85%, #10b981 85%, #10b981 100%)',
                    opacity: 0.3,
                    position: 'relative'
                  }}></div>
                  
                  {/* Indicador de progreso */}
                  <div style={{
                    position: 'absolute',
                    top: 0,
                    left: 0,
                    width: `${kpis.porcentajeProductivo}%`,
                    height: '32px',
                    borderRadius: '16px',
                    background: kpis.porcentajeProductivo >= 85 ? 
                                'linear-gradient(90deg, #10b981, #059669)' :
                                kpis.porcentajeProductivo >= 70 ?
                                'linear-gradient(90deg, #f59e0b, #d97706)' :
                                'linear-gradient(90deg, #ef4444, #dc2626)',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.15)',
                    transition: 'width 0.5s ease'
                  }}></div>
                  
                  {/* Marcador en la posición actual */}
                  <div style={{
                    position: 'absolute',
                    top: '-8px',
                    left: `${kpis.porcentajeProductivo}%`,
                    transform: 'translateX(-50%)',
                    width: '4px',
                    height: '48px',
                    background: '#1f2937',
                    borderRadius: '2px',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
                  }}></div>
                  
                  {/* Marcadores de rangos */}
                  <div style={{
                    position: 'absolute',
                    top: 0,
                    left: '70%',
                    width: '2px',
                    height: '32px',
                    background: 'rgba(255,255,255,0.5)'
                  }}></div>
                  <div style={{
                    position: 'absolute',
                    top: 0,
                    left: '85%',
                    width: '2px',
                    height: '32px',
                    background: 'rgba(255,255,255,0.5)'
                  }}></div>
                </div>
                
                {/* Etiquetas de rangos */}
                <div className="flex justify-between text-xs font-semibold px-2">
                  <div className="text-center">
                    <div className="text-red-600">0%</div>
                    <div className="text-red-500 text-xs mt-1">Crítico</div>
                  </div>
                  <div className="text-center">
                    <div className="text-amber-600">70%</div>
                    <div className="text-amber-500 text-xs mt-1">Bueno</div>
                  </div>
                  <div className="text-center">
                    <div className="text-emerald-600">85%</div>
                    <div className="text-emerald-500 text-xs mt-1">Excelente</div>
                  </div>
                  <div className="text-center">
                    <div className="text-emerald-700">100%</div>
                    <div className="text-emerald-600 text-xs mt-1">Óptimo</div>
                  </div>
                </div>
              </div>

              {/* ⭐ v1.10.0 - NUEVOS GRÁFICOS: Composición y Comparativa */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Gráfico Barras Apiladas 100% - Composición */}
                <div className="bg-white rounded-xl shadow-md p-6">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">
                    📊 Composición del Tiempo (%)
                  </h3>
                  <p className="text-sm text-gray-600 mb-4">
                    Distribución diaria: productivo vs improductivo
                  </p>
                  <div style={{ height: '350px' }}>
                    <canvas id="composicionChart"></canvas>
                  </div>
                </div>
                
                {/* Gráfico Líneas - Comparativa */}
                <div className="bg-white rounded-xl shadow-md p-6">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">
                    📈 Tendencia Comparativa
                  </h3>
                  <p className="text-sm text-gray-600 mb-4">
                    Evolución: tiempo productivo vs improductivo
                  </p>
                  <div style={{ height: '350px' }}>
                    <canvas id="comparativaChart"></canvas>
                  </div>
                </div>
              </div>

              {/* Divisor */}
              <div className="border-t border-gray-200 my-4">
                <h3 className="text-xl font-bold text-gray-700 mt-6 mb-4">
                  🔍 Detalle de Tiempos Improductivos
                </h3>
              </div>

              {/* Gráficos Improductivos */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Gráfico de Torta */}
                <div className="bg-white rounded-xl shadow-md p-6">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">
                    Distribución por Categoría
                  </h3>
                  <div style={{ height: '300px' }}>
                    <canvas id="distribucionCategoriaChart"></canvas>
                  </div>
                </div>
                
                {/* Gráfico de Barras */}
                <div className="bg-white rounded-xl shadow-md p-6">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">
                    Top 10 Causas
                  </h3>
                  <div style={{ height: '300px' }}>
                    <canvas id="topCausasChart"></canvas>
                  </div>
                </div>
              </div>

              {/* Gráfico de Líneas */}
              <div className="bg-white rounded-xl shadow-md p-6">
                <h3 className="text-lg font-bold text-gray-800 mb-4">
                  Tendencia Temporal
                </h3>
                <div style={{ height: '350px' }}>
                  <canvas id="tendenciaChart"></canvas>
                </div>
              </div>

              {/* Tabla Detallada */}
              <div className="bg-white rounded-xl shadow-md overflow-hidden">
                <div className="p-6 border-b border-gray-200">
                  <h3 className="text-lg font-bold text-gray-800">
                    Registros Detallados ({registrosFiltrados.length})
                  </h3>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trabajador</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actividad</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Detalle</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Horas</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Costo</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {registrosFiltrados.length === 0 ? (
                        <tr>
                          <td colSpan="7" className="px-6 py-8 text-center text-gray-500">
                            No hay registros que coincidan con los filtros
                          </td>
                        </tr>
                      ) : (
                        registrosFiltrados.map(reg => (
                          <tr key={reg.id} className="hover:bg-gray-50">
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                              {new Date(reg.fecha).toLocaleDateString('es-CO')}
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm">
                              <div className="font-medium text-gray-900">{reg.trabajador}</div>
                              <div className="text-gray-500">{reg.tipoTrabajador}</div>
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm">
                              {reg.esProductivo ? (
                                <span className="px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                  ✅ Productivo
                                </span>
                              ) : (
                                <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                                  reg.categoria === 'esperas' ? 'bg-red-100 text-red-800' :
                                  reg.categoria === 'permisos' ? 'bg-purple-100 text-purple-800' :
                                  'bg-gray-100 text-gray-800'
                                }`}>
                                  {reg.categoria === 'esperas' ? '⏳ Esperas' :
                                   reg.categoria === 'permisos' ? '🚪 Permisos' :
                                   '⏸️ Sin Tareas'}
                                </span>
                              )}
                            </td>
                            <td className="px-6 py-4 text-sm text-gray-900">
                              {reg.esProductivo ? (
                                <div>
                                  <div className="font-medium">{reg.disciplina}</div>
                                  <div className="text-gray-500 text-xs">{reg.tarea}</div>
                                </div>
                              ) : (
                                reg.subcategoria ? reg.subcategoria.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A'
                              )}
                            </td>
                            <td className="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">
                              {reg.esProductivo ? reg.subtarea : reg.descripcion}
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                              {reg.duracionHoras.toFixed(1)}h
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                              {new Intl.NumberFormat('es-CO', {
                                style: 'currency',
                                currency: 'COP',
                                minimumFractionDigits: 0
                              }).format(reg.costoTotal)}
                            </td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          );
        }


        // ==================== REPORTE DE SUBUTILIZACIÓN v1.7.0 ====================
        
        function ReporteSubutilizacion({ proyectos, trabajadores, clientes, tiposTrabajador, currentClienteId, userRole }) {
          const isAdmin = userRole === 'admin';
          
          // ⭐ Filtrar proyectos visibles por cliente
          const visibleProyectos = isAdmin
            ? proyectos
            : proyectos.filter(p => p.clienteId === currentClienteId);
          
          // ⭐ Datos de demostración (reemplazar con datos reales)
          const [registros] = React.useState([
            {
              id: 1,
              fecha: '2025-01-15',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              nivelTrabajador: 4,
              disciplina: 'Albañilería',
              tarea: 'Levante de muros',
              subtarea: 'Limpieza',
              nivelOptimo: 1,
              horas: 3,
              salarioPorHora: 40000,
              ubicacion: 'Torre Norte - Piso 5 - Apt 02'
            },
            {
              id: 2,
              fecha: '2025-01-15',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              nivelTrabajador: 3,
              disciplina: 'Pintura',
              tarea: 'Preparación de superficie',
              subtarea: 'Limpieza',
              nivelOptimo: 1,
              horas: 2,
              salarioPorHora: 30000,
              ubicacion: 'Torre Sur - Piso 3 - Apt 05'
            },
            {
              id: 3,
              fecha: '2025-01-16',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 1,
              trabajador: 'Carlos Ramírez',
              tipoTrabajador: 'Oficial',
              nivelTrabajador: 4,
              disciplina: 'Albañilería',
              tarea: 'Pañete',
              subtarea: 'Preparación de mezcla',
              nivelOptimo: 2,
              horas: 4,
              salarioPorHora: 40000,
              ubicacion: 'Torre Norte - Piso 6 - Apt 01'
            },
            {
              id: 4,
              fecha: '2025-01-16',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 3,
              trabajador: 'María Torres',
              tipoTrabajador: 'Maestro',
              nivelTrabajador: 5,
              disciplina: 'Estructura',
              tarea: 'Excavación',
              subtarea: 'Retiro de material',
              nivelOptimo: 1,
              horas: 2,
              salarioPorHora: 50000,
              ubicacion: 'Sótano - Zona A'
            },
            {
              id: 5,
              fecha: '2025-01-17',
              clienteId: 1,
              proyectoId: 1,
              proyecto: 'Torres del Parque',
              trabajadorId: 2,
              trabajador: 'Pedro González',
              tipoTrabajador: 'Operario',
              nivelTrabajador: 3,
              disciplina: 'Albañilería',
              tarea: 'Levante de muros',
              subtarea: 'Trazado',
              nivelOptimo: 2,
              horas: 3,
              salarioPorHora: 30000,
              ubicacion: 'Torre Norte - Piso 7 - Apt 03'
            },
          ]);

          // ⭐ Filtros mejorados
          const [filtroCliente, setFiltroCliente] = React.useState('all');
          const [filtroProyecto, setFiltroProyecto] = React.useState('all');
          const [filtroTrabajador, setFiltroTrabajador] = React.useState('all');
          const [filtroFecha, setFiltroFecha] = React.useState('all');
          
          // ⭐ v1.8.0 - NUEVO: Filtro de período para gráfico %
          const [filtroPeriodo, setFiltroPeriodo] = React.useState('semanas'); // 'dias', 'semanas', 'meses'
          

          // ⭐ v1.7.0 - MEJORA: Asignar proyectos automáticamente basado en registros
          const trabajadoresConProyectos = React.useMemo(() => {
            return (trabajadores || []).map(t => {
              // 1. Si ya tiene proyectosAsignados, usarlos
              if (t.proyectosAsignados && t.proyectosAsignados.length > 0) {
                return { ...t };
              }
              
              // 2. Si tiene proyectoId, crear array
              if (t.proyectoId) {
                return {
                  ...t,
                  proyectosAsignados: [t.proyectoId]
                };
              }
              
              // 3. CRÍTICO: Detectar proyectos de sus registros
              const proyectosDeRegistros = registros
                .filter(r => r.trabajadorId === t.id)
                .map(r => r.proyectoId)
                .filter(Boolean);
              
              const proyectosUnicos = [...new Set(proyectosDeRegistros)];
              
              return {
                ...t,
                proyectosAsignados: proyectosUnicos,
                proyectosDetectados: proyectosUnicos.length > 0, // Flag para alertar
                sinAsignacionFormal: proyectosUnicos.length > 0 && !t.proyectoId // Inconsistencia
              };
            });
          }, [trabajadores, registros]);

          
          // ⭐ Proyectos filtrados según cliente seleccionado (para admin)
          const proyectosFiltrados = React.useMemo(() => {
            if (!isAdmin) {
              // Cliente: solo sus proyectos
              return visibleProyectos;
            }
            
            // Admin: filtrar por cliente seleccionado
            if (filtroCliente === 'all') {
              return proyectos;
            }
            return proyectos.filter(p => p.clienteId === parseInt(filtroCliente));
          }, [isAdmin, filtroCliente, proyectos, visibleProyectos]);
          

          // ⭐ ANÁLISIS: Trabajadores inactivos e inconsistencias
          const analisisTrabajadores = React.useMemo(() => {
            // CASO 1: Filtro "Todos"
            if (filtroProyecto === 'all') {
              const sinAsignar = trabajadoresConProyectos.filter(t => 
                !t.proyectosAsignados || t.proyectosAsignados.length === 0
              );
              
              return {
                inactivos: [],
                inconsistencias: [],
                sinAsignar: sinAsignar || []
              };
            }
            
            // CASO 2: Filtro "Sin asignar"
            if (filtroProyecto === 'sin-asignar') {
              const sinAsignar = trabajadoresConProyectos.filter(t => 
                !t.proyectosAsignados || t.proyectosAsignados.length === 0
              );
              
              return {
                inactivos: [],
                inconsistencias: [],
                sinAsignar: sinAsignar || []
              };
            }
            
            // CASO 3: Proyecto específico
            const proyectoId = parseInt(filtroProyecto);
            
            // Trabajadores del proyecto seleccionado
            const trabajadoresProyecto = trabajadoresConProyectos.filter(t =>
              t.proyectosAsignados && t.proyectosAsignados.includes(proyectoId)
            );
            
            // IDs de trabajadores con registros en este proyecto
            const trabajadoresConRegistros = new Set(
              (registrosFiltrados || []).map(r => r.trabajadorId)
            );
            
            // INACTIVOS: Asignados pero sin registros
            const inactivos = trabajadoresProyecto.filter(t => 
              !trabajadoresConRegistros.has(t.id)
            );
            
            // INCONSISTENCIAS: Registrando sin estar asignados formalmente
            const inconsistencias = trabajadoresProyecto.filter(t => 
              t.sinAsignacionFormal && trabajadoresConRegistros.has(t.id)
            );
            
            return {
              inactivos: inactivos || [],
              inconsistencias: inconsistencias || [],
              sinAsignar: []
            };
          }, [filtroProyecto, trabajadoresConProyectos, registrosFiltrados, registros]);

          
          // ⭐ Trabajadores filtrados según proyecto seleccionado
          
          const trabajadoresFiltrados = React.useMemo(() => {
            console.log('🔍 DEBUG trabajadoresFiltrados:');
            console.log('  filtroProyecto:', filtroProyecto);
            console.log('  Total trabajadores recibidos:', trabajadoresConProyectos.length);
            
            if (filtroProyecto === 'all') {
              console.log('  → Retornando TODOS los trabajadores');
              return trabajadoresConProyectos;
            }
            
            // NUEVO: Filtro para trabajadores sin asignar
            if (filtroProyecto === 'sin-asignar') {
              const sinAsignar = trabajadoresConProyectos.filter(t => 
                !t.proyectosAsignados || t.proyectosAsignados.length === 0
              );
              console.log('  → Trabajadores sin asignar:', sinAsignar.length);
              return sinAsignar;
            }
            
            // Filtrar trabajadores asignados al proyecto seleccionado
            const filtrados = trabajadoresConProyectos.filter(t => {
              const tieneProyectos = t.proyectosAsignados && Array.isArray(t.proyectosAsignados);
              const incluyeProyecto = tieneProyectos && t.proyectosAsignados.includes(parseInt(filtroProyecto));
              
              if (tieneProyectos) {
                console.log(`  ${t.nombre}: proyectos=[${t.proyectosAsignados}], incluye ${filtroProyecto}?`, incluyeProyecto);
              } else {
                console.log(`  ${t.nombre}: ❌ SIN proyectosAsignados`);
              }
              
              return incluyeProyecto;
            });
            
            console.log('  → Resultado: ' + filtrados.length + ' trabajadores');
            return filtrados;
          }, [filtroProyecto, trabajadoresConProyectos]);


          // Calcular salarios óptimos por nivel
          const salariosOptimos = {
            1: 15000, // Peón
            2: 20000, // Ayudante
            3: 30000, // Operario
            4: 40000, // Oficial
            5: 50000  // Maestro
          };

          // Calcular sobrecostos
          const registrosConSobrecosto = registros.map(reg => {
            const diferenciaNivel = reg.nivelTrabajador - reg.nivelOptimo;
            const salarioOptimo = salariosOptimos[reg.nivelOptimo];
            const sobrecostoPorHora = reg.salarioPorHora - salarioOptimo;
            const sobrecostoTotal = sobrecostoPorHora * reg.horas;
            
            return {
              ...reg,
              diferenciaNivel,
              salarioOptimo,
              sobrecostoPorHora,
              sobrecostoTotal
            };
          });

          // ⭐ FILTRAR POR CLIENTE (SEGURIDAD)
          const registrosDelCliente = isAdmin
            ? registrosConSobrecosto
            : registrosConSobrecosto.filter(r => r.clienteId === currentClienteId);
          
          // Filtrar
          const registrosFiltrados = registrosDelCliente.filter(reg => {
            // Filtro por cliente (admin)
            if (isAdmin && filtroCliente !== 'all' && reg.clienteId !== parseInt(filtroCliente)) return false;
            
            // Filtro por proyecto
            if (filtroProyecto !== 'all' && reg.proyectoId !== parseInt(filtroProyecto)) return false;
            
            // Filtro por trabajador
            if (filtroTrabajador !== 'all' && reg.trabajadorId !== parseInt(filtroTrabajador)) return false;
            if (filtroFecha !== 'all') {
              // Implementar filtro de fecha
            }
            return true;
          });

          // Calcular totales
          const stats = {
            totalRegistros: registrosFiltrados.length,
            horasTotal: registrosFiltrados.reduce((sum, r) => sum + r.horas, 0),
            sobrecostoTotal: registrosFiltrados.reduce((sum, r) => sum + r.sobrecostoTotal, 0),
            promedioSobrecosto: 0
          };
          stats.promedioSobrecosto = stats.totalRegistros > 0 
            ? Math.round(stats.sobrecostoTotal / stats.totalRegistros) 
            : 0;

          // TOP 10 subtareas
          const subtareasAgrupadas = {};
          registrosFiltrados.forEach(reg => {
            const key = `${reg.tarea} - ${reg.subtarea}`;
            if (!subtareasAgrupadas[key]) {
              subtareasAgrupadas[key] = {
                nombre: key,
                ocurrencias: 0,
                horasTotal: 0,
                sobrecostoTotal: 0
              };
            }
            subtareasAgrupadas[key].ocurrencias++;
            subtareasAgrupadas[key].horasTotal += reg.horas;
            subtareasAgrupadas[key].sobrecostoTotal += reg.sobrecostoTotal;
          });

          const top10Subtareas = Object.values(subtareasAgrupadas)
            .sort((a, b) => b.sobrecostoTotal - a.sobrecostoTotal)
            .slice(0, 10);

          // Distribución por nivel de diferencia
          const distribucionNivel = {
            1: registrosFiltrados.filter(r => r.diferenciaNivel === 1).length,
            2: registrosFiltrados.filter(r => r.diferenciaNivel === 2).length,
            3: registrosFiltrados.filter(r => r.diferenciaNivel === 3).length,
            4: registrosFiltrados.filter(r => r.diferenciaNivel === 4).length,
          };

          // ⭐ v1.8.0 - NUEVO: Agrupar datos por período (días/semanas/meses)
          const datosPorPeriodo = React.useMemo(() => {
            const agrupados = {};
            
            registrosFiltrados.forEach(reg => {
              let clave;
              const fecha = new Date(reg.fecha);
              
              if (filtroPeriodo === 'dias') {
                // Últimos 7 días
                clave = reg.fecha;
              } else if (filtroPeriodo === 'semanas') {
                // Últimas 4 semanas - Agrupar por semana
                const inicioSemana = new Date(fecha);
                inicioSemana.setDate(fecha.getDate() - fecha.getDay());
                clave = inicioSemana.toISOString().split('T')[0];
              } else if (filtroPeriodo === 'meses') {
                // Todos los meses - Agrupar por mes
                clave = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
              }
              
              if (!agrupados[clave]) {
                agrupados[clave] = {
                  costoOptimo: 0,
                  costoReal: 0,
                  sobrecosto: 0,
                  fecha: clave
                };
              }
              
              const costoReal = reg.salarioPorHora * reg.horas;
              const costoOptimo = reg.salarioOptimo * reg.horas;
              
              agrupados[clave].costoOptimo += costoOptimo;
              agrupados[clave].costoReal += costoReal;
              agrupados[clave].sobrecosto += reg.sobrecostoTotal;
            });
            
            // Convertir a array y ordenar
            let resultado = Object.values(agrupados).sort((a, b) => 
              a.fecha.localeCompare(b.fecha)
            );
            
            // Filtrar según el período
            if (filtroPeriodo === 'dias') {
              // Últimos 7 días
              resultado = resultado.slice(-7);
            } else if (filtroPeriodo === 'semanas') {
              // Últimas 4 semanas
              resultado = resultado.slice(-4);
            }
            // Para meses, mostrar todos
            
            return resultado;
          }, [registrosFiltrados, filtroPeriodo]);

          // Gráfica de distribución
          React.useEffect(() => {
            const ctx = document.getElementById('distribucionNivelChart');
            if (ctx) {
              const existingChart = Chart.getChart(ctx);
              if (existingChart) existingChart.destroy();
              
              new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: ['1 nivel', '2 niveles', '3 niveles', '4 niveles'],
                  datasets: [{
                    label: 'Cantidad de registros',
                    data: [distribucionNivel[1], distribucionNivel[2], distribucionNivel[3], distribucionNivel[4]],
                    backgroundColor: ['#fbbf24', '#f97316', '#ef4444', '#dc2626'],
                    borderRadius: 8
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: { display: false },
                    title: {
                      display: true,
                      text: 'Distribución por Nivel de Sobrecalificación'
                    }
                  },
                  scales: {
                    y: { beginAtZero: true }
                  }
                }
              });
            }
          }, [registrosFiltrados]);

          // ⭐ v1.7.3 - MEJORADO: Gráfica Combinada (Barras + Línea)
          React.useEffect(() => {
            const ctx = document.getElementById('comparacionCostosChart');
            if (ctx) {
              const existingChart = Chart.getChart(ctx);
              if (existingChart) existingChart.destroy();
              
              // Agrupar datos por fecha para el gráfico
              const datosPorFecha = {};
              
              registrosFiltrados.forEach(reg => {
                if (!datosPorFecha[reg.fecha]) {
                  datosPorFecha[reg.fecha] = {
                    costoOptimo: 0,
                    costoReal: 0,
                    sobrecosto: 0
                  };
                }
                
                // Costo real = lo que se pagó
                const costoReal = reg.salarioPorHora * reg.horas;
                
                // Costo óptimo = lo que debería costar con el nivel óptimo
                const costoOptimo = reg.salarioOptimo * reg.horas;
                
                datosPorFecha[reg.fecha].costoOptimo += costoOptimo;
                datosPorFecha[reg.fecha].costoReal += costoReal;
                datosPorFecha[reg.fecha].sobrecosto += reg.sobrecostoTotal;
              });
              
              // Convertir a arrays ordenados por fecha
              const fechasOrdenadas = Object.keys(datosPorFecha).sort();
              const costosOptimos = fechasOrdenadas.map(fecha => datosPorFecha[fecha].costoOptimo);
              const costosReales = fechasOrdenadas.map(fecha => datosPorFecha[fecha].costoReal);
              const sobrecostos = fechasOrdenadas.map(fecha => datosPorFecha[fecha].sobrecosto);
              
              // Formatear fechas para mejor visualización
              const fechasFormateadas = fechasOrdenadas.map(fecha => {
                const [year, month, day] = fecha.split('-');
                return `${day}/${month}`;
              });
              
              new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: fechasFormateadas,
                  datasets: [
                    {
                      label: 'Costo Óptimo',
                      data: costosOptimos,
                      backgroundColor: 'rgba(34, 197, 94, 0.85)',
                      borderColor: 'rgb(34, 197, 94)',
                      borderWidth: 2,
                      borderRadius: 6,
                      order: 2,
                      yAxisID: 'y'
                    },
                    {
                      label: 'Costo Real',
                      data: costosReales,
                      backgroundColor: 'rgba(239, 68, 68, 0.85)',
                      borderColor: 'rgb(239, 68, 68)',
                      borderWidth: 2,
                      borderRadius: 6,
                      order: 2,
                      yAxisID: 'y'
                    },
                    {
                      label: 'Sobrecosto',
                      data: sobrecostos,
                      type: 'line',
                      backgroundColor: 'rgba(249, 115, 22, 0.1)',
                      borderColor: 'rgb(249, 115, 22)',
                      borderWidth: 3,
                      pointRadius: 6,
                      pointHoverRadius: 8,
                      pointBackgroundColor: 'rgb(249, 115, 22)',
                      pointBorderColor: '#fff',
                      pointBorderWidth: 2,
                      pointHoverBackgroundColor: 'rgb(249, 115, 22)',
                      pointHoverBorderColor: '#fff',
                      fill: true,
                      tension: 0.4,
                      order: 1,
                      yAxisID: 'y'
                    }
                  ]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  interaction: {
                    mode: 'index',
                    intersect: false
                  },
                  plugins: {
                    legend: {
                      display: true,
                      position: 'top',
                      labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: {
                          size: 13,
                          weight: 'bold'
                        },
                        generateLabels: function(chart) {
                          const datasets = chart.data.datasets;
                          return datasets.map((dataset, i) => ({
                            text: dataset.label,
                            fillStyle: dataset.borderColor,
                            strokeStyle: dataset.borderColor,
                            lineWidth: dataset.type === 'line' ? 3 : 0,
                            hidden: !chart.isDatasetVisible(i),
                            index: i,
                            pointStyle: dataset.type === 'line' ? 'line' : 'rect'
                          }));
                        }
                      }
                    },
                    title: {
                      display: true,
                      text: 'Comparación de Costos por Fecha',
                      font: {
                        size: 16,
                        weight: 'bold'
                      },
                      padding: {
                        bottom: 20
                      }
                    },
                    tooltip: {
                      callbacks: {
                        title: function(context) {
                          return 'Fecha: ' + context[0].label;
                        },
                        label: function(context) {
                          let label = context.dataset.label || '';
                          if (label) {
                            label += ': ';
                          }
                          // Formatear como moneda colombiana
                          label += new Intl.NumberFormat('es-CO', {
                            style: 'currency',
                            currency: 'COP',
                            minimumFractionDigits: 0
                          }).format(context.parsed.y);
                          
                          return label;
                        },
                        afterLabel: function(context) {
                          // Mostrar porcentaje de sobrecosto
                          if (context.datasetIndex === 2) {
                            const fecha = fechasOrdenadas[context.dataIndex];
                            const optimo = datosPorFecha[fecha].costoOptimo;
                            const sobrecosto = datosPorFecha[fecha].sobrecosto;
                            if (optimo > 0) {
                              const porcentaje = ((sobrecosto / optimo) * 100).toFixed(1);
                              return `(+${porcentaje}% sobre óptimo)`;
                            }
                          }
                          return '';
                        },
                        footer: function(context) {
                          // Mostrar resumen en el footer
                          const dataIndex = context[0].dataIndex;
                          const fecha = fechasOrdenadas[dataIndex];
                          const datos = datosPorFecha[fecha];
                          
                          return [
                            '─────────────────',
                            'Total Real: ' + new Intl.NumberFormat('es-CO', {
                              style: 'currency',
                              currency: 'COP',
                              minimumFractionDigits: 0
                            }).format(datos.costoReal)
                          ].join('\n');
                        }
                      },
                      backgroundColor: 'rgba(0, 0, 0, 0.85)',
                      padding: 16,
                      titleFont: {
                        size: 15,
                        weight: 'bold'
                      },
                      bodyFont: {
                        size: 14
                      },
                      footerFont: {
                        size: 13,
                        weight: 'normal'
                      },
                      displayColors: true,
                      boxPadding: 6
                    }
                  },
                  scales: {
                    x: {
                      grid: {
                        display: false
                      },
                      ticks: {
                        font: {
                          weight: 'bold',
                          size: 12
                        }
                      }
                    },
                    y: {
                      beginAtZero: true,
                      position: 'left',
                      ticks: {
                        callback: function(value) {
                          // Formatear eje Y como moneda
                          return '$' + (value / 1000) + 'k';
                        },
                        font: {
                          size: 11
                        }
                      },
                      grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                      }
                    }
                  }
                }
              });
            }
          }, [registrosFiltrados]);

          // ⭐ v1.8.0 - NUEVO: Gráfico de Barras Apiladas en %
          React.useEffect(() => {
            const ctx = document.getElementById('eficienciaChart');
            if (ctx && datosPorPeriodo.length > 0) {
              const existingChart = Chart.getChart(ctx);
              if (existingChart) existingChart.destroy();
              
              // Calcular porcentajes
              const porcentajesOptimo = datosPorPeriodo.map(d => {
                const total = d.costoReal;
                return total > 0 ? (d.costoOptimo / total) * 100 : 0;
              });
              
              const porcentajesSobre = datosPorPeriodo.map(d => {
                const total = d.costoReal;
                return total > 0 ? (d.sobrecosto / total) * 100 : 0;
              });
              
              // Formatear etiquetas según período
              const etiquetas = datosPorPeriodo.map(d => {
                if (filtroPeriodo === 'dias') {
                  const [year, month, day] = d.fecha.split('-');
                  return `${day}/${month}`;
                } else if (filtroPeriodo === 'semanas') {
                  const fecha = new Date(d.fecha);
                  const finSemana = new Date(fecha);
                  finSemana.setDate(fecha.getDate() + 6);
                  return `${fecha.getDate()}/${fecha.getMonth() + 1} - ${finSemana.getDate()}/${finSemana.getMonth() + 1}`;
                } else {
                  const [year, month] = d.fecha.split('-');
                  const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                  return `${meses[parseInt(month) - 1]} ${year}`;
                }
              });
              
              new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: etiquetas,
                  datasets: [
                    {
                      label: 'Eficiente (Costo Óptimo)',
                      data: porcentajesOptimo,
                      backgroundColor: 'rgba(34, 197, 94, 0.85)',
                      borderColor: 'rgb(34, 197, 94)',
                      borderWidth: 2
                    },
                    {
                      label: 'Sobrecosto',
                      data: porcentajesSobre,
                      backgroundColor: 'rgba(249, 115, 22, 0.85)',
                      borderColor: 'rgb(249, 115, 22)',
                      borderWidth: 2
                    }
                  ]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  interaction: {
                    mode: 'index',
                    intersect: false
                  },
                  plugins: {
                    legend: {
                      display: true,
                      position: 'top',
                      labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                          size: 13,
                          weight: 'bold'
                        }
                      }
                    },
                    title: {
                      display: true,
                      text: 'Eficiencia por Período (%)',
                      font: {
                        size: 16,
                        weight: 'bold'
                      },
                      padding: {
                        bottom: 20
                      }
                    },
                    tooltip: {
                      callbacks: {
                        title: function(context) {
                          return context[0].label;
                        },
                        label: function(context) {
                          const label = context.dataset.label || '';
                          const valor = context.parsed.y.toFixed(1);
                          return `${label}: ${valor}%`;
                        },
                        footer: function(context) {
                          const dataIndex = context[0].dataIndex;
                          const datos = datosPorPeriodo[dataIndex];
                          
                          return [
                            '─────────────────',
                            'Costo Óptimo: ' + new Intl.NumberFormat('es-CO', {
                              style: 'currency',
                              currency: 'COP',
                              minimumFractionDigits: 0
                            }).format(datos.costoOptimo),
                            'Costo Real: ' + new Intl.NumberFormat('es-CO', {
                              style: 'currency',
                              currency: 'COP',
                              minimumFractionDigits: 0
                            }).format(datos.costoReal),
                            'Sobrecosto: ' + new Intl.NumberFormat('es-CO', {
                              style: 'currency',
                              currency: 'COP',
                              minimumFractionDigits: 0
                            }).format(datos.sobrecosto)
                          ].join('\n');
                        }
                      },
                      backgroundColor: 'rgba(0, 0, 0, 0.85)',
                      padding: 16,
                      titleFont: {
                        size: 15,
                        weight: 'bold'
                      },
                      bodyFont: {
                        size: 14
                      },
                      footerFont: {
                        size: 13,
                        weight: 'normal'
                      }
                    }
                  },
                  scales: {
                    x: {
                      stacked: true,
                      grid: {
                        display: false
                      },
                      ticks: {
                        font: {
                          weight: 'bold',
                          size: 11
                        }
                      }
                    },
                    y: {
                      stacked: true,
                      beginAtZero: true,
                      max: 100,
                      ticks: {
                        callback: function(value) {
                          return value + '%';
                        },
                        font: {
                          size: 11
                        }
                      },
                      grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                      }
                    }
                  }
                }
              });
            }
          }, [datosPorPeriodo, filtroPeriodo]);

          return (
            <div className="space-y-6">
              <div>
                <h2 className="text-3xl font-bold text-gray-800 mb-2">
                  {isAdmin ? '📊 Reporte de Subutilización - Global' : '📊 Mi Reporte de Subutilización'}
                </h2>
                <p className="text-gray-600">
                  {isAdmin 
                    ? 'Análisis detallado de trabajadores sobrecalificados y sobrecostos generados en todos los proyectos'
                    : 'Análisis de subutilización en tus proyectos y cálculo de sobrecostos'}
                </p>
              </div>

              {/* KPIs de Sobrecostos */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div className="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl shadow-md p-6 text-white">
                  <div className="text-sm opacity-90 mb-1">
                    {isAdmin ? 'Registros Afectados (Global)' : 'Registros Afectados en Mis Proyectos'}
                  </div>
                  <div className="text-3xl font-bold">{stats.totalRegistros}</div>
                  <div className="text-xs opacity-75 mt-2">Con subutilización</div>
                </div>

                <div className="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-md p-6 text-white">
                  <div className="text-sm opacity-90 mb-1">Horas Subutilizadas</div>
                  <div className="text-3xl font-bold">{stats.horasTotal}h</div>
                  <div className="text-xs opacity-75 mt-2">Total acumulado</div>
                </div>

                <div className="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-md p-6 text-white">
                  <div className="text-sm opacity-90 mb-1">Sobrecosto Total</div>
                  <div className="text-2xl font-bold">{formatCurrency(stats.sobrecostoTotal)}</div>
                  <div className="text-xs opacity-75 mt-2">Costo adicional</div>
                </div>

                <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-md p-6 text-white">
                  <div className="text-sm opacity-90 mb-1">Promedio por Registro</div>
                  <div className="text-2xl font-bold">{formatCurrency(stats.promedioSobrecosto)}</div>
                  <div className="text-xs opacity-75 mt-2">Sobrecosto medio</div>
                </div>
              </div>

              {/* ⭐ v1.7.1 - NUEVO: Panel de Actividad de Trabajadores */}
              {filtroProyecto !== 'all' && filtroProyecto !== 'sin-asignar' && (
                <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-lg font-bold text-gray-800">
                      📊 Análisis de Actividad - {proyectosFiltrados.find(p => p.id === parseInt(filtroProyecto))?.nombre}
                    </h3>
                  </div>
                  
                  {/* Resumen de Actividad */}
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    {/* Trabajadores Activos */}
                    <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                      <div className="flex items-center gap-3">
                        <div className="text-3xl">✓</div>
                        <div>
                          <div className="text-2xl font-bold text-green-700">
                            {trabajadoresFiltrados.filter(t => 
                              registrosFiltrados.some(r => r.trabajadorId === t.id)
                            ).length}
                          </div>
                          <div className="text-sm text-green-600">Con Registros</div>
                        </div>
                      </div>
                    </div>
                    
                    {/* Trabajadores Inactivos */}
                    <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-4 border border-yellow-200">
                      <div className="flex items-center gap-3">
                        <div className="text-3xl">⚠️</div>
                        <div>
                          <div className="text-2xl font-bold text-yellow-700">
                            {(analisisTrabajadores.inactivos || []).length}
                          </div>
                          <div className="text-sm text-yellow-600">Sin Actividad</div>
                        </div>
                      </div>
                    </div>
                    
                    {/* Total Asignados */}
                    <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                      <div className="flex items-center gap-3">
                        <div className="text-3xl">👥</div>
                        <div>
                          <div className="text-2xl font-bold text-blue-700">
                            {trabajadoresFiltrados.length}
                          </div>
                          <div className="text-sm text-blue-600">Total Asignados</div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* Lista de Trabajadores Inactivos */}
                  {(analisisTrabajadores.inactivos || []).length > 0 && (
                    <div className="mt-4">
                      <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                        <div className="flex items-start">
                          <div className="text-2xl mr-3">⚠️</div>
                          <div className="flex-1">
                            <h4 className="font-bold text-yellow-800 mb-2">
                              Trabajadores Sin Actividad Registrada
                            </h4>
                            <p className="text-sm text-yellow-700 mb-3">
                              Estos trabajadores están asignados al proyecto pero no tienen registros de subutilización:
                            </p>
                            <div className="space-y-2">
                              {(analisisTrabajadores.inactivos || []).map(trabajador => {
                                const tipo = (tiposTrabajador || []).find(tt => tt.id === trabajador.tipoTrabajadorId);
                                return (
                                  <div key={trabajador.id} className="bg-white rounded-lg p-3 flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                      <div className="w-10 h-10 bg-yellow-200 rounded-full flex items-center justify-center text-lg">
                                        👤
                                      </div>
                                      <div>
                                        <div className="font-semibold text-gray-900">{trabajador.nombre}</div>
                                        <div className="text-sm text-gray-600">{tipo?.nombre || 'N/A'}</div>
                                      </div>
                                    </div>
                                    <div className="text-right">
                                      <div className="text-xs text-gray-500">Sin registros</div>
                                      <div className="text-xs text-yellow-600 font-medium">Verificar actividad</div>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* Mensaje cuando todos están activos */}
                  {(analisisTrabajadores.inactivos || []).length === 0 && trabajadoresFiltrados.length > 0 && (
                    <div className="bg-green-50 border-l-4 border-green-400 p-4 rounded">
                      <div className="flex items-center">
                        <div className="text-2xl mr-3">✅</div>
                        <div>
                          <h4 className="font-bold text-green-800">¡Excelente!</h4>
                          <p className="text-sm text-green-700">
                            Todos los trabajadores asignados a este proyecto tienen registros de actividad.
                          </p>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Filtros */}

              {/* ⭐ v1.7.0 - Filtros Mejorados */}
              <div className="bg-white rounded-xl shadow-md p-6">
                <h3 className="text-lg font-bold text-gray-800 mb-4">Filtros</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  
                  {/* ⭐ ADMIN: Filtro por Cliente primero */}
                  {isAdmin && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Cliente
                      </label>
                      <select
                        value={filtroCliente}
                        onChange={(e) => {
                          setFiltroCliente(e.target.value);
                          setFiltroProyecto('all'); // Reset proyecto al cambiar cliente
                        }}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="all">Todos los clientes</option>
                        {(clientes || []).map(c => (
                          <option key={c.id} value={c.id}>{c.nombre}</option>
                        ))}
                      </select>
                    </div>
                  )}


                  {/* Filtro por Proyecto */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Proyecto
                    </label>
                    <select
                      value={filtroProyecto}
                      onChange={(e) => setFiltroProyecto(e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="all">
                        {isAdmin ? 'Todos los proyectos' : 'Mis proyectos'}
                      </option>
                      {(proyectosFiltrados || []).map(p => (
                        <option key={p.id} value={p.id}>{p.nombre}</option>
                      ))}
                      <option value="sin-asignar" className="bg-blue-50">
                        👥 Sin asignar
                      </option>
                    </select>
                  </div>



                  {/* Filtro por Trabajador con Indicadores */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Trabajador
                    </label>
                    <select
                      value={filtroTrabajador}
                      onChange={(e) => setFiltroTrabajador(e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="all">Todos los trabajadores</option>
                      {(trabajadoresFiltrados || []).map(t => {
                        // Verificar si tiene registros
                        const tieneRegistros = registrosFiltrados.some(r => r.trabajadorId === t.id);
                        
                        // Verificar si es inconsistencia (registra sin estar asignado)
                        const esInconsistencia = t.sinAsignacionFormal;
                        
                        // Seleccionar indicador
                        let indicador = '';
                        if (esInconsistencia) {
                          indicador = ' 🚨'; // Inconsistencia crítica
                        } else if (tieneRegistros) {
                          indicador = ' ✓'; // Tiene registros
                        } else if (filtroProyecto !== 'all' && filtroProyecto !== 'sin-asignar') {
                          indicador = ' ⚠️'; // Asignado pero sin registros
                        }
                        
                        return (
                          <option key={t.id} value={t.id}>
                            {t.nombre}{indicador}
                          </option>
                        );
                      })}
                    </select>
                    
                    {/* Leyenda de indicadores - Mejorada v1.7.1 */}
                    {filtroProyecto !== 'all' && trabajadoresFiltrados.length > 0 && (
                      <div className="mt-3 bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div className="text-xs font-semibold text-blue-900 mb-2">Indicadores:</div>
                        <div className="grid grid-cols-1 gap-1.5 text-xs">
                          <div className="flex items-center gap-2">
                            <span className="text-base">✓</span>
                            <span className="text-green-700 font-medium">Con registros de subutilización</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className="text-base">⚠️</span>
                            <span className="text-yellow-700 font-medium">Sin actividad registrada</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className="text-base">🚨</span>
                            <span className="text-red-700 font-medium">Inconsistencia (registra sin asignación)</span>
                          </div>
                        </div>
                      </div>
                    )}
                    {filtroProyecto === 'all' && (
                      <div className="mt-2 text-xs text-gray-500 italic">
                        Selecciona un proyecto específico para ver indicadores de actividad
                      </div>
                    )}
                  </div>


                  {/* Filtro por Período */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Período
                    </label>
                    <select
                      value={filtroFecha}
                      onChange={(e) => setFiltroFecha(e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="all">Todo el período</option>
                      <option value="hoy">Hoy</option>
                      <option value="semana">Esta semana</option>
                      <option value="mes">Este mes</option>
                    </select>
                  </div>
                </div>
                
                {/* Indicador de filtros activos */}
                {(filtroCliente !== 'all' || filtroProyecto !== 'all' || filtroTrabajador !== 'all' || filtroFecha !== 'all') && (
                  <div className="mt-4 flex items-center gap-2 flex-wrap">
                    <span className="text-sm text-gray-600">Filtros activos:</span>
                    {isAdmin && filtroCliente !== 'all' && (
                      <span className="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">
                        Cliente: {clientes.find(c => c.id === parseInt(filtroCliente))?.nombre}
                      </span>
                    )}
                    {filtroProyecto !== 'all' && (
                      <span className="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs">
                        Proyecto: {proyectosFiltrados.find(p => p.id === parseInt(filtroProyecto))?.nombre}
                      </span>
                    )}
                    {filtroTrabajador !== 'all' && (
                      <span className="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-xs">
                        Trabajador seleccionado
                      </span>
                    )}
                    {filtroFecha !== 'all' && (
                      <span className="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-xs">
                        {filtroFecha === 'hoy' ? 'Hoy' : filtroFecha === 'semana' ? 'Esta semana' : 'Este mes'}
                      </span>
                    )}
                    <button
                      onClick={() => {
                        setFiltroCliente('all');
                        setFiltroProyecto('all');
                        setFiltroTrabajador('all');
                        setFiltroFecha('all');
                      }}
                      className="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs hover:bg-gray-200"
                    >
                      Limpiar filtros
                    </button>
                  </div>
                )}
              </div>


              {/* Gráfica y TOP 10 */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="bg-white rounded-xl shadow-md p-6">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">
                    Distribución por Nivel
                  </h3>
                  <div style={{ height: '300px' }}>
                    <canvas id="distribucionNivelChart"></canvas>
                  </div>
                </div>

                <div className="bg-white rounded-xl shadow-md p-6">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">
                    TOP 10 Subtareas Afectadas
                  </h3>
                  <div className="space-y-2 max-h-80 overflow-y-auto">
                    {top10Subtareas.map((subtarea, index) => (
                      <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div className="flex-1">
                          <div className="font-medium text-sm text-gray-900">{subtarea.nombre}</div>
                          <div className="text-xs text-gray-500">
                            {subtarea.ocurrencias} registros • {subtarea.horasTotal}h
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="font-bold text-red-600">
                            {formatCurrency(subtarea.sobrecostoTotal)}
                          </div>
                          <div className="text-xs text-gray-500">sobrecosto</div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>


              {/* ⭐ v1.8.0 - NUEVO: Gráfico de Eficiencia en % */}
              <div className="bg-white rounded-xl shadow-md p-6 mt-6">
                <div className="mb-4">
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="text-lg font-bold text-gray-800">
                      📊 Eficiencia por Período
                    </h3>
                    
                    {/* Filtro de Período */}
                    <div className="flex gap-2">
                      <button
                        onClick={() => setFiltroPeriodo('dias')}
                        className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all ${
                          filtroPeriodo === 'dias'
                            ? 'bg-purple-600 text-white shadow-md'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}
                      >
                        📅 Días
                      </button>
                      <button
                        onClick={() => setFiltroPeriodo('semanas')}
                        className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all ${
                          filtroPeriodo === 'semanas'
                            ? 'bg-purple-600 text-white shadow-md'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}
                      >
                        📆 Semanas
                      </button>
                      <button
                        onClick={() => setFiltroPeriodo('meses')}
                        className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all ${
                          filtroPeriodo === 'meses'
                            ? 'bg-purple-600 text-white shadow-md'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}
                      >
                        📊 Meses
                      </button>
                    </div>
                  </div>
                  
                  <p className="text-sm text-gray-600">
                    {filtroPeriodo === 'dias' && 'Últimos 7 días: % de eficiencia vs sobrecosto'}
                    {filtroPeriodo === 'semanas' && 'Últimas 4 semanas: % de eficiencia vs sobrecosto'}
                    {filtroPeriodo === 'meses' && 'Todos los meses: % de eficiencia vs sobrecosto'}
                  </p>
                </div>
                
                <div style={{ height: '400px' }}>
                  <canvas id="eficienciaChart"></canvas>
                </div>
                
                {/* KPIs de Resumen */}
                {datosPorPeriodo.length > 0 && (
                  <div className="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                    {/* Eficiencia Promedio */}
                    <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                      <div className="text-sm text-blue-700 font-medium mb-1">Eficiencia Promedio</div>
                      <div className="text-2xl font-bold text-blue-900">
                        {(
                          (datosPorPeriodo.reduce((sum, d) => sum + (d.costoOptimo / d.costoReal) * 100, 0) / 
                          datosPorPeriodo.length) || 0
                        ).toFixed(1)}%
                      </div>
                      <div className="text-xs text-blue-600 mt-1">
                        {datosPorPeriodo.length} {filtroPeriodo === 'dias' ? 'días' : filtroPeriodo === 'semanas' ? 'semanas' : 'meses'}
                      </div>
                    </div>
                    
                    {/* Mejor Período */}
                    <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                      <div className="text-sm text-green-700 font-medium mb-1">Mejor Período</div>
                      <div className="text-2xl font-bold text-green-900">
                        {(() => {
                          const mejor = datosPorPeriodo.reduce((max, d) => 
                            ((d.costoOptimo / d.costoReal) > (max.costoOptimo / max.costoReal)) ? d : max
                          , datosPorPeriodo[0]);
                          return ((mejor.costoOptimo / mejor.costoReal) * 100).toFixed(1);
                        })()}%
                      </div>
                      <div className="text-xs text-green-600 mt-1">Mayor eficiencia</div>
                    </div>
                    
                    {/* Peor Período */}
                    <div className="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border border-orange-200">
                      <div className="text-sm text-orange-700 font-medium mb-1">Peor Período</div>
                      <div className="text-2xl font-bold text-orange-900">
                        {(() => {
                          const peor = datosPorPeriodo.reduce((min, d) => 
                            ((d.costoOptimo / d.costoReal) < (min.costoOptimo / min.costoReal)) ? d : min
                          , datosPorPeriodo[0]);
                          return ((peor.costoOptimo / peor.costoReal) * 100).toFixed(1);
                        })()}%
                      </div>
                      <div className="text-xs text-orange-600 mt-1">Menor eficiencia</div>
                    </div>
                    
                    {/* Tendencia */}
                    <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200">
                      <div className="text-sm text-purple-700 font-medium mb-1">Tendencia</div>
                      <div className="text-2xl font-bold text-purple-900">
                        {(() => {
                          if (datosPorPeriodo.length < 2) return '—';
                          const primera = (datosPorPeriodo[0].costoOptimo / datosPorPeriodo[0].costoReal) * 100;
                          const ultima = (datosPorPeriodo[datosPorPeriodo.length - 1].costoOptimo / datosPorPeriodo[datosPorPeriodo.length - 1].costoReal) * 100;
                          const diff = ultima - primera;
                          return diff > 0 ? '📈 +' + diff.toFixed(1) + '%' : '📉 ' + diff.toFixed(1) + '%';
                        })()}
                      </div>
                      <div className="text-xs text-purple-600 mt-1">
                        {(() => {
                          if (datosPorPeriodo.length < 2) return 'Sin datos';
                          const primera = (datosPorPeriodo[0].costoOptimo / datosPorPeriodo[0].costoReal) * 100;
                          const ultima = (datosPorPeriodo[datosPorPeriodo.length - 1].costoOptimo / datosPorPeriodo[datosPorPeriodo.length - 1].costoReal) * 100;
                          return ultima > primera ? 'Mejorando' : 'Empeorando';
                        })()}
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Leyenda */}
                <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div className="bg-green-50 border-l-4 border-green-500 p-3 rounded">
                    <div className="flex items-center gap-2">
                      <div className="w-4 h-4 bg-green-500 rounded"></div>
                      <span className="text-sm font-semibold text-green-900">Eficiente (Costo Óptimo)</span>
                    </div>
                    <p className="text-xs text-green-700 mt-1">
                      % del costo total que representa el costo óptimo (nivel apropiado)
                    </p>
                  </div>
                  <div className="bg-orange-50 border-l-4 border-orange-500 p-3 rounded">
                    <div className="flex items-center gap-2">
                      <div className="w-4 h-4 bg-orange-500 rounded"></div>
                      <span className="text-sm font-semibold text-orange-900">Sobrecosto</span>
                    </div>
                    <p className="text-xs text-orange-700 mt-1">
                      % del costo total que representa el sobrecosto por subutilización
                    </p>
                  </div>
                </div>
              </div>


              {/* ⭐ v1.7.2 - NUEVO: Gráfico de Comparación de Costos */}
              <div className="bg-white rounded-xl shadow-md p-6 mt-6">
                <div className="mb-4">
                  <h3 className="text-lg font-bold text-gray-800 mb-2">
                    💰 Comparación de Costos: Óptimo vs Real
                  </h3>
                  <p className="text-sm text-gray-600">
                    Visualiza el impacto económico de la subutilización. Las barras verdes muestran lo que 
                    debería costar (nivel óptimo), las rojas lo que realmente cuesta (nivel actual).
                  </p>
                </div>
                <div style={{ height: '400px' }}>
                  <canvas id="comparacionCostosChart"></canvas>
                </div>
                
                {/* Leyenda explicativa */}
                <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div className="bg-green-50 border-l-4 border-green-500 p-3 rounded">
                    <div className="flex items-center gap-2">
                      <div className="w-4 h-4 bg-green-500 rounded"></div>
                      <span className="text-sm font-semibold text-green-900">🟩 Costo Óptimo</span>
                    </div>
                    <p className="text-xs text-green-700 mt-1">
                      Barras verdes: Lo que costaría con trabajadores del nivel apropiado
                    </p>
                  </div>
                  <div className="bg-red-50 border-l-4 border-red-500 p-3 rounded">
                    <div className="flex items-center gap-2">
                      <div className="w-4 h-4 bg-red-500 rounded"></div>
                      <span className="text-sm font-semibold text-red-900">🟥 Costo Real</span>
                    </div>
                    <p className="text-xs text-red-700 mt-1">
                      Barras rojas: Lo que realmente se está pagando con subutilización
                    </p>
                  </div>
                  <div className="bg-orange-50 border-l-4 border-orange-500 p-3 rounded">
                    <div className="flex items-center gap-2">
                      <div className="flex items-center gap-1">
                        <div className="w-8 h-0.5 bg-orange-500"></div>
                        <div className="w-2 h-2 bg-orange-500 rounded-full"></div>
                      </div>
                      <span className="text-sm font-semibold text-orange-900">📈 Sobrecosto</span>
                    </div>
                    <p className="text-xs text-orange-700 mt-1">
                      Línea naranja: Dinero perdido por subutilización (tendencia)
                    </p>
                  </div>
                </div>
              </div>


              {/* ⭐ TABLA: Inconsistencias Críticas */}
              {(analisisTrabajadores.inconsistencias || []).length > 0 && (
                <div className="bg-white rounded-xl shadow-md overflow-hidden mt-6">
                  <div className="p-6 border-b border-gray-200 bg-red-50">
                    <h3 className="text-lg font-bold text-red-900 flex items-center gap-2">
                      🚨 Inconsistencias Detectadas
                    </h3>
                    <p className="text-sm text-red-700 mt-1">
                      Estos trabajadores tienen registros en este proyecto pero NO están asignados formalmente.
                      Revisa y actualiza sus asignaciones.
                    </p>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-red-100">
                        <tr>
                          <th className="px-6 py-3 text-left text-xs font-medium text-red-900 uppercase">
                            Trabajador
                          </th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-red-900 uppercase">
                            Tipo
                          </th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-red-900 uppercase">
                            Registros
                          </th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-red-900 uppercase">
                            Proyectos Detectados
                          </th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-red-900 uppercase">
                            Acción Requerida
                          </th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-red-200">
                        {(analisisTrabajadores.inconsistencias || []).map(t => {
                          const numRegistros = registrosFiltrados.filter(r => r.trabajadorId === t.id).length;
                          const proyectosStr = t.proyectosAsignados.map(pId => {
                            const proyecto = proyectos.find(p => p.id === pId);
                            return proyecto ? proyecto.nombre : `Proyecto ${pId}`;
                          }).join(', ');
                          
                          return (
                            <tr key={t.id} className="hover:bg-red-50">
                              <td className="px-6 py-4">
                                <div className="font-medium text-gray-900">{t.nombre}</div>
                                <div className="text-sm text-gray-500">{t.documento}</div>
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-700">
                                {(tiposTrabajador || []).find(tt => tt.id === t.tipoTrabajadorId)?.nombre || 'N/A'}
                              </td>
                              <td className="px-6 py-4">
                                <span className="px-2 py-1 bg-red-100 text-red-800 rounded text-sm font-medium">
                                  {numRegistros} {numRegistros === 1 ? 'registro' : 'registros'}
                                </span>
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-700">
                                {proyectosStr}
                              </td>
                              <td className="px-6 py-4">
                                <span className="px-3 py-1 bg-red-600 text-white rounded text-xs font-medium">
                                  Asignar formalmente
                                </span>
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
              
              {/* ⭐ TABLA: Trabajadores Sin Actividad */}
              {(analisisTrabajadores.inactivos || []).length > 0 && (
                <div className="bg-white rounded-xl shadow-md overflow-hidden mt-6">
                  <div className="p-6 border-b border-gray-200 bg-yellow-50">
                    <h3 className="text-lg font-bold text-yellow-900 flex items-center gap-2">
                      ⚠️ Trabajadores Sin Actividad Registrada
                    </h3>
                    <p className="text-sm text-yellow-700 mt-1">
                      Trabajadores asignados a este proyecto que no han registrado ninguna actividad.
                    </p>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-yellow-100">
                        <tr>
                          <th className="px-6 py-3 text-left text-xs font-medium text-yellow-900 uppercase">
                            Trabajador
                          </th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-yellow-900 uppercase">
                            Tipo
                          </th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-yellow-900 uppercase">
                            Proyecto Asignado
                          </th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-yellow-900 uppercase">
                            Estado
                          </th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-yellow-200">
                        {(analisisTrabajadores.inactivos || []).map(t => {
                          const proyectoNombre = proyectos.find(p => p.id === parseInt(filtroProyecto))?.nombre || 'N/A';
                          
                          return (
                            <tr key={t.id} className="hover:bg-yellow-50">
                              <td className="px-6 py-4">
                                <div className="font-medium text-gray-900">{t.nombre}</div>
                                <div className="text-sm text-gray-500">{t.documento}</div>
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-700">
                                {(tiposTrabajador || []).find(tt => tt.id === t.tipoTrabajadorId)?.nombre || 'N/A'}
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-700">
                                {proyectoNombre}
                              </td>
                              <td className="px-6 py-4">
                                <span className="px-3 py-1 bg-yellow-200 text-yellow-800 rounded text-xs font-medium">
                                  Sin registros
                                </span>
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
              
              {/* ⭐ TABLA: Trabajadores Sin Asignar */}
              {filtroProyecto === 'sin-asignar' && (analisisTrabajadores.sinAsignar || []).length > 0 && (
                <div className="bg-white rounded-xl shadow-md overflow-hidden mt-6">
                  <div className="p-6 border-b border-gray-200 bg-blue-50">
                    <h3 className="text-lg font-bold text-blue-900 flex items-center gap-2">
                      👥 Trabajadores Disponibles (Sin Asignar)
                    </h3>
                    <p className="text-sm text-blue-700 mt-1">
                      Trabajadores que no están asignados a ningún proyecto.
                    </p>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-blue-100">
                        <tr>
                          <th className="px-6 py-3 text-left text-xs font-medium text-blue-900 uppercase">
                            Trabajador
                          </th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-blue-900 uppercase">
                            Tipo
                          </th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-blue-900 uppercase">
                            Contacto
                          </th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-blue-900 uppercase">
                            Estado
                          </th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-blue-200">
                        {(analisisTrabajadores.sinAsignar || []).map(t => (
                          <tr key={t.id} className="hover:bg-blue-50">
                            <td className="px-6 py-4">
                              <div className="font-medium text-gray-900">{t.nombre}</div>
                              <div className="text-sm text-gray-500">{t.documento}</div>
                            </td>
                            <td className="px-6 py-4 text-sm text-gray-700">
                              {(tiposTrabajador || []).find(tt => tt.id === t.tipoTrabajadorId)?.nombre || 'N/A'}
                            </td>
                            <td className="px-6 py-4 text-sm text-gray-700">
                              <div>{t.telefono || 'N/A'}</div>
                              <div className="text-xs text-gray-500">{t.email || 'N/A'}</div>
                            </td>
                            <td className="px-6 py-4">
                              <span className="px-3 py-1 bg-blue-200 text-blue-800 rounded text-xs font-medium">
                                {t.activo ? 'Disponible' : 'Inactivo'}
                              </span>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              
              {/* Tabla Detallada */}
              <div className="bg-white rounded-xl shadow-md overflow-hidden">
                <div className="p-6 border-b border-gray-200">
                  <h3 className="text-lg font-bold text-gray-800">
                    {isAdmin ? 'Detalle de Todos los Registros' : 'Detalle de Mis Registros'}
                  </h3>
                  <p className="text-sm text-gray-500 mt-1">
                    {isAdmin 
                      ? 'Vista completa de registros con subutilización en todos los proyectos'
                      : `Registros de subutilización en tus ${visibleProyectos.length} proyectos`}
                  </p>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trabajador</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subtarea</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nivel</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Horas</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sobrecosto</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ubicación</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {(registrosFiltrados || []).map(reg => (
                        <tr key={reg.id} className="hover:bg-gray-50">
                          <td className="px-6 py-4 text-sm text-gray-900">
                            {new Date(reg.fecha).toLocaleDateString('es-CO')}
                          </td>
                          <td className="px-6 py-4">
                            <div className="text-sm font-medium text-gray-900">{reg.trabajador}</div>
                            <div className="text-xs text-gray-500">{reg.proyecto}</div>
                          </td>
                          <td className="px-6 py-4">
                            <span className="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                              {reg.tipoTrabajador}
                            </span>
                          </td>
                          <td className="px-6 py-4">
                            <div className="text-sm text-gray-900">{reg.subtarea}</div>
                            <div className="text-xs text-gray-500">{reg.tarea}</div>
                          </td>
                          <td className="px-6 py-4">
                            <div className="flex items-center gap-2">
                              <span className={`px-2 py-1 text-xs font-semibold rounded ${
                                reg.diferenciaNivel === 1 ? 'bg-yellow-100 text-yellow-800' :
                                reg.diferenciaNivel === 2 ? 'bg-orange-100 text-orange-800' :
                                reg.diferenciaNivel === 3 ? 'bg-red-100 text-red-800' :
                                'bg-red-200 text-red-900'
                              }`}>
                                {reg.nivelTrabajador} → {reg.nivelOptimo}
                              </span>
                              <span className="text-xs text-gray-500">
                                (+{reg.diferenciaNivel})
                              </span>
                            </div>
                          </td>
                          <td className="px-6 py-4 text-sm font-medium text-gray-900">
                            {reg.horas}h
                          </td>
                          <td className="px-6 py-4">
                            <div className="text-sm font-bold text-red-600">
                              {formatCurrency(reg.sobrecostoTotal)}
                            </div>
                            <div className="text-xs text-gray-500">
                              {formatCurrency(reg.sobrecostoPorHora)}/h
                            </div>
                          </td>
                          <td className="px-6 py-4 text-xs text-gray-500">
                            📍 {reg.ubicacion}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                {registrosFiltrados.length === 0 && (
                  <div className="text-center py-8 text-gray-500">
                    {isAdmin 
                      ? 'No se encontraron registros con subutilización en el sistema'
                      : '¡Excelente! No hay registros de subutilización en tus proyectos'}
                  </div>
                )}
              </div>
            </div>
          );
        }


        // ==================== CRUD DISCIPLINAS MAESTRAS ====================
        
        function DisciplinasMaestrasCRUD({ disciplinas, setDisciplinas }) {
          const [searchTerm, setSearchTerm] = useState('');
          const [filterActivo, setFilterActivo] = useState('all');
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [editingDisciplina, setEditingDisciplina] = useState(null);

          const filteredDisciplinas = useMemo(() => {
            let result = disciplinas;

            if (filterActivo !== 'all') {
              result = result.filter(d => d.activo === (filterActivo === 'active'));
            }

            if (searchTerm) {
              result = result.filter(d =>
                d.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
                d.codigo.toLowerCase().includes(searchTerm.toLowerCase())
              );
            }

            return result.sort((a, b) => a.orden - b.orden);
          }, [disciplinas, searchTerm, filterActivo]);

          const handleCreate = () => {
            setEditingDisciplina(null);
            setIsModalOpen(true);
          };

          const handleEdit = (disciplina) => {
            setEditingDisciplina(disciplina);
            setIsModalOpen(true);
          };

          const handleDelete = (id) => {
            const disciplina = disciplinas.find(d => d.id === id);
            if (disciplina?.sistema) {
              alert('No se puede eliminar una disciplina del sistema');
              return;
            }
            if (confirm('¿Estás seguro de eliminar esta disciplina?')) {
              setDisciplinas(disciplinas.filter(d => d.id !== id));
            }
          };

          const handleSave = (disciplinaData) => {
            if (editingDisciplina) {
              setDisciplinas(disciplinas.map(d =>
                d.id === editingDisciplina.id ? { ...d, ...disciplinaData } : d
              ));
            } else {
              const newDisciplina = {
                ...disciplinaData,
                id: Math.max(...disciplinas.map(d => d.id), 0) + 1,
                sistema: false
              };
              setDisciplinas([...disciplinas, newDisciplina]);
            }
            setIsModalOpen(false);
          };

          const handleToggleActivo = (id) => {
            setDisciplinas(disciplinas.map(d =>
              d.id === id ? { ...d, activo: !d.activo } : d
            ));
          };

          const activeCount = disciplinas.filter(d => d.activo).length;
          const inactiveCount = disciplinas.length - activeCount;

          return (
            <div>
              <div className="flex items-center justify-between mb-8">
                <div>
                  <h2 className="text-3xl font-bold text-gray-800">📂 Disciplinas Maestras</h2>
                  <p className="text-gray-600 mt-2">Categorías principales de trabajo (Solo Admin)</p>
                </div>
                <button
                  onClick={handleCreate}
                  className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors shadow-md"
                >
                  <Plus className="w-5 h-5" />
                  Nueva Disciplina
                </button>
              </div>

              <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                <div className="flex items-center gap-4 mb-4 flex-wrap">
                  <div className="flex-1 min-w-[200px] relative">
                    <Search className="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                    <input
                      type="text"
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      placeholder="Buscar disciplinas..."
                      className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                  <select
                    value={filterActivo}
                    onChange={(e) => setFilterActivo(e.target.value)}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="all">Todas</option>
                    <option value="active">Solo activas</option>
                    <option value="inactive">Solo inactivas</option>
                  </select>
                </div>

                <div className="text-sm text-gray-600">
                  📊 {disciplinas.length} disciplina(s) • {activeCount} activa(s) • {inactiveCount} inactiva(s)
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {filteredDisciplinas.map(disciplina => (
                  <div
                    key={disciplina.id}
                    className="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow border-l-4"
                    style={{ borderLeftColor: disciplina.color }}
                  >
                    <div className="p-6">
                      <div className="flex items-start justify-between mb-4">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <h3 className="text-xl font-bold text-gray-800">{disciplina.nombre}</h3>
                            {disciplina.sistema && (
                              <span className="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full">
                                Sistema
                              </span>
                            )}
                          </div>
                          <p className="text-sm font-mono text-gray-600 mb-2">{disciplina.codigo}</p>
                          {disciplina.descripcion && (
                            <p className="text-sm text-gray-600 mb-3">{disciplina.descripcion}</p>
                          )}
                        </div>
                      </div>

                      <div className="flex items-center justify-between pt-4 border-t border-gray-200">
                        <button
                          onClick={() => handleToggleActivo(disciplina.id)}
                          className={`px-3 py-1 rounded text-sm font-medium transition-colors ${
                            disciplina.activo
                              ? 'bg-green-100 text-green-700 hover:bg-green-200'
                              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          {disciplina.activo ? '✓ Activa' : '○ Inactiva'}
                        </button>
                        <div className="flex gap-2">
                          <button
                            onClick={() => handleEdit(disciplina)}
                            className="p-2 text-blue-600 hover:bg-blue-50 rounded transition-colors"
                            title="Editar"
                          >
                            <Edit2 className="w-4 h-4" />
                          </button>
                          {!disciplina.sistema && (
                            <button
                              onClick={() => handleDelete(disciplina.id)}
                              className="p-2 text-red-600 hover:bg-red-50 rounded transition-colors"
                              title="Eliminar"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              {filteredDisciplinas.length === 0 && (
                <div className="text-center py-12 bg-white rounded-xl shadow-md">
                  <p className="text-gray-500 text-lg">No se encontraron disciplinas</p>
                </div>
              )}

              {isModalOpen && (
                <DisciplinaMaestraModal
                  disciplina={editingDisciplina}
                  onSave={handleSave}
                  onClose={() => setIsModalOpen(false)}
                />
              )}
            </div>
          );
        }


        // ==================== MODAL TAREA MAESTRA ====================
        
        function TareaMaestraModal({ tarea, disciplinas, onSave, onClose }) {
          const [formData, setFormData] = useState(tarea || {
            disciplinaMaestraId: disciplinas[0]?.id || 1,
            nombre: '',
            codigo: '',
            descripcion: '',
            unidad: '',
            rendimientoBase: 0,
            orden: 1,
            activo: true
          });

          const handleSubmit = (e) => {
            e.preventDefault();
            onSave({
              ...formData,
              disciplinaMaestraId: parseInt(formData.disciplinaMaestraId),
              rendimientoBase: parseFloat(formData.rendimientoBase) || 0
            });
          };

          const disciplinasActivas = disciplinas.filter(d => d.activo);

          return (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div className="flex items-center justify-between p-6 border-b border-gray-200">
                  <h3 className="text-xl font-bold text-gray-900">
                    {tarea ? 'Editar Tarea' : 'Nueva Tarea'}
                  </h3>
                  <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                    <X className="w-6 h-6" />
                  </button>
                </div>

                <form onSubmit={handleSubmit}>
                  <div className="p-6 space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Disciplina *
                      </label>
                      <select
                        required
                        value={formData.disciplinaMaestraId}
                        onChange={(e) => setFormData({...formData, disciplinaMaestraId: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      >
                        {disciplinasActivas.map(d => (
                          <option key={d.id} value={d.id}>
                            {d.nombre} ({d.codigo})
                          </option>
                        ))}
                      </select>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Nombre *
                        </label>
                        <input
                          type="text"
                          required
                          value={formData.nombre}
                          onChange={(e) => setFormData({...formData, nombre: e.target.value})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="Excavación"
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Código *
                        </label>
                        <input
                          type="text"
                          required
                          value={formData.codigo}
                          onChange={(e) => setFormData({...formData, codigo: e.target.value.toUpperCase()})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="EST-001"
                        />
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Descripción
                      </label>
                      <textarea
                        value={formData.descripcion}
                        onChange={(e) => setFormData({...formData, descripcion: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        rows="2"
                        placeholder="Descripción de la tarea..."
                      />
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Unidad
                        </label>
                        <select
                          value={formData.unidad}
                          onChange={(e) => setFormData({...formData, unidad: e.target.value})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        >
                          <option value="">Sin unidad</option>
                          <option value="m³">m³ (Metro cúbico)</option>
                          <option value="m²">m² (Metro cuadrado)</option>
                          <option value="m">m (Metro lineal)</option>
                          <option value="und">und (Unidad)</option>
                          <option value="kg">kg (Kilogramo)</option>
                          <option value="ton">ton (Tonelada)</option>
                        </select>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Rendimiento base
                        </label>
                        <input
                          type="number"
                          step="0.01"
                          min="0"
                          value={formData.rendimientoBase}
                          onChange={(e) => setFormData({...formData, rendimientoBase: e.target.value})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="0.00"
                        />
                      </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Orden
                        </label>
                        <input
                          type="number"
                          min="1"
                          value={formData.orden}
                          onChange={(e) => setFormData({...formData, orden: parseInt(e.target.value)})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                      </div>

                      <div className="flex items-end">
                        <label className="flex items-center gap-2">
                          <input
                            type="checkbox"
                            checked={formData.activo}
                            onChange={(e) => setFormData({...formData, activo: e.target.checked})}
                            className="w-4 h-4 text-blue-600 border-gray-300 rounded"
                          />
                          <span className="text-sm font-medium text-gray-700">Tarea activa</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <div className="flex items-center justify-end gap-3 p-6 border-t border-gray-200 bg-gray-50">
                    <button
                      type="button"
                      onClick={onClose}
                      className="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                      Cancelar
                    </button>
                    <button
                      type="submit"
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                    >
                      {tarea ? 'Actualizar' : 'Crear'}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          );
        }

        // ==================== CRUD TAREAS MAESTRAS ====================
        
        function TareasMaestrasCRUD({ tareas, setTareas, disciplinas }) {
          const [searchTerm, setSearchTerm] = useState('');
          const [filterDisciplina, setFilterDisciplina] = useState('all');
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [editingTarea, setEditingTarea] = useState(null);

          const filteredTareas = useMemo(() => {
            let result = tareas;

            if (filterDisciplina !== 'all') {
              result = result.filter(t => t.disciplinaMaestraId === parseInt(filterDisciplina));
            }

            if (searchTerm) {
              result = result.filter(t =>
                t.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
                t.codigo.toLowerCase().includes(searchTerm.toLowerCase())
              );
            }

            return result.sort((a, b) => {
              if (a.disciplinaMaestraId !== b.disciplinaMaestraId) {
                return a.disciplinaMaestraId - b.disciplinaMaestraId;
              }
              return a.orden - b.orden;
            });
          }, [tareas, searchTerm, filterDisciplina]);

          const tareasGrouped = useMemo(() => {
            const groups = {};
            filteredTareas.forEach(tarea => {
              const disciplinaId = tarea.disciplinaMaestraId;
              if (!groups[disciplinaId]) {
                const disciplina = disciplinas.find(d => d.id === disciplinaId);
                groups[disciplinaId] = {
                  disciplina,
                  tareas: []
                };
              }
              groups[disciplinaId].tareas.push(tarea);
            });
            return Object.values(groups);
          }, [filteredTareas, disciplinas]);

          const handleCreate = () => {
            setEditingTarea(null);
            setIsModalOpen(true);
          };

          const handleEdit = (tarea) => {
            setEditingTarea(tarea);
            setIsModalOpen(true);
          };

          const handleDelete = (id) => {
            if (confirm('¿Estás seguro de eliminar esta tarea?')) {
              setTareas(tareas.filter(t => t.id !== id));
            }
          };

          const handleSave = (tareaData) => {
            if (editingTarea) {
              setTareas(tareas.map(t =>
                t.id === editingTarea.id ? { ...t, ...tareaData } : t
              ));
            } else {
              const newTarea = {
                ...tareaData,
                id: Math.max(...tareas.map(t => t.id), 0) + 1
              };
              setTareas([...tareas, newTarea]);
            }
            setIsModalOpen(false);
          };

          const handleToggleActivo = (id) => {
            setTareas(tareas.map(t =>
              t.id === id ? { ...t, activo: !t.activo } : t
            ));
          };

          return (
            <div>
              <div className="flex items-center justify-between mb-8">
                <div>
                  <h2 className="text-3xl font-bold text-gray-800">📋 Tareas Maestras</h2>
                  <p className="text-gray-600 mt-2">Actividades principales por disciplina (Solo Admin)</p>
                </div>
                <button
                  onClick={handleCreate}
                  className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors shadow-md"
                >
                  <Plus className="w-5 h-5" />
                  Nueva Tarea
                </button>
              </div>

              <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                <div className="flex items-center gap-4 mb-4 flex-wrap">
                  <div className="flex-1 min-w-[200px] relative">
                    <Search className="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                    <input
                      type="text"
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      placeholder="Buscar por nombre o código..."
                      className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                  <select
                    value={filterDisciplina}
                    onChange={(e) => setFilterDisciplina(e.target.value)}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="all">Todas las disciplinas</option>
                    {disciplinas.map(d => (
                      <option key={d.id} value={d.id}>{d.nombre}</option>
                    ))}
                  </select>
                </div>

                <div className="text-sm text-gray-600">
                  📊 {filteredTareas.length} tarea(s) • {filteredTareas.filter(t => t.activo).length} activa(s)
                </div>
              </div>

              <div className="space-y-6">
                {tareasGrouped.map(group => (
                  <div key={group.disciplina?.id} className="bg-white rounded-xl shadow-md overflow-hidden">
                    <div
                      className="p-4 border-l-4 font-semibold text-lg text-gray-800"
                      style={{ borderLeftColor: group.disciplina?.color }}
                    >
                      {group.disciplina?.nombre} ({group.disciplina?.codigo})
                    </div>

                    <div className="divide-y divide-gray-200">
                      {group.tareas.map(tarea => (
                        <div key={tarea.id} className="p-4 hover:bg-gray-50 transition-colors">
                          <div className="flex items-center justify-between">
                            <div className="flex-1">
                              <div className="flex items-center gap-2 mb-1">
                                <h5 className="font-medium text-gray-800">{tarea.nombre}</h5>
                                <span className="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded font-mono">
                                  {tarea.codigo}
                                </span>
                                {!tarea.activo && (
                                  <span className="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded-full">
                                    Inactiva
                                  </span>
                                )}
                              </div>
                              {tarea.descripcion && (
                                <p className="text-sm text-gray-600 mb-1">{tarea.descripcion}</p>
                              )}
                              <div className="flex gap-3 text-xs text-gray-500">
                                {tarea.unidad && (
                                  <span>Unidad: <strong>{tarea.unidad}</strong></span>
                                )}
                                {tarea.rendimientoBase > 0 && (
                                  <span>Rendimiento: <strong>{tarea.rendimientoBase}</strong></span>
                                )}
                              </div>
                            </div>
                            <div className="flex items-center gap-2 ml-4">
                              <button
                                onClick={() => handleToggleActivo(tarea.id)}
                                className={`px-3 py-1 rounded text-sm font-medium transition-colors ${
                                  tarea.activo
                                    ? 'bg-green-100 text-green-700 hover:bg-green-200'
                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                }`}
                              >
                                {tarea.activo ? '✓' : '○'}
                              </button>
                              <button
                                onClick={() => handleEdit(tarea)}
                                className="p-2 text-blue-600 hover:bg-blue-50 rounded transition-colors"
                                title="Editar"
                              >
                                <Edit2 className="w-4 h-4" />
                              </button>
                              <button
                                onClick={() => handleDelete(tarea.id)}
                                className="p-2 text-red-600 hover:bg-red-50 rounded transition-colors"
                                title="Eliminar"
                              >
                                <Trash2 className="w-4 h-4" />
                              </button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>

              {filteredTareas.length === 0 && (
                <div className="text-center py-12 bg-white rounded-xl shadow-md">
                  <p className="text-gray-500 text-lg">No se encontraron tareas</p>
                </div>
              )}

              {isModalOpen && (
                <TareaMaestraModal
                  tarea={editingTarea}
                  disciplinas={disciplinas}
                  onSave={handleSave}
                  onClose={() => setIsModalOpen(false)}
                />
              )}
            </div>
          );
        }


        function SubtareaMaestraModal({ subtarea, tareas, disciplinas, tiposTrabajador, onSave, onClose }) {
          const [formData, setFormData] = useState(subtarea || {
            tareaMaestraId: tareas[0]?.id || 1,
            nombre: '',
            codigo: '',
            descripcion: '',
            tiposTrabajadorPermitidos: [],
            tipoTrabajadorOptimo: null,
            orden: 1,
            activo: true
          });

          const handleSubmit = (e) => {
            e.preventDefault();
            
            // ⭐ v1.7.0 - Derivar nivel_optimo del tipoTrabajadorOptimo
            let nivelOptimo = null;
            if (formData.tipoTrabajadorOptimo) {
              const tipoSeleccionado = tiposTrabajador.find(t => t.id === parseInt(formData.tipoTrabajadorOptimo));
              nivelOptimo = tipoSeleccionado?.nivel || null;
            }
            
            onSave({
              ...formData,
              tareaMaestraId: parseInt(formData.tareaMaestraId),
              tipoTrabajadorOptimo: formData.tipoTrabajadorOptimo ? parseInt(formData.tipoTrabajadorOptimo) : null,
              nivel_optimo: nivelOptimo  // ⭐ Campo derivado para app móvil
            });
          };

          const tareasFiltradas = tareas.filter(t => t.activo);
          
          const tiposOrdenados = [...tiposTrabajador].sort((a, b) => a.nivel - b.nivel);

          const handleTipoToggle = (tipoId) => {
            const current = formData.tiposTrabajadorPermitidos || [];
            if (current.includes(tipoId)) {
              setFormData({
                ...formData,
                tiposTrabajadorPermitidos: current.filter(id => id !== tipoId),
                // Si era el óptimo y se desmarca, limpiar óptimo
                tipoTrabajadorOptimo: formData.tipoTrabajadorOptimo === tipoId ? null : formData.tipoTrabajadorOptimo
              });
            } else {
              setFormData({
                ...formData,
                tiposTrabajadorPermitidos: [...current, tipoId]
              });
            }
          };

          return (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                <div className="flex items-center justify-between p-6 border-b border-gray-200">
                  <h3 className="text-xl font-bold text-gray-900">
                    {subtarea ? 'Editar Subtarea' : 'Nueva Subtarea'}
                  </h3>
                  <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                    <X className="w-6 h-6" />
                  </button>
                </div>

                <form onSubmit={handleSubmit}>
                  <div className="p-6 space-y-6">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Tarea *
                      </label>
                      <select
                        required
                        value={formData.tareaMaestraId}
                        onChange={(e) => setFormData({...formData, tareaMaestraId: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      >
                        {tareasFiltradas.map(t => {
                          const disciplina = disciplinas.find(d => d.id === t.disciplinaMaestraId);
                          return (
                            <option key={t.id} value={t.id}>
                              {disciplina?.codigo} - {t.nombre} ({t.codigo})
                            </option>
                          );
                        })}
                      </select>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Nombre *
                        </label>
                        <input
                          type="text"
                          required
                          value={formData.nombre}
                          onChange={(e) => setFormData({...formData, nombre: e.target.value})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="Replanteo"
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Código *
                        </label>
                        <input
                          type="text"
                          required
                          value={formData.codigo}
                          onChange={(e) => setFormData({...formData, codigo: e.target.value.toUpperCase()})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="EST-001-01"
                        />
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Descripción
                      </label>
                      <textarea
                        value={formData.descripcion}
                        onChange={(e) => setFormData({...formData, descripcion: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        rows="2"
                        placeholder="Descripción de la subtarea..."
                      />
                    </div>

                    {/* NUEVO: Selección de tipos de trabajador */}
                    <div className="border-t border-gray-200 pt-6">
                      <h4 className="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <Users className="w-5 h-5" />
                        Control de Subutilización (Opcional)
                      </h4>
                      
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <p className="text-sm text-blue-800">
                          💡 <strong>Configura quién puede hacer esta tarea</strong> para medir sobrecostos por subutilización.
                          Si no configuras, cualquiera puede registrar tiempo sin alertas.
                        </p>
                      </div>

                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-3">
                            Pueden realizar esta subtarea:
                          </label>
                          <div className="space-y-2">
                            {tiposOrdenados.map(tipo => (
                              <label key={tipo.id} className="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input
                                  type="checkbox"
                                  checked={(formData.tiposTrabajadorPermitidos || []).includes(tipo.id)}
                                  onChange={() => handleTipoToggle(tipo.id)}
                                  className="w-4 h-4 text-blue-600 border-gray-300 rounded"
                                />
                                <div className="flex-1">
                                  <span className="font-medium text-gray-900">{tipo.nombre}</span>
                                  <span className="text-sm text-gray-500 ml-2">(Nivel {tipo.nivel})</span>
                                  <span className="text-sm text-gray-600 block">
                                    ${(tipo.tarifaHoraPorDefecto || 0).toLocaleString()}/hora
                                  </span>
                                </div>
                              </label>
                            ))}
                          </div>
                        </div>

                        {formData.tiposTrabajadorPermitidos && formData.tiposTrabajadorPermitidos.length > 0 && (
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                              Tipo Óptimo (menor costo): *
                            </label>
                            <select
                              required
                              value={formData.tipoTrabajadorOptimo || ''}
                              onChange={(e) => setFormData({...formData, tipoTrabajadorOptimo: parseInt(e.target.value)})}
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            >
                              <option value="">Seleccionar...</option>
                              {tiposOrdenados
                                .filter(t => formData.tiposTrabajadorPermitidos.includes(t.id))
                                .map(tipo => (
                                  <option key={tipo.id} value={tipo.id}>
                                    {tipo.nombre} - ${(tipo.tarifaHoraPorDefecto || 0).toLocaleString()}/hora
                                  </option>
                                ))
                              }
                            </select>
                            <p className="text-xs text-gray-500 mt-1">
                              Se medirá sobrecosto cuando trabajadores de mayor nivel realicen esta tarea
                            </p>
                          </div>
                        )}
                      </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Orden
                        </label>
                        <input
                          type="number"
                          min="1"
                          value={formData.orden}
                          onChange={(e) => setFormData({...formData, orden: parseInt(e.target.value)})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                      </div>

                      <div className="flex items-end">
                        <label className="flex items-center gap-2">
                          <input
                            type="checkbox"
                            checked={formData.activo}
                            onChange={(e) => setFormData({...formData, activo: e.target.checked})}
                            className="w-4 h-4 text-blue-600 border-gray-300 rounded"
                          />
                          <span className="text-sm font-medium text-gray-700">Subtarea activa</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <div className="flex items-center justify-end gap-3 p-6 border-t border-gray-200 bg-gray-50">
                    <button
                      type="button"
                      onClick={onClose}
                      className="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                      Cancelar
                    </button>
                    <button
                      type="submit"
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                    >
                      {subtarea ? 'Actualizar' : 'Crear'}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          );
        }

        // ==================== CRUD SUBTAREAS MAESTRAS (Actualizado v1.5.2) ====================
        
        function SubtareasMaestrasCRUD({ subtareas, setSubtareas, tareas, disciplinas, tiposTrabajador }) {
          const [searchTerm, setSearchTerm] = useState('');
          const [filterDisciplina, setFilterDisciplina] = useState('all');
          const [filterTarea, setFilterTarea] = useState('all');
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [editingSubtarea, setEditingSubtarea] = useState(null);

          const tareasFiltradas = useMemo(() => {
            if (filterDisciplina === 'all') return tareas;
            return tareas.filter(t => t.disciplinaMaestraId === parseInt(filterDisciplina));
          }, [tareas, filterDisciplina]);

          const filteredSubtareas = useMemo(() => {
            let result = subtareas;

            if (filterTarea !== 'all') {
              result = result.filter(s => s.tareaMaestraId === parseInt(filterTarea));
            } else if (filterDisciplina !== 'all') {
              const tareasIds = tareas
                .filter(t => t.disciplinaMaestraId === parseInt(filterDisciplina))
                .map(t => t.id);
              result = result.filter(s => tareasIds.includes(s.tareaMaestraId));
            }

            if (searchTerm) {
              result = result.filter(s =>
                s.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
                s.codigo.toLowerCase().includes(searchTerm.toLowerCase())
              );
            }

            return result.sort((a, b) => {
              if (a.tareaMaestraId !== b.tareaMaestraId) {
                return a.tareaMaestraId - b.tareaMaestraId;
              }
              return a.orden - b.orden;
            });
          }, [subtareas, searchTerm, filterDisciplina, filterTarea, tareas]);

          const subtareasGrouped = useMemo(() => {
            const groups = {};
            filteredSubtareas.forEach(subtarea => {
              const tareaId = subtarea.tareaMaestraId;
              if (!groups[tareaId]) {
                const tarea = tareas.find(t => t.id === tareaId);
                const disciplina = disciplinas.find(d => d.id === tarea?.disciplinaMaestraId);
                groups[tareaId] = {
                  tarea,
                  disciplina,
                  subtareas: []
                };
              }
              groups[tareaId].subtareas.push(subtarea);
            });
            return Object.values(groups);
          }, [filteredSubtareas, tareas, disciplinas]);

          const handleCreate = () => {
            setEditingSubtarea(null);
            setIsModalOpen(true);
          };

          const handleEdit = (subtarea) => {
            setEditingSubtarea(subtarea);
            setIsModalOpen(true);
          };

          const handleDelete = (id) => {
            if (confirm('¿Estás seguro de eliminar esta subtarea?')) {
              setSubtareas(subtareas.filter(s => s.id !== id));
            }
          };

          const handleSave = (subtareaData) => {
            if (editingSubtarea) {
              setSubtareas(subtareas.map(s =>
                s.id === editingSubtarea.id ? { ...s, ...subtareaData } : s
              ));
            } else {
              const newSubtarea = {
                ...subtareaData,
                id: Math.max(...subtareas.map(s => s.id), 0) + 1
              };
              setSubtareas([...subtareas, newSubtarea]);
            }
            setIsModalOpen(false);
          };

          const handleToggleActivo = (id) => {
            setSubtareas(subtareas.map(s =>
              s.id === id ? { ...s, activo: !s.activo } : s
            ));
          };

          const getTipoOptimo = (tipoId) => {
            return tiposTrabajador.find(t => t.id === tipoId);
          };

          return (
            <div>
              <div className="flex items-center justify-between mb-8">
                <div>
                  <h2 className="text-3xl font-bold text-gray-800">📝 Subtareas Maestras</h2>
                  <p className="text-gray-600 mt-2">Desglose detallado + Control de Subutilización</p>
                </div>
                <button
                  onClick={handleCreate}
                  className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors shadow-md"
                >
                  <Plus className="w-5 h-5" />
                  Nueva Subtarea
                </button>
              </div>

              <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                <div className="flex items-center gap-4 mb-4 flex-wrap">
                  <div className="flex-1 min-w-[200px] relative">
                    <Search className="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                    <input
                      type="text"
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      placeholder="Buscar por nombre o código..."
                      className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                  <select
                    value={filterDisciplina}
                    onChange={(e) => {
                      setFilterDisciplina(e.target.value);
                      setFilterTarea('all');
                    }}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="all">Todas las disciplinas</option>
                    {disciplinas.map(d => (
                      <option key={d.id} value={d.id}>{d.nombre}</option>
                    ))}
                  </select>
                  <select
                    value={filterTarea}
                    onChange={(e) => setFilterTarea(e.target.value)}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="all">Todas las tareas</option>
                    {tareasFiltradas.map(t => (
                      <option key={t.id} value={t.id}>{t.nombre}</option>
                    ))}
                  </select>
                </div>

                <div className="text-sm text-gray-600">
                  📊 {filteredSubtareas.length} subtarea(s) • {filteredSubtareas.filter(s => s.activo).length} activa(s) • 
                  {filteredSubtareas.filter(s => s.tipoTrabajadorOptimo).length} con control de subutilización
                </div>
              </div>

              <div className="space-y-6">
                {subtareasGrouped.map(group => (
                  <div key={group.tarea?.id} className="bg-white rounded-xl shadow-md overflow-hidden">
                    <div className="p-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
                      <div className="flex items-center gap-2 mb-1">
                        <span
                          className="w-3 h-3 rounded-full"
                          style={{ backgroundColor: group.disciplina?.color }}
                        ></span>
                        <span className="font-semibold text-gray-700">{group.disciplina?.nombre}</span>
                        <span className="text-gray-500">›</span>
                        <span className="font-bold text-gray-800">{group.tarea?.nombre}</span>
                      </div>
                      <div className="flex items-center gap-2 text-sm text-gray-600">
                        <span className="font-mono">{group.tarea?.codigo}</span>
                        <span>•</span>
                        <span>{group.subtareas.length} subtareas</span>
                      </div>
                    </div>

                    <div className="divide-y divide-gray-200">
                      {group.subtareas.map((subtarea, index) => {
                        const tipoOptimo = subtarea.tipoTrabajadorOptimo ? getTipoOptimo(subtarea.tipoTrabajadorOptimo) : null;
                        const tieneControl = subtarea.tiposTrabajadorPermitidos && subtarea.tiposTrabajadorPermitidos.length > 0;
                        
                        return (
                          <div key={subtarea.id} className="p-4 hover:bg-gray-50 transition-colors">
                            <div className="flex items-start justify-between">
                              <div className="flex items-start gap-3 flex-1">
                                <span className="flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-700 text-xs font-bold mt-0.5">
                                  {index + 1}
                                </span>
                                <div className="flex-1">
                                  <div className="flex items-center gap-2 mb-1 flex-wrap">
                                    <h5 className="font-medium text-gray-800">{subtarea.nombre}</h5>
                                    <span className="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded font-mono">
                                      {subtarea.codigo}
                                    </span>
                                    {!subtarea.activo && (
                                      <span className="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded-full">
                                        Inactiva
                                      </span>
                                    )}
                                    {tieneControl && (
                                      <span className="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full">
                                        ✓ Control activo
                                      </span>
                                    )}
                                  </div>
                                  {subtarea.descripcion && (
                                    <p className="text-sm text-gray-600 mb-2">{subtarea.descripcion}</p>
                                  )}
                                  {tieneControl && tipoOptimo && (
                                    <div className="flex items-center gap-2 text-xs bg-blue-50 border border-blue-200 rounded px-2 py-1 inline-block">
                                      <Users className="w-3 h-3 text-blue-600" />
                                      <span className="text-blue-800">
                                        Óptimo: <strong>{tipoOptimo.nombre}</strong> (${(tipoOptimo.tarifaHoraPorDefecto || 0).toLocaleString()}/h)
                                      </span>
                                    </div>
                                  )}
                                </div>
                              </div>
                              <div className="flex items-center gap-2 ml-4">
                                <button
                                  onClick={() => handleToggleActivo(subtarea.id)}
                                  className={`px-3 py-1 rounded text-sm font-medium transition-colors ${
                                    subtarea.activo
                                      ? 'bg-green-100 text-green-700 hover:bg-green-200'
                                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                  }`}
                                >
                                  {subtarea.activo ? '✓' : '○'}
                                </button>
                                <button
                                  onClick={() => handleEdit(subtarea)}
                                  className="p-2 text-blue-600 hover:bg-blue-50 rounded transition-colors"
                                  title="Editar"
                                >
                                  <Edit2 className="w-4 h-4" />
                                </button>
                                <button
                                  onClick={() => handleDelete(subtarea.id)}
                                  className="p-2 text-red-600 hover:bg-red-50 rounded transition-colors"
                                  title="Eliminar"
                                >
                                  <Trash2 className="w-4 h-4" />
                                </button>
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ))}
              </div>

              {filteredSubtareas.length === 0 && (
                <div className="text-center py-12 bg-white rounded-xl shadow-md">
                  <p className="text-gray-500 text-lg">No se encontraron subtareas</p>
                </div>
              )}

              {isModalOpen && (
                <SubtareaMaestraModal
                  subtarea={editingSubtarea}
                  tareas={tareas}
                  disciplinas={disciplinas}
                  tiposTrabajador={tiposTrabajador}
                  onSave={handleSave}
                  onClose={() => setIsModalOpen(false)}
                />
              )}
            </div>
          );
        }


        // ==================== REPORTES DE UBICACIÓN v1.11.0 - FASE 1 ====================
        
        function ReporteUbicacion({ proyectos, trabajadores, clientes, currentClienteId, userRole, ubicaciones }) {
          const [activeTab, setActiveTab] = React.useState('mapa-calor');
          const [filtroCliente, setFiltroCliente] = React.useState('all');
          const [filtroProyecto, setFiltroProyecto] = React.useState('all');
          const [filtroPeriodo, setFiltroPeriodo] = React.useState('todo');
          
          // ⭐ Estados para drill-down (expandir/colapsar)
          const [pisosExpandidos, setPisosExpandidos] = React.useState([]);
          const [todosExpandidos, setTodosExpandidos] = React.useState(false);
          
          const isAdmin = userRole === 'admin';
          
          // Proyectos visibles según rol
          const visibleProyectos = React.useMemo(() => {
            if (!isAdmin) return proyectos.filter(p => p.clienteId === currentClienteId);
            if (filtroCliente === 'all') return proyectos;
            return proyectos.filter(p => p.clienteId === parseInt(filtroCliente));
          }, [isAdmin, filtroCliente, proyectos, currentClienteId]);
          
          // Datos simulados de ubicaciones con horas trabajadas
          const datosUbicacion = React.useMemo(() => {
            return [
              // PROYECTO: Edificio Torres del Parque
              // Edificio 1
              { proyecto: 'Edificio Torres del Parque', edificio: 'Edificio 1', piso: 'Piso 20', apartamento: 'Apartamento 1', horasTotales: 45.2, horasProductivas: 42.1, costo: 2260000, avance: 100, estado: 'completado' },
              { proyecto: 'Edificio Torres del Parque', edificio: 'Edificio 1', piso: 'Piso 20', apartamento: 'Apartamento 2', horasTotales: 38.5, horasProductivas: 32.8, costo: 1925000, avance: 75, estado: 'en-progreso' },
              { proyecto: 'Edificio Torres del Parque', edificio: 'Edificio 1', piso: 'Piso 20', apartamento: 'Apartamento 3', horasTotales: 28.3, horasProductivas: 24.1, costo: 1415000, avance: 50, estado: 'en-progreso' },
              { proyecto: 'Edificio Torres del Parque', edificio: 'Edificio 1', piso: 'Piso 20', apartamento: 'Apartamento 4', horasTotales: 12.1, horasProductivas: 10.2, costo: 605000, avance: 20, estado: 'en-progreso' },
              { proyecto: 'Edificio Torres del Parque', edificio: 'Edificio 1', piso: 'Piso 20', apartamento: 'Apartamento 5', horasTotales: 0, horasProductivas: 0, costo: 0, avance: 0, estado: 'pendiente' },
              
              { proyecto: 'Edificio Torres del Parque', edificio: 'Edificio 1', piso: 'Piso 19', apartamento: 'Apartamento 1', horasTotales: 28.5, horasProductivas: 24.8, costo: 1425000, avance: 65, estado: 'en-progreso' },
              { proyecto: 'Edificio Torres del Parque', edificio: 'Edificio 1', piso: 'Piso 19', apartamento: 'Apartamento 2', horasTotales: 22.3, horasProductivas: 19.1, costo: 1115000, avance: 55, estado: 'en-progreso' },
              { proyecto: 'Edificio Torres del Parque', edificio: 'Edificio 1', piso: 'Piso 19', apartamento: 'Apartamento 3', horasTotales: 18.7, horasProductivas: 15.2, costo: 935000, avance: 40, estado: 'en-progreso' },
              
              { proyecto: 'Edificio Torres del Parque', edificio: 'Edificio 1', piso: 'Piso 18', apartamento: 'Apartamento 1', horasTotales: 18.3, horasProductivas: 12.5, costo: 915000, avance: 35, estado: 'en-progreso' },
              { proyecto: 'Edificio Torres del Parque', edificio: 'Edificio 1', piso: 'Piso 18', apartamento: 'Apartamento 2', horasTotales: 15.2, horasProductivas: 10.8, costo: 760000, avance: 30, estado: 'en-progreso' },
              
              { proyecto: 'Edificio Torres del Parque', edificio: 'Edificio 1', piso: 'Piso 17', apartamento: 'Apartamento 1', horasTotales: 12.1, horasProductivas: 9.5, costo: 605000, avance: 25, estado: 'en-progreso' },
              
              { proyecto: 'Edificio Torres del Parque', edificio: 'Edificio 1', piso: 'Piso 16', apartamento: 'Apartamento 1', horasTotales: 6.5, horasProductivas: 3.8, costo: 325000, avance: 15, estado: 'en-progreso' },
              
              // Edificio 2
              { proyecto: 'Edificio Torres del Parque', edificio: 'Edificio 2', piso: 'Piso 15', apartamento: 'Apartamento 1', horasTotales: 32.8, horasProductivas: 29.5, costo: 1640000, avance: 70, estado: 'en-progreso' },
              { proyecto: 'Edificio Torres del Parque', edificio: 'Edificio 2', piso: 'Piso 15', apartamento: 'Apartamento 2', horasTotales: 28.1, horasProductivas: 24.3, costo: 1405000, avance: 60, estado: 'en-progreso' },
              
              { proyecto: 'Edificio Torres del Parque', edificio: 'Edificio 2', piso: 'Piso 14', apartamento: 'Apartamento 1', horasTotales: 25.4, horasProductivas: 20.1, costo: 1270000, avance: 50, estado: 'en-progreso' },
              { proyecto: 'Edificio Torres del Parque', edificio: 'Edificio 2', piso: 'Piso 14', apartamento: 'Apartamento 2', horasTotales: 19.8, horasProductivas: 15.6, costo: 990000, avance: 45, estado: 'en-progreso' },
              
              { proyecto: 'Edificio Torres del Parque', edificio: 'Edificio 2', piso: 'Piso 13', apartamento: 'Apartamento 1', horasTotales: 16.9, horasProductivas: 13.2, costo: 845000, avance: 40, estado: 'en-progreso' },
              
              // PROYECTO: Conjunto Residencial Los Sauces
              // Torre A
              { proyecto: 'Conjunto Residencial Los Sauces', edificio: 'Torre A', piso: 'Piso 10', apartamento: 'Apartamento 101', horasTotales: 52.3, horasProductivas: 48.1, costo: 2615000, avance: 100, estado: 'completado' },
              { proyecto: 'Conjunto Residencial Los Sauces', edificio: 'Torre A', piso: 'Piso 10', apartamento: 'Apartamento 102', horasTotales: 41.2, horasProductivas: 35.8, costo: 2060000, avance: 80, estado: 'en-progreso' },
              { proyecto: 'Conjunto Residencial Los Sauces', edificio: 'Torre A', piso: 'Piso 10', apartamento: 'Apartamento 103', horasTotales: 35.6, horasProductivas: 30.2, costo: 1780000, avance: 70, estado: 'en-progreso' },
              
              { proyecto: 'Conjunto Residencial Los Sauces', edificio: 'Torre A', piso: 'Piso 9', apartamento: 'Apartamento 901', horasTotales: 38.9, horasProductivas: 34.5, costo: 1945000, avance: 75, estado: 'en-progreso' },
              { proyecto: 'Conjunto Residencial Los Sauces', edificio: 'Torre A', piso: 'Piso 9', apartamento: 'Apartamento 902', horasTotales: 29.4, horasProductivas: 25.1, costo: 1470000, avance: 60, estado: 'en-progreso' },
              
              { proyecto: 'Conjunto Residencial Los Sauces', edificio: 'Torre A', piso: 'Piso 8', apartamento: 'Apartamento 801', horasTotales: 22.7, horasProductivas: 18.9, costo: 1135000, avance: 45, estado: 'en-progreso' },
              { proyecto: 'Conjunto Residencial Los Sauces', edificio: 'Torre A', piso: 'Piso 8', apartamento: 'Apartamento 802', horasTotales: 18.5, horasProductivas: 15.2, costo: 925000, avance: 35, estado: 'en-progreso' },
              
              // Torre B
              { proyecto: 'Conjunto Residencial Los Sauces', edificio: 'Torre B', piso: 'Piso 12', apartamento: 'Apartamento 1201', horasTotales: 44.8, horasProductivas: 40.3, costo: 2240000, avance: 90, estado: 'en-progreso' },
              { proyecto: 'Conjunto Residencial Los Sauces', edificio: 'Torre B', piso: 'Piso 12', apartamento: 'Apartamento 1202', horasTotales: 37.2, horasProductivas: 32.1, costo: 1860000, avance: 75, estado: 'en-progreso' },
              
              { proyecto: 'Conjunto Residencial Los Sauces', edificio: 'Torre B', piso: 'Piso 11', apartamento: 'Apartamento 1101', horasTotales: 31.5, horasProductivas: 27.8, costo: 1575000, avance: 65, estado: 'en-progreso' },
              { proyecto: 'Conjunto Residencial Los Sauces', edificio: 'Torre B', piso: 'Piso 11', apartamento: 'Apartamento 1102', horasTotales: 25.9, horasProductivas: 21.5, costo: 1295000, avance: 50, estado: 'en-progreso' },
            ];
          }, []);
          
          // ⭐ Filtrar datos según los filtros seleccionados
          const datosFiltrados = React.useMemo(() => {
            let datos = datosUbicacion;
            
            // Filtrar por proyecto
            if (filtroProyecto !== 'all') {
              const proyectoSeleccionado = proyectos.find(p => p.id === parseInt(filtroProyecto));
              if (proyectoSeleccionado) {
                datos = datos.filter(d => d.proyecto === proyectoSeleccionado.nombre);
              }
            }
            
            // Filtrar por cliente (solo admin)
            if (isAdmin && filtroCliente !== 'all') {
              const clienteSeleccionado = clientes.find(c => c.id === parseInt(filtroCliente));
              if (clienteSeleccionado) {
                // Obtener proyectos del cliente
                const proyectosCliente = proyectos.filter(p => p.clienteId === parseInt(filtroCliente));
                const nombresProyectos = proyectosCliente.map(p => p.nombre);
                datos = datos.filter(d => nombresProyectos.includes(d.proyecto));
              }
            }
            
            // Filtrar por período
            if (filtroPeriodo !== 'todo') {
              const hoy = new Date();
              hoy.setHours(0, 0, 0, 0);
              
              if (filtroPeriodo === 'hoy') {
                // Simular filtro de hoy (en datos reales sería: d => esHoy(d.fecha))
                // Por ahora, mantener todos los datos ya que son de ejemplo
              } else if (filtroPeriodo === 'semana') {
                // Simular filtro de esta semana
              } else if (filtroPeriodo === 'mes') {
                // Simular filtro de este mes
              }
            }
            
            return datos;
          }, [datosUbicacion, filtroProyecto, filtroCliente, filtroPeriodo, proyectos, clientes, isAdmin]);
          
          // Agrupar por edificio y piso
          const datosPorEdificio = React.useMemo(() => {
            const grouped = {};
            datosFiltrados.forEach(item => {
              if (!grouped[item.edificio]) {
                grouped[item.edificio] = {
                  nombre: item.edificio,
                  totalHoras: 0,
                  totalCosto: 0,
                  pisos: {}
                };
              }
              
              if (!grouped[item.edificio].pisos[item.piso]) {
                grouped[item.edificio].pisos[item.piso] = {
                  nombre: item.piso,
                  totalHoras: 0,
                  totalCosto: 0,
                  apartamentos: []
                };
              }
              
              grouped[item.edificio].totalHoras += item.horasTotales;
              grouped[item.edificio].totalCosto += item.costo;
              grouped[item.edificio].pisos[item.piso].totalHoras += item.horasTotales;
              grouped[item.edificio].pisos[item.piso].totalCosto += item.costo;
              grouped[item.edificio].pisos[item.piso].apartamentos.push(item);
            });
            
            return grouped;
          }, [datosFiltrados]);
          
          // Calcular totales generales
          const totales = React.useMemo(() => {
            return datosFiltrados.reduce((acc, item) => {
              acc.horasTotales += item.horasTotales;
              acc.costoTotal += item.costo;
              return acc;
            }, { horasTotales: 0, costoTotal: 0 });
          }, [datosFiltrados]);
          
          // ⭐ Funciones para drill-down
          // Obtener todos los pisos con actividad
          const todosPisosConActividad = React.useMemo(() => {
            const pisos = [];
            Object.values(datosPorEdificio).forEach(edificio => {
              Object.keys(edificio.pisos).forEach(pisoNombre => {
                const piso = edificio.pisos[pisoNombre];
                if (piso.totalHoras > 0) {
                  pisos.push(`${edificio.nombre}|${pisoNombre}`);
                }
              });
            });
            return pisos;
          }, [datosPorEdificio]);
          
          // Toggle expandir/colapsar todo
          const toggleTodos = () => {
            if (todosExpandidos) {
              setPisosExpandidos([]);
              setTodosExpandidos(false);
            } else {
              setPisosExpandidos(todosPisosConActividad);
              setTodosExpandidos(true);
            }
          };
          
          // Toggle expandir/colapsar piso individual
          const togglePiso = (pisoKey) => {
            if (pisosExpandidos.includes(pisoKey)) {
              const nuevosExpandidos = pisosExpandidos.filter(id => id !== pisoKey);
              setPisosExpandidos(nuevosExpandidos);
              setTodosExpandidos(nuevosExpandidos.length === todosPisosConActividad.length);
            } else {
              const nuevosExpandidos = [...pisosExpandidos, pisoKey];
              setPisosExpandidos(nuevosExpandidos);
              setTodosExpandidos(nuevosExpandidos.length === todosPisosConActividad.length);
            }
          };
          
          return (
            <div>
              <h2 className="text-3xl font-bold text-gray-800 mb-2">
                📍 Reportes de Ubicación
              </h2>
              <p className="text-gray-600 mb-6">
                Analiza el desempeño, avance y costos por ubicación específica
              </p>
              
              {/* Filtros */}
              <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                <h3 className="font-bold text-gray-800 mb-4">🔍 Filtros</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  {isAdmin && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                      <select
                        value={filtroCliente}
                        onChange={(e) => {
                          setFiltroCliente(e.target.value);
                          setFiltroProyecto('all');
                        }}
                        className="w-full p-2 border border-gray-300 rounded-lg"
                      >
                        <option value="all">Todos los clientes</option>
                        {clientes.map(c => (
                          <option key={c.id} value={c.id}>{c.nombre}</option>
                        ))}
                      </select>
                    </div>
                  )}
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Proyecto</label>
                    <select
                      value={filtroProyecto}
                      onChange={(e) => setFiltroProyecto(e.target.value)}
                      className="w-full p-2 border border-gray-300 rounded-lg"
                    >
                      <option value="all">Todos los proyectos</option>
                      {visibleProyectos.map(p => (
                        <option key={p.id} value={p.id}>{p.nombre}</option>
                      ))}
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Período</label>
                    <select
                      value={filtroPeriodo}
                      onChange={(e) => setFiltroPeriodo(e.target.value)}
                      className="w-full p-2 border border-gray-300 rounded-lg"
                    >
                      <option value="todo">Todo el tiempo</option>
                      <option value="hoy">Hoy</option>
                      <option value="semana">Esta semana</option>
                      <option value="mes">Este mes</option>
                    </select>
                  </div>
                </div>
              </div>
              
              {/* Tabs */}
              <div className="bg-white rounded-xl shadow-md mb-6">
                <div className="border-b border-gray-200">
                  <div className="flex">
                    <button
                      onClick={() => setActiveTab('mapa-calor')}
                      className={`px-6 py-3 font-semibold transition ${
                        activeTab === 'mapa-calor'
                          ? 'border-b-2 border-blue-500 text-blue-600'
                          : 'text-gray-600 hover:text-gray-800'
                      }`}
                    >
                      🗺️ Mapa de Calor
                    </button>
                    <button
                      onClick={() => setActiveTab('avance')}
                      className={`px-6 py-3 font-semibold transition ${
                        activeTab === 'avance'
                          ? 'border-b-2 border-blue-500 text-blue-600'
                          : 'text-gray-600 hover:text-gray-800'
                      }`}
                    >
                      📈 Avance por Área
                    </button>
                    <button
                      onClick={() => setActiveTab('costos')}
                      className={`px-6 py-3 font-semibold transition ${
                        activeTab === 'costos'
                          ? 'border-b-2 border-blue-500 text-blue-600'
                          : 'text-gray-600 hover:text-gray-800'
                      }`}
                    >
                      💰 Costos por Ubicación
                    </button>
                    <button
                      onClick={() => setActiveTab('productividad')}
                      className={`px-6 py-3 font-semibold transition ${
                        activeTab === 'productividad'
                          ? 'border-b-2 border-blue-500 text-blue-600'
                          : 'text-gray-600 hover:text-gray-800'
                      }`}
                    >
                      ⚡ Productividad
                    </button>
                    <button
                      onClick={() => setActiveTab('ocupacion')}
                      className={`px-6 py-3 font-semibold transition ${
                        activeTab === 'ocupacion'
                          ? 'border-b-2 border-blue-500 text-blue-600'
                          : 'text-gray-600 hover:text-gray-800'
                      }`}
                    >
                      📍 Ocupación Actual
                    </button>
                    <button
                      onClick={() => setActiveTab('improductivos-ubicacion')}
                      className={`px-6 py-3 font-semibold transition ${
                        activeTab === 'improductivos-ubicacion'
                          ? 'border-b-2 border-blue-500 text-blue-600'
                          : 'text-gray-600 hover:text-gray-800'
                      }`}
                    >
                      ⏳ Improductivos
                    </button>
                    <button
                      onClick={() => setActiveTab('ruta-trabajadores')}
                      className={`px-6 py-3 font-semibold transition ${
                        activeTab === 'ruta-trabajadores'
                          ? 'border-b-2 border-blue-500 text-blue-600'
                          : 'text-gray-600 hover:text-gray-800'
                      }`}
                    >
                      🗺️ Ruta
                    </button>
                    <button
                      onClick={() => setActiveTab('comparativa')}
                      className={`px-6 py-3 font-semibold transition ${
                        activeTab === 'comparativa'
                          ? 'border-b-2 border-blue-500 text-blue-600'
                          : 'text-gray-600 hover:text-gray-800'
                      }`}
                    >
                      📊 Comparativa
                    </button>
                  </div>
                </div>
                
                <div className="p-6">
                  {/* TAB 1: MAPA DE CALOR */}
                  {activeTab === 'mapa-calor' && (
                    <div>
                      <div className="mb-6">
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <h3 className="text-xl font-bold text-gray-800 mb-2">
                              🗺️ Distribución de Horas por Ubicación
                            </h3>
                            <p className="text-gray-600">
                              Visualiza dónde se concentra el trabajo y detecta áreas con poca actividad
                            </p>
                          </div>
                          <button
                            onClick={toggleTodos}
                            className="ml-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold text-sm transition-all shadow-md hover:shadow-lg flex items-center gap-2"
                          >
                            {todosExpandidos ? (
                              <>
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                                </svg>
                                Colapsar Todo
                              </>
                            ) : (
                              <>
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                </svg>
                                Expandir Todo
                              </>
                            )}
                          </button>
                        </div>
                      </div>
                      
                      {/* Total general */}
                      <div className="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4 mb-6">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm text-blue-800 font-medium">Total General</p>
                            <p className="text-3xl font-bold text-blue-900">{totales.horasTotales.toFixed(1)}h</p>
                          </div>
                          <div className="text-right">
                            <p className="text-sm text-blue-800 font-medium">Costo Acumulado</p>
                            <p className="text-2xl font-bold text-blue-900">
                              ${totales.costoTotal.toLocaleString('es-CO')}
                            </p>
                          </div>
                        </div>
                      </div>
                      
                      {/* Mensaje sin datos */}
                      {Object.keys(datosPorEdificio).length === 0 && (
                        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-lg">
                          <div className="flex items-start gap-3">
                            <svg className="w-6 h-6 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <div>
                              <p className="font-bold text-yellow-800 mb-1">No hay datos disponibles</p>
                              <p className="text-sm text-yellow-700">
                                No se encontraron registros de ubicación para los filtros seleccionados. 
                                Intenta cambiar el cliente, proyecto o período.
                              </p>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {/* Por edificio */}
                      {Object.values(datosPorEdificio).map(edificio => (
                        <div key={edificio.nombre} className="mb-6">
                          <div className="bg-gray-50 rounded-lg p-4 mb-3">
                            <div className="flex items-center justify-between">
                              <h4 className="text-lg font-bold text-gray-800">{edificio.nombre}</h4>
                              <div className="text-right">
                                <p className="text-sm text-gray-600">Total</p>
                                <p className="text-xl font-bold text-gray-800">
                                  {edificio.totalHoras.toFixed(1)}h
                                  <span className="text-sm text-gray-600 ml-2">
                                    ({((edificio.totalHoras / totales.horasTotales) * 100).toFixed(1)}%)
                                  </span>
                                </p>
                              </div>
                            </div>
                          </div>
                          
                          {/* Por piso */}
                          <div className="pl-4 space-y-3">
                            {Object.values(edificio.pisos).sort((a, b) => b.totalHoras - a.totalHoras).map(piso => {
                              const porcentaje = (piso.totalHoras / totales.horasTotales) * 100;
                              let intensidad = 'bg-gray-200';
                              let etiqueta = '';
                              
                              if (porcentaje >= 15) {
                                intensidad = 'bg-red-500';
                                etiqueta = '🔥 Alto';
                              } else if (porcentaje >= 10) {
                                intensidad = 'bg-orange-400';
                                etiqueta = '🔶 Medio-Alto';
                              } else if (porcentaje >= 5) {
                                intensidad = 'bg-yellow-400';
                                etiqueta = '✅ Normal';
                              } else if (porcentaje > 0) {
                                intensidad = 'bg-blue-300';
                                etiqueta = '⚠️ Bajo';
                              } else {
                                intensidad = 'bg-gray-200';
                                etiqueta = '❌ Sin actividad';
                              }
                              
                              const pisoKey = `${edificio.nombre}|${piso.nombre}`;
                              const estaExpandido = pisosExpandidos.includes(pisoKey);
                              const tieneActividad = piso.totalHoras > 0;
                              
                              return (
                                <div key={piso.nombre} className="bg-white rounded-lg p-3 shadow-sm">
                                  <div className="flex items-center gap-3 mb-2">
                                    <div className="flex-1">
                                      <p className="font-semibold text-gray-800">{piso.nombre}</p>
                                      <p className="text-sm text-gray-600">
                                        {piso.totalHoras.toFixed(1)}h • {piso.apartamentos.length} apartamentos • {etiqueta}
                                      </p>
                                    </div>
                                    {tieneActividad && (
                                      <button
                                        onClick={() => togglePiso(pisoKey)}
                                        className="px-3 py-1.5 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-lg transition-colors flex items-center gap-1"
                                      >
                                        {estaExpandido ? (
                                          <>
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                                            </svg>
                                            Ocultar
                                          </>
                                        ) : (
                                          <>
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                            </svg>
                                            Ver apartamentos
                                          </>
                                        )}
                                      </button>
                                    )}
                                  </div>
                                  
                                  {/* Barra de progreso */}
                                  <div className="relative h-6 bg-gray-200 rounded-full overflow-hidden">
                                    <div 
                                      className={`h-full ${intensidad} transition-all duration-300`}
                                      style={{ width: `${Math.min(porcentaje * 2, 100)}%` }}
                                    ></div>
                                    <div className="absolute inset-0 flex items-center justify-center">
                                      <span className="text-xs font-bold text-gray-700">
                                        {porcentaje.toFixed(1)}% del total
                                      </span>
                                    </div>
                                  </div>
                                  
                                  {/* Lista de apartamentos (expandible) */}
                                  {estaExpandido && tieneActividad && (
                                    <div className="mt-3 pt-3 border-t border-gray-200 space-y-2">
                                      <p className="text-xs font-semibold text-gray-500 uppercase mb-2">Apartamentos:</p>
                                      {piso.apartamentos.sort((a, b) => b.horasTotales - a.horasTotales).map(apto => {
                                        const porcentajeApto = (apto.horasTotales / totales.horasTotales) * 100;
                                        
                                        return (
                                          <div key={apto.apartamento} className="bg-gray-50 rounded p-2">
                                            <div className="flex items-center justify-between mb-1">
                                              <span className="text-sm font-medium text-gray-700">{apto.apartamento}</span>
                                              <span className="text-xs font-bold text-gray-600">
                                                {apto.horasTotales.toFixed(1)}h ({porcentajeApto.toFixed(1)}%)
                                              </span>
                                            </div>
                                            <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                                              <div 
                                                className={`h-full ${intensidad} transition-all duration-300`}
                                                style={{ width: `${Math.min((apto.horasTotales / piso.totalHoras) * 100, 100)}%` }}
                                              ></div>
                                            </div>
                                          </div>
                                        );
                                      })}
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                  
                  {/* TAB 2: AVANCE POR ÁREA */}
                  {activeTab === 'avance' && (
                    <div>
                      <div className="mb-6">
                        <h3 className="text-xl font-bold text-gray-800 mb-2">
                          📈 Avance por Ubicación
                        </h3>
                        <p className="text-gray-600">
                          Visualiza el progreso de cada área y detecta retrasos
                        </p>
                      </div>
                      
                      {/* Mensaje sin datos */}
                      {Object.keys(datosPorEdificio).length === 0 && (
                        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-lg">
                          <div className="flex items-start gap-3">
                            <svg className="w-6 h-6 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <div>
                              <p className="font-bold text-yellow-800 mb-1">No hay datos disponibles</p>
                              <p className="text-sm text-yellow-700">
                                No se encontraron registros de avance para los filtros seleccionados. 
                                Intenta cambiar el cliente, proyecto o período.
                              </p>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {/* Por edificio y piso */}
                      {Object.values(datosPorEdificio).map(edificio => (
                        <div key={edificio.nombre} className="mb-6">
                          <div className="bg-gray-50 rounded-lg p-4 mb-3">
                            <h4 className="text-lg font-bold text-gray-800">{edificio.nombre}</h4>
                          </div>
                          
                          <div className="pl-4 space-y-4">
                            {Object.values(edificio.pisos).map(piso => (
                              <div key={piso.nombre} className="bg-white rounded-lg p-4 shadow-sm">
                                <h5 className="font-bold text-gray-800 mb-3">{piso.nombre}</h5>
                                
                                <div className="space-y-2">
                                  {piso.apartamentos.map(apto => {
                                    let estadoColor = 'bg-gray-200';
                                    let estadoTexto = '⏳ Pendiente';
                                    let estadoIcon = '❌';
                                    
                                    if (apto.avance === 100) {
                                      estadoColor = 'bg-green-500';
                                      estadoTexto = 'Completado';
                                      estadoIcon = '✅';
                                    } else if (apto.avance >= 75) {
                                      estadoColor = 'bg-blue-500';
                                      estadoTexto = 'Avanzado';
                                      estadoIcon = '🔄';
                                    } else if (apto.avance >= 50) {
                                      estadoColor = 'bg-yellow-500';
                                      estadoTexto = 'En progreso';
                                      estadoIcon = '🔄';
                                    } else if (apto.avance >= 25) {
                                      estadoColor = 'bg-orange-400';
                                      estadoTexto = 'Inicio';
                                      estadoIcon = '🔄';
                                    } else if (apto.avance > 0) {
                                      estadoColor = 'bg-red-400';
                                      estadoTexto = 'Muy bajo';
                                      estadoIcon = '⚠️';
                                    }
                                    
                                    return (
                                      <div key={apto.apartamento} className="mb-3">
                                        <div className="flex items-center justify-between mb-1">
                                          <span className="text-sm font-medium text-gray-700">{apto.apartamento}</span>
                                          <span className="text-sm font-bold text-gray-800">
                                            {estadoIcon} {apto.avance}% {estadoTexto}
                                          </span>
                                        </div>
                                        <div className="relative h-8 bg-gray-200 rounded-full overflow-hidden">
                                          <div 
                                            className={`h-full ${estadoColor} transition-all duration-500`}
                                            style={{ width: `${apto.avance}%` }}
                                          ></div>
                                        </div>
                                        <div className="flex items-center justify-between mt-1">
                                          <span className="text-xs text-gray-500">{apto.horasTotales.toFixed(1)}h trabajadas</span>
                                          {apto.avance < 100 && (
                                            <span className="text-xs text-gray-500">
                                              Est. faltante: {((apto.horasTotales / apto.avance) * (100 - apto.avance)).toFixed(1)}h
                                            </span>
                                          )}
                                        </div>
                                      </div>
                                    );
                                  })}
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                  
                  {/* TAB 3: COSTOS POR UBICACIÓN */}
                  {activeTab === 'costos' && (
                    <div>
                      <div className="mb-6">
                        <h3 className="text-xl font-bold text-gray-800 mb-2">
                          💰 Costo de Mano de Obra por Ubicación
                        </h3>
                        <p className="text-gray-600">
                          Analiza el costo invertido y proyecta gastos futuros por área
                        </p>
                      </div>
                      
                      {/* Total general */}
                      <div className="bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg p-4 mb-6">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm text-purple-800 font-medium">Costo Total Ejecutado</p>
                            <p className="text-3xl font-bold text-purple-900">
                              ${totales.costoTotal.toLocaleString('es-CO')}
                            </p>
                          </div>
                          <div className="text-right">
                            <p className="text-sm text-purple-800 font-medium">Horas Totales</p>
                            <p className="text-2xl font-bold text-purple-900">{totales.horasTotales.toFixed(1)}h</p>
                            <p className="text-xs text-purple-700">~$50,000/hora promedio</p>
                          </div>
                        </div>
                      </div>
                      
                      {/* Mensaje sin datos */}
                      {Object.keys(datosPorEdificio).length === 0 && (
                        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-lg">
                          <div className="flex items-start gap-3">
                            <svg className="w-6 h-6 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <div>
                              <p className="font-bold text-yellow-800 mb-1">No hay datos disponibles</p>
                              <p className="text-sm text-yellow-700">
                                No se encontraron registros de costos para los filtros seleccionados. 
                                Intenta cambiar el cliente, proyecto o período.
                              </p>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {/* Por edificio y piso */}
                      {Object.values(datosPorEdificio).map(edificio => (
                        <div key={edificio.nombre} className="mb-6">
                          <div className="bg-gray-50 rounded-lg p-4 mb-3">
                            <div className="flex items-center justify-between">
                              <h4 className="text-lg font-bold text-gray-800">{edificio.nombre}</h4>
                              <div className="text-right">
                                <p className="text-sm text-gray-600">Total Edificio</p>
                                <p className="text-xl font-bold text-gray-800">
                                  ${edificio.totalCosto.toLocaleString('es-CO')}
                                </p>
                              </div>
                            </div>
                          </div>
                          
                          <div className="pl-4 space-y-4">
                            {Object.values(edificio.pisos).map(piso => (
                              <div key={piso.nombre} className="bg-white rounded-lg p-4 shadow-sm">
                                <div className="flex items-center justify-between mb-3">
                                  <h5 className="font-bold text-gray-800">{piso.nombre}</h5>
                                  <div className="text-right">
                                    <p className="text-sm text-gray-600">Total Piso</p>
                                    <p className="text-lg font-bold text-gray-800">
                                      ${piso.totalCosto.toLocaleString('es-CO')}
                                    </p>
                                  </div>
                                </div>
                                
                                <div className="space-y-3">
                                  {piso.apartamentos.map(apto => {
                                    const costoEstimado = apto.avance > 0 ? (apto.costo / apto.avance) * 100 : 0;
                                    const costoFaltante = costoEstimado - apto.costo;
                                    
                                    return (
                                      <div key={apto.apartamento} className="border-l-4 border-blue-500 pl-3 py-2 bg-blue-50">
                                        <div className="flex items-center justify-between mb-2">
                                          <p className="font-semibold text-gray-800">{apto.apartamento}</p>
                                          <p className="text-sm text-gray-600">{apto.avance}% completado</p>
                                        </div>
                                        
                                        <div className="grid grid-cols-3 gap-3 text-sm">
                                          <div>
                                            <p className="text-gray-600">Horas</p>
                                            <p className="font-bold text-gray-800">{apto.horasTotales.toFixed(1)}h</p>
                                          </div>
                                          <div>
                                            <p className="text-gray-600">Costo Ejecutado</p>
                                            <p className="font-bold text-gray-800">${apto.costo.toLocaleString('es-CO')}</p>
                                          </div>
                                          <div>
                                            <p className="text-gray-600">$/hora</p>
                                            <p className="font-bold text-gray-800">
                                              ${apto.horasTotales > 0 ? Math.round(apto.costo / apto.horasTotales).toLocaleString('es-CO') : '0'}
                                            </p>
                                          </div>
                                        </div>
                                        
                                        {apto.avance > 0 && apto.avance < 100 && (
                                          <div className="mt-2 pt-2 border-t border-blue-200">
                                            <div className="flex items-center justify-between text-sm">
                                              <span className="text-blue-800">Estimado faltante:</span>
                                              <span className="font-bold text-blue-900">${Math.round(costoFaltante).toLocaleString('es-CO')}</span>
                                            </div>
                                            <div className="flex items-center justify-between text-sm">
                                              <span className="text-blue-800">Total proyectado:</span>
                                              <span className="font-bold text-blue-900">${Math.round(costoEstimado).toLocaleString('es-CO')}</span>
                                            </div>
                                          </div>
                                        )}
                                        
                                        {apto.avance === 100 && (
                                          <div className="mt-2 text-sm text-green-700 font-semibold">
                                            ✅ Completado
                                          </div>
                                        )}
                                      </div>
                                    );
                                  })}
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                  
                  {/* TAB 4: PRODUCTIVIDAD POR UBICACIÓN */}
                  {activeTab === 'productividad' && (
                    <div>
                      <div className="mb-6">
                        <h3 className="text-xl font-bold text-gray-800 mb-2">
                          ⚡ Productividad por Ubicación
                        </h3>
                        <p className="text-gray-600">
                          Compara la eficiencia entre diferentes áreas y detecta ubicaciones problemáticas
                        </p>
                      </div>
                      
                      {/* Mensaje sin datos */}
                      {Object.keys(datosPorEdificio).length === 0 && (
                        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-lg">
                          <div className="flex items-start gap-3">
                            <svg className="w-6 h-6 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <div>
                              <p className="font-bold text-yellow-800 mb-1">No hay datos disponibles</p>
                              <p className="text-sm text-yellow-700">
                                No se encontraron registros de productividad para los filtros seleccionados.
                              </p>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {/* Ranking de Productividad */}
                      {Object.keys(datosPorEdificio).length > 0 && (
                        <>
                          {/* Top 5 más productivos */}
                          <div className="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4 mb-6">
                            <h4 className="font-bold text-green-900 mb-3">🏆 Top 5 Ubicaciones Más Productivas</h4>
                            <div className="space-y-2">
                              {(() => {
                                const ranking = [];
                                Object.values(datosPorEdificio).forEach(edificio => {
                                  Object.values(edificio.pisos).forEach(piso => {
                                    const productividad = piso.totalHoras > 0 
                                      ? (piso.apartamentos.reduce((acc, apt) => acc + apt.horasProductivas, 0) / piso.totalHoras) * 100
                                      : 0;
                                    ranking.push({
                                      nombre: `${edificio.nombre} - ${piso.nombre}`,
                                      productividad: productividad,
                                      horasProductivas: piso.apartamentos.reduce((acc, apt) => acc + apt.horasProductivas, 0),
                                      horasTotales: piso.totalHoras
                                    });
                                  });
                                });
                                return ranking.sort((a, b) => b.productividad - a.productividad).slice(0, 5).map((item, index) => {
                                  const medalla = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '⭐';
                                  return (
                                    <div key={index} className="bg-white rounded-lg p-3 flex items-center justify-between">
                                      <div className="flex items-center gap-3">
                                        <span className="text-2xl">{medalla}</span>
                                        <div>
                                          <p className="font-semibold text-gray-800">{item.nombre}</p>
                                          <p className="text-sm text-gray-600">{item.horasProductivas.toFixed(1)}h productivas de {item.horasTotales.toFixed(1)}h totales</p>
                                        </div>
                                      </div>
                                      <div className="text-right">
                                        <p className="text-2xl font-bold text-green-700">{item.productividad.toFixed(1)}%</p>
                                        <p className="text-xs text-gray-600">Productividad</p>
                                      </div>
                                    </div>
                                  );
                                });
                              })()}
                            </div>
                          </div>
                          
                          {/* Gráfico comparativo por ubicación */}
                          {Object.values(datosPorEdificio).map(edificio => (
                            <div key={edificio.nombre} className="mb-6">
                              <div className="bg-gray-50 rounded-lg p-4 mb-3">
                                <h4 className="text-lg font-bold text-gray-800">{edificio.nombre}</h4>
                              </div>
                              
                              <div className="pl-4 space-y-3">
                                {Object.values(edificio.pisos).sort((a, b) => {
                                  const prodA = a.totalHoras > 0 ? (a.apartamentos.reduce((acc, apt) => acc + apt.horasProductivas, 0) / a.totalHoras) * 100 : 0;
                                  const prodB = b.totalHoras > 0 ? (b.apartamentos.reduce((acc, apt) => acc + apt.horasProductivas, 0) / b.totalHoras) * 100 : 0;
                                  return prodB - prodA;
                                }).map(piso => {
                                  const horasProductivas = piso.apartamentos.reduce((acc, apt) => acc + apt.horasProductivas, 0);
                                  const horasImproductivas = piso.totalHoras - horasProductivas;
                                  const productividad = piso.totalHoras > 0 ? (horasProductivas / piso.totalHoras) * 100 : 0;
                                  
                                  let color = 'text-red-600';
                                  let badge = '🔴 Bajo';
                                  if (productividad >= 85) {
                                    color = 'text-green-600';
                                    badge = '✅ Excelente';
                                  } else if (productividad >= 70) {
                                    color = 'text-yellow-600';
                                    badge = '🟡 Bueno';
                                  } else if (productividad >= 50) {
                                    color = 'text-orange-600';
                                    badge = '🟠 Regular';
                                  }
                                  
                                  return (
                                    <div key={piso.nombre} className="bg-white rounded-lg p-4 shadow-sm">
                                      <div className="flex items-center justify-between mb-3">
                                        <div>
                                          <p className="font-semibold text-gray-800">{piso.nombre}</p>
                                          <p className="text-sm text-gray-600">{piso.totalHoras.toFixed(1)}h totales</p>
                                        </div>
                                        <div className="text-right">
                                          <p className={`text-2xl font-bold ${color}`}>{productividad.toFixed(1)}%</p>
                                          <p className="text-xs text-gray-600">{badge}</p>
                                        </div>
                                      </div>
                                      
                                      {/* Barra de productivo vs improductivo */}
                                      <div className="space-y-2">
                                        <div className="flex items-center gap-2 text-sm">
                                          <div className="w-3 h-3 bg-green-500 rounded"></div>
                                          <span className="text-gray-700">Productivo: {horasProductivas.toFixed(1)}h ({productividad.toFixed(1)}%)</span>
                                        </div>
                                        <div className="flex items-center gap-2 text-sm">
                                          <div className="w-3 h-3 bg-red-400 rounded"></div>
                                          <span className="text-gray-700">Improductivo: {horasImproductivas.toFixed(1)}h ({(100 - productividad).toFixed(1)}%)</span>
                                        </div>
                                      </div>
                                      
                                      <div className="mt-3 h-8 bg-gray-200 rounded-full overflow-hidden flex">
                                        <div 
                                          className="bg-green-500 transition-all duration-300"
                                          style={{ width: `${productividad}%` }}
                                        ></div>
                                        <div 
                                          className="bg-red-400 transition-all duration-300"
                                          style={{ width: `${100 - productividad}%` }}
                                        ></div>
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                            </div>
                          ))}
                          
                          {/* Recomendaciones */}
                          <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg">
                            <h4 className="font-bold text-blue-900 mb-2">💡 Recomendaciones</h4>
                            <ul className="text-sm text-blue-800 space-y-1">
                              {(() => {
                                const ubicacionesBajas = [];
                                Object.values(datosPorEdificio).forEach(edificio => {
                                  Object.values(edificio.pisos).forEach(piso => {
                                    const horasProductivas = piso.apartamentos.reduce((acc, apt) => acc + apt.horasProductivas, 0);
                                    const productividad = piso.totalHoras > 0 ? (horasProductivas / piso.totalHoras) * 100 : 0;
                                    if (productividad < 70 && piso.totalHoras > 0) {
                                      ubicacionesBajas.push(`${edificio.nombre} - ${piso.nombre}`);
                                    }
                                  });
                                });
                                
                                if (ubicacionesBajas.length === 0) {
                                  return <li>✅ Todas las ubicaciones tienen productividad aceptable (≥70%)</li>;
                                }
                                
                                return ubicacionesBajas.map((ubi, idx) => (
                                  <li key={idx}>⚠️ Investigar causas de baja productividad en: <strong>{ubi}</strong></li>
                                ));
                              })()}
                            </ul>
                          </div>
                        </>
                      )}
                    </div>
                  )}
                  
                  {/* TAB 5: OCUPACIÓN ACTUAL */}
                  {activeTab === 'ocupacion' && (
                    <div>
                      <div className="mb-6">
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <h3 className="text-xl font-bold text-gray-800 mb-2">
                              📍 Ocupación Actual - Tiempo Real
                            </h3>
                            <p className="text-gray-600">
                              Ve dónde está trabajando cada persona en este momento
                            </p>
                          </div>
                          <div className="text-right">
                            <p className="text-sm text-gray-500">Actualizado:</p>
                            <p className="text-sm font-semibold text-gray-700">Hace 2 minutos</p>
                          </div>
                        </div>
                      </div>
                      
                      {/* Resumen rápido */}
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div className="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4">
                          <p className="text-sm text-blue-800 font-medium">Trabajadores Activos</p>
                          <p className="text-3xl font-bold text-blue-900">12</p>
                        </div>
                        <div className="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4">
                          <p className="text-sm text-green-800 font-medium">Productivos</p>
                          <p className="text-3xl font-bold text-green-900">10</p>
                        </div>
                        <div className="bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-lg p-4">
                          <p className="text-sm text-yellow-800 font-medium">En Espera</p>
                          <p className="text-3xl font-bold text-yellow-900">2</p>
                        </div>
                        <div className="bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg p-4">
                          <p className="text-sm text-purple-800 font-medium">Ubicaciones Activas</p>
                          <p className="text-3xl font-bold text-purple-900">8</p>
                        </div>
                      </div>
                      
                      {/* Ocupación por edificio */}
                      <div className="space-y-6">
                        {/* Edificio 1 */}
                        <div>
                          <div className="bg-gray-50 rounded-lg p-4 mb-3">
                            <div className="flex items-center justify-between">
                              <h4 className="text-lg font-bold text-gray-800">Edificio 1</h4>
                              <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                                👷 7 trabajadores
                              </span>
                            </div>
                          </div>
                          
                          <div className="pl-4 space-y-3">
                            {/* Piso 20 */}
                            <div className="bg-white rounded-lg p-4 shadow-sm">
                              <div className="flex items-center justify-between mb-3">
                                <h5 className="font-bold text-gray-800">Piso 20 - Apartamento 2</h5>
                                <span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">
                                  👷 2 activos
                                </span>
                              </div>
                              
                              <div className="space-y-2">
                                <div className="flex items-center justify-between p-2 bg-green-50 rounded">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                                      JP
                                    </div>
                                    <div>
                                      <p className="font-semibold text-gray-800">Juan Pérez</p>
                                      <p className="text-sm text-gray-600">Albañilería: Resane</p>
                                    </div>
                                  </div>
                                  <div className="text-right">
                                    <p className="text-sm font-semibold text-green-700">🔄 2.3h</p>
                                    <p className="text-xs text-gray-500">Productivo</p>
                                  </div>
                                </div>
                                
                                <div className="flex items-center justify-between p-2 bg-green-50 rounded">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                                      CR
                                    </div>
                                    <div>
                                      <p className="font-semibold text-gray-800">Carlos Ruiz</p>
                                      <p className="text-sm text-gray-600">Plomería: Instalación</p>
                                    </div>
                                  </div>
                                  <div className="text-right">
                                    <p className="text-sm font-semibold text-green-700">🔄 1.8h</p>
                                    <p className="text-xs text-gray-500">Productivo</p>
                                  </div>
                                </div>
                              </div>
                            </div>
                            
                            {/* Piso 19 */}
                            <div className="bg-white rounded-lg p-4 shadow-sm">
                              <div className="flex items-center justify-between mb-3">
                                <h5 className="font-bold text-gray-800">Piso 19 - Apartamento 1</h5>
                                <span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">
                                  👷 3 activos
                                </span>
                              </div>
                              
                              <div className="space-y-2">
                                <div className="flex items-center justify-between p-2 bg-green-50 rounded">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                                      ML
                                    </div>
                                    <div>
                                      <p className="font-semibold text-gray-800">María López</p>
                                      <p className="text-sm text-gray-600">Instalación Eléctrica</p>
                                    </div>
                                  </div>
                                  <div className="text-right">
                                    <p className="text-sm font-semibold text-green-700">🔄 0.5h</p>
                                    <p className="text-xs text-gray-500">Productivo</p>
                                  </div>
                                </div>
                                
                                <div className="flex items-center justify-between p-2 bg-green-50 rounded">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                                      PG
                                    </div>
                                    <div>
                                      <p className="font-semibold text-gray-800">Pedro Gómez</p>
                                      <p className="text-sm text-gray-600">Albañilería: Pañete</p>
                                    </div>
                                  </div>
                                  <div className="text-right">
                                    <p className="text-sm font-semibold text-green-700">🔄 1.2h</p>
                                    <p className="text-xs text-gray-500">Productivo</p>
                                  </div>
                                </div>
                                
                                <div className="flex items-center justify-between p-2 bg-green-50 rounded">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                                      AS
                                    </div>
                                    <div>
                                      <p className="font-semibold text-gray-800">Ana Suárez</p>
                                      <p className="text-sm text-gray-600">Pintura: Preparación</p>
                                    </div>
                                  </div>
                                  <div className="text-right">
                                    <p className="text-sm font-semibold text-green-700">🔄 0.8h</p>
                                    <p className="text-xs text-gray-500">Productivo</p>
                                  </div>
                                </div>
                              </div>
                            </div>
                            
                            {/* Piso 18 - Con espera */}
                            <div className="bg-white rounded-lg p-4 shadow-sm border-2 border-yellow-200">
                              <div className="flex items-center justify-between mb-3">
                                <h5 className="font-bold text-gray-800">Piso 18 - Apartamento 1</h5>
                                <span className="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-semibold">
                                  ⚠️ 2 activos (1 esperando)
                                </span>
                              </div>
                              
                              <div className="space-y-2">
                                <div className="flex items-center justify-between p-2 bg-green-50 rounded">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                                      LM
                                    </div>
                                    <div>
                                      <p className="font-semibold text-gray-800">Luis Martín</p>
                                      <p className="text-sm text-gray-600">Albañilería: Enchape</p>
                                    </div>
                                  </div>
                                  <div className="text-right">
                                    <p className="text-sm font-semibold text-green-700">🔄 2.1h</p>
                                    <p className="text-xs text-gray-500">Productivo</p>
                                  </div>
                                </div>
                                
                                <div className="flex items-center justify-between p-2 bg-yellow-50 rounded border border-yellow-200">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center text-white font-bold">
                                      JD
                                    </div>
                                    <div>
                                      <p className="font-semibold text-gray-800">José Díaz</p>
                                      <p className="text-sm text-red-600">⏳ Espera de materiales</p>
                                    </div>
                                  </div>
                                  <div className="text-right">
                                    <p className="text-sm font-semibold text-yellow-700">⏸️ 0.3h</p>
                                    <p className="text-xs text-gray-500">Improductivo</p>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        {/* Edificio 2 */}
                        <div>
                          <div className="bg-gray-50 rounded-lg p-4 mb-3">
                            <div className="flex items-center justify-between">
                              <h4 className="text-lg font-bold text-gray-800">Edificio 2</h4>
                              <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                                👷 5 trabajadores
                              </span>
                            </div>
                          </div>
                          
                          <div className="pl-4 space-y-3">
                            {/* Piso 15 */}
                            <div className="bg-white rounded-lg p-4 shadow-sm">
                              <div className="flex items-center justify-between mb-3">
                                <h5 className="font-bold text-gray-800">Piso 15 - Apartamento 1</h5>
                                <span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">
                                  👷 3 activos
                                </span>
                              </div>
                              
                              <div className="space-y-2">
                                <div className="flex items-center justify-between p-2 bg-green-50 rounded">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                                      RV
                                    </div>
                                    <div>
                                      <p className="font-semibold text-gray-800">Roberto Vargas</p>
                                      <p className="text-sm text-gray-600">Carpintería</p>
                                    </div>
                                  </div>
                                  <div className="text-right">
                                    <p className="text-sm font-semibold text-green-700">🔄 1.5h</p>
                                    <p className="text-xs text-gray-500">Productivo</p>
                                  </div>
                                </div>
                                
                                <div className="flex items-center justify-between p-2 bg-green-50 rounded">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                                      SC
                                    </div>
                                    <div>
                                      <p className="font-semibold text-gray-800">Sandra Castro</p>
                                      <p className="text-sm text-gray-600">Pintura</p>
                                    </div>
                                  </div>
                                  <div className="text-right">
                                    <p className="text-sm font-semibold text-green-700">🔄 2.0h</p>
                                    <p className="text-xs text-gray-500">Productivo</p>
                                  </div>
                                </div>
                                
                                <div className="flex items-center justify-between p-2 bg-green-50 rounded">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                                      DH
                                    </div>
                                    <div>
                                      <p className="font-semibold text-gray-800">Diego Herrera</p>
                                      <p className="text-sm text-gray-600">Instalación puertas</p>
                                    </div>
                                  </div>
                                  <div className="text-right">
                                    <p className="text-sm font-semibold text-green-700">🔄 0.9h</p>
                                    <p className="text-xs text-gray-500">Productivo</p>
                                  </div>
                                </div>
                              </div>
                            </div>
                            
                            {/* Piso 14 */}
                            <div className="bg-white rounded-lg p-4 shadow-sm">
                              <div className="flex items-center justify-between mb-3">
                                <h5 className="font-bold text-gray-800">Piso 14 - Apartamento 2</h5>
                                <span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">
                                  👷 2 activos
                                </span>
                              </div>
                              
                              <div className="space-y-2">
                                <div className="flex items-center justify-between p-2 bg-green-50 rounded">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                                      FM
                                    </div>
                                    <div>
                                      <p className="font-semibold text-gray-800">Felipe Morales</p>
                                      <p className="text-sm text-gray-600">Plomería</p>
                                    </div>
                                  </div>
                                  <div className="text-right">
                                    <p className="text-sm font-semibold text-green-700">🔄 1.1h</p>
                                    <p className="text-xs text-gray-500">Productivo</p>
                                  </div>
                                </div>
                                
                                <div className="flex items-center justify-between p-2 bg-yellow-50 rounded border border-yellow-200">
                                  <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center text-white font-bold">
                                      GS
                                    </div>
                                    <div>
                                      <p className="font-semibold text-gray-800">Gloria Sánchez</p>
                                      <p className="text-sm text-red-600">⏳ Espera herramienta</p>
                                    </div>
                                  </div>
                                  <div className="text-right">
                                    <p className="text-sm font-semibold text-yellow-700">⏸️ 0.2h</p>
                                    <p className="text-xs text-gray-500">Improductivo</p>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      {/* Leyenda */}
                      <div className="mt-6 bg-gray-50 rounded-lg p-4">
                        <h4 className="font-bold text-gray-800 mb-3">📖 Leyenda</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                          <div className="flex items-center gap-2">
                            <div className="w-4 h-4 bg-green-500 rounded-full"></div>
                            <span className="text-gray-700">🔄 Trabajando (Productivo)</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <div className="w-4 h-4 bg-yellow-500 rounded-full"></div>
                            <span className="text-gray-700">⏸️ En espera (Improductivo)</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* TAB 6: IMPRODUCTIVOS POR UBICACIÓN */}
                  {activeTab === 'improductivos-ubicacion' && (
                    <div>
                      <div className="mb-6">
                        <h3 className="text-xl font-bold text-gray-800 mb-2">
                          ⏳ Tiempos Improductivos por Ubicación
                        </h3>
                        <p className="text-gray-600">
                          Detecta áreas con más esperas y problemas para focalizar esfuerzos de mejora
                        </p>
                      </div>
                      
                      {/* Mensaje sin datos */}
                      {Object.keys(datosPorEdificio).length === 0 && (
                        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-lg">
                          <div className="flex items-start gap-3">
                            <svg className="w-6 h-6 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <div>
                              <p className="font-bold text-yellow-800 mb-1">No hay datos disponibles</p>
                              <p className="text-sm text-yellow-700">
                                No se encontraron registros de tiempos improductivos para los filtros seleccionados.
                              </p>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {Object.keys(datosPorEdificio).length > 0 && (
                        <>
                          {/* Resumen de causas principales */}
                          <div className="bg-gradient-to-r from-red-50 to-red-100 rounded-lg p-6 mb-6">
                            <h4 className="font-bold text-red-900 mb-4">📊 Causas de Improductividad</h4>
                            <div className="space-y-3">
                              {(() => {
                                // Calcular totales por causa
                                const causas = {
                                  'Espera materiales': 35.2,
                                  'Clima': 12.8,
                                  'Espera otros oficios': 10.5,
                                  'Falta herramientas': 8.3,
                                  'Espera instrucciones': 7.1,
                                  'Otros': 5.4
                                };
                                const total = Object.values(causas).reduce((a, b) => a + b, 0);
                                
                                return Object.entries(causas).map(([causa, horas], index) => {
                                  const porcentaje = (horas / total) * 100;
                                  return (
                                    <div key={index}>
                                      <div className="flex items-center justify-between mb-1">
                                        <span className="text-sm font-medium text-gray-700">{causa}</span>
                                        <span className="text-sm font-bold text-red-800">{horas.toFixed(1)}h ({porcentaje.toFixed(1)}%)</span>
                                      </div>
                                      <div className="h-3 bg-red-200 rounded-full overflow-hidden">
                                        <div 
                                          className="h-full bg-red-600 transition-all duration-300"
                                          style={{ width: `${porcentaje}%` }}
                                        ></div>
                                      </div>
                                    </div>
                                  );
                                });
                              })()}
                            </div>
                          </div>
                          
                          {/* Top 5 ubicaciones con más improductividad */}
                          <div className="mb-6">
                            <h4 className="font-bold text-gray-800 mb-3">🔴 Top 5 Ubicaciones con más Tiempos Improductivos</h4>
                            <div className="space-y-3">
                              {(() => {
                                const ubicaciones = [];
                                Object.values(datosPorEdificio).forEach(edificio => {
                                  Object.values(edificio.pisos).forEach(piso => {
                                    const horasProductivas = piso.apartamentos.reduce((acc, apt) => acc + apt.horasProductivas, 0);
                                    const horasImproductivas = piso.totalHoras - horasProductivas;
                                    if (horasImproductivas > 0) {
                                      ubicaciones.push({
                                        nombre: `${edificio.nombre} - ${piso.nombre}`,
                                        horasImproductivas: horasImproductivas,
                                        horasTotales: piso.totalHoras,
                                        porcentaje: (horasImproductivas / piso.totalHoras) * 100,
                                        // Simular causas
                                        causas: {
                                          'Espera materiales': horasImproductivas * 0.5,
                                          'Clima': horasImproductivas * 0.2,
                                          'Otros': horasImproductivas * 0.3
                                        }
                                      });
                                    }
                                  });
                                });
                                
                                return ubicaciones
                                  .sort((a, b) => b.horasImproductivas - a.horasImproductivas)
                                  .slice(0, 5)
                                  .map((ubicacion, index) => {
                                    const posicion = index + 1;
                                    const colorBorde = posicion === 1 ? 'border-red-500' : posicion === 2 ? 'border-orange-500' : 'border-yellow-500';
                                    
                                    return (
                                      <div key={index} className={`bg-white rounded-lg p-4 shadow-md border-l-4 ${colorBorde}`}>
                                        <div className="flex items-start justify-between mb-3">
                                          <div className="flex items-center gap-3">
                                            <div className="w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center font-bold text-sm">
                                              {posicion}
                                            </div>
                                            <div>
                                              <p className="font-bold text-gray-800">{ubicacion.nombre}</p>
                                              <p className="text-sm text-gray-600">
                                                {ubicacion.horasImproductivas.toFixed(1)}h improductivas de {ubicacion.horasTotales.toFixed(1)}h totales
                                              </p>
                                            </div>
                                          </div>
                                          <div className="text-right">
                                            <p className="text-2xl font-bold text-red-600">{ubicacion.porcentaje.toFixed(1)}%</p>
                                            <p className="text-xs text-gray-500">Improductivo</p>
                                          </div>
                                        </div>
                                        
                                        {/* Desglose de causas */}
                                        <div className="bg-gray-50 rounded-lg p-3">
                                          <p className="text-xs font-semibold text-gray-600 mb-2">Causas principales:</p>
                                          <div className="space-y-1">
                                            {Object.entries(ubicacion.causas).map(([causa, horas], idx) => (
                                              <div key={idx} className="flex items-center justify-between text-sm">
                                                <span className="text-gray-700">• {causa}</span>
                                                <span className="font-semibold text-gray-800">
                                                  {horas.toFixed(1)}h ({((horas / ubicacion.horasImproductivas) * 100).toFixed(0)}%)
                                                </span>
                                              </div>
                                            ))}
                                          </div>
                                        </div>
                                        
                                        {/* Recomendación */}
                                        <div className="mt-3 flex items-start gap-2 bg-blue-50 p-2 rounded">
                                          <span className="text-blue-600">💡</span>
                                          <p className="text-xs text-blue-800">
                                            {Object.entries(ubicacion.causas).sort((a, b) => b[1] - a[1])[0][0] === 'Espera materiales' 
                                              ? 'Acción recomendada: Revisar logística de materiales'
                                              : Object.entries(ubicacion.causas).sort((a, b) => b[1] - a[1])[0][0] === 'Clima'
                                              ? 'Acción recomendada: Considerar protección temporal contra clima'
                                              : 'Acción recomendada: Mejorar coordinación entre oficios'}
                                          </p>
                                        </div>
                                      </div>
                                    );
                                  });
                              })()}
                            </div>
                          </div>
                          
                          {/* Desglose por edificio */}
                          <div className="mb-6">
                            <h4 className="font-bold text-gray-800 mb-3">🏢 Desglose por Edificio</h4>
                            {Object.values(datosPorEdificio).map(edificio => {
                              const horasProductivas = Object.values(edificio.pisos).reduce((acc, piso) => 
                                acc + piso.apartamentos.reduce((sum, apt) => sum + apt.horasProductivas, 0), 0
                              );
                              const horasImproductivas = edificio.totalHoras - horasProductivas;
                              
                              if (horasImproductivas === 0) return null;
                              
                              return (
                                <div key={edificio.nombre} className="mb-4">
                                  <div className="bg-gray-50 rounded-lg p-4 mb-3">
                                    <div className="flex items-center justify-between">
                                      <h5 className="text-lg font-bold text-gray-800">{edificio.nombre}</h5>
                                      <div className="text-right">
                                        <p className="text-sm text-gray-600">Horas Improductivas</p>
                                        <p className="text-xl font-bold text-red-600">
                                          {horasImproductivas.toFixed(1)}h
                                          <span className="text-sm text-gray-600 ml-2">
                                            ({((horasImproductivas / edificio.totalHoras) * 100).toFixed(1)}%)
                                          </span>
                                        </p>
                                      </div>
                                    </div>
                                  </div>
                                  
                                  <div className="pl-4 space-y-2">
                                    {Object.values(edificio.pisos).map(piso => {
                                      const horasProductivasPiso = piso.apartamentos.reduce((acc, apt) => acc + apt.horasProductivas, 0);
                                      const horasImproductivasPiso = piso.totalHoras - horasProductivasPiso;
                                      
                                      if (horasImproductivasPiso === 0) return null;
                                      
                                      return (
                                        <div key={piso.nombre} className="bg-white rounded-lg p-3 shadow-sm">
                                          <div className="flex items-center justify-between">
                                            <div>
                                              <p className="font-semibold text-gray-800">{piso.nombre}</p>
                                              <p className="text-xs text-gray-600">
                                                {horasImproductivasPiso.toFixed(1)}h improductivas
                                              </p>
                                            </div>
                                            <div className="text-right">
                                              <div className="flex items-center gap-2">
                                                <div className="w-32 h-6 bg-gray-200 rounded-full overflow-hidden">
                                                  <div 
                                                    className="h-full bg-red-500"
                                                    style={{ width: `${(horasImproductivasPiso / piso.totalHoras) * 100}%` }}
                                                  ></div>
                                                </div>
                                                <span className="text-sm font-bold text-red-600">
                                                  {((horasImproductivasPiso / piso.totalHoras) * 100).toFixed(1)}%
                                                </span>
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                      );
                                    })}
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                          
                          {/* Resumen de acciones recomendadas */}
                          <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg">
                            <h4 className="font-bold text-blue-900 mb-3">💡 Acciones Recomendadas</h4>
                            <ul className="space-y-2 text-sm text-blue-800">
                              <li className="flex items-start gap-2">
                                <span className="font-bold">1.</span>
                                <span>Implementar sistema de alertas tempranas para materiales en ubicaciones con alta espera</span>
                              </li>
                              <li className="flex items-start gap-2">
                                <span className="font-bold">2.</span>
                                <span>Coordinar horarios de oficios diferentes para evitar tiempos de espera cruzados</span>
                              </li>
                              <li className="flex items-start gap-2">
                                <span className="font-bold">3.</span>
                                <span>Revisar stock de herramientas disponibles en cada piso activo</span>
                              </li>
                              <li className="flex items-start gap-2">
                                <span className="font-bold">4.</span>
                                <span>Establecer protocolo de comunicación más directo para instrucciones</span>
                              </li>
                            </ul>
                          </div>
                        </>
                      )}
                    </div>
                  )}
                  
                  {/* TAB 7: RUTA DE TRABAJADORES */}
                  {activeTab === 'ruta-trabajadores' && (
                    <div>
                      <div className="mb-6">
                        <h3 className="text-xl font-bold text-gray-800 mb-2">
                          🗺️ Ruta de Trabajadores
                        </h3>
                        <p className="text-gray-600">
                          Visualiza el historial de movimientos y tareas de cada trabajador durante el día
                        </p>
                      </div>
                      
                      {/* Selector de trabajador y fecha */}
                      <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                        <h4 className="font-bold text-gray-800 mb-4">🔍 Seleccionar Trabajador</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Trabajador</label>
                            <select className="w-full p-2 border border-gray-300 rounded-lg">
                              <option value="1">Juan Pérez</option>
                              <option value="2">Carlos Ruiz</option>
                              <option value="3">María López</option>
                              <option value="4">Pedro Gómez</option>
                              <option value="5">Ana Suárez</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Fecha</label>
                            <input 
                              type="date" 
                              defaultValue="2024-12-30"
                              className="w-full p-2 border border-gray-300 rounded-lg"
                            />
                          </div>
                        </div>
                      </div>
                      
                      {/* Resumen del día */}
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div className="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4">
                          <p className="text-sm text-blue-800 font-medium">Horas Totales</p>
                          <p className="text-3xl font-bold text-blue-900">7.5h</p>
                        </div>
                        <div className="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4">
                          <p className="text-sm text-green-800 font-medium">Productivo</p>
                          <p className="text-3xl font-bold text-green-900">6.5h</p>
                          <p className="text-xs text-green-700">87%</p>
                        </div>
                        <div className="bg-gradient-to-r from-red-50 to-red-100 rounded-lg p-4">
                          <p className="text-sm text-red-800 font-medium">Improductivo</p>
                          <p className="text-3xl font-bold text-red-900">1.0h</p>
                          <p className="text-xs text-red-700">13%</p>
                        </div>
                        <div className="bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg p-4">
                          <p className="text-sm text-purple-800 font-medium">Ubicaciones</p>
                          <p className="text-3xl font-bold text-purple-900">4</p>
                        </div>
                      </div>
                      
                      {/* Timeline de movimientos */}
                      <div className="bg-white rounded-xl shadow-md p-6">
                        <h4 className="font-bold text-gray-800 mb-6">📍 Timeline del Día - Juan Pérez</h4>
                        
                        <div className="relative">
                          {/* Línea vertical del timeline */}
                          <div className="absolute left-8 top-0 bottom-0 w-0.5 bg-gray-300"></div>
                          
                          <div className="space-y-6">
                            {/* Evento 1 */}
                            <div className="relative pl-20">
                              <div className="absolute left-0 w-16 text-right">
                                <p className="text-sm font-bold text-gray-700">08:00</p>
                              </div>
                              <div className="absolute left-7 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                              
                              <div className="bg-green-50 border-l-4 border-green-500 rounded-lg p-4">
                                <div className="flex items-start justify-between mb-2">
                                  <div>
                                    <p className="font-bold text-gray-800">Edificio 1 - Piso 20 - Apartamento 1</p>
                                    <p className="text-sm text-gray-600">Albañilería: Resane</p>
                                  </div>
                                  <span className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                    ✅ Productivo
                                  </span>
                                </div>
                                <div className="flex items-center gap-4 text-sm text-gray-600">
                                  <span>⏱️ Duración: 2.5h</span>
                                  <span>🎯 100% completado</span>
                                </div>
                              </div>
                            </div>
                            
                            {/* Evento 2 */}
                            <div className="relative pl-20">
                              <div className="absolute left-0 w-16 text-right">
                                <p className="text-sm font-bold text-gray-700">10:30</p>
                              </div>
                              <div className="absolute left-7 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                              
                              <div className="bg-green-50 border-l-4 border-green-500 rounded-lg p-4">
                                <div className="flex items-start justify-between mb-2">
                                  <div>
                                    <p className="font-bold text-gray-800">Edificio 1 - Piso 20 - Apartamento 2</p>
                                    <p className="text-sm text-gray-600">Albañilería: Repello</p>
                                  </div>
                                  <span className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                    ✅ Productivo
                                  </span>
                                </div>
                                <div className="flex items-center gap-4 text-sm text-gray-600">
                                  <span>⏱️ Duración: 1.8h</span>
                                  <span>🎯 75% completado</span>
                                </div>
                              </div>
                            </div>
                            
                            {/* Evento 3 - Almuerzo */}
                            <div className="relative pl-20">
                              <div className="absolute left-0 w-16 text-right">
                                <p className="text-sm font-bold text-gray-700">12:30</p>
                              </div>
                              <div className="absolute left-7 w-3 h-3 bg-gray-400 rounded-full border-2 border-white"></div>
                              
                              <div className="bg-gray-50 border-l-4 border-gray-400 rounded-lg p-4">
                                <div className="flex items-start justify-between mb-2">
                                  <div>
                                    <p className="font-bold text-gray-800">⏸️ Almuerzo / Descanso</p>
                                    <p className="text-sm text-gray-600">Permiso autorizado</p>
                                  </div>
                                  <span className="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-semibold">
                                    ⏸️ Permiso
                                  </span>
                                </div>
                                <div className="flex items-center gap-4 text-sm text-gray-600">
                                  <span>⏱️ Duración: 1.0h</span>
                                </div>
                              </div>
                            </div>
                            
                            {/* Evento 4 - Espera */}
                            <div className="relative pl-20">
                              <div className="absolute left-0 w-16 text-right">
                                <p className="text-sm font-bold text-gray-700">13:30</p>
                              </div>
                              <div className="absolute left-7 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></div>
                              
                              <div className="bg-red-50 border-l-4 border-red-500 rounded-lg p-4">
                                <div className="flex items-start justify-between mb-2">
                                  <div>
                                    <p className="font-bold text-gray-800">Edificio 1 - Piso 19 - Apartamento 5</p>
                                    <p className="text-sm text-red-600">⏳ Espera de materiales</p>
                                  </div>
                                  <span className="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-semibold">
                                    ❌ Improductivo
                                  </span>
                                </div>
                                <div className="flex items-center gap-4 text-sm text-gray-600">
                                  <span>⏱️ Duración: 0.5h</span>
                                  <span>⚠️ Tiempo de espera</span>
                                </div>
                              </div>
                            </div>
                            
                            {/* Evento 5 */}
                            <div className="relative pl-20">
                              <div className="absolute left-0 w-16 text-right">
                                <p className="text-sm font-bold text-gray-700">14:00</p>
                              </div>
                              <div className="absolute left-7 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                              
                              <div className="bg-green-50 border-l-4 border-green-500 rounded-lg p-4">
                                <div className="flex items-start justify-between mb-2">
                                  <div>
                                    <p className="font-bold text-gray-800">Edificio 1 - Piso 19 - Apartamento 6</p>
                                    <p className="text-sm text-gray-600">Albañilería: Pañete</p>
                                  </div>
                                  <span className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                    ✅ Productivo
                                  </span>
                                </div>
                                <div className="flex items-center gap-4 text-sm text-gray-600">
                                  <span>⏱️ Duración: 3.2h (hasta 17:12)</span>
                                  <span>🎯 60% completado</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      {/* Análisis de eficiencia */}
                      <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg">
                          <h5 className="font-bold text-blue-900 mb-2">📊 Análisis de Eficiencia</h5>
                          <ul className="text-sm text-blue-800 space-y-1">
                            <li>• Trabajó en 4 ubicaciones diferentes</li>
                            <li>• Todas en mismo edificio (baja distancia)</li>
                            <li>• Productividad: 87% (Excelente)</li>
                            <li>• Solo 1 evento de espera (30 min)</li>
                          </ul>
                        </div>
                        
                        <div className="bg-green-50 border-l-4 border-green-500 p-4 rounded-lg">
                          <h5 className="font-bold text-green-900 mb-2">✅ Recomendaciones</h5>
                          <ul className="text-sm text-green-800 space-y-1">
                            <li>• Excelente organización de ruta</li>
                            <li>• Mantener asignaciones en mismo edificio</li>
                            <li>• Revisar suministro de materiales en Piso 19</li>
                            <li>• Trabajador eficiente como referencia</li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* TAB 8: COMPARATIVA ENTRE UBICACIONES */}
                  {activeTab === 'comparativa' && (
                    <div>
                      <div className="mb-6">
                        <h3 className="text-xl font-bold text-gray-800 mb-2">
                          📊 Comparativa entre Ubicaciones Similares
                        </h3>
                        <p className="text-gray-600">
                          Compara métricas entre ubicaciones del mismo tipo para identificar mejores prácticas
                        </p>
                      </div>
                      
                      {/* Selector de tipo de ubicación */}
                      <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                        <h4 className="font-bold text-gray-800 mb-4">🔍 Tipo de Ubicación</h4>
                        <select className="w-full md:w-1/2 p-2 border border-gray-300 rounded-lg">
                          <option value="tipo-a">Apartamentos Tipo A (70m²)</option>
                          <option value="tipo-b">Apartamentos Tipo B (85m²)</option>
                          <option value="tipo-c">Apartamentos Tipo C (100m²)</option>
                        </select>
                      </div>
                      
                      {/* Promedio vs Individual */}
                      <div className="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-6 mb-6">
                        <h4 className="font-bold text-blue-900 mb-4">📈 Promedio del Tipo A (70m²)</h4>
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                          <div>
                            <p className="text-sm text-blue-800">Horas Totales</p>
                            <p className="text-2xl font-bold text-blue-900">42.0h</p>
                          </div>
                          <div>
                            <p className="text-sm text-blue-800">Productividad</p>
                            <p className="text-2xl font-bold text-blue-900">82.5%</p>
                          </div>
                          <div>
                            <p className="text-sm text-blue-800">Costo</p>
                            <p className="text-2xl font-bold text-blue-900">$2.1M</p>
                          </div>
                          <div>
                            <p className="text-sm text-blue-800">Días</p>
                            <p className="text-2xl font-bold text-blue-900">8.5d</p>
                          </div>
                          <div>
                            <p className="text-sm text-blue-800">$/m²</p>
                            <p className="text-2xl font-bold text-blue-900">$30,000</p>
                          </div>
                        </div>
                      </div>
                      
                      {/* Tabla comparativa */}
                      <div className="bg-white rounded-xl shadow-md overflow-hidden mb-6">
                        <div className="overflow-x-auto">
                          <table className="w-full">
                            <thead className="bg-gray-50">
                              <tr>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ubicación</th>
                                <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Horas Totales</th>
                                <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Productividad</th>
                                <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Costo</th>
                                <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Días</th>
                                <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">$/m²</th>
                                <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ranking</th>
                              </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                              {/* Fila 1 - Mejor */}
                              <tr className="bg-green-50">
                                <td className="px-6 py-4">
                                  <div className="flex items-center gap-2">
                                    <span className="text-2xl">🥇</span>
                                    <div>
                                      <p className="font-semibold text-gray-800">Edificio 1 - P20 - Apto 3</p>
                                      <p className="text-xs text-gray-500">Apartamento Tipo A</p>
                                    </div>
                                  </div>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">38.5h</p>
                                  <p className="text-xs text-green-600">-8.3% ✓</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">91.2%</p>
                                  <p className="text-xs text-green-600">+10.5% ✓</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">$1.93M</p>
                                  <p className="text-xs text-green-600">-8.1% ✓</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">7.7d</p>
                                  <p className="text-xs text-green-600">-9.4% ✓</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">$27,571</p>
                                  <p className="text-xs text-green-600">-8.1% ✓</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <span className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-bold">
                                    #1
                                  </span>
                                </td>
                              </tr>
                              
                              {/* Fila 2 */}
                              <tr>
                                <td className="px-6 py-4">
                                  <div className="flex items-center gap-2">
                                    <span className="text-2xl">🥈</span>
                                    <div>
                                      <p className="font-semibold text-gray-800">Edificio 2 - P15 - Apto 1</p>
                                      <p className="text-xs text-gray-500">Apartamento Tipo A</p>
                                    </div>
                                  </div>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">40.2h</p>
                                  <p className="text-xs text-green-600">-4.3% ✓</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">88.5%</p>
                                  <p className="text-xs text-green-600">+7.3% ✓</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">$2.01M</p>
                                  <p className="text-xs text-green-600">-4.3% ✓</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">8.0d</p>
                                  <p className="text-xs text-green-600">-5.9% ✓</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">$28,714</p>
                                  <p className="text-xs text-green-600">-4.3% ✓</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-bold">
                                    #2
                                  </span>
                                </td>
                              </tr>
                              
                              {/* Fila 3 - Promedio */}
                              <tr className="bg-blue-50 font-semibold">
                                <td className="px-6 py-4">
                                  <p className="font-bold text-gray-800">📊 PROMEDIO</p>
                                </td>
                                <td className="px-6 py-4 text-center text-gray-800">42.0h</td>
                                <td className="px-6 py-4 text-center text-gray-800">82.5%</td>
                                <td className="px-6 py-4 text-center text-gray-800">$2.1M</td>
                                <td className="px-6 py-4 text-center text-gray-800">8.5d</td>
                                <td className="px-6 py-4 text-center text-gray-800">$30,000</td>
                                <td className="px-6 py-4 text-center">-</td>
                              </tr>
                              
                              {/* Fila 4 */}
                              <tr>
                                <td className="px-6 py-4">
                                  <div className="flex items-center gap-2">
                                    <span className="text-2xl">⭐</span>
                                    <div>
                                      <p className="font-semibold text-gray-800">Edificio 1 - P19 - Apto 2</p>
                                      <p className="text-xs text-gray-500">Apartamento Tipo A</p>
                                    </div>
                                  </div>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">44.8h</p>
                                  <p className="text-xs text-red-600">+6.7% ✗</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">78.2%</p>
                                  <p className="text-xs text-red-600">-5.2% ✗</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">$2.24M</p>
                                  <p className="text-xs text-red-600">+6.7% ✗</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">9.0d</p>
                                  <p className="text-xs text-red-600">+5.9% ✗</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">$32,000</p>
                                  <p className="text-xs text-red-600">+6.7% ✗</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <span className="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-bold">
                                    #4
                                  </span>
                                </td>
                              </tr>
                              
                              {/* Fila 5 - Peor */}
                              <tr className="bg-red-50">
                                <td className="px-6 py-4">
                                  <div className="flex items-center gap-2">
                                    <span className="text-2xl">⚠️</span>
                                    <div>
                                      <p className="font-semibold text-gray-800">Edificio 1 - P20 - Apto 4</p>
                                      <p className="text-xs text-gray-500">Apartamento Tipo A</p>
                                    </div>
                                  </div>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">48.5h</p>
                                  <p className="text-xs text-red-600">+15.5% ✗</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">68.2%</p>
                                  <p className="text-xs text-red-600">-17.3% ✗</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">$2.43M</p>
                                  <p className="text-xs text-red-600">+15.7% ✗</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">9.7d</p>
                                  <p className="text-xs text-red-600">+14.1% ✗</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <p className="font-semibold text-gray-800">$34,714</p>
                                  <p className="text-xs text-red-600">+15.7% ✗</p>
                                </td>
                                <td className="px-6 py-4 text-center">
                                  <span className="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-bold">
                                    #5
                                  </span>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                      
                      {/* Mejores prácticas identificadas */}
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div className="bg-green-50 border-l-4 border-green-500 p-6 rounded-lg">
                          <h4 className="font-bold text-green-900 mb-3">✅ Mejores Prácticas (Edif1-P20-Apto3)</h4>
                          <ul className="text-sm text-green-800 space-y-2">
                            <li className="flex items-start gap-2">
                              <span>✓</span>
                              <span><strong>Coordinación previa:</strong> Materiales listos antes de iniciar</span>
                            </li>
                            <li className="flex items-start gap-2">
                              <span>✓</span>
                              <span><strong>Cuadrillas especializadas:</strong> Personal con experiencia en tipo A</span>
                            </li>
                            <li className="flex items-start gap-2">
                              <span>✓</span>
                              <span><strong>Turnos optimizados:</strong> Sin tiempos muertos entre tareas</span>
                            </li>
                            <li className="flex items-start gap-2">
                              <span>✓</span>
                              <span><strong>Supervisión continua:</strong> Resolvió problemas inmediatamente</span>
                            </li>
                          </ul>
                        </div>
                        
                        <div className="bg-red-50 border-l-4 border-red-500 p-6 rounded-lg">
                          <h4 className="font-bold text-red-900 mb-3">⚠️ Problemas Detectados (Edif1-P20-Apto4)</h4>
                          <ul className="text-sm text-red-800 space-y-2">
                            <li className="flex items-start gap-2">
                              <span>✗</span>
                              <span><strong>Falta de materiales:</strong> 8.5h de espera acumulada</span>
                            </li>
                            <li className="flex items-start gap-2">
                              <span>✗</span>
                              <span><strong>Personal sin experiencia:</strong> Mayor tiempo en tareas</span>
                            </li>
                            <li className="flex items-start gap-2">
                              <span>✗</span>
                              <span><strong>Retrabajos:</strong> 12% del tiempo en correcciones</span>
                            </li>
                            <li className="flex items-start gap-2">
                              <span>✗</span>
                              <span><strong>Coordinación deficiente:</strong> Oficios se bloquearon mutuamente</span>
                            </li>
                          </ul>
                        </div>
                      </div>
                      
                      {/* Recomendaciones */}
                      <div className="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg">
                        <h4 className="font-bold text-blue-900 mb-3">💡 Aplicar Mejores Prácticas</h4>
                        <div className="space-y-3">
                          <div className="bg-white rounded p-3">
                            <p className="font-semibold text-gray-800 mb-1">Para apartamentos similares pendientes:</p>
                            <ul className="text-sm text-gray-700 space-y-1">
                              <li>• <strong>Edif1-P19-A1:</strong> Aplicar proceso de Apto3 → Reducción estimada: 10%</li>
                              <li>• <strong>Edif2-P15-A3:</strong> Aplicar proceso de Apto3 → Reducción estimada: 8%</li>
                            </ul>
                          </div>
                          <div className="bg-white rounded p-3">
                            <p className="font-semibold text-gray-800 mb-1">Proyección de ahorro:</p>
                            <p className="text-sm text-gray-700">
                              Aplicando mejores prácticas a los 8 apartamentos pendientes tipo A: 
                              <strong className="text-green-700"> ahorro estimado de $640,000</strong> y 
                              <strong className="text-green-700"> 32 horas</strong>
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        }


        // ==================== DASHBOARD MEJORADO v1.7.0 ====================
        
        function Dashboard({ userRole, clientes, proyectos, trabajadores, currentClienteId }) {
          const isAdmin = userRole === 'admin';
          const currentCliente = clientes.find(c => c.id === currentClienteId);
          
          const visibleProyectos = isAdmin 
            ? proyectos 
            : proyectos.filter(p => p.clienteId === currentClienteId);

          const visibleTrabajadores = isAdmin
            ? trabajadores
            : trabajadores.filter(t => t.clienteId === currentClienteId);

          // ⭐ v1.7.0 - Datos de demo para dashboard (reemplazar con datos reales)
          const [registrosDemo] = React.useState([
            { id: 1, tipo: 'productivo', disciplina: 'Albañilería', horas: 120, trabajador: 'Operario', nivelTrabajador: 3, nivelOptimo: 3 },
            { id: 2, tipo: 'productivo', disciplina: 'Estructura', horas: 95, trabajador: 'Oficial', nivelTrabajador: 4, nivelOptimo: 4 },
            { id: 3, tipo: 'improductivo', disciplina: 'Esperas', horas: 25, trabajador: 'Peón', nivelTrabajador: 1, nivelOptimo: 1 },
            { id: 4, tipo: 'productivo', disciplina: 'Pintura', horas: 60, trabajador: 'Operario', nivelTrabajador: 3, nivelOptimo: 2 },
            { id: 5, tipo: 'improductivo', disciplina: 'Permisos', horas: 15, trabajador: 'Ayudante', nivelTrabajador: 2, nivelOptimo: 1 },
            { id: 6, tipo: 'productivo', disciplina: 'Eléctrica', horas: 80, trabajador: 'Oficial', nivelTrabajador: 4, nivelOptimo: 4 },
          ]);

          // Calcular stats
          const stats = {
            totalProyectos: visibleProyectos.length,
            enEjecucion: visibleProyectos.filter(p => p.estado === 'En Ejecución').length,
            completados: visibleProyectos.filter(p => p.estado === 'Completado').length,
            presupuestoTotal: visibleProyectos.reduce((sum, p) => sum + p.presupuesto, 0),
            totalTrabajadores: visibleTrabajadores.length,
            trabajadoresActivos: visibleTrabajadores.filter(t => t.activo).length,
            
            // ⭐ v1.7.0 - KPIs de productividad
            horasProductivas: registrosDemo.filter(r => r.tipo === 'productivo').reduce((sum, r) => sum + r.horas, 0),
            horasImproductivas: registrosDemo.filter(r => r.tipo === 'improductivo').reduce((sum, r) => sum + r.horas, 0),
            subutilizacion: registrosDemo.filter(r => r.nivelTrabajador > r.nivelOptimo).length,
            eficiencia: 0
          };
          
          stats.totalHoras = stats.horasProductivas + stats.horasImproductivas;
          stats.eficiencia = stats.totalHoras > 0 
            ? Math.round((stats.horasProductivas / stats.totalHoras) * 100) 
            : 0;

          // ⭐ Datos para gráfica de productividad
          const productividadData = {
            labels: ['Productivas', 'Improductivas'],
            values: [stats.horasProductivas, stats.horasImproductivas],
            colors: ['#10b981', '#ef4444']
          };

          // ⭐ Datos para gráfica de disciplinas
          const disciplinasData = {};
          registrosDemo.forEach(r => {
            if (r.tipo === 'productivo') {
              disciplinasData[r.disciplina] = (disciplinasData[r.disciplina] || 0) + r.horas;
            }
          });

          const disciplinasChartData = {
            labels: Object.keys(disciplinasData),
            values: Object.values(disciplinasData)
          };

          // ⭐ Renderizar gráfica de productividad
          React.useEffect(() => {
            const ctx = document.getElementById('productividadChart');
            if (ctx) {
              new Chart(ctx, {
                type: 'doughnut',
                data: {
                  labels: productividadData.labels,
                  datasets: [{
                    data: productividadData.values,
                    backgroundColor: productividadData.colors,
                    borderWidth: 0
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      position: 'bottom'
                    },
                    title: {
                      display: true,
                      text: 'Distribución de Horas'
                    }
                  }
                }
              });
            }
          }, []);

          // ⭐ Renderizar gráfica de disciplinas
          React.useEffect(() => {
            const ctx = document.getElementById('disciplinasChart');
            if (ctx) {
              new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: disciplinasChartData.labels,
                  datasets: [{
                    label: 'Horas',
                    data: disciplinasChartData.values,
                    backgroundColor: '#3b82f6',
                    borderRadius: 8
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      display: false
                    },
                    title: {
                      display: true,
                      text: 'Horas por Disciplina'
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true
                    }
                  }
                }
              });
            }
          }, []);

          return (
            <div className="space-y-6">
              <div>
                <h2 className="text-3xl font-bold text-gray-800 mb-2">
                  {isAdmin ? 'Dashboard Administrador' : 'Mi Dashboard'}
                </h2>
                <p className="text-gray-600">
                  {isAdmin ? 'Vista general del sistema' : `Bienvenido, ${currentCliente?.nombre}`}
                </p>
              </div>
              
              {/* ⭐ KPIs Cards - Fila 1: Proyectos y Trabajadores */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="text-sm text-gray-600 mb-1">
                        {isAdmin ? 'Total Clientes' : 'Mis Proyectos'}
                      </div>
                      <div className="text-3xl font-bold text-gray-800">
                        {isAdmin ? clientes.length : stats.totalProyectos}
                      </div>
                      <div className="text-xs text-green-600 mt-2">
                        {isAdmin ? `${clientes.filter(c => c.activo).length} activos` : 'Totales'}
                      </div>
                    </div>
                    <div className="text-blue-500 text-4xl opacity-20">📊</div>
                  </div>
                </div>
                
                <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="text-sm text-gray-600 mb-1">Proyectos Activos</div>
                      <div className="text-3xl font-bold text-gray-800">{stats.totalProyectos}</div>
                      <div className="text-xs text-blue-600 mt-2">{stats.enEjecucion} en ejecución</div>
                    </div>
                    <div className="text-green-500 text-4xl opacity-20">🏗️</div>
                  </div>
                </div>
                
                <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="text-sm text-gray-600 mb-1">Trabajadores</div>
                      <div className="text-3xl font-bold text-gray-800">{stats.totalTrabajadores}</div>
                      <div className="text-xs text-gray-500 mt-2">{stats.trabajadoresActivos} activos</div>
                    </div>
                    <div className="text-purple-500 text-4xl opacity-20">👷</div>
                  </div>
                </div>
                
                <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-orange-500">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="text-sm text-gray-600 mb-1">Presupuesto Total</div>
                      <div className="text-2xl font-bold text-gray-800">{formatCurrency(stats.presupuestoTotal)}</div>
                      <div className="text-xs text-blue-600 mt-2">Inversión</div>
                    </div>
                    <div className="text-orange-500 text-4xl opacity-20">💰</div>
                  </div>
                </div>
              </div>

              {/* ⭐ v1.7.0 - KPIs Cards - Fila 2: Productividad */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div className="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl shadow-md p-6 text-white">
                  <div className="text-sm opacity-90 mb-1">Horas Productivas</div>
                  <div className="text-3xl font-bold">{stats.horasProductivas}h</div>
                  <div className="text-xs opacity-75 mt-2">Actividades productivas</div>
                </div>
                
                <div className="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-md p-6 text-white">
                  <div className="text-sm opacity-90 mb-1">Horas Improductivas</div>
                  <div className="text-3xl font-bold">{stats.horasImproductivas}h</div>
                  <div className="text-xs opacity-75 mt-2">Esperas, permisos, etc.</div>
                </div>
                
                <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-md p-6 text-white">
                  <div className="text-sm opacity-90 mb-1">Eficiencia</div>
                  <div className="text-3xl font-bold">{stats.eficiencia}%</div>
                  <div className="text-xs opacity-75 mt-2">Tiempo productivo</div>
                </div>
                
                <div className="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl shadow-md p-6 text-white">
                  <div className="text-sm opacity-90 mb-1">Alertas Subutilización</div>
                  <div className="text-3xl font-bold">{stats.subutilizacion}</div>
                  <div className="text-xs opacity-75 mt-2">Trabajadores sobrecalificados</div>
                </div>
              </div>

              {/* ⭐ v1.7.0 - Gráficas */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="bg-white rounded-xl shadow-md p-6">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">
                    Productividad
                  </h3>
                  <div style={{ height: '300px' }}>
                    <canvas id="productividadChart"></canvas>
                  </div>
                </div>

                <div className="bg-white rounded-xl shadow-md p-6">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">
                    Horas por Disciplina
                  </h3>
                  <div style={{ height: '300px' }}>
                    <canvas id="disciplinasChart"></canvas>
                  </div>
                </div>
              </div>

              {/* Proyectos Recientes */}
              <div className="bg-white rounded-xl shadow-md p-6">
                <h3 className="text-lg font-bold text-gray-800 mb-4">
                  Proyectos Recientes
                </h3>
                <div className="space-y-3">
                  {visibleProyectos.slice(0, 5).map(proyecto => (
                    <div key={proyecto.id} className="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
                      <div>
                        <div className="font-medium text-gray-900">{proyecto.nombre}</div>
                        <div className="text-sm text-gray-500">{proyecto.direccion}</div>
                      </div>
                      <span className={`px-3 py-1 text-xs font-semibold rounded-full ${getEstadoColor(proyecto.estado)}`}>
                        {proyecto.estado}
                      </span>
                    </div>
                  ))}
                  {visibleProyectos.length === 0 && (
                    <div className="text-center text-gray-500 py-8">
                      No hay proyectos registrados
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        }


        function ConfiguracionLocalizacionModal({ proyecto, onSave, onClose }) {
          const [config, setConfig] = useState({
            nivel1: {
              tipo: 'Torre',
              etiqueta: 'Torre/Edificio',
              opciones: ['Torre Norte', 'Torre Sur']
            },
            nivel2: {
              tipo: 'PisoApto',
              etiqueta: 'Piso + Apartamento',
              generarAutomatico: true,
              formato: 'Piso {piso} - Apto {apto}',
              config: {
                'Torre Norte': { pisos: 20, aptosPorPiso: 6 },
                'Torre Sur': { pisos: 20, aptosPorPiso: 6 }
              }
            },
            nivel3: {
              activo: false,
              tipo: 'Area',
              etiqueta: 'Área',
              opciones: []
            }
          });

          const [tipoNivel1, setTipoNivel1] = useState('Torre');
          const [tipoNivel2, setTipoNivel2] = useState('PisoApto');
          const [generacionAuto, setGeneracionAuto] = useState(true);

          const tiposNivel1 = [
            { value: 'Torre', label: 'Torre/Edificio' },
            { value: 'Manzana', label: 'Manzana' },
            { value: 'Bloque', label: 'Bloque' },
            { value: 'Sector', label: 'Sector' },
            { value: 'Area', label: 'Área' }
          ];

          const tiposNivel2 = [
            { value: 'PisoApto', label: 'Piso + Apartamento' },
            { value: 'Casa', label: 'Casa' },
            { value: 'Local', label: 'Local' },
            { value: 'Area', label: 'Área' }
          ];

          const handleSubmit = (e) => {
            e.preventDefault();
            
            const localizacionConfig = {
              proyectoId: proyecto.id,
              nivel1: config.nivel1,
              nivel2: config.nivel2,
              nivel3: config.nivel3
            };

            onSave(localizacionConfig);
          };

          const totalUbicaciones = useMemo(() => {
            return LocalizacionUtils.contarUbicaciones(config);
          }, [config]);

          return (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl my-8">
                <div className="flex items-center justify-between p-6 border-b border-gray-200">
                  <div>
                    <h3 className="text-xl font-bold text-gray-900">
                      📍 Configurar Localización
                    </h3>
                    <p className="text-sm text-gray-600 mt-1">
                      Proyecto: {proyecto.nombre}
                    </p>
                  </div>
                  <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                    <X className="w-6 h-6" />
                  </button>
                </div>

                <form onSubmit={handleSubmit}>
                  <div className="p-6 space-y-6 max-h-[600px] overflow-y-auto">
                    
                    {/* Nivel 1 */}
                    <div className="border border-blue-200 rounded-lg p-4 bg-blue-50">
                      <h4 className="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <span className="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">1</span>
                        Nivel Principal (Obligatorio)
                      </h4>

                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Tipo de Nivel *
                          </label>
                          <select
                            required
                            value={tipoNivel1}
                            onChange={(e) => {
                              setTipoNivel1(e.target.value);
                              const selected = tiposNivel1.find(t => t.value === e.target.value);
                              setConfig({
                                ...config,
                                nivel1: {
                                  ...config.nivel1,
                                  tipo: e.target.value,
                                  etiqueta: selected?.label || ''
                                }
                              });
                            }}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                          >
                            {tiposNivel1.map(tipo => (
                              <option key={tipo.value} value={tipo.value}>{tipo.label}</option>
                            ))}
                          </select>
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Cantidad de {config.nivel1.etiqueta}s *
                          </label>
                          <input
                            type="number"
                            min="1"
                            max="20"
                            value={config.nivel1.opciones.length}
                            onChange={(e) => {
                              const cantidad = parseInt(e.target.value);
                              const nuevasOpciones = [];
                              const etiqueta = config.nivel1.etiqueta;
                              for (let i = 1; i <= cantidad; i++) {
                                nuevasOpciones.push(`${etiqueta} ${i}`);
                              }
                              setConfig({
                                ...config,
                                nivel1: { ...config.nivel1, opciones: nuevasOpciones }
                              });
                            }}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                      </div>

                      <div className="mt-3">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Nombres (puedes editarlos)
                        </label>
                        <div className="flex flex-wrap gap-2">
                          {config.nivel1.opciones.map((opcion, index) => (
                            <input
                              key={index}
                              type="text"
                              value={opcion}
                              onChange={(e) => {
                                const nuevasOpciones = [...config.nivel1.opciones];
                                nuevasOpciones[index] = e.target.value;
                                setConfig({
                                  ...config,
                                  nivel1: { ...config.nivel1, opciones: nuevasOpciones }
                                });
                              }}
                              className="px-3 py-1 border border-gray-300 rounded text-sm"
                            />
                          ))}
                        </div>
                      </div>
                    </div>

                    {/* Nivel 2 */}
                    <div className="border border-green-200 rounded-lg p-4 bg-green-50">
                      <h4 className="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <span className="bg-green-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">2</span>
                        Nivel Secundario (Obligatorio)
                      </h4>

                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Tipo de Nivel *
                        </label>
                        <select
                          required
                          value={tipoNivel2}
                          onChange={(e) => {
                            setTipoNivel2(e.target.value);
                            const selected = tiposNivel2.find(t => t.value === e.target.value);
                            setConfig({
                              ...config,
                              nivel2: {
                                ...config.nivel2,
                                tipo: e.target.value,
                                etiqueta: selected?.label || ''
                              }
                            });
                          }}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                        >
                          {tiposNivel2.map(tipo => (
                            <option key={tipo.value} value={tipo.value}>{tipo.label}</option>
                          ))}
                        </select>
                      </div>

                      <div className="mb-4">
                        <label className="flex items-center gap-2">
                          <input
                            type="checkbox"
                            checked={generacionAuto}
                            onChange={(e) => {
                              setGeneracionAuto(e.target.checked);
                              setConfig({
                                ...config,
                                nivel2: { ...config.nivel2, generarAutomatico: e.target.checked }
                              });
                            }}
                            className="w-4 h-4 text-blue-600 border-gray-300 rounded"
                          />
                          <span className="text-sm font-medium text-gray-700">
                            Generar automáticamente (recomendado)
                          </span>
                        </label>
                      </div>

                      {generacionAuto && tipoNivel2 === 'PisoApto' && (
                        <div className="space-y-3">
                          <p className="text-sm text-gray-600">
                            Configurar pisos y apartamentos por cada {config.nivel1.etiqueta}:
                          </p>
                          {config.nivel1.opciones.map((opcion, index) => (
                            <div key={index} className="grid grid-cols-3 gap-3 items-center bg-white p-3 rounded border border-gray-200">
                              <div className="font-medium text-sm">{opcion}</div>
                              <div>
                                <label className="text-xs text-gray-600">Pisos</label>
                                <input
                                  type="number"
                                  min="1"
                                  value={config.nivel2.config[opcion]?.pisos || 20}
                                  onChange={(e) => {
                                    const newConfig = { ...config.nivel2.config };
                                    newConfig[opcion] = {
                                      ...newConfig[opcion],
                                      pisos: parseInt(e.target.value)
                                    };
                                    setConfig({
                                      ...config,
                                      nivel2: { ...config.nivel2, config: newConfig }
                                    });
                                  }}
                                  className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                />
                              </div>
                              <div>
                                <label className="text-xs text-gray-600">Aptos/Piso</label>
                                <input
                                  type="number"
                                  min="1"
                                  value={config.nivel2.config[opcion]?.aptosPorPiso || 6}
                                  onChange={(e) => {
                                    const newConfig = { ...config.nivel2.config };
                                    newConfig[opcion] = {
                                      ...newConfig[opcion],
                                      aptosPorPiso: parseInt(e.target.value)
                                    };
                                    setConfig({
                                      ...config,
                                      nivel2: { ...config.nivel2, config: newConfig }
                                    });
                                  }}
                                  className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                />
                              </div>
                            </div>
                          ))}
                        </div>
                      )}

                      {generacionAuto && tipoNivel2 === 'Casa' && (
                        <div className="space-y-3">
                          <p className="text-sm text-gray-600">
                            Configurar casas por cada {config.nivel1.etiqueta}:
                          </p>
                          {config.nivel1.opciones.map((opcion, index) => (
                            <div key={index} className="grid grid-cols-2 gap-3 items-center bg-white p-3 rounded border border-gray-200">
                              <div className="font-medium text-sm">{opcion}</div>
                              <div>
                                <label className="text-xs text-gray-600">Número de Casas</label>
                                <input
                                  type="number"
                                  min="1"
                                  value={config.nivel2.config[opcion]?.casas || 10}
                                  onChange={(e) => {
                                    const newConfig = { ...config.nivel2.config };
                                    newConfig[opcion] = {
                                      casas: parseInt(e.target.value)
                                    };
                                    setConfig({
                                      ...config,
                                      nivel2: { ...config.nivel2, config: newConfig }
                                    });
                                  }}
                                  className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                />
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>

                    {/* Preview */}
                    <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                      <h4 className="font-semibold text-gray-900 mb-2 flex items-center gap-2">
                        <span>📊</span>
                        Preview de Ubicaciones
                      </h4>
                      <div className="text-sm text-gray-600 space-y-1">
                        <p>
                          Se generarán <strong className="text-blue-600">{totalUbicaciones} ubicaciones</strong> automáticamente
                        </p>
                        <p className="text-xs">
                          Ejemplos:
                        </p>
                        <div className="bg-white p-2 rounded border border-gray-200 text-xs font-mono space-y-1">
                          {config.nivel1.opciones.slice(0, 2).map(nivel1 => (
                            <div key={nivel1}>
                              • {nivel1} → Piso 1 - Apto 1, Piso 1 - Apto 2, ...
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>

                  </div>

                  <div className="flex items-center justify-end gap-3 p-6 border-t border-gray-200 bg-gray-50">
                    <button
                      type="button"
                      onClick={onClose}
                      className="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                      Cancelar
                    </button>
                    <button
                      type="submit"
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"
                    >
                      <span>Guardar y Generar {totalUbicaciones} Ubicaciones</span>
                    </button>
                  </div>
                </form>
              </div>
            </div>
          );
        }


        function ProyectosCRUD({ 
          proyectos, 
          setProyectos, 
          clientes, 
          userRole, 
          currentClienteId,
          // ⭐ NUEVO v1.6.0 - Props para instanciación
          disciplinasMaestras,
          tareasMaestras,
          subtareasMaestras,
          proyectoDisciplinas,
          setProyectoDisciplinas,
          proyectoTareas,
          setProyectoTareas,
          proyectoSubtareas,
          setProyectoSubtareas,
          localizacionConfig,
          setLocalizacionConfig,
          ubicaciones,
          setUbicaciones,
          // ⭐ NUEVO v1.6.1 - Props para trabajadores
          proyectoTrabajadores,
          setProyectoTrabajadores,
          trabajadores,
          tiposTrabajador
        }) {
          const isAdmin = userRole === 'admin';
          const [searchTerm, setSearchTerm] = useState('');
          const [filterCliente, setFilterCliente] = useState('all');
          const [filterEstado, setFilterEstado] = useState('all');
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [editingProyecto, setEditingProyecto] = useState(null);
          
          // ⭐ NUEVO v1.8.0 - Vista de detalles
          const [vista, setVista] = useState('lista'); // 'lista' | 'detalle'
          const [proyectoSeleccionado, setProyectoSeleccionado] = useState(null);

          // Filtrar proyectos según rol
          const visibleProyectos = isAdmin 
            ? proyectos 
            : proyectos.filter(p => p.clienteId === currentClienteId);

          // Aplicar filtros
          const filteredProyectos = useMemo(() => {
            let result = visibleProyectos;

            // Búsqueda por texto
            if (searchTerm) {
              result = result.filter(p =>
                p.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.descripcion.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.direccion.toLowerCase().includes(searchTerm.toLowerCase())
              );
            }

            // Filtro por cliente
            if (filterCliente !== 'all') {
              result = result.filter(p => p.clienteId === parseInt(filterCliente));
            }

            // Filtro por estado
            if (filterEstado !== 'all') {
              result = result.filter(p => p.estado === filterEstado);
            }

            return result;
          }, [visibleProyectos, searchTerm, filterCliente, filterEstado]);

          const handleCreate = () => {
            setEditingProyecto(null);
            setIsModalOpen(true);
          };

          const handleEdit = (proyecto) => {
            setEditingProyecto(proyecto);
            setIsModalOpen(true);
          };
          
          // ⭐ NUEVO v1.8.0 - Funciones de vista
          const handleVerDetalles = (proyecto) => {
            setProyectoSeleccionado(proyecto);
            setVista('detalle');
          };
          
          const handleVolverALista = () => {
            setProyectoSeleccionado(null);
            setVista('lista');
          };

          const handleDelete = (id) => {
            if (confirm('¿Estás seguro de eliminar este proyecto?')) {
              setProyectos(proyectos.filter(p => p.id !== id));
            }
          };

          const handleSave = (proyectoData) => {
            let proyectoGuardado;
            
            if (editingProyecto) {
              // Editar
              proyectoGuardado = { ...proyectoData, id: editingProyecto.id };
              setProyectos((proyectos || []).map(p => 
                p.id === editingProyecto.id ? proyectoGuardado : p
              ));
              setIsModalOpen(false);
            } else {
              // Crear
              proyectoGuardado = {
                ...proyectoData,
                id: Math.max(...(proyectos || []).map(p => p.id), 0) + 1
              };
              setProyectos([...proyectos, proyectoGuardado]);
              // No cerrar modal aquí - el ProyectoModal lo manejará
            }
            
            return proyectoGuardado;
          };

          // ==================== COMPONENTE: DETALLE PROYECTO (v1.8.0) ====================
          
          const ProyectoDetalle = ({ proyecto, proyectoTrabajadores, setProyectoTrabajadores, trabajadores, tiposTrabajador, userRole, currentClienteId }) => {
            const [pestanaActiva, setPestanaActiva] = useState('plantillas');
            
            const cliente = clientes.find(c => c.id === proyecto.clienteId);
            
            return (
              <div>
                {/* Header con botón volver */}
                <div className="flex items-center gap-4 mb-6">
                  <button
                    onClick={handleVolverALista}
                    className="flex items-center gap-2 text-gray-600 hover:text-gray-800 transition-colors"
                  >
                    <ArrowLeft className="w-5 h-5" />
                    Volver
                  </button>
                  <div className="flex-1">
                    <h2 className="text-3xl font-bold text-gray-800">{proyecto.nombre}</h2>
                    <p className="text-gray-600 mt-1">{proyecto.descripcion}</p>
                  </div>
                </div>

                {/* Info general */}
                <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                      <div className="text-sm text-gray-500 mb-1">Cliente</div>
                      <div className="font-medium">{cliente?.nombre || 'N/A'}</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500 mb-1">Dirección</div>
                      <div className="font-medium">{proyecto.direccion}</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500 mb-1">Presupuesto</div>
                      <div className="font-medium text-green-600">{formatCurrency(proyecto.presupuesto)}</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500 mb-1">Fecha Inicio</div>
                      <div className="font-medium">{formatDate(proyecto.fechaInicio)}</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500 mb-1">Fecha Fin Estimada</div>
                      <div className="font-medium">{formatDate(proyecto.fechaFin)}</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500 mb-1">Estado</div>
                      <span className={`px-2 py-1 text-xs font-semibold rounded-full ${getEstadoColor(proyecto.estado)}`}>
                        {proyecto.estado}
                      </span>
                    </div>
                  </div>
                </div>

                {/* Pestañas */}
                <div className="bg-white rounded-lg shadow-sm">
                  <div className="border-b border-gray-200">
                    <div className="flex gap-0">
                      <button
                        onClick={() => setPestanaActiva('plantillas')}
                        className={`px-6 py-3 font-medium transition-colors border-b-2 ${
                          pestanaActiva === 'plantillas'
                            ? 'border-blue-600 text-blue-600'
                            : 'border-transparent text-gray-600 hover:text-gray-800'
                        }`}
                      >
                        📋 Plantillas Instanciadas
                      </button>
                      <button
                        onClick={() => setPestanaActiva('ubicaciones')}
                        className={`px-6 py-3 font-medium transition-colors border-b-2 ${
                          pestanaActiva === 'ubicaciones'
                            ? 'border-blue-600 text-blue-600'
                            : 'border-transparent text-gray-600 hover:text-gray-800'
                        }`}
                      >
                        📍 Ubicaciones
                      </button>
                      <button
                        onClick={() => setPestanaActiva('trabajadores')}
                        className={`px-6 py-3 font-medium transition-colors border-b-2 ${
                          pestanaActiva === 'trabajadores'
                            ? 'border-blue-600 text-blue-600'
                            : 'border-transparent text-gray-600 hover:text-gray-800'
                        }`}
                      >
                        👷 Trabajadores
                      </button>
                    </div>
                  </div>

                  <div className="p-6">
                    {pestanaActiva === 'plantillas' && (
                      <PlantillasProyecto proyectoId={proyecto.id} />
                    )}
                    {pestanaActiva === 'ubicaciones' && (
                      <UbicacionesProyecto 
                        proyectoId={proyecto.id}
                        proyecto={proyecto}
                        userRole={userRole}
                        currentClienteId={currentClienteId}
                      />
                    )}
                    {pestanaActiva === 'trabajadores' && (
                      <TrabajadoresProyecto 
                        proyectoId={proyecto.id}
                        proyecto={proyecto}
                        proyectoTrabajadores={proyectoTrabajadores}
                        setProyectoTrabajadores={setProyectoTrabajadores}
                        trabajadores={trabajadores}
                        tiposTrabajador={tiposTrabajador}
                        userRole={userRole}
                        currentClienteId={currentClienteId}
                      />
                    )}
                  </div>
                </div>
              </div>
            );
          };

          // ==================== COMPONENTE: PLANTILLAS PROYECTO (v1.8.0) ====================
          
          const PlantillasProyecto = ({ proyectoId }) => {
            const [expandidoDisciplina, setExpandidoDisciplina] = useState({});
            const [expandidoTarea, setExpandidoTarea] = useState({});
            const [editingSubtarea, setEditingSubtarea] = useState(null);
            
            // Filtrar plantillas de este proyecto
            const disciplinas = proyectoDisciplinas.filter(d => d.proyectoId === proyectoId);
            const tareas = proyectoTareas.filter(t => t.proyectoId === proyectoId);
            const subtareas = proyectoSubtareas.filter(s => s.proyectoId === proyectoId);
            
            const toggleDisciplina = (id) => {
              setExpandidoDisciplina(prev => ({ ...prev, [id]: !prev[id] }));
            };
            
            const toggleTarea = (id) => {
              setExpandidoTarea(prev => ({ ...prev, [id]: !prev[id] }));
            };
            
            const handleEditarSubtarea = (subtarea) => {
              setEditingSubtarea(subtarea);
            };
            
            const handleGuardarSubtarea = (subtareaActualizada) => {
              const index = proyectoSubtareas.findIndex(s => s.id === subtareaActualizada.id);
              if (index !== -1) {
                const nuevasSubtareas = [...proyectoSubtareas];
                nuevasSubtareas[index] = subtareaActualizada;
                setProyectoSubtareas(nuevasSubtareas);
              }
              setEditingSubtarea(null);
            };
            
            if (disciplinas.length === 0) {
              return (
                <div className="text-center py-12 text-gray-500">
                  <p className="text-lg mb-2">No hay plantillas instanciadas</p>
                  <p className="text-sm">Este proyecto no tiene disciplinas, tareas o subtareas asignadas.</p>
                </div>
              );
            }
            
            return (
              <div>
                {/* Estadísticas */}
                <div className="grid grid-cols-3 gap-4 mb-6">
                  <div className="bg-blue-50 p-4 rounded-lg">
                    <div className="text-sm text-blue-600 mb-1">Disciplinas</div>
                    <div className="text-2xl font-bold text-blue-700">{disciplinas.length}</div>
                  </div>
                  <div className="bg-green-50 p-4 rounded-lg">
                    <div className="text-sm text-green-600 mb-1">Tareas</div>
                    <div className="text-2xl font-bold text-green-700">{tareas.length}</div>
                  </div>
                  <div className="bg-purple-50 p-4 rounded-lg">
                    <div className="text-sm text-purple-600 mb-1">Subtareas</div>
                    <div className="text-2xl font-bold text-purple-700">{subtareas.length}</div>
                  </div>
                </div>

                {/* Árbol de plantillas */}
                <div className="space-y-2">
                  {disciplinas.map(disciplina => {
                    const tareasDisciplina = tareas.filter(t => t.disciplinaId === disciplina.id);
                    const isExpanded = expandidoDisciplina[disciplina.id];
                    
                    return (
                      <div key={disciplina.id} className="border border-gray-200 rounded-lg overflow-hidden">
                        {/* Disciplina */}
                        <div
                          className="bg-blue-50 p-4 cursor-pointer hover:bg-blue-100 transition-colors flex items-center justify-between"
                          onClick={() => toggleDisciplina(disciplina.id)}
                        >
                          <div className="flex items-center gap-3">
                            {isExpanded ? <ChevronDown className="w-5 h-5 text-blue-600" /> : <ChevronRight className="w-5 h-5 text-blue-600" />}
                            <div>
                              <div className="font-semibold text-gray-800">{disciplina.nombre}</div>
                              <div className="text-sm text-gray-600">{disciplina.codigo} • {tareasDisciplina.length} tareas</div>
                            </div>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className={`px-2 py-1 text-xs rounded-full ${disciplina.activo ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}`}>
                              {disciplina.activo ? 'Activa' : 'Inactiva'}
                            </span>
                          </div>
                        </div>

                        {/* Tareas de la disciplina */}
                        {isExpanded && (
                          <div className="bg-white">
                            {tareasDisciplina.map(tarea => {
                              const subtareasTarea = subtareas.filter(s => s.tareaId === tarea.id);
                              const isTareaExpanded = expandidoTarea[tarea.id];
                              
                              return (
                                <div key={tarea.id} className="border-t border-gray-200">
                                  {/* Tarea */}
                                  <div
                                    className="p-4 pl-12 cursor-pointer hover:bg-gray-50 transition-colors flex items-center justify-between"
                                    onClick={() => toggleTarea(tarea.id)}
                                  >
                                    <div className="flex items-center gap-3">
                                      {isTareaExpanded ? <ChevronDown className="w-4 h-4 text-green-600" /> : <ChevronRight className="w-4 h-4 text-green-600" />}
                                      <div>
                                        <div className="font-medium text-gray-800">{tarea.nombre}</div>
                                        <div className="text-xs text-gray-500">{tarea.codigo} • {subtareasTarea.length} subtareas</div>
                                      </div>
                                    </div>
                                  </div>

                                  {/* Subtareas de la tarea */}
                                  {isTareaExpanded && (
                                    <div className="bg-gray-50">
                                      {subtareasTarea.map(subtarea => (
                                        <div key={subtarea.id} className="p-3 pl-20 border-t border-gray-200 hover:bg-gray-100 transition-colors">
                                          <div className="flex items-start justify-between">
                                            <div className="flex-1">
                                              <div className="font-medium text-gray-800 mb-2">{subtarea.nombre}</div>
                                              <div className="flex items-center gap-4 text-sm">
                                                <div>
                                                  <span className="text-gray-500">Tipo Óptimo: </span>
                                                  <span className="font-medium text-blue-600">{subtarea.tipoTrabajadorOptimo || 'No definido'}</span>
                                                </div>
                                                <div>
                                                  <span className="text-gray-500">Permitidos: </span>
                                                  <span className="font-medium text-green-600">
                                                    {subtarea.tiposPermitidos && subtarea.tiposPermitidos.length > 0
                                                      ? subtarea.tiposPermitidos.join(', ')
                                                      : 'No definidos'}
                                                  </span>
                                                </div>
                                                {subtarea.alertaSubutilizacion && (
                                                  <span className="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full">
                                                    ⚠️ Alerta activa
                                                  </span>
                                                )}
                                              </div>
                                            </div>
                                            <button
                                              onClick={() => handleEditarSubtarea(subtarea)}
                                              className="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-50 rounded-lg transition-colors"
                                              title="Editar tipos"
                                            >
                                              <Edit2 className="w-4 h-4" />
                                            </button>
                                          </div>
                                        </div>
                                      ))}
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>

                {/* Modal de edición de subtarea */}
                {editingSubtarea && (
                  <ModalEditarSubtarea
                    subtarea={editingSubtarea}
                    onGuardar={handleGuardarSubtarea}
                    onCerrar={() => setEditingSubtarea(null)}
                  />
                )}
              </div>
            );
          };

          // ==================== COMPONENTE: UBICACIONES PROYECTO ====================
          
          const UbicacionesProyecto = ({ proyectoId, proyecto, userRole, currentClienteId }) => {
            const [expandidoNivel1, setExpandidoNivel1] = useState({});
            const [expandidoNivel2, setExpandidoNivel2] = useState({});
            const [busqueda, setBusqueda] = useState('');
            const [editingUbicacion, setEditingUbicacion] = useState(null);
            const [showAgregarModal, setShowAgregarModal] = useState(false);
            
            const ubicacionesProyecto = ubicaciones.filter(u => u.proyectoId === proyectoId);
            const config = localizacionConfig.find(c => c.proyectoId === proyectoId);
            
            // ⭐ NUEVO v1.6.1 - Validación de permisos (Opción C: Mixto)
            const puedeEditarUbicaciones = () => {
              if (userRole === 'admin') return true; // Admin puede editar cualquier proyecto
              if (userRole === 'cliente' && proyecto.clienteId === currentClienteId) {
                return true; // Cliente puede editar solo SUS proyectos
              }
              return false; // Cliente no puede editar proyectos de otros clientes
            };
            
            const tienePermisoEdicion = puedeEditarUbicaciones();
            
            const toggleNivel1 = (nombre) => {
              setExpandidoNivel1(prev => ({ ...prev, [nombre]: !prev[nombre] }));
            };
            
            const toggleNivel2 = (key) => {
              setExpandidoNivel2(prev => ({ ...prev, [key]: !prev[key] }));
            };
            
            const handleEditarUbicacion = (ubicacion) => {
              if (!tienePermisoEdicion) {
                alert('No tienes permiso para editar ubicaciones de este proyecto.');
                return;
              }
              setEditingUbicacion(ubicacion);
            };
            
            const handleEliminarUbicacion = (ubicacion) => {
              if (!tienePermisoEdicion) {
                alert('No tienes permiso para eliminar ubicaciones de este proyecto.');
                return;
              }
              // TODO: Verificar si tiene registros de tiempo asociados
              if (confirm(`¿Estás seguro de eliminar la ubicación "${ubicacion.nivel1} - ${ubicacion.nivel2}"?\n\n⚠️ Esta acción no se puede deshacer.`)) {
                setUbicaciones(ubicaciones.filter(u => u.id !== ubicacion.id));
              }
            };
            
            const handleToggleActivo = (ubicacion) => {
              if (!tienePermisoEdicion) {
                alert('No tienes permiso para modificar ubicaciones de este proyecto.');
                return;
              }
              const index = ubicaciones.findIndex(u => u.id === ubicacion.id);
              if (index !== -1) {
                const nuevasUbicaciones = [...ubicaciones];
                nuevasUbicaciones[index] = {
                  ...ubicacion,
                  activo: !ubicacion.activo
                };
                setUbicaciones(nuevasUbicaciones);
              }
            };
            
            const handleGuardarUbicacion = (ubicacionActualizada) => {
              const index = ubicaciones.findIndex(u => u.id === ubicacionActualizada.id);
              if (index !== -1) {
                const nuevasUbicaciones = [...ubicaciones];
                nuevasUbicaciones[index] = ubicacionActualizada;
                setUbicaciones(nuevasUbicaciones);
              }
              setEditingUbicacion(null);
            };
            
            const handleAgregarUbicacion = (nuevaUbicacion) => {
              const maxId = ubicaciones.length > 0 ? Math.max(...ubicaciones.map(u => u.id)) : 0;
              const ubicacionConId = {
                ...nuevaUbicacion,
                id: maxId + 1,
                proyectoId: proyectoId,
                activo: true
              };
              setUbicaciones([...ubicaciones, ubicacionConId]);
              setShowAgregarModal(false);
            };
            
            if (ubicacionesProyecto.length === 0) {
              return (
                <div className="text-center py-12 text-gray-500">
                  <p className="text-lg mb-2">No hay ubicaciones configuradas</p>
                  <p className="text-sm mb-4">Este proyecto no tiene un sistema de localización jerárquica.</p>
                  {tienePermisoEdicion ? (
                    <button
                      onClick={() => setShowAgregarModal(true)}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                    >
                      + Agregar Primera Ubicación
                    </button>
                  ) : (
                    <div className="text-sm text-gray-500 mt-2">
                      🔒 No tienes permiso para agregar ubicaciones a este proyecto
                    </div>
                  )}
                </div>
              );
            }
            
            // Filtrar por búsqueda
            const ubicacionesFiltradas = busqueda.trim()
              ? ubicacionesProyecto.filter(u => {
                  const searchLower = busqueda.toLowerCase();
                  return (
                    u.nivel1?.toLowerCase().includes(searchLower) ||
                    u.nivel2?.toLowerCase().includes(searchLower) ||
                    u.nivel3?.toLowerCase().includes(searchLower) ||
                    u.alias?.toLowerCase().includes(searchLower)
                  );
                })
              : ubicacionesProyecto;
            
            // Agrupar por nivel 1
            const ubicacionesPorNivel1 = {};
            ubicacionesFiltradas.forEach(u => {
              const nivel1Key = u.nivel1 || 'Sin Nivel 1';
              if (!ubicacionesPorNivel1[nivel1Key]) {
                ubicacionesPorNivel1[nivel1Key] = [];
              }
              ubicacionesPorNivel1[nivel1Key].push(u);
            });
            
            // Calcular estadísticas
            const totalActivas = ubicacionesProyecto.filter(u => u.activo).length;
            const totalInactivas = ubicacionesProyecto.length - totalActivas;
            const totalNiveles1 = Object.keys(ubicacionesPorNivel1).length;
            
            return (
              <div>
                {/* Header con búsqueda y botón agregar */}
                <div className="flex items-center justify-between mb-6">
                  <div className="flex-1 max-w-md">
                    <div className="relative">
                      <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                      <input
                        type="text"
                        placeholder="Buscar ubicación..."
                        value={busqueda}
                        onChange={(e) => setBusqueda(e.target.value)}
                        className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                  </div>
                  {tienePermisoEdicion ? (
                    <button
                      onClick={() => setShowAgregarModal(true)}
                      className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                    >
                      <Plus className="w-5 h-5" />
                      Agregar Ubicación
                    </button>
                  ) : (
                    <div className="text-sm text-gray-500 bg-gray-100 px-4 py-2 rounded-lg border border-gray-300">
                      🔒 Solo lectura
                    </div>
                  )}
                </div>

                {/* Mensaje de permisos */}
                {!tienePermisoEdicion && (
                  <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div className="flex items-start gap-2">
                      <span className="text-yellow-600 text-sm">⚠️</span>
                      <div className="text-sm text-yellow-800">
                        <strong>Vista de solo lectura:</strong> No puedes editar ubicaciones de proyectos de otros clientes.
                      </div>
                    </div>
                  </div>
                )}

                {/* Estadísticas */}
                <div className="grid grid-cols-4 gap-4 mb-6">
                  <div className="bg-blue-50 p-4 rounded-lg">
                    <div className="text-sm text-blue-600 mb-1">Total Ubicaciones</div>
                    <div className="text-2xl font-bold text-blue-700">{ubicacionesProyecto.length}</div>
                  </div>
                  <div className="bg-green-50 p-4 rounded-lg">
                    <div className="text-sm text-green-600 mb-1">Activas</div>
                    <div className="text-2xl font-bold text-green-700">{totalActivas}</div>
                  </div>
                  <div className="bg-gray-50 p-4 rounded-lg">
                    <div className="text-sm text-gray-600 mb-1">Inactivas</div>
                    <div className="text-2xl font-bold text-gray-700">{totalInactivas}</div>
                  </div>
                  <div className="bg-purple-50 p-4 rounded-lg">
                    <div className="text-sm text-purple-600 mb-1">Niveles Principales</div>
                    <div className="text-2xl font-bold text-purple-700">{totalNiveles1}</div>
                  </div>
                </div>

                {/* Árbol de ubicaciones */}
                <div className="space-y-2">
                  {Object.entries(ubicacionesPorNivel1).map(([nivel1, ubicacionesNivel1]) => {
                    // Agrupar nivel2 dentro de nivel1
                    const ubicacionesPorNivel2 = {};
                    ubicacionesNivel1.forEach(u => {
                      const nivel2Key = u.nivel2 || 'Sin Nivel 2';
                      if (!ubicacionesPorNivel2[nivel2Key]) {
                        ubicacionesPorNivel2[nivel2Key] = [];
                      }
                      ubicacionesPorNivel2[nivel2Key].push(u);
                    });
                    
                    const isExpanded = expandidoNivel1[nivel1];
                    const activasNivel1 = ubicacionesNivel1.filter(u => u.activo).length;
                    
                    return (
                      <div key={nivel1} className="border border-gray-200 rounded-lg overflow-hidden">
                        {/* Nivel 1 */}
                        <div
                          className="bg-blue-50 p-4 cursor-pointer hover:bg-blue-100 transition-colors flex items-center justify-between"
                          onClick={() => toggleNivel1(nivel1)}
                        >
                          <div className="flex items-center gap-3">
                            {isExpanded ? <ChevronDown className="w-5 h-5 text-blue-600" /> : <ChevronRight className="w-5 h-5 text-blue-600" />}
                            <div>
                              <div className="font-semibold text-gray-800">{nivel1}</div>
                              <div className="text-sm text-gray-600">
                                {ubicacionesNivel1.length} ubicaciones • {activasNivel1} activas
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Nivel 2 y 3 */}
                        {isExpanded && (
                          <div className="bg-white">
                            {Object.entries(ubicacionesPorNivel2).map(([nivel2, ubicacionesNivel2]) => {
                              // Si solo hay una ubicación en nivel2 sin nivel3, mostrarla directamente
                              if (ubicacionesNivel2.length === 1 && !ubicacionesNivel2[0].nivel3) {
                                const u = ubicacionesNivel2[0];
                                return (
                                  <div key={u.id} className="border-t border-gray-200 p-4 pl-12 hover:bg-gray-50">
                                    <div className="flex items-center justify-between">
                                      <div className="flex-1">
                                        <div className="font-medium text-gray-800">
                                          {u.nivel2}
                                          {u.alias && <span className="text-sm text-gray-500 ml-2">({u.alias})</span>}
                                        </div>
                                        {u.descripcion && (
                                          <div className="text-sm text-gray-500 mt-1">{u.descripcion}</div>
                                        )}
                                      </div>
                                      <div className="flex items-center gap-2">
                                        {tienePermisoEdicion ? (
                                          <button
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              handleToggleActivo(u);
                                            }}
                                            className={`px-2 py-1 text-xs rounded-full cursor-pointer ${
                                              u.activo ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'
                                            }`}
                                          >
                                            {u.activo ? 'Activa' : 'Inactiva'}
                                          </button>
                                        ) : (
                                          <span className={`px-2 py-1 text-xs rounded-full ${
                                            u.activo ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'
                                          }`}>
                                            {u.activo ? 'Activa' : 'Inactiva'}
                                          </span>
                                        )}
                                        {tienePermisoEdicion && (
                                          <>
                                            <button
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                handleEditarUbicacion(u);
                                              }}
                                              className="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-50 rounded-lg transition-colors"
                                              title="Editar"
                                            >
                                              <Edit2 className="w-4 h-4" />
                                            </button>
                                            <button
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                handleEliminarUbicacion(u);
                                              }}
                                              className="text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg transition-colors"
                                              title="Eliminar"
                                            >
                                              <Trash2 className="w-4 h-4" />
                                            </button>
                                          </>
                                        )}
                                      </div>
                                    </div>
                                  </div>
                                );
                              }
                              
                              // Si hay múltiples o tienen nivel3, mostrar expandible
                              const nivel2Key = `${nivel1}-${nivel2}`;
                              const isNivel2Expanded = expandidoNivel2[nivel2Key];
                              
                              return (
                                <div key={nivel2Key} className="border-t border-gray-200">
                                  <div
                                    className="p-4 pl-12 cursor-pointer hover:bg-gray-50 transition-colors flex items-center justify-between"
                                    onClick={() => toggleNivel2(nivel2Key)}
                                  >
                                    <div className="flex items-center gap-3">
                                      {isNivel2Expanded ? <ChevronDown className="w-4 h-4 text-green-600" /> : <ChevronRight className="w-4 h-4 text-green-600" />}
                                      <div>
                                        <div className="font-medium text-gray-800">{nivel2}</div>
                                        <div className="text-xs text-gray-500">{ubicacionesNivel2.length} ubicaciones</div>
                                      </div>
                                    </div>
                                  </div>

                                  {isNivel2Expanded && (
                                    <div className="bg-gray-50">
                                      {ubicacionesNivel2.map(u => (
                                        <div key={u.id} className="p-3 pl-24 border-t border-gray-200 hover:bg-gray-100 transition-colors">
                                          <div className="flex items-center justify-between">
                                            <div className="flex-1">
                                              <div className="font-medium text-gray-800">
                                                {u.nivel3 || u.nivel2}
                                                {u.alias && <span className="text-sm text-gray-500 ml-2">({u.alias})</span>}
                                              </div>
                                              {u.descripcion && (
                                                <div className="text-sm text-gray-500 mt-1">{u.descripcion}</div>
                                              )}
                                            </div>
                                            <div className="flex items-center gap-2">
                                              {tienePermisoEdicion ? (
                                                <button
                                                  onClick={(e) => {
                                                    e.stopPropagation();
                                                    handleToggleActivo(u);
                                                  }}
                                                  className={`px-2 py-1 text-xs rounded-full cursor-pointer ${
                                                    u.activo ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'
                                                  }`}
                                                >
                                                  {u.activo ? 'Activa' : 'Inactiva'}
                                                </button>
                                              ) : (
                                                <span className={`px-2 py-1 text-xs rounded-full ${
                                                  u.activo ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'
                                                }`}>
                                                  {u.activo ? 'Activa' : 'Inactiva'}
                                                </span>
                                              )}
                                              {tienePermisoEdicion && (
                                                <>
                                                  <button
                                                    onClick={(e) => {
                                                      e.stopPropagation();
                                                      handleEditarUbicacion(u);
                                                    }}
                                                    className="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-50 rounded-lg transition-colors"
                                                    title="Editar"
                                                  >
                                                    <Edit2 className="w-4 h-4" />
                                                  </button>
                                                  <button
                                                    onClick={(e) => {
                                                      e.stopPropagation();
                                                      handleEliminarUbicacion(u);
                                                    }}
                                                    className="text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg transition-colors"
                                                    title="Eliminar"
                                                  >
                                                    <Trash2 className="w-4 h-4" />
                                                  </button>
                                                </>
                                              )}
                                            </div>
                                          </div>
                                        </div>
                                      ))}
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>

                {/* Modal de edición */}
                {editingUbicacion && (
                  <ModalEditarUbicacion
                    ubicacion={editingUbicacion}
                    onGuardar={handleGuardarUbicacion}
                    onCerrar={() => setEditingUbicacion(null)}
                  />
                )}

                {/* Modal de agregar */}
                {showAgregarModal && (
                  <ModalAgregarUbicacion
                    onAgregar={handleAgregarUbicacion}
                    onCerrar={() => setShowAgregarModal(false)}
                  />
                )}
              </div>
            );
          };

          // ==================== COMPONENTE: TRABAJADORES PROYECTO (v1.6.1) ====================
          
          const TrabajadoresProyecto = ({ proyectoId, proyecto, proyectoTrabajadores, setProyectoTrabajadores, trabajadores, tiposTrabajador, userRole, currentClienteId }) => {
            const [busqueda, setBusqueda] = useState('');
            const [filterTipo, setFilterTipo] = useState('all');
            const [showAgregarModal, setShowAgregarModal] = useState(false);
            
            // ⭐ NUEVO - Validación de permisos (Opción C: Mixto)
            const puedeEditarTrabajadores = () => {
              if (userRole === 'admin') return true;
              if (userRole === 'cliente' && proyecto.clienteId === currentClienteId) {
                return true;
              }
              return false;
            };
            
            const tienePermisoEdicion = puedeEditarTrabajadores();
            
            // Obtener trabajadores asignados a este proyecto
            const asignaciones = proyectoTrabajadores.filter(pt => pt.proyectoId === proyectoId && pt.activo);
            const trabajadoresIds = asignaciones.map(a => a.trabajadorId);
            const trabajadoresAsignados = trabajadores.filter(t => trabajadoresIds.includes(t.id));
            
            // Obtener trabajadores disponibles (no asignados)
            const trabajadoresDisponibles = trabajadores.filter(t => !trabajadoresIds.includes(t.id));
            
            // Filtrar trabajadores asignados
            const trabajadoresFiltrados = trabajadoresAsignados.filter(t => {
              const tipo = tiposTrabajador.find(tipo => tipo.id === t.tipoTrabajadorId);
              const matchBusqueda = busqueda.trim() === '' || 
                t.nombre.toLowerCase().includes(busqueda.toLowerCase()) ||
                t.apellido.toLowerCase().includes(busqueda.toLowerCase()) ||
                tipo?.nombre.toLowerCase().includes(busqueda.toLowerCase());
              
              const matchTipo = filterTipo === 'all' || t.tipoTrabajadorId === parseInt(filterTipo);
              
              return matchBusqueda && matchTipo;
            });
            
            const handleAgregarTrabajadores = (trabajadoresSeleccionados) => {
              if (!tienePermisoEdicion) {
                alert('No tienes permiso para agregar trabajadores a este proyecto.');
                return;
              }
              const maxId = proyectoTrabajadores.length > 0 
                ? Math.max(...proyectoTrabajadores.map(pt => pt.id)) 
                : 0;
              
              const nuevasAsignaciones = trabajadoresSeleccionados.map((trabajadorId, index) => ({
                id: maxId + index + 1,
                proyectoId: proyectoId,
                trabajadorId: trabajadorId,
                activo: true
              }));
              
              setProyectoTrabajadores([...proyectoTrabajadores, ...nuevasAsignaciones]);
              setShowAgregarModal(false);
            };
            
            const handleEliminarTrabajador = (trabajadorId) => {
              if (!tienePermisoEdicion) {
                alert('No tienes permiso para quitar trabajadores de este proyecto.');
                return;
              }
              if (confirm('¿Estás seguro de quitar este trabajador del proyecto?')) {
                const asignacion = proyectoTrabajadores.find(
                  pt => pt.proyectoId === proyectoId && pt.trabajadorId === trabajadorId
                );
                if (asignacion) {
                  setProyectoTrabajadores(
                    proyectoTrabajadores.map(pt => 
                      pt.id === asignacion.id ? { ...pt, activo: false } : pt
                    )
                  );
                }
              }
            };
            
            // Agrupar por tipo
            const trabajadoresPorTipo = {};
            trabajadoresFiltrados.forEach(t => {
              const tipo = tiposTrabajador.find(tipo => tipo.id === t.tipoTrabajadorId);
              const tipoNombre = tipo ? tipo.nombre : 'Sin tipo';
              if (!trabajadoresPorTipo[tipoNombre]) {
                trabajadoresPorTipo[tipoNombre] = [];
              }
              trabajadoresPorTipo[tipoNombre].push(t);
            });
            
            return (
              <div>
                {/* Header con búsqueda y botón agregar */}
                <div className="flex items-center gap-4 mb-6">
                  <div className="flex-1 flex gap-4">
                    <div className="flex-1 max-w-md relative">
                      <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                      <input
                        type="text"
                        placeholder="Buscar trabajador..."
                        value={busqueda}
                        onChange={(e) => setBusqueda(e.target.value)}
                        className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <select
                      value={filterTipo}
                      onChange={(e) => setFilterTipo(e.target.value)}
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="all">Todos los tipos</option>
                      {(tiposTrabajador || []).map(tipo => (
                        <option key={tipo.id} value={tipo.id}>{tipo.nombre}</option>
                      ))}
                    </select>
                  </div>
                  {tienePermisoEdicion ? (
                    <button
                      onClick={() => setShowAgregarModal(true)}
                      className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                      disabled={trabajadoresDisponibles.length === 0}
                    >
                      <Plus className="w-5 h-5" />
                      Agregar Trabajadores
                    </button>
                  ) : (
                    <div className="text-sm text-gray-500 bg-gray-100 px-4 py-2 rounded-lg border border-gray-300">
                      🔒 Solo lectura
                    </div>
                  )}
                </div>

                {/* Mensaje de permisos */}
                {!tienePermisoEdicion && (
                  <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div className="flex items-start gap-2">
                      <span className="text-yellow-600 text-sm">⚠️</span>
                      <div className="text-sm text-yellow-800">
                        <strong>Vista de solo lectura:</strong> No puedes gestionar trabajadores de proyectos de otros clientes.
                      </div>
                    </div>
                  </div>
                )}

                {/* Estadísticas */}
                <div className="grid grid-cols-4 gap-4 mb-6">
                  <div className="bg-blue-50 p-4 rounded-lg">
                    <div className="text-sm text-blue-600 mb-1">Total Asignados</div>
                    <div className="text-2xl font-bold text-blue-700">{trabajadoresAsignados.length}</div>
                  </div>
                  <div className="bg-green-50 p-4 rounded-lg">
                    <div className="text-sm text-green-600 mb-1">Disponibles</div>
                    <div className="text-2xl font-bold text-green-700">{trabajadoresDisponibles.length}</div>
                  </div>
                  <div className="bg-purple-50 p-4 rounded-lg">
                    <div className="text-sm text-purple-600 mb-1">Tipos Diferentes</div>
                    <div className="text-2xl font-bold text-purple-700">{Object.keys(trabajadoresPorTipo).length}</div>
                  </div>
                  <div className="bg-orange-50 p-4 rounded-lg">
                    <div className="text-sm text-orange-600 mb-1">Mostrando</div>
                    <div className="text-2xl font-bold text-orange-700">{trabajadoresFiltrados.length}</div>
                  </div>
                </div>

                {trabajadoresAsignados.length === 0 ? (
                  <div className="text-center py-12 text-gray-500">
                    <p className="text-lg mb-2">No hay trabajadores asignados</p>
                    <p className="text-sm mb-4">Agrega trabajadores a este proyecto para comenzar.</p>
                    {tienePermisoEdicion ? (
                      <button
                        onClick={() => setShowAgregarModal(true)}
                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                        disabled={trabajadoresDisponibles.length === 0}
                      >
                        + Agregar Primeros Trabajadores
                      </button>
                    ) : (
                      <div className="text-sm text-gray-500 mt-2">
                        🔒 No tienes permiso para agregar trabajadores a este proyecto
                      </div>
                    )}
                  </div>
                ) : (
                  <div className="space-y-4">
                    {Object.entries(trabajadoresPorTipo).map(([tipoNombre, trabajadoresTipo]) => (
                      <div key={tipoNombre} className="border border-gray-200 rounded-lg overflow-hidden">
                        <div className="bg-gray-50 p-3 font-semibold text-gray-800">
                          {tipoNombre} ({trabajadoresTipo.length} trabajadores)
                        </div>
                        <div className="divide-y divide-gray-200">
                          {trabajadoresTipo.map(trabajador => {
                            const tipo = tiposTrabajador.find(t => t.id === trabajador.tipoTrabajadorId);
                            return (
                              <div key={trabajador.id} className="p-4 hover:bg-gray-50 transition-colors flex items-center justify-between">
                                <div className="flex-1">
                                  <div className="font-medium text-gray-800">
                                    {trabajador.nombre} {trabajador.apellido}
                                  </div>
                                  <div className="text-sm text-gray-500 mt-1">
                                    {trabajador.email} • {trabajador.telefono}
                                  </div>
                                </div>
                                <div className="flex items-center gap-2">
                                  <span className={`px-3 py-1 text-xs font-semibold rounded-full ${
                                    tipo?.id === 1 ? 'bg-gray-100 text-gray-700' :
                                    tipo?.id === 2 ? 'bg-blue-100 text-blue-700' :
                                    tipo?.id === 3 ? 'bg-green-100 text-green-700' :
                                    'bg-purple-100 text-purple-700'
                                  }`}>
                                    {tipo?.nombre || 'Sin tipo'}
                                  </span>
                                  {tienePermisoEdicion && (
                                    <button
                                      onClick={() => handleEliminarTrabajador(trabajador.id)}
                                      className="text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg transition-colors"
                                      title="Quitar del proyecto"
                                    >
                                      <Trash2 className="w-4 h-4" />
                                    </button>
                                  )}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                {/* Modal de agregar */}
                {showAgregarModal && (
                  <ModalAgregarTrabajadores
                    trabajadoresDisponibles={trabajadoresDisponibles}
                    tiposTrabajador={tiposTrabajador}
                    onAgregar={handleAgregarTrabajadores}
                    onCerrar={() => setShowAgregarModal(false)}
                  />
                )}
              </div>
            );
          };

          // ==================== MODAL: EDITAR UBICACIÓN ====================
          
          const ModalEditarUbicacion = ({ ubicacion, onGuardar, onCerrar }) => {
            const [formData, setFormData] = useState({
              nivel1: ubicacion.nivel1 || '',
              nivel2: ubicacion.nivel2 || '',
              nivel3: ubicacion.nivel3 || '',
              alias: ubicacion.alias || '',
              descripcion: ubicacion.descripcion || '',
              activo: ubicacion.activo !== undefined ? ubicacion.activo : true
            });
            
            const handleSubmit = (e) => {
              e.preventDefault();
              onGuardar({
                ...ubicacion,
                ...formData
              });
            };
            
            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
                  <h3 className="text-xl font-bold text-gray-800 mb-4">Editar Ubicación</h3>
                  
                  <form onSubmit={handleSubmit} className="space-y-4">
                    {/* Nivel 1 */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Nivel Principal *
                      </label>
                      <input
                        type="text"
                        value={formData.nivel1}
                        onChange={(e) => setFormData({ ...formData, nivel1: e.target.value })}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Ej: Torre A, Manzana 1, Tramo Norte"
                        required
                      />
                      <p className="text-xs text-gray-500 mt-1">Primer nivel jerárquico (Torre, Manzana, Sector, etc.)</p>
                    </div>

                    {/* Nivel 2 */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Nivel Secundario *
                      </label>
                      <input
                        type="text"
                        value={formData.nivel2}
                        onChange={(e) => setFormData({ ...formData, nivel2: e.target.value })}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Ej: Piso 5, Casa 10, Km 15-20"
                        required
                      />
                      <p className="text-xs text-gray-500 mt-1">Segundo nivel jerárquico (Piso, Casa, Kilómetro, etc.)</p>
                    </div>

                    {/* Nivel 3 */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Nivel Terciario (Opcional)
                      </label>
                      <input
                        type="text"
                        value={formData.nivel3}
                        onChange={(e) => setFormData({ ...formData, nivel3: e.target.value })}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Ej: Apartamento 501, Local 302, Carril Sur"
                      />
                      <p className="text-xs text-gray-500 mt-1">Tercer nivel jerárquico (Apartamento, Local, Área, etc.)</p>
                    </div>

                    {/* Alias */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Alias (Opcional)
                      </label>
                      <input
                        type="text"
                        value={formData.alias}
                        onChange={(e) => setFormData({ ...formData, alias: e.target.value })}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Ej: Penthouse Presidencial, Área VIP"
                      />
                      <p className="text-xs text-gray-500 mt-1">Nombre alternativo para identificación rápida</p>
                    </div>

                    {/* Descripción */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Descripción (Opcional)
                      </label>
                      <textarea
                        value={formData.descripcion}
                        onChange={(e) => setFormData({ ...formData, descripcion: e.target.value })}
                        rows={3}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Ej: 700m², vista panorámica, piscina privada"
                      />
                      <p className="text-xs text-gray-500 mt-1">Detalles adicionales sobre esta ubicación</p>
                    </div>

                    {/* Estado */}
                    <div>
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={formData.activo}
                          onChange={(e) => setFormData({ ...formData, activo: e.target.checked })}
                          className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                        />
                        <span className="text-sm font-medium text-gray-700">Ubicación activa</span>
                      </label>
                      <p className="text-xs text-gray-500 mt-1 ml-6">
                        Las ubicaciones inactivas no aparecerán en el registro de tiempo
                      </p>
                    </div>

                    {/* Botones */}
                    <div className="flex gap-3 pt-4">
                      <button
                        type="button"
                        onClick={onCerrar}
                        className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                      >
                        Cancelar
                      </button>
                      <button
                        type="submit"
                        className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                      >
                        Guardar Cambios
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            );
          };

          // ==================== MODAL: AGREGAR UBICACIÓN ====================
          
          const ModalAgregarUbicacion = ({ onAgregar, onCerrar }) => {
            const [formData, setFormData] = useState({
              nivel1: '',
              nivel2: '',
              nivel3: '',
              alias: '',
              descripcion: ''
            });
            
            const handleSubmit = (e) => {
              e.preventDefault();
              onAgregar(formData);
              setFormData({
                nivel1: '',
                nivel2: '',
                nivel3: '',
                alias: '',
                descripcion: ''
              });
            };
            
            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
                  <h3 className="text-xl font-bold text-gray-800 mb-4">Agregar Nueva Ubicación</h3>
                  <p className="text-sm text-gray-600 mb-4">
                    Complete los niveles jerárquicos según la estructura de su proyecto
                  </p>
                  
                  <form onSubmit={handleSubmit} className="space-y-4">
                    {/* Nivel 1 */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Nivel Principal * 
                        <span className="text-xs font-normal text-gray-500 ml-2">(Torre, Manzana, Tramo, Zona)</span>
                      </label>
                      <input
                        type="text"
                        value={formData.nivel1}
                        onChange={(e) => setFormData({ ...formData, nivel1: e.target.value })}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Ej: Torre C, Manzana 5, Tramo Sur"
                        required
                      />
                    </div>

                    {/* Nivel 2 */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Nivel Secundario *
                        <span className="text-xs font-normal text-gray-500 ml-2">(Piso, Casa, Kilómetro, Área)</span>
                      </label>
                      <input
                        type="text"
                        value={formData.nivel2}
                        onChange={(e) => setFormData({ ...formData, nivel2: e.target.value })}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Ej: Piso 8, Casa 25, Km 30-35"
                        required
                      />
                    </div>

                    {/* Nivel 3 */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Nivel Terciario (Opcional)
                        <span className="text-xs font-normal text-gray-500 ml-2">(Apartamento, Local, Subsector)</span>
                      </label>
                      <input
                        type="text"
                        value={formData.nivel3}
                        onChange={(e) => setFormData({ ...formData, nivel3: e.target.value })}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Ej: Apto 801, Local 105, Carril Norte"
                      />
                    </div>

                    {/* Alias */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Alias (Opcional)
                      </label>
                      <input
                        type="text"
                        value={formData.alias}
                        onChange={(e) => setFormData({ ...formData, alias: e.target.value })}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Ej: Oficina Principal, Piscina Olímpica"
                      />
                    </div>

                    {/* Descripción */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Descripción (Opcional)
                      </label>
                      <textarea
                        value={formData.descripcion}
                        onChange={(e) => setFormData({ ...formData, descripcion: e.target.value })}
                        rows={3}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Características especiales de esta ubicación..."
                      />
                    </div>

                    {/* Botones */}
                    <div className="flex gap-3 pt-4">
                      <button
                        type="button"
                        onClick={onCerrar}
                        className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                      >
                        Cancelar
                      </button>
                      <button
                        type="submit"
                        className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                      >
                        Agregar Ubicación
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            );
          };

          // ==================== MODAL: AGREGAR TRABAJADORES (v1.6.1) ====================
          
          const ModalAgregarTrabajadores = ({ trabajadoresDisponibles, tiposTrabajador, onAgregar, onCerrar }) => {
            const [trabajadoresSeleccionados, setTrabajadoresSeleccionados] = useState([]);
            const [busquedaModal, setBusquedaModal] = useState('');
            const [filterTipoModal, setFilterTipoModal] = useState('all');
            
            const trabajadoresFiltrados = trabajadoresDisponibles.filter(t => {
              const tipo = tiposTrabajador.find(tipo => tipo.id === t.tipoTrabajadorId);
              const matchBusqueda = busquedaModal.trim() === '' || 
                t.nombre.toLowerCase().includes(busquedaModal.toLowerCase()) ||
                t.apellido.toLowerCase().includes(busquedaModal.toLowerCase()) ||
                tipo?.nombre.toLowerCase().includes(busquedaModal.toLowerCase());
              
              const matchTipo = filterTipoModal === 'all' || t.tipoTrabajadorId === parseInt(filterTipoModal);
              
              return matchBusqueda && matchTipo;
            });
            
            const toggleTrabajador = (trabajadorId) => {
              if (trabajadoresSeleccionados.includes(trabajadorId)) {
                setTrabajadoresSeleccionados(trabajadoresSeleccionados.filter(id => id !== trabajadorId));
              } else {
                setTrabajadoresSeleccionados([...trabajadoresSeleccionados, trabajadorId]);
              }
            };
            
            const toggleTodos = () => {
              if (trabajadoresSeleccionados.length === trabajadoresFiltrados.length) {
                setTrabajadoresSeleccionados([]);
              } else {
                setTrabajadoresSeleccionados((trabajadoresFiltrados || []).map(t => t.id));
              }
            };
            
            const handleSubmit = () => {
              if (trabajadoresSeleccionados.length > 0) {
                onAgregar(trabajadoresSeleccionados);
              }
            };
            
            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                  <div className="p-6 border-b border-gray-200">
                    <h3 className="text-xl font-bold text-gray-800 mb-4">Agregar Trabajadores al Proyecto</h3>
                    
                    {/* Filtros */}
                    <div className="flex gap-4">
                      <div className="flex-1 relative">
                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                        <input
                          type="text"
                          placeholder="Buscar trabajador..."
                          value={busquedaModal}
                          onChange={(e) => setBusquedaModal(e.target.value)}
                          className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                      <select
                        value={filterTipoModal}
                        onChange={(e) => setFilterTipoModal(e.target.value)}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="all">Todos los tipos</option>
                        {(tiposTrabajador || []).map(tipo => (
                          <option key={tipo.id} value={tipo.id}>{tipo.nombre}</option>
                        ))}
                      </select>
                    </div>
                    
                    <div className="mt-4 flex items-center justify-between text-sm">
                      <button
                        onClick={toggleTodos}
                        className="text-blue-600 hover:text-blue-800 font-medium"
                      >
                        {trabajadoresSeleccionados.length === trabajadoresFiltrados.length ? 'Deseleccionar todos' : 'Seleccionar todos'}
                      </button>
                      <span className="text-gray-600">
                        {trabajadoresSeleccionados.length} seleccionado{trabajadoresSeleccionados.length !== 1 ? 's' : ''}
                      </span>
                    </div>
                  </div>
                  
                  {/* Lista de trabajadores */}
                  <div className="flex-1 overflow-y-auto p-6">
                    {trabajadoresFiltrados.length === 0 ? (
                      <div className="text-center py-12 text-gray-500">
                        <p className="text-lg mb-2">No hay trabajadores disponibles</p>
                        <p className="text-sm">Todos los trabajadores ya están asignados a este proyecto.</p>
                      </div>
                    ) : (
                      <div className="space-y-2">
                        {(trabajadoresFiltrados || []).map(trabajador => {
                          const tipo = tiposTrabajador.find(t => t.id === trabajador.tipoTrabajadorId);
                          const isSelected = trabajadoresSeleccionados.includes(trabajador.id);
                          
                          return (
                            <div
                              key={trabajador.id}
                              onClick={() => toggleTrabajador(trabajador.id)}
                              className={`p-4 border rounded-lg cursor-pointer transition-all ${
                                isSelected
                                  ? 'border-blue-500 bg-blue-50'
                                  : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                              }`}
                            >
                              <div className="flex items-center gap-3">
                                <input
                                  type="checkbox"
                                  checked={isSelected}
                                  onChange={() => {}}
                                  className="w-4 h-4 text-blue-600 border-gray-300 rounded"
                                />
                                <div className="flex-1">
                                  <div className="font-medium text-gray-800">
                                    {trabajador.nombre} {trabajador.apellido}
                                  </div>
                                  <div className="text-sm text-gray-500 mt-1">
                                    {trabajador.email} • {trabajador.telefono}
                                  </div>
                                </div>
                                <span className={`px-3 py-1 text-xs font-semibold rounded-full ${
                                  tipo?.id === 1 ? 'bg-gray-100 text-gray-700' :
                                  tipo?.id === 2 ? 'bg-blue-100 text-blue-700' :
                                  tipo?.id === 3 ? 'bg-green-100 text-green-700' :
                                  'bg-purple-100 text-purple-700'
                                }`}>
                                  {tipo?.nombre || 'Sin tipo'}
                                </span>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                  
                  {/* Botones */}
                  <div className="p-6 border-t border-gray-200 flex gap-3">
                    <button
                      onClick={onCerrar}
                      className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                    >
                      Cancelar
                    </button>
                    <button
                      onClick={handleSubmit}
                      disabled={trabajadoresSeleccionados.length === 0}
                      className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                      Agregar {trabajadoresSeleccionados.length > 0 ? `(${trabajadoresSeleccionados.length})` : ''}
                    </button>
                  </div>
                </div>
              </div>
            );
          };

          // ==================== MODAL: EDITAR SUBTAREA ====================
          
          const ModalEditarSubtarea = ({ subtarea, onGuardar, onCerrar }) => {
            const [formData, setFormData] = useState({
              tipoTrabajadorOptimo: subtarea.tipoTrabajadorOptimo || '',
              tiposPermitidos: subtarea.tiposPermitidos || [],
              alertaSubutilizacion: subtarea.alertaSubutilizacion || false
            });
            
            const tiposDisponibles = ['Peón', 'Ayudante', 'Oficial', 'Maestro'];
            
            const toggleTipoPermitido = (tipo) => {
              const nuevosPermitidos = formData.tiposPermitidos.includes(tipo)
                ? formData.tiposPermitidos.filter(t => t !== tipo)
                : [...formData.tiposPermitidos, tipo];
              setFormData({ ...formData, tiposPermitidos: nuevosPermitidos });
            };
            
            const handleSubmit = (e) => {
              e.preventDefault();
              onGuardar({
                ...subtarea,
                ...formData
              });
            };
            
            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                  <h3 className="text-xl font-bold text-gray-800 mb-4">Editar Tipos de Trabajador</h3>
                  <p className="text-sm text-gray-600 mb-4">{subtarea.nombre}</p>
                  
                  <form onSubmit={handleSubmit} className="space-y-4">
                    {/* Tipo Óptimo */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Tipo Óptimo *
                      </label>
                      <select
                        value={formData.tipoTrabajadorOptimo}
                        onChange={(e) => setFormData({ ...formData, tipoTrabajadorOptimo: e.target.value })}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        required
                      >
                        <option value="">Seleccionar tipo</option>
                        {tiposDisponibles.map(tipo => (
                          <option key={tipo} value={tipo}>{tipo}</option>
                        ))}
                      </select>
                      <p className="text-xs text-gray-500 mt-1">Tipo más eficiente para esta subtarea</p>
                    </div>

                    {/* Tipos Permitidos */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Tipos Permitidos *
                      </label>
                      <div className="space-y-2">
                        {tiposDisponibles.map(tipo => (
                          <label key={tipo} className="flex items-center gap-2">
                            <input
                              type="checkbox"
                              checked={formData.tiposPermitidos.includes(tipo)}
                              onChange={() => toggleTipoPermitido(tipo)}
                              className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                            />
                            <span className="text-sm text-gray-700">{tipo}</span>
                          </label>
                        ))}
                      </div>
                      <p className="text-xs text-gray-500 mt-1">Tipos que pueden realizar esta subtarea</p>
                    </div>

                    {/* Alerta de Subutilización */}
                    <div>
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={formData.alertaSubutilizacion}
                          onChange={(e) => setFormData({ ...formData, alertaSubutilizacion: e.target.checked })}
                          className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                        />
                        <span className="text-sm font-medium text-gray-700">Activar alerta de subutilización</span>
                      </label>
                      <p className="text-xs text-gray-500 mt-1 ml-6">
                        Alertar cuando un tipo superior al óptimo realice esta subtarea
                      </p>
                    </div>

                    {/* Botones */}
                    <div className="flex gap-3 pt-4">
                      <button
                        type="button"
                        onClick={onCerrar}
                        className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                      >
                        Cancelar
                      </button>
                      <button
                        type="submit"
                        className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                      >
                        Guardar
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            );
          };

          return (
            <div>
              {vista === 'lista' ? (
                <>
                  {/* Header */}
                  <div className="flex items-center justify-between mb-6">
                    <div>
                      <h2 className="text-3xl font-bold text-gray-800">
                        {isAdmin ? 'Gestión de Proyectos' : 'Mis Proyectos'}
                      </h2>
                      <p className="text-gray-600 mt-1">
                        {filteredProyectos.length} proyecto{filteredProyectos.length !== 1 ? 's' : ''} {searchTerm || filterCliente !== 'all' || filterEstado !== 'all' ? 'encontrado' + (filteredProyectos.length !== 1 ? 's' : '') : ''}
                      </p>
                    </div>
                    <button
                      onClick={handleCreate}
                      className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                    >
                      <Plus className="w-5 h-5" />
                      Nuevo Proyecto
                    </button>
                  </div>

              {/* Filtros */}
              <div className="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                {/* Búsqueda */}
                <div className="md:col-span-1">
                  <div className="relative">
                    <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                      <Search className="w-5 h-5" />
                    </div>
                    <input
                      type="text"
                      placeholder="Buscar proyectos..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                </div>

                {/* Filtro por Cliente */}
                {isAdmin && (
                  <div>
                    <select
                      value={filterCliente}
                      onChange={(e) => setFilterCliente(e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="all">Todos los clientes</option>
                      {(clientes || []).map(c => (
                        <option key={c.id} value={c.id}>{c.nombre}</option>
                      ))}
                    </select>
                  </div>
                )}

                {/* Filtro por Estado */}
                <div>
                  <select
                    value={filterEstado}
                    onChange={(e) => setFilterEstado(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="all">Todos los estados</option>
                    {ESTADOS_PROYECTO.map(estado => (
                      <option key={estado} value={estado}>{estado}</option>
                    ))}
                  </select>
                </div>
              </div>

              {/* Tabla de Proyectos */}
              <div className="bg-white rounded-xl shadow-md overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-50 border-b border-gray-200">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Proyecto</th>
                        {isAdmin && <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>}
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ubicación</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fechas</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Presupuesto</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {filteredProyectos.map(proyecto => {
                        const cliente = clientes.find(c => c.id === proyecto.clienteId);
                        return (
                          <tr key={proyecto.id} className="hover:bg-gray-50">
                            <td className="px-6 py-4">
                              <div className="font-medium text-gray-900">{proyecto.nombre}</div>
                              <div className="text-sm text-gray-500">{proyecto.descripcion}</div>
                            </td>
                            {isAdmin && (
                              <td className="px-6 py-4">
                                <div className="text-sm text-gray-900">{cliente?.nombre || 'N/A'}</div>
                              </td>
                            )}
                            <td className="px-6 py-4 text-sm text-gray-900">{proyecto.direccion}</td>
                            <td className="px-6 py-4">
                              <div className="text-sm text-gray-900">Inicio: {formatDate(proyecto.fechaInicio)}</div>
                              <div className="text-sm text-gray-500">Fin: {formatDate(proyecto.fechaFin)}</div>
                            </td>
                            <td className="px-6 py-4">
                              <div className="text-sm font-medium text-gray-900">{formatCurrency(proyecto.presupuesto)}</div>
                            </td>
                            <td className="px-6 py-4">
                              <span className={`px-2 py-1 text-xs font-semibold rounded-full ${getEstadoColor(proyecto.estado)}`}>
                                {proyecto.estado}
                              </span>
                            </td>
                            <td className="px-6 py-4">
                              <div className="flex items-center gap-2">
                                <button
                                  onClick={() => handleVerDetalles(proyecto)}
                                  className="text-indigo-600 hover:text-indigo-800 p-2 hover:bg-indigo-50 rounded-lg transition-colors"
                                  title="Ver Detalles"
                                >
                                  <Eye className="w-4 h-4" />
                                </button>
                                <button
                                  onClick={() => handleEdit(proyecto)}
                                  className="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-50 rounded-lg transition-colors"
                                  title="Editar"
                                >
                                  <Edit2 className="w-4 h-4" />
                                </button>
                                <button
                                  onClick={() => handleDelete(proyecto.id)}
                                  className="text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg transition-colors"
                                  title="Eliminar"
                                >
                                  <Trash2 className="w-4 h-4" />
                                </button>
                              </div>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>

                  {filteredProyectos.length === 0 && (
                    <div className="text-center py-12 text-gray-500">
                      No se encontraron proyectos
                    </div>
                  )}
                </div>
              </div>
              </>
              ) : (
                <ProyectoDetalle 
                  proyecto={proyectoSeleccionado}
                  proyectoTrabajadores={proyectoTrabajadores}
                  setProyectoTrabajadores={setProyectoTrabajadores}
                  trabajadores={trabajadores}
                  tiposTrabajador={tiposTrabajador}
                  userRole={userRole}
                  currentClienteId={currentClienteId}
                />
              )}

              {/* Modal */}
              {isModalOpen && (
                <ProyectoModal
                  proyecto={editingProyecto}
                  clientes={clientes}
                  onSave={handleSave}
                  onClose={() => setIsModalOpen(false)}
                  disciplinasMaestras={disciplinasMaestras}
                  tareasMaestras={tareasMaestras}
                  subtareasMaestras={subtareasMaestras}
                  proyectoDisciplinas={proyectoDisciplinas}
                  setProyectoDisciplinas={setProyectoDisciplinas}
                  proyectoTareas={proyectoTareas}
                  setProyectoTareas={setProyectoTareas}
                  proyectoSubtareas={proyectoSubtareas}
                  setProyectoSubtareas={setProyectoSubtareas}
                  localizacionConfig={localizacionConfig}
                  setLocalizacionConfig={setLocalizacionConfig}
                  ubicaciones={ubicaciones}
                  setUbicaciones={setUbicaciones}
                />
              )}
            </div>
          );
        }

        // ==================== MODAL PROYECTO ====================
        
        // ==================== MODAL PROYECTO (Actualizado v1.6.0) ====================
        
        function ProyectoModal({ 
          proyecto, 
          clientes, 
          onSave, 
          onClose,
          disciplinasMaestras,
          tareasMaestras,
          subtareasMaestras,
          proyectoDisciplinas,
          setProyectoDisciplinas,
          proyectoTareas,
          setProyectoTareas,
          proyectoSubtareas,
          setProyectoSubtareas,
          localizacionConfig,
          setLocalizacionConfig,
          ubicaciones,
          setUbicaciones
        }) {
          console.log('🎬 ProyectoModal renderizado con props:');
          console.log('  disciplinasMaestras:', disciplinasMaestras);
          console.log('  tareasMaestras:', tareasMaestras);
          console.log('  subtareasMaestras:', subtareasMaestras);
          
          const [formData, setFormData] = useState(proyecto || {
            nombre: '',
            clienteId: clientes[0]?.id || 1,
            descripcion: '',
            direccion: '',
            fechaInicio: new Date().toISOString().split('T')[0],
            fechaFin: '',
            presupuesto: 0,
            estado: 'En Planificación',
            activo: true,
            usarUbicaciones: false, // ⭐ NUEVO v1.8.5 - Sistema opcional
            jornada: {
              horaInicio: '07:00',
              horaFin: '17:00',
              horasEstandar: 8,
              tiempoAlmuerzo: 60,
              diasLaborales: [1,2,3,4,5,6]
            }
          });

          const [paso, setPaso] = useState(1); // 1: Datos básicos, 2: Localización (solo para nuevo proyecto)
          const [proyectoCreado, setProyectoCreado] = useState(proyecto || null);
          const [showConfigLocalizacion, setShowConfigLocalizacion] = useState(false);

          const handleSubmitBasico = (e) => {
            e.preventDefault();
            
            if (proyecto) {
              // Editando proyecto existente
              onSave(formData);
              onClose();
            } else {
              // Creando nuevo proyecto
              const nuevoProyecto = {
                ...formData,
                id: null, // Se asignará en onSave
                clienteId: parseInt(formData.clienteId),
                presupuesto: parseFloat(formData.presupuesto) || 0
              };
              
              console.log('📝 Creando proyecto:', nuevoProyecto);
              
              // Guardar proyecto y obtener el ID asignado
              const proyectoGuardado = onSave(nuevoProyecto);
              
              console.log('✅ Proyecto guardado:', proyectoGuardado);
              
              if (!proyectoGuardado || !proyectoGuardado.id) {
                console.error('❌ Error: onSave no retornó proyecto válido');
                alert('Error al crear proyecto. Por favor revisa la consola.');
                return;
              }
              
              setProyectoCreado(proyectoGuardado);
              
              // Instanciar plantillas automáticamente
              console.log('🔄 Instanciando plantillas para proyecto ID:', proyectoGuardado.id);
              instanciarPlantillas(proyectoGuardado.id);
              
              // ⭐ NUEVO v1.8.5: Solo pasar a configuración si usarUbicaciones es true
              if (formData.usarUbicaciones) {
                console.log('📍 Pasando a paso 2: Configuración de localización');
                setPaso(2);
              } else {
                console.log('📍 Proyecto sin sistema de ubicaciones - cerrando modal');
                onClose();
              }
            }
          };

          const instanciarPlantillas = (proyectoId) => {
            console.log('🔍 DEBUG instanciarPlantillas:');
            console.log('  proyectoId:', proyectoId);
            console.log('  disciplinasMaestras:', disciplinasMaestras);
            console.log('  tareasMaestras:', tareasMaestras);
            console.log('  subtareasMaestras:', subtareasMaestras);
            console.log('  proyectoDisciplinas:', proyectoDisciplinas);
            console.log('  proyectoTareas:', proyectoTareas);
            console.log('  proyectoSubtareas:', proyectoSubtareas);
            
            if (!disciplinasMaestras || !tareasMaestras || !subtareasMaestras) {
              console.error('❌ ERROR: Plantillas maestras undefined!');
              alert('Error: Las plantillas maestras no están disponibles. Por favor recarga la página.');
              return;
            }
            
            // Validar arrays de proyecto (pueden ser undefined)
            const pdArray = proyectoDisciplinas || [];
            const ptArray = proyectoTareas || [];
            const psArray = proyectoSubtareas || [];
            
            const resultado = InstanciacionUtils.instanciarProyecto(
              proyectoId,
              disciplinasMaestras,
              tareasMaestras,
              subtareasMaestras,
              pdArray,
              ptArray,
              psArray
            );

            console.log('✅ Resultado de instanciación:', resultado);

            // Actualizar estados (concatenar con arrays validados)
            setProyectoDisciplinas([...pdArray, ...resultado.proyectoDisciplinas]);
            setProyectoTareas([...ptArray, ...resultado.proyectoTareas]);
            setProyectoSubtareas([...psArray, ...resultado.proyectoSubtareas]);
          };

          const handleConfigLocalizacion = (configLoc) => {
            console.log('💾 Guardando configuración de localización:', configLoc);
            console.log('   localizacionConfig actual:', localizacionConfig);
            console.log('   ubicaciones actuales:', ubicaciones);
            
            // Guardar configuración (con validación para arrays undefined)
            const configArray = localizacionConfig || [];
            const newConfig = {
              ...configLoc,
              id: (configArray.length > 0 ? Math.max(...configArray.map(c => c.id)) : 0) + 1
            };
            setLocalizacionConfig([...configArray, newConfig]);
            console.log('   ✅ Nueva configuración:', newConfig);

            // Generar ubicaciones automáticamente
            const ubicacionesArray = ubicaciones || [];
            const nuevasUbicaciones = LocalizacionUtils.generarUbicaciones(
              configLoc,
              proyectoCreado.id,
              ubicacionesArray
            );
            console.log('   ✅ Nuevas ubicaciones generadas:', nuevasUbicaciones.length);
            setUbicaciones([...ubicacionesArray, ...nuevasUbicaciones]);

            setShowConfigLocalizacion(false);
            
            // Cerrar modal completo
            onClose();
          };

          const handleOmitirLocalizacion = () => {
            onClose();
          };

          if (paso === 2 && !showConfigLocalizacion) {
            // Paso 2: Opción de configurar localización
            return (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl">
                  <div className="p-6 border-b border-gray-200">
                    <h3 className="text-xl font-bold text-gray-900">
                      ✅ Proyecto Creado Exitosamente
                    </h3>
                    <p className="text-sm text-gray-600 mt-1">
                      {proyectoCreado.nombre}
                    </p>
                  </div>

                  <div className="p-6 space-y-6">
                    <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                      <h4 className="font-semibold text-green-900 mb-2 flex items-center gap-2">
                        <span>✅</span>
                        Plantillas Instanciadas
                      </h4>
                      <p className="text-sm text-green-800">
                        Se clonaron automáticamente las plantillas maestras (disciplinas, tareas y subtareas) al proyecto.
                      </p>
                    </div>

                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-6">
                      <h4 className="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                        <span>📍</span>
                        ¿Configurar Localización?
                      </h4>
                      <p className="text-sm text-gray-600 mb-4">
                        Configura las ubicaciones del proyecto (pisos, apartamentos, casas, etc.) para que los trabajadores puedan registrar dónde están trabajando.
                      </p>
                      
                      <div className="space-y-2 text-sm text-gray-600 mb-4">
                        <div className="flex items-start gap-2">
                          <span className="text-green-600">✓</span>
                          <span>Permite control de ubicación en registros de tiempo</span>
                        </div>
                        <div className="flex items-start gap-2">
                          <span className="text-green-600">✓</span>
                          <span>Genera reportes por zona del proyecto</span>
                        </div>
                        <div className="flex items-start gap-2">
                          <span className="text-green-600">✓</span>
                          <span>Mejora trazabilidad y control</span>
                        </div>
                      </div>

                      <div className="flex gap-3">
                        <button
                          onClick={() => setShowConfigLocalizacion(true)}
                          className="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium"
                        >
                          Configurar Ahora
                        </button>
                        <button
                          onClick={handleOmitirLocalizacion}
                          className="flex-1 px-4 py-3 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                        >
                          Configurar Después
                        </button>
                      </div>

                      <p className="text-xs text-gray-500 mt-3 text-center">
                        Puedes configurar la localización más tarde desde la configuración del proyecto
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          if (showConfigLocalizacion && proyectoCreado) {
            return (
              <ConfiguracionLocalizacionModal
                proyecto={proyectoCreado}
                onSave={handleConfigLocalizacion}
                onClose={() => {
                  setShowConfigLocalizacion(false);
                  onClose();
                }}
              />
            );
          }

          // Paso 1: Formulario básico del proyecto
          return (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl my-8">
                <div className="flex items-center justify-between p-6 border-b border-gray-200">
                  <h3 className="text-xl font-bold text-gray-900">
                    {proyecto ? 'Editar Proyecto' : 'Nuevo Proyecto'}
                  </h3>
                  <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                    <X className="w-6 h-6" />
                  </button>
                </div>

                <form onSubmit={handleSubmitBasico}>
                  <div className="p-6 space-y-4 max-h-[600px] overflow-y-auto">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Cliente *
                      </label>
                      <select
                        required
                        value={formData.clienteId}
                        onChange={(e) => setFormData({...formData, clienteId: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      >
                        {(clientes || []).map(c => (
                          <option key={c.id} value={c.id}>{c.nombre}</option>
                        ))}
                      </select>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Nombre del Proyecto *
                      </label>
                      <input
                        type="text"
                        required
                        value={formData.nombre}
                        onChange={(e) => setFormData({...formData, nombre: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Edificio Torres del Parque"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Descripción
                      </label>
                      <textarea
                        value={formData.descripcion}
                        onChange={(e) => setFormData({...formData, descripcion: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        rows="3"
                        placeholder="Descripción del proyecto..."
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Dirección
                      </label>
                      <input
                        type="text"
                        value={formData.direccion}
                        onChange={(e) => setFormData({...formData, direccion: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Carrera 15 #85-40, Bogotá"
                      />
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Fecha Inicio *
                        </label>
                        <input
                          type="date"
                          required
                          value={formData.fechaInicio}
                          onChange={(e) => setFormData({...formData, fechaInicio: e.target.value})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Fecha Fin Estimada
                        </label>
                        <input
                          type="date"
                          value={formData.fechaFin}
                          onChange={(e) => setFormData({...formData, fechaFin: e.target.value})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Presupuesto (COP)
                      </label>
                      <input
                        type="number"
                        min="0"
                        value={formData.presupuesto}
                        onChange={(e) => setFormData({...formData, presupuesto: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="5000000000"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Estado
                      </label>
                      <select
                        value={formData.estado}
                        onChange={(e) => setFormData({...formData, estado: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      >
                        {ESTADOS_PROYECTO.map(estado => (
                          <option key={estado} value={estado}>{estado}</option>
                        ))}
                      </select>
                    </div>

                    <div className="flex items-center">
                      <input
                        type="checkbox"
                        id="activo"
                        checked={formData.activo}
                        onChange={(e) => setFormData({...formData, activo: e.target.checked})}
                        className="w-4 h-4 text-blue-600 border-gray-300 rounded"
                      />
                      <label htmlFor="activo" className="ml-2 text-sm font-medium text-gray-700">
                        Proyecto activo
                      </label>
                    </div>

                    {!proyecto && (
                      <div className="border-t border-gray-200 pt-4">
                        <div className="flex items-start">
                          <input
                            type="checkbox"
                            id="usarUbicaciones"
                            checked={formData.usarUbicaciones}
                            onChange={(e) => setFormData({...formData, usarUbicaciones: e.target.checked})}
                            className="w-4 h-4 text-blue-600 border-gray-300 rounded mt-1"
                          />
                          <div className="ml-2">
                            <label htmlFor="usarUbicaciones" className="text-sm font-medium text-gray-700">
                              ¿Usar sistema de ubicaciones?
                            </label>
                            <p className="text-xs text-gray-500 mt-1">
                              Activa esta opción si tu proyecto requiere control detallado por ubicaciones (torres, pisos, apartamentos, áreas, etc.).
                              <br />
                              <span className="font-medium text-blue-600">Valor agregado:</span> Permite estadísticas y reportes por ubicación específica.
                            </p>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>

                  <div className="flex items-center justify-end gap-3 p-6 border-t border-gray-200 bg-gray-50">
                    <button
                      type="button"
                      onClick={onClose}
                      className="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                      Cancelar
                    </button>
                    <button
                      type="submit"
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                    >
                      {proyecto ? 'Actualizar' : 'Crear Proyecto'}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          );
        }


        function TrabajadoresCRUD({ trabajadores, setTrabajadores, clientes, proyectos, tiposTrabajador, setTiposTrabajador, userRole, currentClienteId }) {
          const isAdmin = userRole === 'admin';
          const [searchTerm, setSearchTerm] = useState('');
          const [filterCliente, setFilterCliente] = useState('all');
          const [filterProyecto, setFilterProyecto] = useState('all');
          const [filterTipo, setFilterTipo] = useState('all');
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [editingTrabajador, setEditingTrabajador] = useState(null);

          // Filtrar trabajadores según rol
          const visibleTrabajadores = isAdmin 
            ? trabajadores 
            : trabajadores.filter(t => t.clienteId === currentClienteId);

          // Aplicar filtros
          const filteredTrabajadores = useMemo(() => {
            let result = visibleTrabajadores;

            // Búsqueda por texto
            if (searchTerm) {
              result = result.filter(t => {
                const tipo = tiposTrabajador.find(tipo => tipo.id === t.tipoTrabajadorId);
                const tipoNombre = tipo ? tipo.nombre.toLowerCase() : '';
                return t.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
                       t.documento.includes(searchTerm) ||
                       tipoNombre.includes(searchTerm.toLowerCase()) ||
                       t.email.toLowerCase().includes(searchTerm.toLowerCase());
              });
            }

            // Filtro por cliente
            if (filterCliente !== 'all') {
              result = result.filter(t => t.clienteId === parseInt(filterCliente));
            }

            // Filtro por proyecto
            if (filterProyecto !== 'all') {
              result = result.filter(t => t.proyectoId === parseInt(filterProyecto));
            }

            // Filtro por tipo
            if (filterTipo !== 'all') {
              result = result.filter(t => t.tipoTrabajadorId === parseInt(filterTipo));
            }

            return result;
          }, [visibleTrabajadores, searchTerm, filterCliente, filterProyecto, filterTipo, tiposTrabajador]);

          const handleCreate = () => {
            setEditingTrabajador(null);
            setIsModalOpen(true);
          };

          const handleEdit = (trabajador) => {
            setEditingTrabajador(trabajador);
            setIsModalOpen(true);
          };

          const handleDelete = (id) => {
            if (confirm('¿Estás seguro de eliminar este trabajador?')) {
              setTrabajadores(trabajadores.filter(t => t.id !== id));
            }
          };

          const handleSave = (trabajadorData) => {
            if (editingTrabajador) {
              // Editar
              setTrabajadores((trabajadores || []).map(t => 
                t.id === editingTrabajador.id ? { ...trabajadorData, id: editingTrabajador.id } : t
              ));
            } else {
              // Crear
              const newTrabajador = {
                ...trabajadorData,
                id: Math.max(...(trabajadores || []).map(t => t.id), 0) + 1
              };
              setTrabajadores([...trabajadores, newTrabajador]);
            }
            setIsModalOpen(false);
          };

          // Proyectos disponibles según filtro de cliente
          const availableProyectos = filterCliente !== 'all'
            ? proyectos.filter(p => p.clienteId === parseInt(filterCliente))
            : proyectos;

          return (
            <div>
              {/* Header */}
              <div className="flex items-center justify-between mb-6">
                <div>
                  <h2 className="text-3xl font-bold text-gray-800">
                    {isAdmin ? 'Gestión de Trabajadores' : 'Mis Trabajadores'}
                  </h2>
                  <p className="text-gray-600 mt-1">
                    {filteredTrabajadores.length} trabajador{filteredTrabajadores.length !== 1 ? 'es' : ''} {searchTerm || filterCliente !== 'all' || filterProyecto !== 'all' || filterTipo !== 'all' ? 'encontrado' + (filteredTrabajadores.length !== 1 ? 's' : '') : ''}
                  </p>
                </div>
                <button
                  onClick={handleCreate}
                  className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                >
                  <Plus className="w-5 h-5" />
                  Nuevo Trabajador
                </button>
              </div>

              {/* Filtros */}
              <div className="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                {/* Búsqueda */}
                <div>
                  <div className="relative">
                    <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                      <Search className="w-5 h-5" />
                    </div>
                    <input
                      type="text"
                      placeholder="Buscar trabajadores..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                </div>

                {/* Filtro por Cliente */}
                {isAdmin && (
                  <div>
                    <select
                      value={filterCliente}
                      onChange={(e) => {
                        setFilterCliente(e.target.value);
                        setFilterProyecto('all'); // Reset proyecto filter
                      }}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="all">Todos los clientes</option>
                      {(clientes || []).map(c => (
                        <option key={c.id} value={c.id}>{c.nombre}</option>
                      ))}
                    </select>
                  </div>
                )}

                {/* Filtro por Proyecto */}
                <div>
                  <select
                    value={filterProyecto}
                    onChange={(e) => setFilterProyecto(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="all">Todos los proyectos</option>
                    {availableProyectos.map(p => (
                      <option key={p.id} value={p.id}>{p.nombre}</option>
                    ))}
                  </select>
                </div>

                {/* Filtro por Tipo de Trabajador */}
                <div>
                  <select
                    value={filterTipo}
                    onChange={(e) => setFilterTipo(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="all">Todos los tipos</option>
                    {(tiposTrabajador || []).map(t => (
                      <option key={t.id} value={t.id}>{t.nombre}</option>
                    ))}
                  </select>
                </div>
              </div>

              {/* Tabla de Trabajadores */}
              <div className="bg-white rounded-xl shadow-md overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-50 border-b border-gray-200">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trabajador</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                        {isAdmin && <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>}
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Proyecto</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tarifa/Hora</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contacto</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {filteredTrabajadores.map(trabajador => {
                        const cliente = clientes.find(c => c.id === trabajador.clienteId);
                        const proyecto = proyectos.find(p => p.id === trabajador.proyectoId);
                        const tipo = tiposTrabajador.find(t => t.id === trabajador.tipoTrabajadorId);
                        return (
                          <tr key={trabajador.id} className="hover:bg-gray-50">
                            <td className="px-6 py-4">
                              <div className="font-medium text-gray-900">{trabajador.nombre}</div>
                              <div className="text-sm text-gray-500">CC: {trabajador.documento}</div>
                            </td>
                            <td className="px-6 py-4">
                              <span className={`px-2 py-1 text-xs font-semibold rounded-full ${
                                tipo?.fijo ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'
                              }`}>
                                {tipo?.nombre || 'N/A'}
                              </span>
                            </td>
                            {isAdmin && (
                              <td className="px-6 py-4">
                                <div className="text-sm text-gray-900">{cliente?.nombre || 'N/A'}</div>
                              </td>
                            )}
                            <td className="px-6 py-4 text-sm text-gray-900">{proyecto?.nombre || 'Sin asignar'}</td>
                            <td className="px-6 py-4">
                              <div className="text-sm font-medium text-gray-900">{formatCurrency(trabajador.tarifaHora)}/h</div>
                              <div className="text-xs text-gray-500">{formatCurrency(trabajador.tarifaHora * 8)}/día</div>
                            </td>
                            <td className="px-6 py-4">
                              <div className="text-sm text-gray-900">{trabajador.telefono}</div>
                              <div className="text-sm text-gray-500">{trabajador.email}</div>
                            </td>
                            <td className="px-6 py-4">
                              <span className={`px-2 py-1 text-xs font-semibold rounded-full ${
                                trabajador.activo 
                                  ? 'bg-green-100 text-green-800' 
                                  : 'bg-red-100 text-red-800'
                              }`}>
                                {trabajador.activo ? 'Activo' : 'Inactivo'}
                              </span>
                            </td>
                            <td className="px-6 py-4">
                              <div className="flex items-center gap-2">
                                <button
                                  onClick={() => handleEdit(trabajador)}
                                  className="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-50 rounded-lg transition-colors"
                                  title="Editar"
                                >
                                  <Edit2 className="w-4 h-4" />
                                </button>
                                <button
                                  onClick={() => handleDelete(trabajador.id)}
                                  className="text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg transition-colors"
                                  title="Eliminar"
                                >
                                  <Trash2 className="w-4 h-4" />
                                </button>
                              </div>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>

                  {filteredTrabajadores.length === 0 && (
                    <div className="text-center py-12 text-gray-500">
                      No se encontraron trabajadores
                    </div>
                  )}
                </div>
              </div>

              {/* Modal */}
              {isModalOpen && (
                <TrabajadorModal
                  trabajador={editingTrabajador}
                  clientes={clientes}
                  proyectos={proyectos}
                  tiposTrabajador={tiposTrabajador}
                  setTiposTrabajador={setTiposTrabajador}
                  trabajadores={trabajadores}
                  onSave={handleSave}
                  onClose={() => setIsModalOpen(false)}
                  isAdmin={isAdmin}
                  currentClienteId={currentClienteId}
                />
              )}
            </div>
          );
        }

        // ==================== MODAL TRABAJADOR ====================
        
        function TrabajadorModal({ trabajador, clientes, proyectos, tiposTrabajador, setTiposTrabajador, trabajadores, onSave, onClose, isAdmin, currentClienteId }) {
          // Inicializar con tarifa por defecto del primer tipo si es nuevo trabajador
          const tipoInicial = tiposTrabajador[0] || {};
          
          const [formData, setFormData] = useState(trabajador || {
            nombre: '',
            documento: '',
            tipoTrabajadorId: tipoInicial.id || 1,
            clienteId: isAdmin ? (clientes[0]?.id || 1) : currentClienteId,
            proyectoId: null,
            tarifaHora: tipoInicial.tarifaHoraPorDefecto || 0,
            telefono: '',
            email: '',
            activo: true,
            fechaIngreso: new Date().toISOString().split('T')[0]
          });

          const [showTiposModal, setShowTiposModal] = useState(false);

          // Proyectos disponibles según cliente seleccionado
          const availableProyectos = proyectos.filter(p => p.clienteId === formData.clienteId);

          const handleSubmit = (e) => {
            e.preventDefault();
            onSave({
              ...formData,
              tarifaHora: parseFloat(formData.tarifaHora),
              proyectoId: formData.proyectoId ? parseInt(formData.proyectoId) : null,
              tipoTrabajadorId: parseInt(formData.tipoTrabajadorId)
            });
          };

          const handleClienteChange = (clienteId) => {
            setFormData({
              ...formData,
              clienteId: parseInt(clienteId),
              proyectoId: null // Reset proyecto cuando cambia cliente
            });
          };

          // Autocompletar tarifa cuando cambia el tipo de trabajador
          const handleTipoChange = (tipoId) => {
            const tipo = tiposTrabajador.find(t => t.id === parseInt(tipoId));
            setFormData({
              ...formData,
              tipoTrabajadorId: parseInt(tipoId),
              tarifaHora: tipo?.tarifaHoraPorDefecto || formData.tarifaHora
            });
          };

          return (
            <>
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                  <div className="flex items-center justify-between p-6 border-b border-gray-200">
                    <h3 className="text-xl font-bold text-gray-800">
                      {trabajador ? 'Editar Trabajador' : 'Nuevo Trabajador'}
                    </h3>
                    <button
                      onClick={onClose}
                      className="text-gray-400 hover:text-gray-600 transition-colors"
                    >
                      <X className="w-6 h-6" />
                    </button>
                  </div>

                  <form onSubmit={handleSubmit} className="p-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {/* Nombre Completo */}
                      <div className="md:col-span-2">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Nombre Completo *
                        </label>
                        <input
                          type="text"
                          required
                          value={formData.nombre}
                          onChange={(e) => setFormData({...formData, nombre: e.target.value})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Ej: Carlos Ramírez"
                        />
                      </div>

                      {/* Documento */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Documento de Identidad *
                        </label>
                        <input
                          type="text"
                          required
                          value={formData.documento}
                          onChange={(e) => setFormData({...formData, documento: e.target.value})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="1.234.567-8"
                        />
                      </div>

                      {/* Tipo de Trabajador con botón de gestión */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Tipo de Trabajador *
                        </label>
                        <div className="flex gap-2">
                          <select
                            required
                            value={formData.tipoTrabajadorId}
                            onChange={(e) => handleTipoChange(e.target.value)}
                            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          >
                            {(tiposTrabajador || []).map(t => (
                              <option key={t.id} value={t.id}>{t.nombre}</option>
                            ))}
                          </select>
                          <button
                            type="button"
                            onClick={() => setShowTiposModal(true)}
                            className="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
                            title="Gestionar Tipos"
                          >
                            ⚙️
                          </button>
                        </div>
                      </div>

                      {/* Cliente */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Cliente *
                        </label>
                        <select
                          required
                          value={formData.clienteId}
                          onChange={(e) => handleClienteChange(e.target.value)}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          disabled={!isAdmin}
                        >
                          {(clientes || []).map(c => (
                            <option key={c.id} value={c.id}>{c.nombre}</option>
                          ))}
                        </select>
                      </div>

                      {/* Proyecto */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Proyecto Asignado
                        </label>
                        <select
                          value={formData.proyectoId || ''}
                          onChange={(e) => setFormData({...formData, proyectoId: e.target.value ? parseInt(e.target.value) : null})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                          <option value="">Sin asignar</option>
                          {availableProyectos.map(p => (
                            <option key={p.id} value={p.id}>{p.nombre}</option>
                          ))}
                        </select>
                      </div>

                      {/* Tarifa por Hora */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Tarifa por Hora (COP) *
                        </label>
                        <input
                          type="number"
                          required
                          min="0"
                          step="100"
                          value={formData.tarifaHora}
                          onChange={(e) => setFormData({...formData, tarifaHora: e.target.value})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="10000"
                        />
                        {formData.tarifaHora > 0 && (
                          <div className="mt-1 space-y-1">
                            <p className="text-sm font-medium text-gray-700">
                              {formatCurrency(parseFloat(formData.tarifaHora))}/hora
                            </p>
                            <p className="text-xs text-gray-500">
                              💡 Equivalente diario (8h): {formatCurrency(parseFloat(formData.tarifaHora) * 8)}
                            </p>
                            {(() => {
                              const tipo = tiposTrabajador.find(t => t.id === formData.tipoTrabajadorId);
                              return tipo && formData.tarifaHora === tipo.tarifaHoraPorDefecto && (
                                <p className="text-xs text-blue-600">
                                  ✨ Tarifa estándar para {tipo.nombre}
                                </p>
                              );
                            })()}
                          </div>
                        )}
                        <p className="text-xs text-gray-500 mt-2">
                          💬 Puedes ajustar la tarifa si este trabajador tiene una tarifa especial
                        </p>
                      </div>

                      {/* Teléfono */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Teléfono *
                        </label>
                        <input
                          type="tel"
                          required
                          value={formData.telefono}
                          onChange={(e) => setFormData({...formData, telefono: e.target.value})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="+57 300 111 2222"
                        />
                      </div>

                      {/* Email */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Email *
                        </label>
                        <input
                          type="email"
                          required
                          value={formData.email}
                          onChange={(e) => setFormData({...formData, email: e.target.value})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="trabajador@email.com"
                        />
                      </div>

                      {/* Fecha de Ingreso */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Fecha de Ingreso *
                        </label>
                        <input
                          type="date"
                          required
                          value={formData.fechaIngreso}
                          onChange={(e) => setFormData({...formData, fechaIngreso: e.target.value})}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                      </div>

                      {/* Trabajador Activo */}
                      <div className="md:col-span-2">
                        <label className="flex items-center gap-2">
                          <input
                            type="checkbox"
                            checked={formData.activo}
                            onChange={(e) => setFormData({...formData, activo: e.target.checked})}
                            className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                          />
                          <span className="text-sm font-medium text-gray-700">Trabajador activo</span>
                        </label>
                      </div>
                    </div>

                    <div className="flex items-center justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
                      <button
                        type="button"
                        onClick={onClose}
                        className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
                      >
                        Cancelar
                      </button>
                      <button
                        type="submit"
                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                      >
                        {trabajador ? 'Guardar Cambios' : 'Crear Trabajador'}
                      </button>
                    </div>
                  </form>
                </div>
              </div>

              {/* Modal de Gestión de Tipos */}
              {showTiposModal && (
                <TiposGestionModal
                  tiposTrabajador={tiposTrabajador}
                  setTiposTrabajador={setTiposTrabajador}
                  trabajadores={trabajadores}
                  onClose={() => setShowTiposModal(false)}
                />
              )}
            </>
          );
        }

        // ==================== MODAL GESTIÓN TIPOS ====================
        
        function TiposGestionModal({ tiposTrabajador, setTiposTrabajador, trabajadores, onClose }) {
          const [editingTipo, setEditingTipo] = useState(null);
          const [nuevoTipo, setNuevoTipo] = useState({ nombre: '', descripcion: '', tarifaHoraPorDefecto: 0 });

          const handleCreateTipo = (e) => {
            e.preventDefault();
            if (!nuevoTipo.nombre.trim()) return;
            if (!nuevoTipo.tarifaHoraPorDefecto || nuevoTipo.tarifaHoraPorDefecto <= 0) {
              alert('Debe ingresar una tarifa por defecto válida');
              return;
            }

            const newTipo = {
              id: Math.max(...(tiposTrabajador || []).map(t => t.id), 0) + 1,
              nombre: nuevoTipo.nombre,
              fijo: false,
              descripcion: nuevoTipo.descripcion,
              tarifaHoraPorDefecto: parseFloat(nuevoTipo.tarifaHoraPorDefecto)
            };

            setTiposTrabajador([...tiposTrabajador, newTipo]);
            setNuevoTipo({ nombre: '', descripcion: '', tarifaHoraPorDefecto: 0 });
          };

          const handleUpdateTipo = (id, nombre, descripcion, tarifaHoraPorDefecto) => {
            setTiposTrabajador((tiposTrabajador || []).map(t =>
              t.id === id ? { ...t, nombre, descripcion, tarifaHoraPorDefecto: parseFloat(tarifaHoraPorDefecto) } : t
            ));
            setEditingTipo(null);
          };

          const handleDeleteTipo = (id) => {
            const tipo = tiposTrabajador.find(t => t.id === id);
            
            if (tipo.fijo) {
              alert('No puedes eliminar "Supervisor" (requerido para App Móvil)');
              return;
            }

            const trabajadoresConTipo = trabajadores.filter(t => t.tipoTrabajadorId === id);
            if (trabajadoresConTipo.length > 0) {
              alert(`No puedes eliminar este tipo. Hay ${trabajadoresConTipo.length} trabajador(es) asignado(s)`);
              return;
            }

            if (confirm(`¿Eliminar el tipo "${tipo.nombre}"?`)) {
              setTiposTrabajador(tiposTrabajador.filter(t => t.id !== id));
            }
          };

          return (
            <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[60]">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden">
                <div className="flex items-center justify-between p-6 border-b border-gray-200">
                  <h3 className="text-xl font-bold text-gray-800">
                    Gestionar Tipos de Trabajador
                  </h3>
                  <button
                    onClick={onClose}
                    className="text-gray-400 hover:text-gray-600 transition-colors"
                  >
                    <X className="w-6 h-6" />
                  </button>
                </div>

                <div className="p-6 overflow-y-auto max-h-[60vh]">
                  {/* Formulario Crear Nuevo Tipo */}
                  <form onSubmit={handleCreateTipo} className="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h4 className="font-semibold text-gray-800 mb-3">Crear Nuevo Tipo</h4>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                      <input
                        type="text"
                        required
                        value={nuevoTipo.nombre}
                        onChange={(e) => setNuevoTipo({...nuevoTipo, nombre: e.target.value})}
                        placeholder="Nombre del tipo"
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                      <input
                        type="number"
                        required
                        min="0"
                        step="100"
                        value={nuevoTipo.tarifaHoraPorDefecto}
                        onChange={(e) => setNuevoTipo({...nuevoTipo, tarifaHoraPorDefecto: e.target.value})}
                        placeholder="Tarifa/hora (ej: 10000)"
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                      <input
                        type="text"
                        value={nuevoTipo.descripcion}
                        onChange={(e) => setNuevoTipo({...nuevoTipo, descripcion: e.target.value})}
                        placeholder="Descripción (opcional)"
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                    </div>
                    <button
                      type="submit"
                      className="mt-3 flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                    >
                      <Plus className="w-4 h-4" />
                      Agregar Tipo
                    </button>
                  </form>

                  {/* Lista de Tipos */}
                  <div className="space-y-2">
                    {(tiposTrabajador || []).map(tipo => (
                      <div
                        key={tipo.id}
                        className={`p-4 border rounded-lg ${
                          tipo.fijo ? 'bg-purple-50 border-purple-200' : 'bg-white border-gray-200'
                        }`}
                      >
                        {editingTipo === tipo.id ? (
                          <div className="space-y-2">
                            <input
                              type="text"
                              value={tipo.nombre}
                              onChange={(e) => setTiposTrabajador((tiposTrabajador || []).map(t =>
                                t.id === tipo.id ? { ...t, nombre: e.target.value } : t
                              ))}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                              disabled={tipo.fijo}
                            />
                            <input
                              type="number"
                              min="0"
                              step="100"
                              value={tipo.tarifaHoraPorDefecto}
                              onChange={(e) => setTiposTrabajador((tiposTrabajador || []).map(t =>
                                t.id === tipo.id ? { ...t, tarifaHoraPorDefecto: e.target.value } : t
                              ))}
                              placeholder="Tarifa/hora"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            />
                            <input
                              type="text"
                              value={tipo.descripcion}
                              onChange={(e) => setTiposTrabajador((tiposTrabajador || []).map(t =>
                                t.id === tipo.id ? { ...t, descripcion: e.target.value } : t
                              ))}
                              placeholder="Descripción"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            />
                            {tipo.fijo && (
                              <div className="flex items-start gap-2 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                                <span className="text-amber-600 text-sm">ℹ️</span>
                                <p className="text-xs text-amber-800">
                                  El nombre <strong>"{tipo.nombre}"</strong> no puede cambiar (requerido para App Móvil), 
                                  pero la <strong>tarifa</strong> y <strong>descripción</strong> sí son editables según las necesidades de cada cliente.
                                </p>
                              </div>
                            )}
                            <div className="flex gap-2">
                              <button
                                onClick={() => setEditingTipo(null)}
                                className="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm"
                              >
                                Guardar
                              </button>
                              <button
                                onClick={() => setEditingTipo(null)}
                                className="px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm"
                              >
                                Cancelar
                              </button>
                            </div>
                          </div>
                        ) : (
                          <div className="flex items-center justify-between">
                            <div className="flex-1">
                              <div className="flex items-center gap-2">
                                <span className="font-semibold text-gray-900">{tipo.nombre}</span>
                                {tipo.fijo && (
                                  <span className="px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded-full">
                                    🔒 Fijo
                                  </span>
                                )}
                              </div>
                              <div className="flex items-center gap-2 mt-1">
                                <span className="text-sm font-medium text-green-700">
                                  💰 {formatCurrency(tipo.tarifaHoraPorDefecto)}/hora
                                </span>
                                <span className="text-xs text-gray-500">
                                  ({formatCurrency(tipo.tarifaHoraPorDefecto * 8)}/día)
                                </span>
                              </div>
                              {tipo.descripcion && (
                                <p className="text-sm text-gray-600 mt-1">{tipo.descripcion}</p>
                              )}
                            </div>
                            <div className="flex items-center gap-2">
                              <button
                                onClick={() => setEditingTipo(tipo.id)}
                                className="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-50 rounded-lg"
                                title={tipo.fijo ? "Editar Tarifa y Descripción" : "Editar"}
                              >
                                <Edit2 className="w-4 h-4" />
                              </button>
                              {!tipo.fijo && (
                                <button
                                  onClick={() => handleDeleteTipo(tipo.id)}
                                  className="text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg"
                                  title="Eliminar"
                                >
                                  <Trash2 className="w-4 h-4" />
                                </button>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>

                  <div className="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <p className="text-sm text-blue-800">
                      ℹ️ <strong>"Supervisor"</strong> es un tipo fijo requerido para la App Móvil:
                    </p>
                    <ul className="text-sm text-blue-700 mt-2 ml-4 list-disc space-y-1">
                      <li><strong>No puede ser eliminado</strong> (requerido por el sistema)</li>
                      <li><strong>Su nombre no puede cambiar</strong> (la App lo busca así)</li>
                      <li><strong>Su tarifa SÍ es editable</strong> (ajusta según tu cliente)</li>
                    </ul>
                  </div>
                </div>

                <div className="flex items-center justify-end gap-3 p-6 border-t border-gray-200">
                  <button
                    onClick={onClose}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    Cerrar
                  </button>
                </div>
              </div>
            </div>
          );
        }

        // ==================== CRUD PERSONAL/STAFF ====================
        
        // ==================== MINI-CRUD MODAL (Reutilizable) ====================
        
        function MiniCRUDModal({ title, items, setItems, itemName, onClose }) {
          const [editingItem, setEditingItem] = useState(null);
          const [nuevoItem, setNuevoItem] = useState({ nombre: '', descripcion: '' });

          const handleCreate = (e) => {
            e.preventDefault();
            if (!nuevoItem.nombre.trim()) return;

            const newItem = {
              id: Math.max(...items.map(t => t.id), 0) + 1,
              nombre: nuevoItem.nombre,
              descripcion: nuevoItem.descripcion
            };

            setItems([...items, newItem]);
            setNuevoItem({ nombre: '', descripcion: '' });
          };

          const handleUpdate = (id, nombre, descripcion) => {
            setItems(items.map(t =>
              t.id === id ? { ...t, nombre, descripcion } : t
            ));
            setEditingItem(null);
          };

          const handleDelete = (id) => {
            if (confirm(`¿Estás seguro de eliminar este ${itemName}?`)) {
              setItems(items.filter(t => t.id !== id));
            }
          };

          return (
            <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[60]">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto">
                <div className="flex items-center justify-between p-6 border-b border-gray-200">
                  <h3 className="text-lg font-bold text-gray-900">{title}</h3>
                  <button
                    onClick={onClose}
                    className="text-gray-400 hover:text-gray-600"
                  >
                    <X className="w-5 h-5" />
                  </button>
                </div>

                <div className="p-6">
                  {/* Formulario Crear */}
                  <form onSubmit={handleCreate} className="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h4 className="font-semibold text-gray-800 mb-3">Crear Nuevo</h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                      <input
                        type="text"
                        required
                        value={nuevoItem.nombre}
                        onChange={(e) => setNuevoItem({...nuevoItem, nombre: e.target.value})}
                        placeholder="Nombre"
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                      <input
                        type="text"
                        value={nuevoItem.descripcion}
                        onChange={(e) => setNuevoItem({...nuevoItem, descripcion: e.target.value})}
                        placeholder="Descripción (opcional)"
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                    </div>
                    <button
                      type="submit"
                      className="mt-3 flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                    >
                      <Plus className="w-4 h-4" />
                      Agregar
                    </button>
                  </form>

                  {/* Lista */}
                  <div className="space-y-2">
                    {items.map(item => (
                      <div
                        key={item.id}
                        className="p-4 border border-gray-200 rounded-lg bg-white"
                      >
                        {editingItem === item.id ? (
                          <div className="space-y-2">
                            <input
                              type="text"
                              value={item.nombre}
                              onChange={(e) => setItems(items.map(t =>
                                t.id === item.id ? { ...t, nombre: e.target.value } : t
                              ))}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            />
                            <input
                              type="text"
                              value={item.descripcion || ''}
                              onChange={(e) => setItems(items.map(t =>
                                t.id === item.id ? { ...t, descripcion: e.target.value } : t
                              ))}
                              placeholder="Descripción"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            />
                            <div className="flex gap-2">
                              <button
                                onClick={() => setEditingItem(null)}
                                className="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm"
                              >
                                Guardar
                              </button>
                              <button
                                onClick={() => setEditingItem(null)}
                                className="px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm"
                              >
                                Cancelar
                              </button>
                            </div>
                          </div>
                        ) : (
                          <div className="flex items-center justify-between">
                            <div className="flex-1">
                              <span className="font-semibold text-gray-900">{item.nombre}</span>
                              {item.descripcion && (
                                <p className="text-sm text-gray-600 mt-1">{item.descripcion}</p>
                              )}
                            </div>
                            <div className="flex items-center gap-2">
                              <button
                                onClick={() => setEditingItem(item.id)}
                                className="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-50 rounded-lg"
                                title="Editar"
                              >
                                <Edit2 className="w-4 h-4" />
                              </button>
                              <button
                                onClick={() => handleDelete(item.id)}
                                className="text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg"
                                title="Eliminar"
                              >
                                <Trash2 className="w-4 h-4" />
                              </button>
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>

                <div className="flex items-center justify-end gap-3 p-6 border-t border-gray-200">
                  <button
                    onClick={onClose}
                    className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
                  >
                    Cerrar
                  </button>
                </div>
              </div>
            </div>
          );
        }

        // ==================== MODAL PERSONAL/STAFF ====================
        
        function PersonalModal({ personal, clientes, proyectos, cargos, setCargos, departamentos, setDepartamentos, onSave, onClose, isAdmin, currentClienteId }) {
          const tipoInicial = cargos[0] || {};
          
          const [formData, setFormData] = useState(personal || {
            nombre: '',
            documento: '',
            cargoId: tipoInicial.id || 1,
            departamentoId: departamentos[0]?.id || 1,
            clienteId: isAdmin ? (clientes[0]?.id || 1) : currentClienteId,
            proyectosAsignados: [],
            tipoContrato: 'Indefinido',
            salarioMensual: 0,
            fechaIngreso: new Date().toISOString().split('T')[0],
            telefono: '',
            email: '',
            activo: true
          });

          const [showCargosModal, setShowCargosModal] = useState(false);
          const [showDepartamentosModal, setShowDepartamentosModal] = useState(false);

          const availableProyectos = proyectos.filter(p => p.clienteId === formData.clienteId);

          const handleSubmit = (e) => {
            e.preventDefault();
            onSave({
              ...formData,
              salarioMensual: parseFloat(formData.salarioMensual),
              cargoId: parseInt(formData.cargoId),
              departamentoId: parseInt(formData.departamentoId),
              clienteId: parseInt(formData.clienteId)
            });
          };

          const handleClienteChange = (clienteId) => {
            setFormData({
              ...formData,
              clienteId: parseInt(clienteId),
              proyectosAsignados: []
            });
          };

          const handleProyectoToggle = (proyectoId) => {
            const id = parseInt(proyectoId);
            const newProyectos = formData.proyectosAsignados.includes(id)
              ? formData.proyectosAsignados.filter(p => p !== id)
              : [...formData.proyectosAsignados, id];
            setFormData({ ...formData, proyectosAsignados: newProyectos });
          };

          return (
            <>
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                  <div className="flex items-center justify-between p-6 border-b border-gray-200">
                    <div>
                      <h3 className="text-xl font-bold text-gray-900">
                        {personal ? 'Editar Personal/Staff' : 'Nuevo Personal/Staff'}
                      </h3>
                      <p className="text-sm text-gray-500 mt-1">
                        Personal administrativo y de gestión
                      </p>
                    </div>
                    <button
                      onClick={onClose}
                      className="text-gray-400 hover:text-gray-600 transition-colors"
                    >
                      <X className="w-6 h-6" />
                    </button>
                  </div>

                  <form onSubmit={handleSubmit}>
                    <div className="p-6 space-y-6">
                      {/* Información Básica */}
                      <div>
                        <h4 className="text-md font-semibold text-gray-800 mb-4">📋 Información Básica</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                              Nombre Completo *
                            </label>
                            <input
                              type="text"
                              required
                              value={formData.nombre}
                              onChange={(e) => setFormData({...formData, nombre: e.target.value})}
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="María González"
                            />
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                              Documento *
                            </label>
                            <input
                              type="text"
                              required
                              value={formData.documento}
                              onChange={(e) => setFormData({...formData, documento: e.target.value})}
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="10.123.456-7"
                            />
                          </div>
                        </div>
                      </div>

                      {/* Cargo y Departamento */}
                      <div>
                        <h4 className="text-md font-semibold text-gray-800 mb-4">💼 Cargo y Departamento</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                              Cargo *
                            </label>
                            <div className="flex gap-2">
                              <select
                                required
                                value={formData.cargoId}
                                onChange={(e) => setFormData({...formData, cargoId: parseInt(e.target.value)})}
                                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              >
                                {cargos.map(c => (
                                  <option key={c.id} value={c.id}>{c.nombre}</option>
                                ))}
                              </select>
                              <button
                                type="button"
                                onClick={() => setShowCargosModal(true)}
                                className="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
                                title="Gestionar Cargos"
                              >
                                ⚙️
                              </button>
                            </div>
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                              Departamento *
                            </label>
                            <div className="flex gap-2">
                              <select
                                required
                                value={formData.departamentoId}
                                onChange={(e) => setFormData({...formData, departamentoId: parseInt(e.target.value)})}
                                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              >
                                {departamentos.map(d => (
                                  <option key={d.id} value={d.id}>{d.nombre}</option>
                                ))}
                              </select>
                              <button
                                type="button"
                                onClick={() => setShowDepartamentosModal(true)}
                                className="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
                                title="Gestionar Departamentos"
                              >
                                ⚙️
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Cliente y Proyectos */}
                      <div>
                        <h4 className="text-md font-semibold text-gray-800 mb-4">🏢 Asignación</h4>
                        <div className="space-y-4">
                          {isAdmin && (
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">
                                Cliente *
                              </label>
                              <select
                                required
                                value={formData.clienteId}
                                onChange={(e) => handleClienteChange(e.target.value)}
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              >
                                {(clientes || []).map(c => (
                                  <option key={c.id} value={c.id}>{c.nombre}</option>
                                ))}
                              </select>
                            </div>
                          )}

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                              Proyectos Asignados
                            </label>
                            <div className="border border-gray-300 rounded-lg p-4 max-h-40 overflow-y-auto">
                              {availableProyectos.length === 0 ? (
                                <p className="text-sm text-gray-500">No hay proyectos disponibles</p>
                              ) : (
                                <div className="space-y-2">
                                  {availableProyectos.map(proyecto => (
                                    <label key={proyecto.id} className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                                      <input
                                        type="checkbox"
                                        checked={formData.proyectosAsignados.includes(proyecto.id)}
                                        onChange={() => handleProyectoToggle(proyecto.id)}
                                        className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                      />
                                      <span className="text-sm text-gray-700">{proyecto.nombre}</span>
                                    </label>
                                  ))}
                                </div>
                              )}
                            </div>
                            <p className="text-xs text-gray-500 mt-1">
                              {formData.proyectosAsignados.length} proyecto(s) seleccionado(s)
                            </p>
                          </div>
                        </div>
                      </div>

                      {/* Información Laboral */}
                      <div>
                        <h4 className="text-md font-semibold text-gray-800 mb-4">💰 Información Laboral</h4>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                              Tipo de Contrato *
                            </label>
                            <select
                              required
                              value={formData.tipoContrato}
                              onChange={(e) => setFormData({...formData, tipoContrato: e.target.value})}
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                              <option value="Indefinido">Indefinido</option>
                              <option value="Fijo">Fijo</option>
                              <option value="Freelance">Freelance</option>
                              <option value="Temporal">Temporal</option>
                            </select>
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                              Salario Mensual (COP) *
                            </label>
                            <input
                              type="number"
                              required
                              min="0"
                              step="10000"
                              value={formData.salarioMensual}
                              onChange={(e) => setFormData({...formData, salarioMensual: e.target.value})}
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="5000000"
                            />
                            {formData.salarioMensual > 0 && (
                              <p className="text-sm text-gray-500 mt-1">
                                {formatCurrency(parseFloat(formData.salarioMensual))}
                              </p>
                            )}
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                              Fecha de Ingreso *
                            </label>
                            <input
                              type="date"
                              required
                              value={formData.fechaIngreso}
                              onChange={(e) => setFormData({...formData, fechaIngreso: e.target.value})}
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                          </div>
                        </div>
                      </div>

                      {/* Contacto */}
                      <div>
                        <h4 className="text-md font-semibold text-gray-800 mb-4">📞 Contacto</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                              Teléfono *
                            </label>
                            <input
                              type="tel"
                              required
                              value={formData.telefono}
                              onChange={(e) => setFormData({...formData, telefono: e.target.value})}
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="+57 300 111 2222"
                            />
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                              Email *
                            </label>
                            <input
                              type="email"
                              required
                              value={formData.email}
                              onChange={(e) => setFormData({...formData, email: e.target.value})}
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="maria@empresa.com"
                            />
                          </div>
                        </div>
                      </div>

                      {/* Estado */}
                      <div>
                        <label className="flex items-center gap-2">
                          <input
                            type="checkbox"
                            checked={formData.activo}
                            onChange={(e) => setFormData({...formData, activo: e.target.checked})}
                            className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                          />
                          <span className="text-sm font-medium text-gray-700">Personal activo</span>
                        </label>
                      </div>
                    </div>

                    <div className="flex items-center justify-end gap-3 p-6 border-t border-gray-200">
                      <button
                        type="button"
                        onClick={onClose}
                        className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
                      >
                        Cancelar
                      </button>
                      <button
                        type="submit"
                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                      >
                        {personal ? 'Actualizar' : 'Crear'}
                      </button>
                    </div>
                  </form>
                </div>
              </div>

              {/* Mini-CRUD Cargos */}
              {showCargosModal && (
                <MiniCRUDModal
                  title="Gestionar Cargos"
                  items={cargos}
                  setItems={setCargos}
                  itemName="cargo"
                  onClose={() => setShowCargosModal(false)}
                />
              )}

              {/* Mini-CRUD Departamentos */}
              {showDepartamentosModal && (
                <MiniCRUDModal
                  title="Gestionar Departamentos"
                  items={departamentos}
                  setItems={setDepartamentos}
                  itemName="departamento"
                  onClose={() => setShowDepartamentosModal(false)}
                />
              )}
            </>
          );
        }

        function PersonalCRUD({ personal, setPersonal, clientes, proyectos, cargos, setCargos, departamentos, setDepartamentos, userRole, currentClienteId }) {
          const isAdmin = userRole === 'admin';
          const [searchTerm, setSearchTerm] = useState('');
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [editingPersonal, setEditingPersonal] = useState(null);
          const [filterCargo, setFilterCargo] = useState('all');
          const [filterDepartamento, setFilterDepartamento] = useState('all');
          const [filterProyecto, setFilterProyecto] = useState('all');

          const visiblePersonal = isAdmin 
            ? personal 
            : personal.filter(p => p.clienteId === currentClienteId);

          const filteredPersonal = useMemo(() => {
            let result = visiblePersonal;

            if (searchTerm) {
              result = result.filter(p =>
                p.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.documento.includes(searchTerm)
              );
            }

            if (filterCargo !== 'all') {
              result = result.filter(p => p.cargoId === parseInt(filterCargo));
            }

            if (filterDepartamento !== 'all') {
              result = result.filter(p => p.departamentoId === parseInt(filterDepartamento));
            }

            if (filterProyecto !== 'all') {
              result = result.filter(p => p.proyectosAsignados.includes(parseInt(filterProyecto)));
            }

            return result;
          }, [visiblePersonal, searchTerm, filterCargo, filterDepartamento, filterProyecto]);

          const handleCreate = () => {
            setEditingPersonal(null);
            setIsModalOpen(true);
          };

          const handleEdit = (pers) => {
            setEditingPersonal(pers);
            setIsModalOpen(true);
          };

          const handleDelete = (id) => {
            if (confirm('¿Estás seguro de eliminar este personal?')) {
              setPersonal(personal.filter(p => p.id !== id));
            }
          };

          const handleSave = (personalData) => {
            if (editingPersonal) {
              setPersonal(personal.map(p => 
                p.id === editingPersonal.id ? { ...personalData, id: editingPersonal.id } : p
              ));
            } else {
              const newPersonal = {
                ...personalData,
                id: Math.max(...personal.map(p => p.id), 0) + 1
              };
              setPersonal([...personal, newPersonal]);
            }
            setIsModalOpen(false);
          };

          return (
            <div>
              <div className="flex items-center justify-between mb-6">
                <div>
                  <h2 className="text-3xl font-bold text-gray-800">
                    {isAdmin ? 'Personal / Staff' : 'Mi Personal'}
                  </h2>
                  <p className="text-gray-600 mt-1">Personal administrativo y de gestión</p>
                </div>
                <button
                  onClick={handleCreate}
                  className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                >
                  <Plus className="w-5 h-5" />
                  Nuevo Personal
                </button>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div className="bg-white p-4 rounded-lg shadow">
                  <div className="text-sm text-gray-600">Total Personal</div>
                  <div className="text-2xl font-bold text-gray-900">{visiblePersonal.length}</div>
                </div>
                <div className="bg-white p-4 rounded-lg shadow">
                  <div className="text-sm text-gray-600">Personal Activo</div>
                  <div className="text-2xl font-bold text-green-600">
                    {visiblePersonal.filter(p => p.activo).length}
                  </div>
                </div>
                <div className="bg-white p-4 rounded-lg shadow">
                  <div className="text-sm text-gray-600">Cargos</div>
                  <div className="text-2xl font-bold text-blue-600">{cargos.length}</div>
                </div>
                <div className="bg-white p-4 rounded-lg shadow">
                  <div className="text-sm text-gray-600">Departamentos</div>
                  <div className="text-2xl font-bold text-purple-600">{departamentos.length}</div>
                </div>
              </div>

              <div className="bg-white p-4 rounded-lg shadow mb-6">
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <div className="relative">
                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                    <input
                      type="text"
                      placeholder="Buscar personal..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                  <select
                    value={filterCargo}
                    onChange={(e) => setFilterCargo(e.target.value)}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="all">Todos los cargos</option>
                    {cargos.map(c => (
                      <option key={c.id} value={c.id}>{c.nombre}</option>
                    ))}
                  </select>
                  <select
                    value={filterDepartamento}
                    onChange={(e) => setFilterDepartamento(e.target.value)}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="all">Todos los departamentos</option>
                    {departamentos.map(d => (
                      <option key={d.id} value={d.id}>{d.nombre}</option>
                    ))}
                  </select>
                  <select
                    value={filterProyecto}
                    onChange={(e) => setFilterProyecto(e.target.value)}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="all">Todos los proyectos</option>
                    {proyectos.filter(p => isAdmin || p.clienteId === currentClienteId).map(p => (
                      <option key={p.id} value={p.id}>{p.nombre}</option>
                    ))}
                  </select>
                </div>
              </div>

              <div className="bg-white rounded-lg shadow overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cargo</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Departamento</th>
                        {isAdmin && (
                          <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                        )}
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Proyectos</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Salario</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contacto</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {filteredPersonal.length === 0 ? (
                        <tr>
                          <td colSpan={isAdmin ? 9 : 8} className="px-6 py-8 text-center text-gray-500">
                            No se encontró personal
                          </td>
                        </tr>
                      ) : (
                        filteredPersonal.map((pers) => {
                          const cliente = clientes.find(c => c.id === pers.clienteId);
                          const cargo = cargos.find(c => c.id === pers.cargoId);
                          const departamento = departamentos.find(d => d.id === pers.departamentoId);
                          const proyectosAsig = proyectos.filter(p => pers.proyectosAsignados.includes(p.id));

                          return (
                            <tr key={pers.id} className="hover:bg-gray-50">
                              <td className="px-6 py-4">
                                <div className="text-sm font-medium text-gray-900">{pers.nombre}</div>
                                <div className="text-sm text-gray-500">{pers.documento}</div>
                              </td>
                              <td className="px-6 py-4">
                                <span className="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                  {cargo?.nombre || 'Sin cargo'}
                                </span>
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-900">
                                {departamento?.nombre || 'Sin departamento'}
                              </td>
                              {isAdmin && (
                                <td className="px-6 py-4 text-sm text-gray-900">{cliente?.nombre || 'N/A'}</td>
                              )}
                              <td className="px-6 py-4 text-sm">
                                {proyectosAsig.length === 0 ? (
                                  <span className="text-gray-500">Sin proyectos</span>
                                ) : (
                                  <div className="text-xs">
                                    {proyectosAsig.slice(0, 2).map(p => (
                                      <div key={p.id} className="text-gray-700">{p.nombre}</div>
                                    ))}
                                    {proyectosAsig.length > 2 && (
                                      <div className="text-gray-500">+{proyectosAsig.length - 2} más</div>
                                    )}
                                  </div>
                                )}
                              </td>
                              <td className="px-6 py-4">
                                <div className="text-sm font-medium text-gray-900">
                                  {formatCurrency(pers.salarioMensual)}/mes
                                </div>
                              </td>
                              <td className="px-6 py-4">
                                <div className="text-sm text-gray-900">{pers.telefono}</div>
                                <div className="text-sm text-gray-500">{pers.email}</div>
                              </td>
                              <td className="px-6 py-4">
                                <span className={`px-2 py-1 text-xs rounded-full ${
                                  pers.activo 
                                    ? 'bg-green-100 text-green-800' 
                                    : 'bg-red-100 text-red-800'
                                }`}>
                                  {pers.activo ? 'Activo' : 'Inactivo'}
                                </span>
                              </td>
                              <td className="px-6 py-4">
                                <div className="flex items-center gap-2">
                                  <button
                                    onClick={() => handleEdit(pers)}
                                    className="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-50 rounded-lg"
                                    title="Editar"
                                  >
                                    <Edit2 className="w-4 h-4" />
                                  </button>
                                  <button
                                    onClick={() => handleDelete(pers.id)}
                                    className="text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg"
                                    title="Eliminar"
                                  >
                                    <Trash2 className="w-4 h-4" />
                                  </button>
                                </div>
                              </td>
                            </tr>
                          );
                        })
                      )}
                    </tbody>
                  </table>
                </div>
              </div>

              {filteredPersonal.length > 0 && (
                <div className="mt-4 text-sm text-gray-600">
                  Mostrando {filteredPersonal.length} de {visiblePersonal.length} personal
                </div>
              )}

              {isModalOpen && (
                <PersonalModal
                  personal={editingPersonal}
                  clientes={clientes}
                  proyectos={proyectos}
                  cargos={cargos}
                  setCargos={setCargos}
                  departamentos={departamentos}
                  setDepartamentos={setDepartamentos}
                  onSave={handleSave}
                  onClose={() => setIsModalOpen(false)}
                  isAdmin={isAdmin}
                  currentClienteId={currentClienteId}
                />
              )}
            </div>
          );
        }

        // ==================== CRUD CLIENTES ====================
        
        function ClientesCRUD({ clientes, setClientes, userRole, currentClienteId }) {
          const isAdmin = userRole === 'admin';
          const [searchTerm, setSearchTerm] = useState('');
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [editingCliente, setEditingCliente] = useState(null);

          const visibleClientes = isAdmin 
            ? clientes 
            : clientes.filter(c => c.id === currentClienteId);

          const filteredClientes = useMemo(() => {
            if (!searchTerm) return visibleClientes;
            return visibleClientes.filter(c =>
              c.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
              c.nit.includes(searchTerm) ||
              c.representante.toLowerCase().includes(searchTerm.toLowerCase())
            );
          }, [visibleClientes, searchTerm]);

          const handleCreate = () => {
            setEditingCliente(null);
            setIsModalOpen(true);
          };

          const handleEdit = (cliente) => {
            setEditingCliente(cliente);
            setIsModalOpen(true);
          };

          const handleDelete = (id) => {
            if (confirm('¿Estás seguro de eliminar este cliente?')) {
              setClientes(clientes.filter(c => c.id !== id));
            }
          };

          const handleSave = (clienteData) => {
            if (editingCliente) {
              setClientes((clientes || []).map(c => 
                c.id === editingCliente.id ? { ...clienteData, id: editingCliente.id } : c
              ));
            } else {
              const newCliente = {
                ...clienteData,
                id: Math.max(...(clientes || []).map(c => c.id)) + 1,
                fechaRegistro: new Date().toISOString().split('T')[0]
              };
              setClientes([...clientes, newCliente]);
            }
            setIsModalOpen(false);
          };

          return (
            <div>
              <div className="flex items-center justify-between mb-6">
                <div>
                  <h2 className="text-3xl font-bold text-gray-800">
                    {isAdmin ? 'Gestión de Clientes' : 'Mi Información'}
                  </h2>
                  <p className="text-gray-600 mt-1">
                    {isAdmin 
                      ? `${clientes.length} clientes registrados`
                      : 'Información de tu empresa'}
                  </p>
                </div>
                {isAdmin && (
                  <button
                    onClick={handleCreate}
                    className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    <Plus className="w-5 h-5" />
                    Nuevo Cliente
                  </button>
                )}
              </div>

              {isAdmin && (
                <div className="mb-6">
                  <div className="relative">
                    <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                      <Search className="w-5 h-5" />
                    </div>
                    <input
                      type="text"
                      placeholder="Buscar por nombre, NIT o representante..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                </div>
              )}

              <div className="bg-white rounded-xl shadow-md overflow-hidden">
                <table className="w-full">
                  <thead className="bg-gray-50 border-b border-gray-200">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">NIT</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Representante</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contacto</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {filteredClientes.map(cliente => (
                      <tr key={cliente.id} className="hover:bg-gray-50">
                        <td className="px-6 py-4">
                          <div className="font-medium text-gray-900">{cliente.nombre}</div>
                          <div className="text-sm text-gray-500">{cliente.direccion}</div>
                        </td>
                        <td className="px-6 py-4 text-sm text-gray-900">{cliente.nit}</td>
                        <td className="px-6 py-4 text-sm text-gray-900">{cliente.representante}</td>
                        <td className="px-6 py-4">
                          <div className="text-sm text-gray-900">{cliente.email}</div>
                          <div className="text-sm text-gray-500">{cliente.telefono}</div>
                        </td>
                        <td className="px-6 py-4">
                          <span className={`px-2 py-1 text-xs font-semibold rounded-full ${
                            cliente.activo 
                              ? 'bg-green-100 text-green-800' 
                              : 'bg-red-100 text-red-800'
                          }`}>
                            {cliente.activo ? 'Activo' : 'Inactivo'}
                          </span>
                        </td>
                        <td className="px-6 py-4">
                          <div className="flex items-center gap-2">
                            <button
                              onClick={() => handleEdit(cliente)}
                              className="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-50 rounded-lg transition-colors"
                              title="Editar"
                            >
                              <Edit2 className="w-4 h-4" />
                            </button>
                            {isAdmin && (
                              <button
                                onClick={() => handleDelete(cliente.id)}
                                className="text-red-600 hover:text-red-800 p-2 hover:bg-red-50 rounded-lg transition-colors"
                                title="Eliminar"
                              >
                                <Trash2 className="w-4 h-4" />
                              </button>
                            )}
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>

                {filteredClientes.length === 0 && (
                  <div className="text-center py-12 text-gray-500">
                    No se encontraron clientes
                  </div>
                )}
              </div>

              {isModalOpen && (
                <ClienteModal
                  cliente={editingCliente}
                  onSave={handleSave}
                  onClose={() => setIsModalOpen(false)}
                />
              )}
            </div>
          );
        }

        // ==================== MODAL CLIENTE ====================
        
        function ClienteModal({ cliente, onSave, onClose }) {
          const [formData, setFormData] = useState(cliente || {
            nombre: '',
            nit: '',
            representante: '',
            email: '',
            telefono: '',
            direccion: '',
            activo: true
          });

          const handleSubmit = (e) => {
            e.preventDefault();
            onSave(formData);
          };

          return (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div className="flex items-center justify-between p-6 border-b border-gray-200">
                  <h3 className="text-xl font-bold text-gray-800">
                    {cliente ? 'Editar Cliente' : 'Nuevo Cliente'}
                  </h3>
                  <button
                    onClick={onClose}
                    className="text-gray-400 hover:text-gray-600 transition-colors"
                  >
                    <X className="w-6 h-6" />
                  </button>
                </div>

                <form onSubmit={handleSubmit} className="p-6">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="md:col-span-2">
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Nombre de la Empresa *
                      </label>
                      <input
                        type="text"
                        required
                        value={formData.nombre}
                        onChange={(e) => setFormData({...formData, nombre: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Ej: Constructora ABC S.A."
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        NIT *
                      </label>
                      <input
                        type="text"
                        required
                        value={formData.nit}
                        onChange={(e) => setFormData({...formData, nit: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="900.123.456-7"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Representante Legal *
                      </label>
                      <input
                        type="text"
                        required
                        value={formData.representante}
                        onChange={(e) => setFormData({...formData, representante: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Carlos Méndez"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Email *
                      </label>
                      <input
                        type="email"
                        required
                        value={formData.email}
                        onChange={(e) => setFormData({...formData, email: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="contacto@empresa.com"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Teléfono *
                      </label>
                      <input
                        type="tel"
                        required
                        value={formData.telefono}
                        onChange={(e) => setFormData({...formData, telefono: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="+57 300 123 4567"
                      />
                    </div>

                    <div className="md:col-span-2">
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Dirección *
                      </label>
                      <input
                        type="text"
                        required
                        value={formData.direccion}
                        onChange={(e) => setFormData({...formData, direccion: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Calle 100 #15-20, Bogotá"
                      />
                    </div>

                    <div className="md:col-span-2">
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={formData.activo}
                          onChange={(e) => setFormData({...formData, activo: e.target.checked})}
                          className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                        />
                        <span className="text-sm font-medium text-gray-700">Cliente activo</span>
                      </label>
                    </div>
                  </div>

                  <div className="flex items-center justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
                    <button
                      type="button"
                      onClick={onClose}
                      className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
                    >
                      Cancelar
                    </button>
                    <button
                      type="submit"
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                    >
                      {cliente ? 'Guardar Cambios' : 'Crear Cliente'}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          );
        }

        // ==================== PLACEHOLDER VIEW ====================
        
        function PlaceholderView({ title }) {
          return (
            <div>
              <h2 className="text-3xl font-bold text-gray-800 mb-6">{title}</h2>
              <div className="bg-white rounded-xl shadow-md p-6">
                <p className="text-gray-600">Módulo en desarrollo...</p>
                <p className="text-sm text-gray-500 mt-2">Este módulo será implementado en las siguientes fases.</p>
              </div>
            </div>
          );
        }

        // ==================== RENDER ====================
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TeracontaDualPanel />);
    </script>
</body>
</html>
